<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评论系统组件 - 演示页面</title>
    <link rel="stylesheet" href="comment-system.css">
    <style>
        /* 演示页面专用样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .demo-container {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .demo-header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .demo-title {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .demo-subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .demo-instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .demo-instructions h3 {
            margin-top: 0;
            color: white;
            font-size: 18px;
        }

        .demo-instructions ul {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .demo-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .demo-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .demo-card:hover {
            transform: translateY(-5px);
        }

        .demo-card h3 {
            color: #333;
            margin-top: 0;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .demo-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 8px 0;
            color: #555;
            position: relative;
            padding-left: 25px;
        }

        .feature-list li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }

        .demo-actions {
            text-align: center;
            margin-top: 30px;
        }

        .demo-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin: 0 10px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .demo-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .demo-btn.secondary {
            background: #6c757d;
        }

        .demo-btn.secondary:hover {
            background: #545b62;
        }

        .demo-mockup {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: #6c757d;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .mockup-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .mockup-text {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .mockup-hint {
            font-size: 12px;
            color: #adb5bd;
        }



        /* 响应式设计 */
        @media (max-width: 768px) {
            .demo-content {
                grid-template-columns: 1fr;
            }
            
            .demo-container {
                padding: 20px;
            }
            
            .demo-title {
                font-size: 24px;
            }
            

        }

        /* 状态指示器 */
        .status-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #333;
            backdrop-filter: blur(10px);
            z-index: 998;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-right: 8px;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- 状态指示器 -->
    <div class="status-indicator">
        <span class="status-dot"></span>
        评论系统已加载
    </div>



    <div class="demo-container">
        <!-- 演示页面标题 -->
        <div class="demo-header">
            <h1 class="demo-title">评论系统组件演示</h1>
            <p class="demo-subtitle">类似 Axure / 墨刀 的评论功能，支持在页面任意位置添加评论标记</p>
            
            <div class="demo-instructions">
                <h3>📝 使用说明</h3>
                <ul>
                    <li><strong>步骤1：</strong>点击右上角"💬 评论模式"按钮进入评论模式（按钮会变蓝色）</li>
                    <li><strong>步骤2：</strong>在评论模式下，点击页面任意位置添加评论</li>
                    <li><strong>查看评论：</strong>点击评论标记查看详情，点击评论列表项也可查看</li>
                    <li><strong>控制显示：</strong>使用"👁️ 显示/隐藏评论"按钮控制评论标记的可见性</li>
                    <li><strong>评论列表：</strong>点击"📋 评论列表"按钮查看所有评论</li>
                    <li><strong>退出模式：</strong>再次点击"评论模式"按钮退出评论模式</li>
                    <li><strong>快捷键：</strong>按ESC键可关闭弹窗和模态框</li>
                </ul>
            </div>
        </div>

        <!-- 演示内容区域 -->
        <div class="demo-content">
            <div class="demo-card">
                <h3>🎯 核心功能</h3>
                <p>这是一个功能完整的评论系统组件，您可以在这里测试各种功能。</p>
                <ul class="feature-list">
                    <li>点击添加评论标记</li>
                    <li>评论编辑和删除</li>
                    <li>优先级设置（低/普通/高/紧急）</li>
                    <li>状态管理（未解决/已解决）</li>
                    <li>回复功能</li>
                    <li>本地存储</li>
                </ul>
            </div>

            <div class="demo-card">
                <h3>💡 设计特点</h3>
                <p>参考了 Axure 和墨刀的评论功能设计，提供直观的用户体验。</p>
                <ul class="feature-list">
                    <li>现代化的 UI 设计</li>
                    <li>响应式布局</li>
                    <li>流畅的动画效果</li>
                    <li>完善的交互反馈</li>
                    <li>ESC键关闭弹窗</li>
                    <li>移动端适配</li>
                </ul>
            </div>
        </div>

        <!-- 测试区域 -->
        <div class="demo-mockup">
            <div class="mockup-icon">🖱️</div>
            <div class="mockup-text">在这个区域测试评论功能</div>
            <div class="mockup-hint">进入评论模式后，点击任意位置添加评论</div>
        </div>

        <!-- 操作按钮 -->
        <div class="demo-actions">
            <button class="demo-btn" onclick="window.commentSystem.openPanel()">
                📋 打开评论列表
            </button>
            <button class="demo-btn" onclick="saveToFile()" id="save-btn">
                💾 保存到文件
            </button>
            <button class="demo-btn secondary" onclick="loadFromFile()">
                📂 从文件加载
            </button>
            <button class="demo-btn secondary" onclick="exportComments()">
                📤 导出数据
            </button>
            <button class="demo-btn secondary" onclick="addSampleComments()">
                📝 添加示例评论
            </button>
            <button class="demo-btn secondary" onclick="fixCommentData()">
                🔧 修复数据
            </button>
            <button class="demo-btn secondary" onclick="clearAllComments()">
                🗑️ 清空所有评论
            </button>
            <button class="demo-btn secondary" onclick="window.commentSystem.updateAllMarkerPositions(); console.log('✅ 已强制更新所有标记位置');">
                📍 刷新标记位置
            </button>
        </div>
    </div>

    <!-- 评论系统组件 -->
    <div id="comment-system">
        <!-- 评论工具栏 -->
        <div class="comment-toolbar">
            <button id="toggle-comment-mode" class="toolbar-btn">
                <span class="btn-icon">💬</span>
                <span class="btn-text">评论模式</span>
            </button>
            <button id="toggle-comments-visibility" class="toolbar-btn">
                <span class="btn-icon">👁️</span>
                <span class="btn-text">显示评论</span>
            </button>
            <button id="open-comment-list" class="toolbar-btn">
                <span class="btn-icon">📋</span>
                <span class="btn-text">评论列表</span>
            </button>

        </div>

        <!-- 评论标记容器 -->
        <div id="comment-markers"></div>

        <!-- 评论面板 -->
        <div id="comment-panel" class="comment-panel">
            <div class="panel-header">
                <h3 class="panel-title">评论列表</h3>
                <button id="close-panel" class="close-btn">&times;</button>
            </div>
            <div class="panel-content">
                <div id="comments-list" class="comments-list">
                    <!-- 评论项将通过JavaScript动态添加 -->
                </div>
            </div>
        </div>

        <!-- 评论编辑模态框 -->
        <div id="comment-modal" class="comment-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="modal-title">添加评论</h4>
                    <button id="close-modal" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="comment-author">作者:</label>
                        <input type="text" id="comment-author" placeholder="请输入您的姓名" value="匿名用户">
                    </div>
                    <div class="form-group">
                        <label for="comment-content">评论内容:</label>
                        <textarea id="comment-content" rows="4" placeholder="请输入评论内容..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="comment-priority">优先级:</label>
                        <select id="comment-priority">
                            <option value="low">低</option>
                            <option value="normal" selected>普通</option>
                            <option value="high">高</option>
                            <option value="urgent">紧急</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="save-comment" class="btn btn-primary">保存</button>
                    <button id="cancel-comment" class="btn btn-secondary">取消</button>
                </div>
            </div>
        </div>

        <!-- 评论详情弹窗 -->
        <div id="comment-detail-popup" class="comment-popup">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="comment-info">
                        <span class="comment-number">#1</span>
                        <span class="comment-author">作者姓名</span>
                        <span class="comment-time">2024-01-15 14:30</span>
                    </div>
                    <div class="popup-actions">
                        <button class="action-btn edit-btn" title="编辑">✏️</button>
                        <button class="action-btn delete-btn" title="删除">🗑️</button>
                        <button class="close-popup-btn">&times;</button>
                    </div>
                </div>
                <div class="popup-body">
                    <div class="comment-content-display">
                        评论内容将在这里显示
                    </div>
                    <div class="comment-status">
                        <span class="priority-badge normal">普通</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入评论系统 -->
    <script src="comment-system.js"></script>
    
    <!-- 演示页面专用脚本 -->
    <script>
        // 保存到文件
        async function saveToFile() {
            if (window.commentSystem) {
                const success = await window.commentSystem.saveToJsonFile();
                if (success) {
                    alert('评论数据已保存到文件！');
                    updateSaveButtonState();
                }
            }
        }

        // 从文件加载
        function loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            window.commentSystem.importComments(data);
                            // 清理缓存
                            localStorage.removeItem('comment-system-cache');
                            updateSaveButtonState();
                            alert('评论数据加载成功！');
                        } catch (error) {
                            alert('加载失败：文件格式错误');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // 导出评论数据
        function exportComments() {
            const data = window.commentSystem.exportComments();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comments-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('评论数据已导出！');
        }

        // 更新保存按钮状态
        function updateSaveButtonState() {
            const saveBtn = document.getElementById('save-btn');
            if (window.commentSystem && window.commentSystem.hasUnsavedData()) {
                saveBtn.textContent = '💾 保存到文件 *';
                saveBtn.style.background = '#dc3545';
                saveBtn.title = '有未保存的评论数据';
            } else {
                saveBtn.textContent = '💾 保存到文件';
                saveBtn.style.background = '#007bff';
                saveBtn.title = '保存评论数据到JSON文件';
            }
        }

        // 清空所有评论
        function clearAllComments() {
            if (confirm('确定要清空所有评论吗？此操作不可撤销。')) {
                window.commentSystem.clearAllComments();
                // 清理所有缓存数据
                localStorage.removeItem('comment-system-cache');
                localStorage.removeItem('comment-system-data');
                updateSaveButtonState();
                alert('所有评论已清空！');
            }
        }
        
        // 修复数据功能
        function fixCommentData() {
            if (window.commentSystem) {
                // 清理当前数据
                window.commentSystem.comments = window.commentSystem.comments.map(comment => {
                    return window.commentSystem.cleanCommentData(comment);
                }).filter(comment => comment !== null);
                
                // 重新保存
                window.commentSystem.saveToStorage();
                
                // 重新创建标记
                document.getElementById('comment-markers').innerHTML = '';
                window.commentSystem.comments.forEach(comment => {
                    window.commentSystem.createMarker(comment);
                });
                
    
                window.commentSystem.updateCommentsList();
                updateSaveButtonState();
                
                alert('数据修复完成！');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 开启调试模式
            window.commentDebug = true;
            
            // 延迟初始化，确保评论系统完全加载
            setTimeout(() => {
                // 自动修复数据（静默）
                if (window.commentSystem) {
                    const originalLength = window.commentSystem.comments.length;
                    window.commentSystem.comments = window.commentSystem.comments.map(comment => {
                        return window.commentSystem.cleanCommentData(comment);
                    }).filter(comment => comment !== null);
                    
                    if (window.commentSystem.comments.length !== originalLength) {
                        console.log(`已清理 ${originalLength - window.commentSystem.comments.length} 条无效评论数据`);
                        window.commentSystem.saveToStorage();
            
                        window.commentSystem.updateCommentsList();
                    }
                }
                
                // 更新保存按钮状态
                updateSaveButtonState();
                
                // 不再自动添加示例评论，只从JSON文件加载
                console.log('评论系统初始化完成，当前评论数：', window.commentSystem.comments.length);
            }, 1000);
            
            // 定期检查保存状态
            setInterval(() => {
                updateSaveButtonState();
            }, 5000);
        });

        // 添加示例评论
        function addSampleComments() {
            // 延迟添加，确保页面完全加载
            setTimeout(() => {
                // 动态创建评论，基于实际页面元素
                const demoTitle = document.querySelector('.demo-title');
                const firstCard = document.querySelector('.demo-card:first-child h3');
                const mockupArea = document.querySelector('.demo-mockup');
                
                if (!demoTitle || !firstCard || !mockupArea) {
                    console.warn('无法找到目标元素，跳过示例评论创建');
                    return;
                }
                
                const sampleComments = [
                    {
                        id: 1,
                        targetElement: window.commentSystem.generateElementSelector(demoTitle),
                        offsetX: 50,
                        offsetY: 10,
                        author: '产品经理',
                        content: '标题设计很棒！建议字体可以再大一些，更突出主题。',
                        priority: 'high',
                        status: 'unresolved',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2小时前
                        replies: [
                            {
                                id: 1001,
                                author: 'UI设计师',
                                content: '好的，我会在下个版本中调整字体大小。',
                                timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString() // 1小时前
                            }
                        ]
                    },
                    {
                        id: 2,
                        targetElement: window.commentSystem.generateElementSelector(firstCard),
                        offsetX: 20,
                        offsetY: 5,
                        author: '测试工程师',
                        content: '功能列表很清晰，建议添加更多的使用场景说明。',
                        priority: 'urgent',
                        status: 'unresolved',
                        timestamp: new Date(Date.now() - 30 * 60 * 1000).toISOString(), // 30分钟前
                        replies: []
                    },
                    {
                        id: 3,
                        targetElement: window.commentSystem.generateElementSelector(mockupArea),
                        offsetX: 100,
                        offsetY: 50,
                        author: '前端开发',
                        content: '测试区域的提示很友好，用户体验不错！',
                        priority: 'normal',
                        status: 'resolved',
                        timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(), // 4小时前
                        replies: [
                            {
                                id: 1002,
                                author: '产品经理',
                                content: '感谢反馈！这样的设计确实更直观。',
                                timestamp: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString() // 3小时前
                            }
                        ]
                    }
                ];
                
                // 添加示例评论到系统中
                window.commentSystem.comments = sampleComments;
                window.commentSystem.commentCounter = 3;

                // 创建标记
                sampleComments.forEach(comment => {
                    window.commentSystem.createMarker(comment);
                });

                // 更新统计和列表
    
                window.commentSystem.updateCommentsList();
                window.commentSystem.saveToStorage();

                console.log('已添加示例评论数据');
                updateSaveButtonState();
                alert('示例评论已添加！请点击"保存到文件"按钮保存数据。');
            }, 500);
        }

        // 添加页面提示
        setTimeout(() => {
            if (window.commentSystem && window.commentSystem.comments.length > 0) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                    z-index: 1002;
                    font-size: 14px;
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    <strong>💡 提示</strong><br>
                    页面上已有示例评论，您可以点击查看或添加新的评论！
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease forwards';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 5000);
            }
        }, 2000);

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // 页面卸载时清理资源和提醒保存
        window.addEventListener('beforeunload', function(e) {
            if (window.commentSystem) {
                // 检查是否有未保存的数据
                if (window.commentSystem.hasUnsavedData()) {
                    const message = '您有未保存的评论数据，确定要离开吗？';
                    e.preventDefault();
                    e.returnValue = message;
                    return message;
                }
                
                window.commentSystem.cleanup();
            }
        });
    </script>
</body>
</html>