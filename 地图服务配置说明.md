# 临夏农情遥感系统 - 地图服务配置说明

## 概述

为了解决地图服务需要VPN才能访问的问题，我们已经将所有地图服务替换为国内可访问的地图服务商。

## 主要变更

### 1. 替换的地图服务

| 原服务 | 新服务 | 说明 |
|--------|--------|------|
| Google Maps | 高德地图 | 主要地图服务 |
| OpenStreetMap | 高德地图/腾讯地图 | 标准地图图层 |
| Bing Maps | 高德地图/腾讯地图 | 卫星影像图层 |
| Esri World Imagery | 高德地图/腾讯地图 | 卫星影像图层 |

### 2. 新增的地图服务提供商

#### 高德地图（主要）
- **标准地图**: 道路、建筑物、行政区划等基础地理信息
- **卫星影像**: 高清卫星图像
- **路网标注**: 可叠加在卫星图上的道路标注
- **无需API密钥**: 直接使用，无需申请

#### 腾讯地图（备用）
- **标准地图**: 作为高德地图的备用选择
- **卫星影像**: 备用卫星影像服务
- **无需API密钥**: 直接使用，无需申请

#### 天地图（可选，需要密钥）
- **矢量地图**: 政府官方地图服务
- **影像地图**: 官方卫星影像
- **需要API密钥**: 需要到天地图官网申请密钥

#### OpenStreetMap 国内镜像（备用）
- **清华大学镜像**: 稳定的国内镜像服务
- **中科大镜像**: 备用镜像服务

## 配置文件说明

### 1. `domestic-map-config.js` - 国内地图服务配置文件
这是新创建的配置文件，包含了所有国内地图服务的配置信息：

```javascript
// 高德地图配置
const AMAP_CONFIG = {
    STANDARD: {
        name: '高德标准地图',
        url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
        subdomains: ['1', '2', '3', '4'],
        maxZoom: 18,
        attribution: '© 高德地图'
    }
};
```

### 2. Cesium 配置更新
- `大屏原型/assets/js/cesium-config.js`: 更新了Cesium地图图层配置
- `大屏原型/assets/js/cesium-map.js`: 更新了影像提供器创建函数

### 3. Leaflet 配置更新
更新了以下文件中的地图服务配置：
- `农情遥感系统原型/pages/overview/overview.js`
- `农情遥感系统原型/pages/crop-distribution/crop-distribution.js`
- `农情遥感系统原型/pages/crop-growth/crop-growth.js`
- `农情遥感系统原型/pages/weather-map/weather-map.js`
- `农情遥感系统原型/pages/yield-forecast/yield-forecast.js`

## 使用方法

### 1. 无需额外配置
系统已经配置为默认使用高德地图，无需任何额外设置即可正常使用。

### 2. 切换地图图层
在支持图层切换的页面中，可以在以下地图服务之间切换：
- 高德标准地图
- 高德卫星影像
- 腾讯标准地图
- 腾讯卫星影像

### 3. 使用天地图（可选）
如果需要使用天地图服务：

1. 访问 [天地图官网](https://www.tianditu.gov.cn/)
2. 注册账号并申请API密钥
3. 在 `domestic-map-config.js` 文件中替换密钥：
   ```javascript
   TOKEN: '你的天地图密钥'
   ```

## 服务自动切换机制

系统具备服务自动切换功能：
1. **主要服务**: 优先使用高德地图
2. **备用服务**: 高德地图不可用时自动切换到腾讯地图
3. **镜像服务**: 备用OpenStreetMap国内镜像
4. **应急模式**: 所有服务都不可用时显示应急地图

## 性能优化

### 1. 多域名负载均衡
使用多个子域名分散请求，提高加载速度：
- 高德地图: ['1', '2', '3', '4']
- 腾讯地图: ['0', '1', '2', '3']

### 2. 瓦片缓存
浏览器会自动缓存地图瓦片，提高重复访问速度。

### 3. 按需渲染
Cesium配置为按需渲染模式，降低资源消耗。

## 故障排除

### 1. 地图无法显示
**可能原因**:
- 网络连接问题
- 地图服务临时不可用

**解决方法**:
- 检查网络连接
- 尝试刷新页面
- 切换到其他地图图层

### 2. 地图加载缓慢
**可能原因**:
- 网络带宽限制
- 服务器响应慢

**解决方法**:
- 等待加载完成
- 切换到其他地图服务
- 降低地图缩放级别

### 3. 坐标偏移问题
**说明**: 
- 高德地图和腾讯地图使用GCJ-02坐标系（火星坐标系）
- 与GPS标准坐标系(WGS-84)存在偏移
- 这是正常现象，符合国内地图服务规范

## 技术支持

如果遇到其他问题，请联系技术支持团队。

---

**更新日期**: 2024年12月
**版本**: 1.0
**维护人员**: 开发团队