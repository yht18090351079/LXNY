<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>临夏农情遥感系统 - 地图服务测试</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2rem;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .control-group select,
        .control-group button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }
        
        .control-group button {
            background: #3498db;
            color: white;
            border: none;
        }
        
        .control-group button:hover {
            background: #2980b9;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .info-panel {
            padding: 20px;
            background: #f8f9fa;
        }
        
        .service-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .service-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .service-item h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .service-item p {
            margin: 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🗺️ 地图服务测试页面</h1>
            <p>测试国内地图服务配置是否正常工作</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="mapProvider">地图服务商:</label>
                <select id="mapProvider">
                    <option value="amap">高德地图</option>
                    <option value="tencent">腾讯地图</option>
                    <option value="osm-china">OpenStreetMap(清华镜像)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="mapType">地图类型:</label>
                <select id="mapType">
                    <option value="standard">标准地图</option>
                    <option value="satellite">卫星影像</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button onclick="switchMapLayer()">切换图层</button>
                <button onclick="resetView()">重置视图</button>
                <button onclick="testAllServices()">测试所有服务</button>
            </div>
            
            <span id="status" class="status loading">正在加载地图...</span>
        </div>
        
        <div id="map"></div>
        <div class="coordinates" id="coordinates">鼠标移动到地图上查看坐标</div>
        
        <div class="info-panel">
            <h3>🔧 配置信息</h3>
            <p><strong>当前位置:</strong> 临夏县 (35.6°N, 103.1°E)</p>
            <p><strong>坐标系统:</strong> GCJ-02 (火星坐标系) - 适用于中国大陆</p>
            <p><strong>地图范围:</strong> 临夏回族自治州及周边地区</p>
            
            <h4>📡 可用地图服务</h4>
            <div class="service-list">
                <div class="service-item">
                    <h4>🌏 高德地图</h4>
                    <p>主要地图服务商，提供标准地图和卫星影像</p>
                </div>
                <div class="service-item">
                    <h4>🗺️ 腾讯地图</h4>
                    <p>备用地图服务商，提供标准地图和卫星影像</p>
                </div>
                <div class="service-item">
                    <h4>🌍 OpenStreetMap</h4>
                    <p>开源地图，使用清华大学镜像服务</p>
                </div>
                <div class="service-item">
                    <h4>🛰️ 天地图</h4>
                    <p>官方地图服务(需要API密钥)</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="domestic-map-config.js"></script>
    <script>
        // 全局变量
        let map = null;
        let currentLayer = null;
        
        // 地图配置
        const mapConfigs = {
            amap: {
                standard: {
                    url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
                    subdomains: ['1', '2', '3', '4'],
                    attribution: '© 高德地图'
                },
                satellite: {
                    url: 'https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                    subdomains: ['1', '2', '3', '4'],
                    attribution: '© 高德地图'
                }
            },
            tencent: {
                standard: {
                    url: 'https://rt{s}.map.gtimg.com/tile?z={z}&x={x}&y={y}&type=vector&styleid=3',
                    subdomains: ['0', '1', '2', '3'],
                    attribution: '© 腾讯地图'
                },
                satellite: {
                    url: 'https://p{s}.map.gtimg.com/sateTiles/{z}/{x}/{y}.jpg',
                    subdomains: ['0', '1', '2', '3'],
                    attribution: '© 腾讯地图'
                }
            },
            'osm-china': {
                standard: {
                    url: 'https://mirrors.tuna.tsinghua.edu.cn/osm/{z}/{x}/{y}.png',
                    subdomains: [],
                    attribution: '© OpenStreetMap contributors, 清华大学镜像'
                },
                satellite: {
                    url: 'https://mirrors.tuna.tsinghua.edu.cn/osm/{z}/{x}/{y}.png',
                    subdomains: [],
                    attribution: '© OpenStreetMap contributors, 清华大学镜像'
                }
            }
        };
        
        // 初始化地图
        function initMap() {
            updateStatus('正在初始化地图...', 'loading');
            
            try {
                // 创建地图实例
                map = L.map('map').setView([35.6, 103.1], 10);
                
                // 添加默认图层
                switchMapLayer();
                
                // 添加鼠标移动事件
                map.on('mousemove', function(e) {
                    const lat = e.latlng.lat.toFixed(4);
                    const lng = e.latlng.lng.toFixed(4);
                    document.getElementById('coordinates').textContent = 
                        `坐标: ${lat}°N, ${lng}°E`;
                });
                
                // 添加点击事件
                map.on('click', function(e) {
                    const lat = e.latlng.lat.toFixed(4);
                    const lng = e.latlng.lng.toFixed(4);
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(`
                            <strong>点击位置</strong><br>
                            纬度: ${lat}°N<br>
                            经度: ${lng}°E<br>
                            <small>坐标系: GCJ-02</small>
                        `)
                        .openOn(map);
                });
                
                updateStatus('地图加载成功', 'success');
            } catch (error) {
                console.error('地图初始化失败:', error);
                updateStatus('地图加载失败: ' + error.message, 'error');
            }
        }
        
        // 切换地图图层
        function switchMapLayer() {
            const provider = document.getElementById('mapProvider').value;
            const type = document.getElementById('mapType').value;
            
            updateStatus('正在切换图层...', 'loading');
            
            try {
                // 移除当前图层
                if (currentLayer) {
                    map.removeLayer(currentLayer);
                }
                
                // 获取配置
                const config = mapConfigs[provider][type];
                
                // 创建新图层
                const layerOptions = {
                    maxZoom: 18,
                    attribution: config.attribution
                };
                
                if (config.subdomains.length > 0) {
                    layerOptions.subdomains = config.subdomains;
                }
                
                currentLayer = L.tileLayer(config.url, layerOptions);
                currentLayer.addTo(map);
                
                // 监听图层加载事件
                currentLayer.on('loading', () => {
                    updateStatus('正在加载图层...', 'loading');
                });
                
                currentLayer.on('load', () => {
                    updateStatus(`${getProviderName(provider)} - ${getTypeName(type)} 加载成功`, 'success');
                });
                
                currentLayer.on('tileerror', (e) => {
                    console.warn('图层加载错误:', e);
                    updateStatus('部分图层加载失败', 'error');
                });
                
            } catch (error) {
                console.error('图层切换失败:', error);
                updateStatus('图层切换失败: ' + error.message, 'error');
            }
        }
        
        // 重置视图
        function resetView() {
            if (map) {
                map.setView([35.6, 103.1], 10);
                updateStatus('视图已重置', 'success');
            }
        }
        
        // 测试所有服务
        async function testAllServices() {
            updateStatus('正在测试所有地图服务...', 'loading');
            
            const results = [];
            
            for (const [providerKey, provider] of Object.entries(mapConfigs)) {
                for (const [typeKey, config] of Object.entries(provider)) {
                    try {
                        const success = await testMapService(config.url, config.subdomains);
                        results.push({
                            provider: getProviderName(providerKey),
                            type: getTypeName(typeKey),
                            success: success
                        });
                    } catch (error) {
                        results.push({
                            provider: getProviderName(providerKey),
                            type: getTypeName(typeKey),
                            success: false,
                            error: error.message
                        });
                    }
                }
            }
            
            // 显示测试结果
            showTestResults(results);
        }
        
        // 测试单个地图服务
        async function testMapService(url, subdomains) {
            const testUrl = url
                .replace('{s}', subdomains[0] || '')
                .replace('{z}', '10')
                .replace('{x}', '823')
                .replace('{y}', '375');
            
            try {
                const response = await fetch(testUrl, { 
                    method: 'HEAD',
                    mode: 'no-cors'  // 避免CORS问题
                });
                return true;  // 如果没有抛出异常，认为服务可用
            } catch (error) {
                return false;
            }
        }
        
        // 显示测试结果
        function showTestResults(results) {
            const successful = results.filter(r => r.success).length;
            const total = results.length;
            
            let message = `测试完成: ${successful}/${total} 个服务可用\n\n`;
            
            results.forEach(result => {
                const status = result.success ? '✅' : '❌';
                message += `${status} ${result.provider} - ${result.type}\n`;
                if (!result.success && result.error) {
                    message += `   错误: ${result.error}\n`;
                }
            });
            
            alert(message);
            
            if (successful > 0) {
                updateStatus(`测试完成: ${successful}/${total} 个服务可用`, 'success');
            } else {
                updateStatus('测试完成: 所有服务都不可用', 'error');
            }
        }
        
        // 更新状态显示
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // 获取服务商名称
        function getProviderName(key) {
            const names = {
                'amap': '高德地图',
                'tencent': '腾讯地图',
                'osm-china': 'OpenStreetMap'
            };
            return names[key] || key;
        }
        
        // 获取类型名称
        function getTypeName(key) {
            const names = {
                'standard': '标准地图',
                'satellite': '卫星影像'
            };
            return names[key] || key;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // 绑定控件事件
            document.getElementById('mapProvider').addEventListener('change', switchMapLayer);
            document.getElementById('mapType').addEventListener('change', switchMapLayer);
        });
    </script>
</body>
</html>