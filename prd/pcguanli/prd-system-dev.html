<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç«¯PRDç³»ç»Ÿ - å†œæƒ…é¥æ„Ÿç³»ç»Ÿç®¡ç†ç«¯äº§å“éœ€æ±‚æ–‡æ¡£ (å¼€å‘ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            color: #ffffff;
        }

        .prd-container {
            display: grid;
            grid-template-columns: 70% 30%;
            grid-template-rows: 70% 30%;
            height: 100vh;
            gap: 1px;
            padding: 0;
            background: #2a2a2a;
        }

        /* å·¦ä¸Šè§’ - å†…åµŒé¡µé¢åŒºåŸŸ */
        .embedded-page {
            grid-column: 1;
            grid-row: 1;
            background: #000000;
            border: none;
            overflow: hidden;
            position: relative;
        }

        .embedded-page iframe {
            width: 1920px;
            height: 1080px;
            border: none;
            border-radius: 12px;
            transform-origin: top left;
            position: absolute;
            top: 10px;
            left: 0;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }



        /* å·¥å…·æ  */
        .toolbar {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 2000;
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            background: rgba(42, 42, 42, 0.9);
            color: #ffffff;
            border: 1px solid #404040;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .toolbar-btn:hover {
            background: rgba(60, 60, 60, 0.9);
            border-color: #606060;
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
            background: rgba(80, 80, 80, 0.9);
        }

        .toolbar-btn.active {
            background: rgba(0, 168, 255, 0.9);
            border-color: #00a8ff;
        }

        /* å…¨å±çŠ¶æ€æ ·å¼ */
        .fullscreen-mode .prd-container {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
        }

        .fullscreen-mode .embedded-page {
            grid-column: 1;
            grid-row: 1;
        }

        .fullscreen-mode .annotation-panel,
        .fullscreen-mode .bottom-panels {
            display: none;
        }

        .fullscreen-mode .toolbar-btn.fullscreen-btn {
            background: rgba(220, 53, 69, 0.9);
            border-color: #dc3545;
        }

        /* æ‰¹æ³¨æ¨¡å¼æ ·å¼ */
        .annotation-mode .embedded-page {
            cursor: crosshair;
            position: relative;
        }

        .annotation-mode .embedded-page::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 168, 255, 0.1);
            pointer-events: none;
            border: 2px dashed #00a8ff;
            z-index: 1;
        }

        /* æ‰¹æ³¨æ¨¡å¼ä¸‹çš„iframeè¦†ç›–å±‚ */
        .annotation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2;
            cursor: crosshair;
        }

        /* é«˜äº®æ ·å¼ */
        .highlight-overlay {
            position: fixed;
            background: rgba(255, 193, 7, 0.3);
            border: 3px solid #ffc107;
            pointer-events: none;
            z-index: 1000;
            animation: highlight-pulse 1.5s infinite;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
        }

        @keyframes highlight-pulse {
            0% { 
                background: rgba(255, 193, 7, 0.2);
                border-color: #ffc107;
                transform: scale(1);
            }
            50% { 
                background: rgba(255, 193, 7, 0.4);
                border-color: #ffeb3b;
                transform: scale(1.02);
            }
            100% { 
                background: rgba(255, 193, 7, 0.2);
                border-color: #ffc107;
                transform: scale(1);
            }
        }

        /* é¡µé¢å…ƒç´ åˆ—è¡¨æ ·å¼ */
        .element-list {
            margin-top: 12px;
        }

        .element-item {
            background: #404040;
            border: 1px solid #606060;
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .element-item:hover {
            background: #505050;
            border-color: #00a8ff;
        }

        .element-item.active {
            background: rgba(0, 168, 255, 0.2);
            border-color: #00a8ff;
            color: #00a8ff;
        }

        .element-item .element-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .element-item .element-desc {
            font-size: 11px;
            color: #cccccc;
            opacity: 0.8;
        }

        /* å³ä¾§ - é¡µé¢å…ƒç´ æ‰¹æ³¨åŒºåŸŸ */
        .annotation-panel {
            grid-column: 2;
            grid-row: 1 / 3;
            background: #2a2a2a;
            border: none;
            padding: 0;
            overflow: hidden;
            border-left: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .annotation-header {
            background: #1a1a1a;
            color: #ffffff;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid #404040;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .annotation-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            font-size: 12px;
            color: #cccccc;
            line-height: 1.5;
            max-height: calc(100vh - 270px); /* å†å‡å°‘50pxé«˜åº¦ï¼Œç¡®ä¿åº•éƒ¨æŒ‰é’®æ›´å¥½æ˜¾ç¤º */
        }

        .annotation-item {
            background: #333333;
            border-left: 3px solid #00a8ff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
            transition: all 0.2s ease;
        }

        .annotation-item:hover {
            background: #3a3a3a;
            border-left-color: #20b8ff;
        }

        .annotation-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
            font-size: 13px;
        }

        /* Markdownæ ·å¼æ”¯æŒ */
        .annotation-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .annotation-content li {
            margin: 4px 0;
            list-style-type: disc;
        }

        .annotation-content li.nested {
            margin-left: 15px;
            list-style-type: circle;
            color: #aaaaaa;
        }

        .annotation-content strong {
            color: #ffffff;
            font-weight: 600;
        }

        .annotation-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
        }

        .annotation-content h3, .annotation-content h4 {
            color: #00a8ff;
            margin: 12px 0 6px 0;
            font-size: 13px;
        }

        .annotation-content p {
            margin: 6px 0;
        }

        /* é•¿å†…å®¹æ‰¹æ³¨æ ·å¼ä¼˜åŒ– */
        .annotation-content div[style*="margin-top: 8px"] {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
            /* ä¸ºæ»šåŠ¨æ¡é¢„ç•™ç©ºé—´ */
        }

        /* æ‰¹æ³¨å†…å®¹åŒºåŸŸçš„æ»šåŠ¨æ¡ç¾åŒ– */
        .annotation-content div[style*="margin-top: 8px"]::-webkit-scrollbar {
            width: 6px;
        }

        .annotation-content div[style*="margin-top: 8px"]::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 3px;
        }

        .annotation-content div[style*="margin-top: 8px"]::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 3px;
        }

        .annotation-content div[style*="margin-top: 8px"]::-webkit-scrollbar-thumb:hover {
            background: #666666;
        }

        /* åº•éƒ¨ä¸‰æ åŒºåŸŸ */
        .bottom-panels {
            grid-column: 1;
            grid-row: 2;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1px;
            background: #2a2a2a;
        }

        .panel {
            background: #2a2a2a;
            border: none;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel:not(:first-child) {
            border-left: 1px solid #404040;
        }

        .panel-header {
            background: #1a1a1a;
            color: #ffffff;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid #404040;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .panel-content {
            font-size: 12px;
            line-height: 1.6;
            color: #cccccc;
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .panel-content h4 {
            color: #ffffff;
            font-size: 13px;
            margin: 12px 0 8px 0;
            font-weight: 600;
        }

        .panel-content ul {
            margin: 8px 0;
            padding-left: 16px;
        }

        .panel-content li {
            margin-bottom: 4px;
            color: #cccccc;
        }

        .panel-content strong {
            color: #ffffff;
        }

        .panel-content code {
            background: #404040;
            color: #00a8ff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .nav-button {
            background: #404040;
            color: #ffffff;
            border: 1px solid #606060;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
            transition: all 0.2s ease;
        }

        .nav-button:hover {
            background: #505050;
            border-color: #00a8ff;
            color: #00a8ff;
        }

        .nav-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #333333;
            border-color: #404040;
            color: #666666;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #505050;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .prd-container {
                grid-template-columns: 65% 35%;
            }
        }

        @media (max-width: 768px) {
            .prd-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50% 25% 25%;
            }
            
            .annotation-panel {
                grid-column: 1;
                grid-row: 2;
            }
            
            .bottom-panels {
                grid-row: 3;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel, .annotation-panel, .embedded-page {
            animation: fadeInUp 0.6s ease-out;
        }

        .annotation-panel {
            animation-delay: 0.1s;
        }

        .bottom-panels .panel:nth-child(1) {
            animation-delay: 0.2s;
        }

        .bottom-panels .panel:nth-child(2) {
            animation-delay: 0.3s;
        }

        .bottom-panels .panel:nth-child(3) {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body>
    <!-- å·¥å…·æ  -->
    <div class="toolbar" id="mainToolbar">
        <button class="toolbar-btn annotation-btn" id="annotationBtn" onclick="toggleAnnotationMode()" title="æ‰¹æ³¨æ¨¡å¼">
            <span id="annotationIcon">ğŸ“</span>
        </button>
        <button class="toolbar-btn fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="å…¨å±æ˜¾ç¤º">
            <span id="fullscreenIcon">â›¶</span>
        </button>
        <button class="toolbar-btn debug-btn" id="debugBtn" onclick="showDebugMenu()" title="è°ƒè¯•å·¥å…·">
            <span>ğŸ”§</span>
        </button>
    </div>

    <div class="prd-container">
        <!-- å·¦ä¸Šè§’ - å†…åµŒé¡µé¢åŒºåŸŸ (70%) -->
        <div class="embedded-page">
            <iframe id="embeddedFrame" src="../../å¤§å±åŸå‹/index.html" title="å†œæƒ…é¥æ„Ÿç³»ç»Ÿå¤§å±"></iframe>
        </div>

        <!-- å³ä¾§ - é¡µé¢å…ƒç´ æ‰¹æ³¨åŒºåŸŸ -->
        <div class="annotation-panel">
            <div class="annotation-header">
                ğŸ“ é¡µé¢å…ƒç´ æ‰¹æ³¨
            </div>
            <div id="annotationContent">
                <!-- æ‰¹æ³¨å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- åº•éƒ¨ä¸‰æ åŒºåŸŸ -->
        <div class="bottom-panels">
            <!-- ç¬¬ä¸€æ  - å…¨å±€è¯´æ˜ -->
            <div class="panel">
                <div class="panel-header">ğŸŒ å…¨å±€è¯´æ˜</div>
                <div class="panel-content" id="globalDescription">
                    <p>æ­£åœ¨åŠ è½½å…¨å±€è¯´æ˜...</p>
                </div>
            </div>

            <!-- ç¬¬äºŒæ  - é¡µé¢è¯´æ˜ -->
            <div class="panel">
                <div class="panel-header">ğŸ“„ é¡µé¢è¯´æ˜</div>
                <div class="panel-content" id="pageDescription">
                    <!-- é¡µé¢è¯´æ˜å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ  - é¡µé¢å…ƒç´ æ¸…å• -->
            <div class="panel">
                <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                    <span>ğŸ“‹ é¡µé¢å…ƒç´ æ¸…å•</span>
                    <!-- æ‰¹æ³¨å¯¼èˆªæŒ‰é’® -->
                    <div id="annotationNavigation" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <button id="prevAnnotationBtn" onclick="navigateToPreviousAnnotation()" 
                                    style="background: #667eea; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 9px;"
                                    title="ä¸Šä¸€æ‰¹æ³¨ (â† æˆ– J é”®)">
                                â†
                            </button>
                            <div id="annotationCounter" style="font-size: 9px; color: #ccc; white-space: nowrap;">
                                1/5
                            </div>
                            <button id="nextAnnotationBtn" onclick="navigateToNextAnnotation()" 
                                    style="background: #667eea; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 9px;"
                                    title="ä¸‹ä¸€æ‰¹æ³¨ (â†’ æˆ– K é”®)">
                                â†’
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel-content">

                      <div class="element-list" id="elementList">
                          <!-- é¡µé¢å…ƒç´ æ¸…å•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                      </div>

                    <h4>ç³»ç»ŸçŠ¶æ€</h4>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(103, 126, 234, 0.1); border-radius: 6px; font-size: 11px;">
                        <div>ğŸŸ¢ ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
                        <div>ğŸ“¡ æ•°æ®è¿æ¥ç¨³å®š</div>
                        <div>ğŸ“ æ‰¹æ³¨æ•°æ®: <span id="annotationStatus">åŠ è½½ä¸­...</span></div>
                        <div>â° æœ€åæ›´æ–°: <span id="lastUpdate"></span></div>
                        <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); color: #ffc107;">
                            ğŸ’¡ æ•°æ®æº: prd-docs/annotations.json
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== ç¯å¢ƒæ¨¡å¼é…ç½® ==========
        
        // å¼ºåˆ¶è®¾ç½®ä¸ºå¼€å‘æ¨¡å¼ï¼ˆå¼€å‘ç‰ˆæœ¬ï¼‰
        const APP_MODE = 'development';
        
        function detectAppMode() {
            // å¼€å‘ç‰ˆæœ¬å§‹ç»ˆè¿”å›å¼€å‘æ¨¡å¼
            return 'development';
            // æ£€æµ‹æ–¹å¼1: URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');
            if (modeParam === 'dev' || modeParam === 'development') {
                return 'development';
            }
            if (modeParam === 'prod' || modeParam === 'production') {
                return 'production';
            }
            
            // æ£€æµ‹æ–¹å¼2: åŸŸååˆ¤æ–­
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('dev') || hostname.includes('test')) {
                return 'development';
            }
            
            // æ£€æµ‹æ–¹å¼3: åç«¯APIå¯ç”¨æ€§æ£€æµ‹
            if (typeof window.PRD_API_BASE_URL !== 'undefined') {
                return 'development';
            }
            
            // é»˜è®¤çº¿ä¸Šæ¨¡å¼
            return 'production';
        }
        
        // ç¯å¢ƒé…ç½®
        const ENV_CONFIG = {
            development: {
                name: 'å¼€å‘æ¨¡å¼',
                icon: 'ğŸ› ï¸',
                allowAnnotation: true,
                allowEdit: true,
                enableRealTimeSync: true,
                apiBaseUrl: window.PRD_API_BASE_URL || 'http://localhost:3000/api',
                debugMode: true,
                showDebugTools: true
            },
            production: {
                name: 'çº¿ä¸Šæ¨¡å¼',
                icon: 'ğŸŒ',
                allowAnnotation: false,
                allowEdit: false,
                enableRealTimeSync: false,
                apiBaseUrl: null,
                debugMode: false,
                showDebugTools: false
            }
        };
        
        // å½“å‰ç¯å¢ƒé…ç½®
        const CURRENT_ENV = ENV_CONFIG[APP_MODE];
        
        console.log(`ğŸŒ å½“å‰è¿è¡Œæ¨¡å¼: ${CURRENT_ENV.name} (${APP_MODE})`);
        
        // ========== API é›†æˆ ==========
        
        // åç«¯APIé›†æˆç±»
        class PRDApiClient {
            constructor() {
                this.baseUrl = CURRENT_ENV.apiBaseUrl;
                this.enabled = CURRENT_ENV.enableRealTimeSync && this.baseUrl;
                
                if (this.enabled) {
                    console.log('ğŸ”— APIå®¢æˆ·ç«¯å·²å¯ç”¨:', this.baseUrl);
                } else {
                    console.log('ğŸ“´ APIå®¢æˆ·ç«¯å·²ç¦ç”¨');
                }
            }
            
            // æ£€æŸ¥APIå¯ç”¨æ€§
            async checkConnection() {
                if (!this.enabled) return false;
                
                try {
                    const response = await fetch(`${this.baseUrl}/health`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    return response.ok;
                } catch (error) {
                    console.warn('APIè¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                    return false;
                }
            }
            
            // åŠ è½½æ‰¹æ³¨æ•°æ®
            async loadAnnotations() {
                if (!this.enabled) {
                    // æœ¬åœ°æ¨¡å¼ï¼šä»æ–‡ä»¶åŠ è½½
                    return this.loadAnnotationsFromFile();
                }
                
                try {
                    const response = await fetch(`${this.baseUrl}/annotations`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('ğŸ“¥ ä»APIåŠ è½½æ‰¹æ³¨æ•°æ®æˆåŠŸ');
                        return data;
                    } else {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                } catch (error) {
                    console.warn('APIåŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°æ–‡ä»¶:', error);
                    return this.loadAnnotationsFromFile();
                }
            }
            
            // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½æ‰¹æ³¨æ•°æ®
            async loadAnnotationsFromFile() {
                try {
                    const timestamp = new Date().getTime() + Math.random();
                    const response = await fetch(`prd-docs/annotations.json?t=${timestamp}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (response.ok) {
                        return await response.json();
                    } else {
                        return {};
                    }
                } catch (error) {
                    console.warn('æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥:', error);
                    return {};
                }
            }
            
            // ä¿å­˜æ‰¹æ³¨æ•°æ®
            async saveAnnotations(annotations) {
                if (!this.enabled) {
                    // æœ¬åœ°æ¨¡å¼ï¼šä¸‹è½½æ–‡ä»¶
                    this.downloadAnnotations(annotations);
                    return true;
                }
                
                try {
                    const response = await fetch(`${this.baseUrl}/annotations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(annotations)
                    });
                    
                    if (response.ok) {
                        console.log('ğŸ“¤ æ‰¹æ³¨æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                        return true;
                    } else {
                        throw new Error(`ä¿å­˜å¤±è´¥: ${response.status}`);
                    }
                } catch (error) {
                    console.warn('APIä¿å­˜å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°ä¸‹è½½:', error);
                    this.downloadAnnotations(annotations);
                    return false;
                }
            }
            
            // ä¸‹è½½æ‰¹æ³¨æ–‡ä»¶
            downloadAnnotations(annotations) {
                const cleanedAnnotations = cleanAnnotationsForSave(annotations);
                const dataStr = JSON.stringify(cleanedAnnotations, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                link.download = `annotations-${timestamp}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('âœ… æ‰¹æ³¨æ•°æ®å·²å¯¼å‡º:', `annotations-${timestamp}.json`);
            }
            
            // å¢é‡æ›´æ–°å•ä¸ªæ‰¹æ³¨
            async updateAnnotation(pageKey, elementId, annotation, action = 'update') {
                if (!this.enabled) return false;
                
                try {
                    const response = await fetch(`${this.baseUrl}/annotations/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            pageKey, 
                            elementId, 
                            annotation, 
                            action,
                            timestamp: new Date().toISOString() 
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`âœ… å¢é‡æ›´æ–°æˆåŠŸ: ${result.operation} - ${elementId}`);
                        return result;
                    } else {
                        throw new Error(`å¢é‡æ›´æ–°å¤±è´¥: ${response.status}`);
                    }
                } catch (error) {
                    console.warn('å¢é‡æ›´æ–°å¤±è´¥:', error);
                    return false;
                }
            }
            
            // å®æ—¶åŒæ­¥æ‰¹æ³¨ï¼ˆå¹¿æ’­ç”¨ï¼‰
            async syncAnnotation(annotation, action = 'create') {
                if (!this.enabled) return false;
                
                try {
                    const response = await fetch(`${this.baseUrl}/annotations/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ annotation, action, timestamp: new Date().toISOString() })
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.warn('å®æ—¶åŒæ­¥å¤±è´¥:', error);
                    return false;
                }
            }
        }
        
        // å…¨å±€APIå®¢æˆ·ç«¯å®ä¾‹
        const apiClient = new PRDApiClient();
        
        // ========== æƒé™æ§åˆ¶ ==========
        
        // æƒé™æ£€æŸ¥å‡½æ•°
        function checkPermission(action) {
            switch (action) {
                case 'annotation':
                    return CURRENT_ENV.allowAnnotation;
                case 'edit':
                    return CURRENT_ENV.allowEdit;
                case 'debug':
                    return CURRENT_ENV.showDebugTools;
                default:
                    return true;
            }
        }
        
        // æ˜¾ç¤ºæƒé™æç¤º
        function showPermissionDenied(action) {
            let message = '';
            switch (action) {
                case 'annotation':
                    message = 'å½“å‰ä¸ºçº¿ä¸Šæ¨¡å¼ï¼Œä¸å…è®¸æ·»åŠ æ‰¹æ³¨ã€‚å¦‚éœ€ç¼–è¾‘ï¼Œè¯·åˆ‡æ¢åˆ°å¼€å‘ç¯å¢ƒã€‚';
                    break;
                case 'edit':
                    message = 'å½“å‰ä¸ºçº¿ä¸Šæ¨¡å¼ï¼Œä¸å…è®¸ç¼–è¾‘å†…å®¹ã€‚';
                    break;
                default:
                    message = 'å½“å‰æ¨¡å¼ä¸‹ä¸å…è®¸æ­¤æ“ä½œã€‚';
            }
            
            alert(`ğŸš« æƒé™ä¸è¶³\n\n${message}\n\nå½“å‰æ¨¡å¼: ${CURRENT_ENV.icon} ${CURRENT_ENV.name}`);
        }
        
        // ========== æ¨¡å¼æŒ‡ç¤ºå™¨ ==========
        
        // åˆ›å»ºæ¨¡å¼æŒ‡ç¤ºå™¨
        function createModeIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'mode-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 12px;
                left: 12px;
                z-index: 3000;
                background: ${APP_MODE === 'development' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(33, 150, 243, 0.9)'};
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                cursor: pointer;
                transition: all 0.2s ease;
            `;
            
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 14px;">${CURRENT_ENV.icon}</span>
                    <span>${CURRENT_ENV.name}</span>
                    ${CURRENT_ENV.debugMode ? '<span style="font-size: 10px; opacity: 0.8;">DEBUG</span>' : ''}
                </div>
            `;
            
            indicator.addEventListener('click', showModeInfo);
            indicator.addEventListener('mouseenter', () => {
                indicator.style.transform = 'translateY(-1px)';
                indicator.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
            });
            indicator.addEventListener('mouseleave', () => {
                indicator.style.transform = 'translateY(0)';
                indicator.style.boxShadow = 'none';
            });
            
            document.body.appendChild(indicator);
        }
        
        // æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯
        function showModeInfo() {
            const info = `
ğŸŒ å½“å‰è¿è¡Œæ¨¡å¼: ${CURRENT_ENV.icon} ${CURRENT_ENV.name}

ğŸ“‹ åŠŸèƒ½æƒé™:
â€¢ æŸ¥çœ‹æ‰¹æ³¨: âœ… å…è®¸
â€¢ æ·»åŠ æ‰¹æ³¨: ${CURRENT_ENV.allowAnnotation ? 'âœ… å…è®¸' : 'âŒ ç¦æ­¢'}
â€¢ ç¼–è¾‘å†…å®¹: ${CURRENT_ENV.allowEdit ? 'âœ… å…è®¸' : 'âŒ ç¦æ­¢'}
â€¢ è°ƒè¯•å·¥å…·: ${CURRENT_ENV.showDebugTools ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}

ğŸ”— æ•°æ®æº:
â€¢ APIåœ°å€: ${CURRENT_ENV.apiBaseUrl || 'æœ¬åœ°æ–‡ä»¶'}
â€¢ å®æ—¶åŒæ­¥: ${CURRENT_ENV.enableRealTimeSync ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}

ğŸ’¡ æ¨¡å¼åˆ‡æ¢:
â€¢ å¼€å‘æ¨¡å¼: æ·»åŠ  ?mode=dev å‚æ•°
â€¢ çº¿ä¸Šæ¨¡å¼: æ·»åŠ  ?mode=prod å‚æ•°
            `.trim();
            
            alert(info);
        }

        // åŠŸèƒ½æ¨¡å—é…ç½®æ•°æ® - åŸºäºåŠŸèƒ½åˆ‡æ¢æ çš„data-functionå±æ€§
        const functionConfigs = {
            'crop-distribution': {
                title: 'ä½œç‰©åˆ†å¸ƒç›‘æµ‹',
                mdFile: 'ä½œç‰©åˆ†å¸ƒç›‘æµ‹.md',
                annotations: [
                    {
                        title: 'ğŸ—ºï¸ ä¸‰ç»´åœ°å›¾è§†å›¾',
                        content: 'åŸºäºCesium.jsçš„ä¸‰ç»´åœ°çƒï¼Œæ”¯æŒå¤šç§åœ°å›¾åº•å›¾åˆ‡æ¢ï¼Œå¯è¿›è¡Œç¼©æ”¾ã€æ—‹è½¬ã€å€¾æ–œç­‰æ“ä½œã€‚'
                    },
                    {
                        title: 'ğŸ“Š å³ä¾§æ•°æ®é¢æ¿',
                        content: 'åŒ…å«ä½œç‰©é¢ç§¯ç¯å½¢å›¾ã€å¤§æ£šç»Ÿè®¡å¡ç‰‡ã€åŒºåŸŸé¢ç§¯æ±‡æ€»ç­‰æ•°æ®å¯è§†åŒ–ç»„ä»¶ã€‚'
                    },
                    {
                        title: 'ğŸ“ˆ å·¦ä¾§åˆ†æé¢æ¿',
                        content: 'å±•ç¤ºç§æ¤ç»“æ„å¯¹æ¯”æŸ±çŠ¶å›¾ã€ä½œç‰©è½®ä½œæ¡‘åŸºå›¾ã€æ•°æ®æ›´æ–°çŠ¶æ€ç­‰åˆ†æå›¾è¡¨ã€‚'
                    },
                    {
                        title: 'âš™ï¸ åŠŸèƒ½å¯¼èˆªæ ',
                        content: `åº•éƒ¨å¯¼èˆªæ æä¾›ä¸åŒåŠŸèƒ½æ¨¡å—çš„å¿«é€Ÿåˆ‡æ¢ï¼ŒåŒ…æ‹¬ä½œç‰©åˆ†å¸ƒã€ç¾å®³ç›‘æµ‹ç­‰ã€‚

- **ä¸»åŠŸèƒ½æŒ‰é’®**: 5ä¸ªå•é€‰æŒ‰é’®ï¼Œåˆ‡æ¢ä¸åŒé¡µé¢åŠŸèƒ½
  - ğŸŒ¾ ä½œç‰©åˆ†å¸ƒ (å½“å‰é¡µé¢)
  - ğŸ“Š é•¿åŠ¿åˆ†æ (growth-analysis.html)
  - ğŸ“ˆ äº§é‡é¢„ä¼° (yield-estimation.html)
  - ğŸŒ¤ï¸ æ°”è±¡ç›‘æµ‹ (weather-monitoring.html)
  - âš ï¸ ç¾å®³å®šæŸ (disaster-monitoring.html)`
                    }
                ]
            },
            'growth-analysis': {
                title: 'é•¿åŠ¿åˆ†æåŠŸèƒ½',
                mdFile: 'é•¿åŠ¿åˆ†æåŠŸèƒ½.md',
                annotations: [
                    {
                        title: 'ğŸ“Š é•¿åŠ¿ç­‰çº§å›¾è¡¨',
                        content: 'ä»¥é¥¼å›¾æˆ–æŸ±çŠ¶å›¾å½¢å¼å±•ç¤ºä¸åŒé•¿åŠ¿ç­‰çº§çš„é¢ç§¯åˆ†å¸ƒã€‚'
                    },
                    {
                        title: 'ğŸ—ºï¸ é•¿åŠ¿ç©ºé—´åˆ†å¸ƒ',
                        content: 'åœ¨åœ°å›¾ä¸Šç”¨ä¸åŒé¢œè‰²è¡¨ç¤ºå„åŒºåŸŸçš„ä½œç‰©é•¿åŠ¿ç­‰çº§ã€‚'
                    },
                    {
                        title: 'ğŸ“ˆ æ¤è¢«æŒ‡æ•°æ›²çº¿',
                        content: 'æ˜¾ç¤ºNDVIç­‰æ¤è¢«æŒ‡æ•°çš„æ—¶é—´åºåˆ—å˜åŒ–æ›²çº¿ã€‚'
                    },
                    {
                        title: 'ğŸ” å‘è‚²æœŸæ ‡æ³¨',
                        content: 'åœ¨æ—¶é—´è½´ä¸Šæ ‡æ³¨ä½œç‰©çš„å…³é”®å‘è‚²æœŸèŠ‚ç‚¹ã€‚'
                    }
                ]
            },
            'yield-estimation': {
                title: 'äº§é‡é¢„ä¼°åŠŸèƒ½',
                mdFile: 'äº§é‡é¢„ä¼°åŠŸèƒ½.md',
                annotations: [
                    {
                        title: 'ğŸ“Š äº§é‡é¢„ä¼°å›¾è¡¨',
                        content: 'ä»¥æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ç­‰å½¢å¼å±•ç¤ºå„ä½œç‰©çš„äº§é‡é¢„ä¼°ç»“æœå’Œå†å²å¯¹æ¯”ã€‚'
                    },
                    {
                        title: 'ğŸ—ºï¸ äº§é‡ç©ºé—´åˆ†å¸ƒ',
                        content: 'åœ¨åœ°å›¾ä¸Šä»¥è‰²å½©æ¸å˜æ–¹å¼æ˜¾ç¤ºä¸åŒåŒºåŸŸçš„äº§é‡é¢„ä¼°æ°´å¹³ã€‚'
                    },
                    {
                        title: 'ğŸ“ˆ ç”Ÿé•¿ç›‘æµ‹æ›²çº¿',
                        content: 'æ˜¾ç¤ºä½œç‰©ç”Ÿé•¿å­£å†…NDVIç­‰æ¤è¢«æŒ‡æ•°çš„å˜åŒ–æ›²çº¿ã€‚'
                    },
                    {
                        title: 'ğŸ¯ ç²¾åº¦éªŒè¯é¢æ¿',
                        content: 'å±•ç¤ºäº§é‡é¢„ä¼°æ¨¡å‹çš„ç²¾åº¦æŒ‡æ ‡å’ŒéªŒè¯ç»“æœã€‚'
                    }
                ]
            },
            'weather-monitoring': {
                title: 'æ°”è±¡ç›‘æµ‹åŠŸèƒ½',
                mdFile: 'æ°”è±¡ç›‘æµ‹åŠŸèƒ½.md',
                annotations: [
                    {
                        title: 'ğŸŒ¡ï¸ æ°”è±¡è¦ç´ æ˜¾ç¤º',
                        content: 'å®æ—¶æ˜¾ç¤ºæ¸©åº¦ã€æ¹¿åº¦ã€æ°”å‹ã€é£é€Ÿé£å‘ç­‰åŸºæœ¬æ°”è±¡è¦ç´ æ•°æ®ã€‚'
                    },
                    {
                        title: 'ğŸŒ§ï¸ é™æ°´åˆ†å¸ƒå›¾',
                        content: 'ä»¥ç­‰å€¼çº¿æˆ–è‰²å½©å¡«å……æ–¹å¼æ˜¾ç¤ºé™æ°´åˆ†å¸ƒï¼Œæ”¯æŒå†å²å›æ”¾åŠŸèƒ½ã€‚'
                    },
                    {
                        title: 'ğŸ“ˆ æ°”è±¡è¶‹åŠ¿å›¾',
                        content: 'å±•ç¤ºæ°”è±¡è¦ç´ çš„æ—¶é—´å˜åŒ–è¶‹åŠ¿ï¼Œæ”¯æŒå¤šè¦ç´ åŒæ—¶æ˜¾ç¤ºã€‚'
                    },
                    {
                        title: 'âš ï¸ é¢„è­¦ä¿¡æ¯é¢æ¿',
                        content: 'æ˜¾ç¤ºå½“å‰ç”Ÿæ•ˆçš„æ°”è±¡é¢„è­¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬é¢„è­¦ç­‰çº§å’Œå½±å“åŒºåŸŸã€‚'
                    }
                ]
            },
            'disaster-monitoring': {
                title: 'ç¾å®³å®šæŸåŠŸèƒ½',
                mdFile: 'ç¾å®³å®šæŸåŠŸèƒ½.md',
                annotations: [
                    {
                        title: 'ğŸŒªï¸ ç¾å®³ç±»å‹è¯†åˆ«',
                        content: 'ç³»ç»Ÿå¯è‡ªåŠ¨è¯†åˆ«æ´ªæ¶ã€å¹²æ—±ã€å†°é›¹ã€ç—…è™«å®³ç­‰å¤šç§å†œä¸šç¾å®³ç±»å‹ã€‚'
                    },
                    {
                        title: 'ğŸ“ å—ç¾åŒºåŸŸæ ‡æ³¨',
                        content: 'åœ¨åœ°å›¾ä¸Šç”¨ä¸åŒé¢œè‰²æ ‡æ³¨å—ç¾åŒºåŸŸï¼Œæ”¯æŒç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ç¾å®³ä¿¡æ¯ã€‚'
                    },
                    {
                        title: 'ğŸ“Š æŸå¤±ç»Ÿè®¡å›¾è¡¨',
                        content: 'æä¾›å—ç¾é¢ç§¯ç»Ÿè®¡ã€ç»æµæŸå¤±è¯„ä¼°ã€ç¾å®³ç­‰çº§åˆ†å¸ƒç­‰æ•°æ®å›¾è¡¨ã€‚'
                    },
                    {
                        title: 'ğŸ” å½±åƒå¯¹æ¯”å·¥å…·',
                        content: 'æ”¯æŒç¾å‰ç¾åé¥æ„Ÿå½±åƒå¯¹æ¯”ï¼Œç›´è§‚å±•ç¤ºç¾å®³å½±å“ç¨‹åº¦ã€‚'
                    }
                ]
            },
            'device-monitoring': {
                title: 'è®¾å¤‡ç›‘æ§åŠŸèƒ½',
                mdFile: 'è®¾å¤‡ç›‘æ§åŠŸèƒ½.md',
                annotations: [
                    {
                        title: 'ğŸ“± è®¾å¤‡çŠ¶æ€ç›‘æ§',
                        content: 'å®æ—¶ç›‘æ§å„ç±»å†œä¸šç‰©è”ç½‘è®¾å¤‡çš„è¿è¡ŒçŠ¶æ€å’Œæ•°æ®ä¼ è¾“æƒ…å†µã€‚'
                    },
                    {
                        title: 'ğŸ“Š è®¾å¤‡æ•°æ®ç»Ÿè®¡',
                        content: 'ç»Ÿè®¡è®¾å¤‡æ•°æ®é‡‡é›†é‡ã€åœ¨çº¿ç‡ã€æ•…éšœç‡ç­‰å…³é”®æŒ‡æ ‡ã€‚'
                    },
                    {
                        title: 'âš ï¸ è®¾å¤‡å¼‚å¸¸é¢„è­¦',
                        content: 'è®¾å¤‡ç¦»çº¿ã€æ•°æ®å¼‚å¸¸ã€è®¾å¤‡æ•…éšœç­‰æƒ…å†µçš„åŠæ—¶é¢„è­¦æé†’ã€‚'
                    },
                    {
                        title: 'ğŸ”§ è®¾å¤‡ç®¡ç†å·¥å…·',
                        content: 'æä¾›è®¾å¤‡é…ç½®ã€å‚æ•°è®¾ç½®ã€è¿œç¨‹æ§åˆ¶ç­‰ç®¡ç†åŠŸèƒ½ã€‚'
                    }
                ]
            },
            'crop-selection': {
                title: 'ä½œç‰©é€‰æ‹©åŠŸèƒ½',
                mdFile: 'ä½œç‰©é€‰æ‹©åŠŸèƒ½.md',
                annotations: [
                    {
                        title: 'ğŸŒ¾ ä½œç‰©ç±»å‹ç­›é€‰',
                        content: 'æ”¯æŒæŒ‰ä½œç‰©ç±»å‹ï¼ˆå°éº¦ã€ç‰ç±³ã€è¾£æ¤’ç­‰ï¼‰è¿›è¡Œåœ°å›¾æ˜¾ç¤ºç­›é€‰ã€‚'
                    },
                    {
                        title: 'ğŸ“… ç”Ÿé•¿æœŸç­›é€‰',
                        content: 'æŒ‰ä½œç‰©ä¸åŒç”Ÿé•¿å‘è‚²æœŸè¿›è¡Œæ•°æ®ç­›é€‰å’Œåˆ†æå±•ç¤ºã€‚'
                    },
                    {
                        title: 'ğŸ—ºï¸ ç©ºé—´èŒƒå›´é€‰æ‹©',
                        content: 'æ”¯æŒæ¡†é€‰ã€åœ†é€‰ã€å¤šè¾¹å½¢é€‰æ‹©ç­‰å¤šç§ç©ºé—´èŒƒå›´é€‰æ‹©æ–¹å¼ã€‚'
                    },
                    {
                        title: 'ğŸ“Š æ¡ä»¶ç»„åˆç­›é€‰',
                        content: 'æ”¯æŒå¤šæ¡ä»¶ç»„åˆç­›é€‰ï¼Œå®ç°ç²¾å‡†çš„æ•°æ®æŸ¥è¯¢å’Œåˆ†æã€‚'
                    }
                ]
            }
        };

        // é¡µé¢é…ç½®æ•°æ® - å…¼å®¹åŸæœ‰çš„é¡µé¢åˆ‡æ¢é€»è¾‘
        const pageConfigs = {
            'index.html': functionConfigs['crop-distribution'],
            'disaster-monitoring.html': functionConfigs['disaster-monitoring'],
            'weather-monitoring.html': functionConfigs['weather-monitoring'],
            'yield-estimation.html': functionConfigs['yield-estimation'],
            'growth-analysis.html': functionConfigs['growth-analysis']
        };

        // é¡µé¢åˆ—è¡¨ - ç®¡ç†ç«¯åŸå‹ä¸»è¦é¡µé¢
        const pages = ['index.html'];
        let currentPageIndex = 0;
        let currentFunction = 'crop-distribution'; // å½“å‰é€‰ä¸­çš„åŠŸèƒ½
        let isFullscreen = false; // å…¨å±çŠ¶æ€
        let isAnnotationMode = false; // æ‰¹æ³¨æ¨¡å¼çŠ¶æ€
        let currentAnnotations = {}; // å½“å‰é¡µé¢çš„æ‰¹æ³¨æ•°æ®
        let selectedElementId = null; // å½“å‰é€‰ä¸­çš„å…ƒç´ ID
        let pageElements = {}; // æŠ“å–åˆ°çš„é¡µé¢å…ƒç´ 
        
        // æ‰¹æ³¨å¯¼èˆªç›¸å…³å˜é‡
        let currentPageAnnotationList = []; // å½“å‰é¡µé¢çš„æ‰¹æ³¨åˆ—è¡¨
        let currentAnnotationIndex = 0; // å½“å‰é€‰ä¸­çš„æ‰¹æ³¨ç´¢å¼•

        // æ™ºèƒ½æ£€æµ‹å¹¶è®¾ç½®iframeè·¯å¾„
        function setupSmartIframePath() {
            const iframe = document.getElementById('embeddedFrame');
            const currentUrl = window.location.href;
            
            let targetPath;
            
            if (currentUrl.includes('localhost:3000') || currentUrl.includes('127.0.0.1:3000')) {
                // é€šè¿‡APIæœåŠ¡å™¨è®¿é—®
                targetPath = '/ç®¡ç†ç«¯åŸå‹/index.html';
                console.log('ğŸŒ æ£€æµ‹åˆ°APIæœåŠ¡å™¨ç¯å¢ƒï¼Œä½¿ç”¨æœåŠ¡å™¨è·¯å¾„');
            } else if (currentUrl.includes('127.0.0.1:5501') || currentUrl.includes('localhost:5501')) {
                // é€šè¿‡Live Serverè®¿é—®
                targetPath = '/ç®¡ç†ç«¯åŸå‹/index.html';
                console.log('ğŸŒ æ£€æµ‹åˆ°Live Serverç¯å¢ƒï¼Œä½¿ç”¨æœåŠ¡å™¨è·¯å¾„');
            } else {
                // ç›´æ¥æ‰“å¼€æ–‡ä»¶
                targetPath = '../../ç®¡ç†ç«¯åŸå‹/index.html';
                console.log('ğŸ“ æ£€æµ‹åˆ°æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„');
            }
            
            iframe.src = targetPath;
            console.log('ğŸ¯ iframeè·¯å¾„å·²è®¾ç½®ä¸º:', targetPath);
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initializePage() {
            console.log('=== é¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
            
            // æ­¥éª¤0: æ™ºèƒ½è®¾ç½®iframeè·¯å¾„
            console.log('æ­¥éª¤0: æ™ºèƒ½è®¾ç½®iframeè·¯å¾„');
            setupSmartIframePath();
            
            // æ­¥éª¤1: åˆ›å»ºæ¨¡å¼æŒ‡ç¤ºå™¨å’ŒUIé€‚é…
            console.log('æ­¥éª¤1: ç¯å¢ƒé…ç½®å’ŒUIé€‚é…');
            createModeIndicator();
            adaptUIForCurrentMode();
            
            // æ£€æŸ¥APIè¿æ¥ï¼ˆå¼€å‘æ¨¡å¼ä¸‹ï¼‰
            if (CURRENT_ENV.enableRealTimeSync) {
                console.log('æ­¥éª¤1.5: æ£€æŸ¥APIè¿æ¥');
                const apiConnected = await apiClient.checkConnection();
                updateConnectionStatus(apiConnected);
            }
            
            // é¦–å…ˆåŠ è½½æ‰¹æ³¨æ•°æ®
            console.log('æ­¥éª¤2: åŠ è½½æ‰¹æ³¨æ•°æ®');
            await loadAnnotations();
            
            // ç„¶åæ›´æ–°é¡µé¢å†…å®¹
            console.log('æ­¥éª¤3: æ›´æ–°é¡µé¢å†…å®¹');
            await updatePageContent();

            console.log('æ­¥éª¤4: æ›´æ–°æ—¶é—´æˆ³');
            updateLastUpdateTime();
            
            console.log('æ­¥éª¤5: åŠ è½½å…¨å±€è¯´æ˜');
            
            console.log('æ­¥éª¤6: å¯åŠ¨é¡µé¢çŠ¶æ€ç›‘å¬');
            startPageStateMonitoring();
            
            console.log('æ­¥éª¤7: è®¾ç½®é”®ç›˜å¿«æ·é”®');
            setupKeyboardShortcuts();
            await loadGlobalDescription();
            
            // è®¡ç®—å¹¶åº”ç”¨iframeç¼©æ”¾
            console.log('æ­¥éª¤8: è®¡ç®—iframeç¼©æ”¾');
            calculateIframeScale();
            
            // è®¾ç½®iframeåŠ è½½å®Œæˆåçš„ç›‘å¬
            console.log('æ­¥éª¤9: è®¾ç½®iframeç›‘å¬');
            setupIframeListener();
            
            // å»¶è¿Ÿæ›´æ–°å…ƒç´ æ¸…å•ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½å·²åŠ è½½
            setTimeout(() => {
                console.log('æ­¥éª¤10: å»¶è¿Ÿæ›´æ–°å…ƒç´ æ¸…å•');
                updateElementList();
            }, 2000);
            
            // æ¯åˆ†é’Ÿæ›´æ–°æ—¶é—´
            setInterval(updateLastUpdateTime, 60000);
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', calculateIframeScale);
        }
        
        // æ ¹æ®å½“å‰æ¨¡å¼é€‚é…UI
        function adaptUIForCurrentMode() {
            console.log('ğŸ¨ é€‚é…UIç•Œé¢ä¸º', CURRENT_ENV.name);
            
            // è·å–UIå…ƒç´ 
            const annotationBtn = document.getElementById('annotationBtn');
            const debugBtn = document.getElementById('debugBtn');
            
            // çº¿ä¸Šæ¨¡å¼éšè—/ç¦ç”¨æ‰¹æ³¨æŒ‰é’®
            if (!CURRENT_ENV.allowAnnotation && annotationBtn) {
                annotationBtn.style.display = 'none';
                console.log('ğŸš« å·²éšè—æ‰¹æ³¨æŒ‰é’®ï¼ˆçº¿ä¸Šæ¨¡å¼ï¼‰');
            }
            
            // çº¿ä¸Šæ¨¡å¼éšè—è°ƒè¯•æŒ‰é’®
            if (!CURRENT_ENV.showDebugTools && debugBtn) {
                debugBtn.style.display = 'none';
                console.log('ğŸš« å·²éšè—è°ƒè¯•æŒ‰é’®ï¼ˆçº¿ä¸Šæ¨¡å¼ï¼‰');
            }
            
            // ä¿®æ”¹é¡µé¢æ ‡é¢˜
            document.title = `æ™ºèƒ½åŒ–PRDç³»ç»Ÿ - ${CURRENT_ENV.name}`;
            
            // åœ¨ç³»ç»ŸçŠ¶æ€ä¸­æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯
            updateSystemStatus();
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('annotationStatus');
            if (statusElement && CURRENT_ENV.enableRealTimeSync) {
                if (connected) {
                    statusElement.textContent = 'å·²è¿æ¥APIæœåŠ¡å™¨';
                    statusElement.style.color = '#4CAF50';
                } else {
                    statusElement.textContent = 'APIè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼';
                    statusElement.style.color = '#ff9800';
                }
            }
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
        function updateSystemStatus() {
            // åœ¨ç³»ç»ŸçŠ¶æ€åŒºåŸŸæ·»åŠ æ¨¡å¼ä¿¡æ¯
            const systemStatus = document.querySelector('#elementList').parentElement;
            if (systemStatus) {
                const existingModeInfo = systemStatus.querySelector('#mode-status');
                if (existingModeInfo) {
                    existingModeInfo.remove();
                }
                
                const modeInfo = document.createElement('div');
                modeInfo.id = 'mode-status';
                modeInfo.style.cssText = `
                    margin-top: 12px; 
                    padding: 8px; 
                    background: ${APP_MODE === 'development' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(33, 150, 243, 0.1)'}; 
                    border-radius: 6px; 
                    font-size: 11px;
                    border-left: 3px solid ${APP_MODE === 'development' ? '#4CAF50' : '#2196F3'};
                `;
                
                // è·å–å½“å‰é¡µé¢ä¿¡æ¯
                const detectedFunction = detectCurrentFunction();
                const functionTitle = functionConfigs[detectedFunction]?.title || detectedFunction;
                const currentPageKey = getCurrentPageKey();
                const hasAnnotations = currentAnnotations[currentPageKey] && Object.keys(currentAnnotations[currentPageKey]).length > 0;
                
                modeInfo.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 4px;">
                        ${CURRENT_ENV.icon} å½“å‰æ¨¡å¼: ${CURRENT_ENV.name}
                    </div>
                    <div>â€¢ å½“å‰é¡µé¢: ğŸ¯ ${functionTitle}</div>
                    <div>â€¢ é¡µé¢æ‰¹æ³¨: ${hasAnnotations ? 'âœ… æœ‰æ•°æ®' : 'ğŸ“ å¾…æ·»åŠ '}</div>
                    <div>â€¢ æ‰¹æ³¨åŠŸèƒ½: ${CURRENT_ENV.allowAnnotation ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</div>
                    <div>â€¢ ç¼–è¾‘åŠŸèƒ½: ${CURRENT_ENV.allowEdit ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}</div>
                    <div>â€¢ æ•°æ®åŒæ­¥: ${CURRENT_ENV.enableRealTimeSync ? 'âœ… å®æ—¶' : 'ğŸ“ æœ¬åœ°'}</div>
                `;
                
                systemStatus.appendChild(modeInfo);
            }
        }
        
        // æ˜¾ç¤ºè°ƒè¯•èœå•
        function showDebugMenu() {
            if (!checkPermission('debug')) {
                showPermissionDenied('debug');
                return;
            }
            
            const debugMenu = `
ğŸ”§ è°ƒè¯•å·¥å…·èœå•

è¯·é€‰æ‹©æ“ä½œ:
1. ç³»ç»Ÿè¯Šæ–­
2. æµ‹è¯•æ‰€æœ‰æ‰¹æ³¨
3. æŸ¥çœ‹å…ƒç´ ç­¾å
4. æ‰¹æ³¨æ•°æ®ä¿®å¤
5. å¼ºåˆ¶åˆ·æ–°æ•°æ®
6. æµ‹è¯•APIè¿æ¥
7. å¯¼å‡ºè°ƒè¯•ä¿¡æ¯

è¾“å…¥é€‰é¡¹æ•°å­— (1-7):
            `.trim();
            
            const choice = prompt(debugMenu);
            
            switch (choice) {
                case '1':
                    comprehensiveDiagnosis();
                    break;
                case '2':
                    testAllAnnotations();
                    break;
                case '3':
                    showElementSignatures();
                    break;
                case '4':
                    validateAndFixAnnotations();
                    break;
                case '5':
                    forceRefreshAnnotations();
                    break;
                case '6':
                    testApiConnection();
                    break;
                case '7':
                    exportDebugInfo();
                    break;
                default:
                    if (choice !== null) {
                        alert('æ— æ•ˆé€‰é¡¹ï¼Œè¯·è¾“å…¥ 1-7 ä¹‹é—´çš„æ•°å­—');
                    }
            }
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            if (!CURRENT_ENV.enableRealTimeSync) {
                alert('å½“å‰æ¨¡å¼ä¸‹APIåŠŸèƒ½æœªå¯ç”¨');
                return;
            }
            
            console.log('ğŸ”— æµ‹è¯•APIè¿æ¥...');
            const connected = await apiClient.checkConnection();
            
            if (connected) {
                alert('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼\næœåŠ¡å™¨å“åº”æ­£å¸¸ã€‚');
            } else {
                alert('âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼\nè¯·æ£€æŸ¥:\n1. æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨\n2. ç½‘ç»œè¿æ¥\n3. APIåœ°å€é…ç½®');
            }
        }
        
        // å¯¼å‡ºè°ƒè¯•ä¿¡æ¯
        function exportDebugInfo() {
            const debugInfo = {
                timestamp: new Date().toISOString(),
                mode: APP_MODE,
                environment: CURRENT_ENV,
                annotations: currentAnnotations,
                pageElements: pageElements,
                system: {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    }
                }
            };
            
            const dataStr = JSON.stringify(debugInfo, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            link.download = `prd-debug-${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('ğŸ”§ è°ƒè¯•ä¿¡æ¯å·²å¯¼å‡ºåˆ°æ–‡ä»¶');
        }

        // è®¾ç½®iframeå†…å®¹ç›‘å¬ - æ”¹è¿›ç‰ˆ
        function setupIframeListener() {
            const iframe = document.getElementById('embeddedFrame');
            
            iframe.onload = function() {
                console.log('=== iframeåŠ è½½å®Œæˆ ===');
                
                // é‡æ–°è®¡ç®—ç¼©æ”¾
                setTimeout(calculateIframeScale, 300);
                
                // å°è¯•å¤šç§æ–¹å¼è®¿é—®iframeå†…å®¹
                let iframeAccessible = false;
                
                try {
                    // æ–¹æ³•1: ç›´æ¥è®¿é—®contentDocument
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body) {
                        console.log('âœ… iframeç›´æ¥è®¿é—®æˆåŠŸ');
                        iframeAccessible = true;
                        setupIframeContent(iframeDoc);
                        
                        // æ£€æµ‹å½“å‰åŠŸèƒ½çŠ¶æ€å¹¶æ›´æ–°
                        setTimeout(() => {
                            detectCurrentFunction();
                        }, 1000);
                    }
                } catch (error) {
                    console.log('âŒ iframeç›´æ¥è®¿é—®å¤±è´¥:', error.message);
                }
                
                // æ–¹æ³•2: postMessageé€šä¿¡
                if (!iframeAccessible) {
                    console.log('å°è¯•postMessageé€šä¿¡...');
                    setupPostMessageCommunication(iframe);
                }
                
                // æ–¹æ³•3: åæ ‡æ˜ å°„é«˜äº®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                if (!iframeAccessible) {
                    console.log('ä½¿ç”¨åæ ‡æ˜ å°„å¤‡ç”¨æ–¹æ¡ˆ');
                    setupCoordinateMapping();
                }
                
                // å»¶è¿Ÿé‡è¯•è®¿é—®
                    setTimeout(() => {
                    if (!iframeAccessible) {
                        console.log('å»¶è¿Ÿé‡è¯•iframeè®¿é—®...');
                        try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc && iframeDoc.body) {
                                console.log('âœ… å»¶è¿Ÿè®¿é—®æˆåŠŸ');
                                setupIframeContent(iframeDoc);
                            }
                        } catch (e) {
                            console.log('âŒ å»¶è¿Ÿè®¿é—®ä»ç„¶å¤±è´¥');
                        }
                    }
                }, 2000);
            };
        }
        
        // è®¾ç½®iframeå†…å®¹ï¼ˆå½“å¯ä»¥è®¿é—®æ—¶ï¼‰
        function setupIframeContent(iframeDoc) {
            try {
                console.log('è®¾ç½®iframeå†…å®¹äº¤äº’...');
                
                            // ç›‘å¬åŠŸèƒ½åˆ‡æ¢æŒ‰é’®ç‚¹å‡»
                            const functionButtons = iframeDoc.querySelectorAll('.main-switch-btn, .overlay-switch-btn');
                console.log('æ‰¾åˆ°åŠŸèƒ½æŒ‰é’®æ•°é‡:', functionButtons.length);
                            
                            functionButtons.forEach(button => {
                                button.addEventListener('click', async function() {
                                    const functionName = this.getAttribute('data-function');
                        console.log('åŠŸèƒ½åˆ‡æ¢:', functionName);
                                    if (functionName && functionConfigs[functionName]) {
                                        currentFunction = functionName;
                                        await updatePageContentByFunction(functionName);
                                    }
                                });
                            });

                            // æ£€æµ‹å½“å‰æ¿€æ´»çš„åŠŸèƒ½æŒ‰é’®
                            const activeButton = iframeDoc.querySelector('.main-switch-btn.active, .overlay-switch-btn.active');
                            if (activeButton) {
                                const functionName = activeButton.getAttribute('data-function');
                                if (functionName && functionConfigs[functionName]) {
                                    currentFunction = functionName;
                                    updatePageContentByFunction(functionName);
                                }
                            }

                            // æŠ“å–é¡µé¢å…ƒç´ 
                            extractPageElements(iframeDoc);
                            
                            // å¦‚æœå·²ç»æ˜¯æ‰¹æ³¨æ¨¡å¼ï¼Œé‡æ–°è®¾ç½®è¦†ç›–å±‚
                            if (isAnnotationMode) {
                                setTimeout(() => {
                                    setupAnnotationOverlay();
                                }, 500);
                            }
                
                console.log('âœ… iframeå†…å®¹è®¾ç½®å®Œæˆ');
                
            } catch (error) {
                console.log('âŒ iframeå†…å®¹è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        // è®¾ç½®postMessageé€šä¿¡
        function setupPostMessageCommunication(iframe) {
            console.log('è®¾ç½®postMessageé€šä¿¡...');
            
            // ç›‘å¬æ¥è‡ªiframeçš„æ¶ˆæ¯
            window.addEventListener('message', function(event) {
                // å®‰å…¨æ£€æŸ¥
                if (event.source !== iframe.contentWindow) return;
                
                const data = event.data;
                console.log('æ”¶åˆ°iframeæ¶ˆæ¯:', data);
                
                if (data.type === 'elementInfo') {
                    // æ¥æ”¶å…ƒç´ ä¿¡æ¯
                    handleElementInfo(data.elements);
                } else if (data.type === 'functionChange') {
                    // åŠŸèƒ½åˆ‡æ¢
                    currentFunction = data.function;
                    updatePageContentByFunction(data.function);
                }
            });
            
            // å‘iframeå‘é€åˆå§‹åŒ–æ¶ˆæ¯
            setTimeout(() => {
                try {
                    iframe.contentWindow.postMessage({
                        type: 'init',
                        message: 'æ‰¹æ³¨ç³»ç»Ÿåˆå§‹åŒ–'
                    }, '*');
                } catch (e) {
                    console.log('postMessageå‘é€å¤±è´¥:', e);
                        }
                    }, 1000);
        }
        
        // è®¾ç½®åæ ‡æ˜ å°„ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function setupCoordinateMapping() {
            console.log('ä½¿ç”¨åæ ‡æ˜ å°„å¤‡ç”¨æ–¹æ¡ˆ...');
            
            // åˆ›å»ºè™šæ‹Ÿå…ƒç´ æ˜ å°„
            const pageKey = getCurrentPageKey();
            if (!pageElements[pageKey]) {
                pageElements[pageKey] = {};
            }
            
            // æ ¹æ®å·²çŸ¥çš„é¡µé¢å¸ƒå±€åˆ›å»ºè™šæ‹Ÿå…ƒç´ 
            const commonElements = [
                { id: 'virtual-chart-area', name: 'å›¾è¡¨åŒºåŸŸ', rect: { left: 100, top: 100, width: 400, height: 300 } },
                { id: 'virtual-map-area', name: 'åœ°å›¾åŒºåŸŸ', rect: { left: 500, top: 100, width: 600, height: 400 } },
                { id: 'virtual-panel-area', name: 'é¢æ¿åŒºåŸŸ', rect: { left: 1100, top: 100, width: 300, height: 500 } }
            ];
            
            commonElements.forEach(element => {
                pageElements[pageKey][element.id] = {
                    id: element.id,
                    name: element.name,
                    rect: element.rect,
                    virtual: true, // æ ‡è®°ä¸ºè™šæ‹Ÿå…ƒç´ 
                    selector: `virtual-${element.id}`
                };
            });
            
            console.log('âœ… è™šæ‹Ÿå…ƒç´ æ˜ å°„å·²åˆ›å»º');
        }

        // åŠ è½½å…¨å±€è¯´æ˜æ–‡æ¡£
        async function loadGlobalDescription() {
            const globalDescElement = document.getElementById('globalDescription');
            
            try {
                // å°è¯•åŠ è½½æœ¬åœ°MDæ–‡ä»¶
                const response = await fetch('prd-docs/å…¨å±€è¯´æ˜.md');
                if (response.ok) {
                    const mdContent = await response.text();
                    // ç®€å•çš„Markdownè½¬HTMLå¤„ç†
                    const htmlContent = convertMarkdownToHTML(mdContent);
                    globalDescElement.innerHTML = htmlContent;
                } else {
                    throw new Error('æ–‡ä»¶æœªæ‰¾åˆ°');
                }
            } catch (error) {
                console.log('æœªæ‰¾åˆ°å…¨å±€è¯´æ˜.mdæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹');
                // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé»˜è®¤å†…å®¹å’Œæç¤º
                globalDescElement.innerHTML = `
                    <div style="background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 0 4px 4px 0;">
                        <h4 style="color: #ffc107; margin-bottom: 8px;">ğŸ“ é…ç½®æç¤º</h4>
                        <p style="color: #ffc107; font-size: 12px; margin: 0;">
                            è¯·åœ¨ <code>prd-docs/</code> ç›®å½•ä¸‹åˆ›å»º <code>å…¨å±€è¯´æ˜.md</code> æ–‡ä»¶æ¥è‡ªå®šä¹‰å…¨å±€è¯´æ˜å†…å®¹ã€‚
                        </p>
                    </div>
                    
                    <h4>ç³»ç»Ÿæ¦‚è¿°</h4>
                    <p>ä¸´å¤å¿å†œæƒ…é¥æ„Ÿç³»ç»Ÿæ˜¯åŸºäºå«æ˜Ÿé¥æ„ŸæŠ€æœ¯çš„æ™ºèƒ½åŒ–å†œä¸šç›‘æµ‹å¹³å°ï¼Œæä¾›ä½œç‰©åˆ†å¸ƒã€ç¾å®³ç›‘æµ‹ã€æ°”è±¡åˆ†æã€äº§é‡é¢„ä¼°å’Œé•¿åŠ¿åˆ†æç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
                    
                    <h4>æŠ€æœ¯æ¶æ„</h4>
                    <ul>
                        <li><strong>å‰ç«¯æŠ€æœ¯</strong>: HTML5, CSS3, JavaScript ES6</li>
                        <li><strong>åœ°å›¾å¼•æ“</strong>: Cesium.js 1.110</li>
                        <li><strong>å›¾è¡¨åº“</strong>: ECharts 5.4.3</li>
                        <li><strong>è®¾è®¡é£æ ¼</strong>: ç§‘æŠ€æ„Ÿæ¯›ç»ç’ƒæ•ˆæœ</li>
                    </ul>

                    <h4>æ ¸å¿ƒç‰¹æ€§</h4>
                    <ul>
                        <li>ğŸ—ºï¸ ä¸‰ç»´åœ°å›¾å¯è§†åŒ–</li>
                        <li>ğŸ“Š å®æ—¶æ•°æ®å›¾è¡¨å±•ç¤º</li>
                        <li>ğŸ¯ äº¤äº’å¼æ“ä½œä½“éªŒ</li>
                        <li>ğŸ“± å“åº”å¼è‡ªé€‚åº”å¸ƒå±€</li>
                        <li>ğŸ”„ æ•°æ®å®æ—¶æ›´æ–°æœºåˆ¶</li>
                    </ul>

                    <h4>ç›®æ ‡ç”¨æˆ·</h4>
                    <p>å†œä¸šç®¡ç†éƒ¨é—¨ã€å†œæŠ€ä¸“å®¶ã€å†œä¸šåˆä½œç¤¾ã€ç§æ¤å¤§æˆ·ç­‰å†œä¸šä»ä¸šäººå‘˜ã€‚</p>
                `;
            }
        }

        // å¢å¼ºçš„Markdownè½¬HTMLè½¬æ¢å™¨
        function convertMarkdownToHTML(markdown) {
            if (!markdown || typeof markdown !== 'string') {
                return '';
            }
            
            return markdown
                // æ ‡é¢˜è½¬æ¢
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                // ç²—ä½“è½¬æ¢
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // ä»£ç è½¬æ¢
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // å¸¦ç¼–å·çš„åˆ—è¡¨è½¬æ¢
                .replace(/^\d+\.\s+(.*$)/gim, '<li>$1</li>')
                // æ™®é€šåˆ—è¡¨è½¬æ¢ (æ”¯æŒ - å’Œ * ä¸¤ç§æ ¼å¼)
                .replace(/^[\-\*]\s+(.*$)/gim, '<li>$1</li>')
                // åµŒå¥—åˆ—è¡¨è½¬æ¢ (æ”¯æŒ2çº§ç¼©è¿›)
                .replace(/^  [\-\*]\s+(.*$)/gim, '<li class="nested">$1</li>')
                // åŒ…è£…è¿ç»­çš„liä¸ºul
                .replace(/((?:<li(?:\s+class="[^"]*")?>[^<]*<\/li>\s*)+)/g, '<ul>$1</ul>')
                // æ®µè½è½¬æ¢ (å…ˆå¤„ç†æ¢è¡Œ)
                .replace(/\n\n+/g, '</p><p>')
                .replace(/^(?!<[uh]|<li)(.+)$/gim, '<p>$1</p>')
                // æ¸…ç†å¤šä½™çš„pæ ‡ç­¾
                .replace(/<p>(<h[1-6]>.*?<\/h[1-6]>)<\/p>/g, '$1')
                .replace(/<p>(<ul>.*?<\/ul>)<\/p>/gs, '$1')
                .replace(/<p>(<ol>.*?<\/ol>)<\/p>/gs, '$1')
                // æ¸…ç†ç©ºæ®µè½
                .replace(/<p><\/p>/g, '')
                // æ¸…ç†å¼€å¤´å’Œç»“å°¾çš„ç©ºpæ ‡ç­¾
                .replace(/^<p><\/p>|<p><\/p>$/g, '');
        }

        // è®¡ç®—iframeç¼©æ”¾æ¯”ä¾‹
        function calculateIframeScale() {
            const embeddedPage = document.querySelector('.embedded-page');
            const iframe = document.getElementById('embeddedFrame');
            
            if (embeddedPage && iframe) {
                const containerWidth = embeddedPage.clientWidth;
                const containerHeight = embeddedPage.clientHeight;
                
                // æœ€å°åŒ–è¾¹è·ï¼Œæœ€å¤§åŒ–æ˜¾ç¤ºåŒºåŸŸ
                const availableWidth = containerWidth - 5; // æœ€å°è¾¹è·
                const availableHeight = containerHeight - 5; // ç§»é™¤é¡¶éƒ¨é€‰æ‹©å™¨åï¼Œæœ€å°ç©ºé—´
                
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒ1920x1080çš„å®½é«˜æ¯”
                const scaleX = availableWidth / 1920;
                const scaleY = availableHeight / 1080;
                const scale = Math.min(scaleX, scaleY, 1.5); // å…è®¸æ”¾å¤§åˆ°150%
                
                // åº”ç”¨ç¼©æ”¾
                iframe.style.transform = `scale(${scale})`;
                
                // è®¡ç®—å±…ä¸­ä½ç½®
                const scaledWidth = 1920 * scale;
                const scaledHeight = 1080 * scale;
                
                const offsetX = (containerWidth - scaledWidth) / 2;
                const offsetY = Math.max(5, (containerHeight - scaledHeight) / 2);
                
                iframe.style.left = `${Math.max(0, offsetX)}px`;
                iframe.style.top = `${offsetY}px`;
            }
        }

        // åˆ‡æ¢é¡µé¢
        async function switchPage() {
            const selectedPage = pages[currentPageIndex];
            
            const iframe = document.getElementById('embeddedFrame');
            iframe.src = '/prototype/' + selectedPage;
            
            // é‡ç½®å½“å‰åŠŸèƒ½ä¸ºé»˜è®¤å€¼
            currentFunction = 'crop-distribution';
            
            // é‡æ–°åŠ è½½æ‰¹æ³¨æ•°æ®ç¡®ä¿æ•°æ®æœ€æ–°
            await loadAnnotations();
            
            updatePageContent();

        }



        // æ›´æ–°é¡µé¢å†…å®¹
        async function updatePageContent() {
            const currentPage = pages[currentPageIndex];
            const config = pageConfigs[currentPage];
            
            // æ›´æ–°é¡µé¢è¯´æ˜ - ä»MDæ–‡ä»¶åŠ è½½
            await loadPageDescription(config.mdFile);
            
            // æ›´æ–°æ‰¹æ³¨å†…å®¹
            const annotationContent = document.getElementById('annotationContent');
            annotationContent.innerHTML = config.annotations.map(annotation => `
                <div class="annotation-item">
                    <div class="annotation-title">${annotation.title}</div>
                    <div class="annotation-content">${convertMarkdownToHTML(annotation.content)}</div>
                </div>
            `).join('');
            
            // æ›´æ–°é¡µé¢å…ƒç´ æ¸…å•
            updateElementList();
        }

        // æ ¹æ®åŠŸèƒ½æ›´æ–°é¡µé¢å†…å®¹
        async function updatePageContentByFunction(functionName) {
            const config = functionConfigs[functionName];
            if (!config) return;
            
            // é‡æ–°åŠ è½½æ‰¹æ³¨æ•°æ®ç¡®ä¿æ•°æ®æœ€æ–°
            await loadAnnotations();
            
            // æ›´æ–°é¡µé¢è¯´æ˜ - ä»MDæ–‡ä»¶åŠ è½½
            await loadPageDescription(config.mdFile);
            
            // æ›´æ–°æ‰¹æ³¨å†…å®¹
            const annotationContent = document.getElementById('annotationContent');
            annotationContent.innerHTML = config.annotations.map(annotation => `
                <div class="annotation-item">
                    <div class="annotation-title">${annotation.title}</div>
                    <div class="annotation-content">${convertMarkdownToHTML(annotation.content)}</div>
                </div>
            `).join('');
            
            // æ›´æ–°é¡µé¢å…ƒç´ æ¸…å•
            updateElementList();
        }



        // åŠ è½½é¡µé¢è¯´æ˜æ–‡æ¡£
        async function loadPageDescription(mdFile) {
            const pageDescElement = document.getElementById('pageDescription');
            
            try {
                // å°è¯•åŠ è½½é¡µé¢å¯¹åº”çš„MDæ–‡ä»¶
                const response = await fetch(`prd-docs/${mdFile}`);
                if (response.ok) {
                    const mdContent = await response.text();
                    // ç®€å•çš„Markdownè½¬HTMLå¤„ç†
                    const htmlContent = convertMarkdownToHTML(mdContent);
                    pageDescElement.innerHTML = htmlContent;
                } else {
                    throw new Error('æ–‡ä»¶æœªæ‰¾åˆ°');
                }
            } catch (error) {
                console.log(`æœªæ‰¾åˆ°é¡µé¢è¯´æ˜æ–‡ä»¶: ${mdFile}ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹`);
                // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé»˜è®¤å†…å®¹å’Œæç¤º
                pageDescElement.innerHTML = `
                    <div style="background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 0 4px 4px 0;">
                        <h4 style="color: #ffc107; margin-bottom: 8px;">ğŸ“ é…ç½®æç¤º</h4>
                        <p style="color: #ffc107; font-size: 12px; margin: 0;">
                            è¯·åœ¨ <code>prd-docs/</code> ç›®å½•ä¸‹åˆ›å»º <code>${mdFile}</code> æ–‡ä»¶æ¥è‡ªå®šä¹‰é¡µé¢è¯´æ˜å†…å®¹ã€‚
                        </p>
                    </div>
                    
                    <h4>é¡µé¢åŠŸèƒ½</h4>
                    <p>è¯¥é¡µé¢çš„è¯¦ç»†åŠŸèƒ½è¯´æ˜è¯·å‚è€ƒå¤–éƒ¨æ–‡æ¡£ã€‚</p>
                    
                    <h4>ä½¿ç”¨è¯´æ˜</h4>
                    <p>è¯·åˆ›å»ºå¯¹åº”çš„Markdownæ–‡æ¡£æ¥è¯¦ç»†æè¿°è¯¥é¡µé¢çš„åŠŸèƒ½ç‰¹æ€§å’Œä½¿ç”¨æ–¹æ³•ã€‚</p>
                `;
            }
        }



        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdate) {
                const now = new Date();
                const timeString = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                lastUpdate.textContent = timeString;
            }
        }

        // å…¨å±åˆ‡æ¢åŠŸèƒ½
        function toggleFullscreen() {
            const body = document.body;
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            
            isFullscreen = !isFullscreen;
            
            if (isFullscreen) {
                // è¿›å…¥å…¨å±æ¨¡å¼
                body.classList.add('fullscreen-mode');
                fullscreenIcon.textContent = 'â›¶';
                fullscreenBtn.title = 'é€€å‡ºå…¨å±';
                
                // è¯·æ±‚æµè§ˆå™¨å…¨å±
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                // é€€å‡ºå…¨å±æ¨¡å¼
                body.classList.remove('fullscreen-mode');
                fullscreenIcon.textContent = 'â›¶';
                fullscreenBtn.title = 'å…¨å±æ˜¾ç¤º';
                
                // é€€å‡ºæµè§ˆå™¨å…¨å±
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
            
            // é‡æ–°è®¡ç®—iframeç¼©æ”¾
            setTimeout(calculateIframeScale, 300);
        }

        // ç›‘å¬æµè§ˆå™¨å…¨å±çŠ¶æ€å˜åŒ–
        function handleFullscreenChange() {
            const isInFullscreen = !!(document.fullscreenElement || 
                                    document.webkitFullscreenElement || 
                                    document.msFullscreenElement);
            
            if (!isInFullscreen && isFullscreen) {
                // æµè§ˆå™¨é€€å‡ºå…¨å±ï¼ŒåŒæ­¥æ›´æ–°çŠ¶æ€
                isFullscreen = false;
                document.body.classList.remove('fullscreen-mode');
                document.getElementById('fullscreenIcon').textContent = 'â›¶';
                document.getElementById('fullscreenBtn').title = 'å…¨å±æ˜¾ç¤º';
                setTimeout(calculateIframeScale, 300);
            }
        }

        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–äº‹ä»¶
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(event) {
            // F11 æˆ– Ctrl+Shift+F åˆ‡æ¢å…¨å±
            if (event.key === 'F11' || (event.ctrlKey && event.shiftKey && event.key === 'F')) {
                event.preventDefault();
                toggleFullscreen();
            }
            // ESC é€€å‡ºå…¨å±
            if (event.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
        });

        // æ‰¹æ³¨æ¨¡å¼åˆ‡æ¢
        function toggleAnnotationMode() {
            // æƒé™æ£€æŸ¥
            if (!checkPermission('annotation')) {
                showPermissionDenied('annotation');
                return;
            }
            
            const body = document.body;
            const annotationBtn = document.getElementById('annotationBtn');
            const annotationIcon = document.getElementById('annotationIcon');
            
            isAnnotationMode = !isAnnotationMode;
            
            if (isAnnotationMode) {
                body.classList.add('annotation-mode');
                annotationBtn.classList.add('active');
                annotationIcon.textContent = 'ğŸ“';
                annotationBtn.title = 'é€€å‡ºæ‰¹æ³¨æ¨¡å¼';
                setupAnnotationOverlay();
            } else {
                body.classList.remove('annotation-mode');
                annotationBtn.classList.remove('active');
                annotationIcon.textContent = 'ğŸ“';
                annotationBtn.title = 'æ‰¹æ³¨æ¨¡å¼';
                clearHighlights();
                removeAnnotationOverlay();
            }
        }

        // è®¾ç½®æ‰¹æ³¨è¦†ç›–å±‚
        function setupAnnotationOverlay() {
            const embeddedPage = document.querySelector('.embedded-page');
            
            // ç§»é™¤å·²æœ‰çš„è¦†ç›–å±‚
            removeAnnotationOverlay();
            
            // åˆ›å»ºæ–°çš„è¦†ç›–å±‚
            const overlay = document.createElement('div');
            overlay.className = 'annotation-overlay';
            overlay.id = 'annotation-overlay';
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
            overlay.addEventListener('click', handleAnnotationClick);
            
            embeddedPage.appendChild(overlay);
        }

        // ç§»é™¤æ‰¹æ³¨è¦†ç›–å±‚
        function removeAnnotationOverlay() {
            const overlay = document.getElementById('annotation-overlay');
            if (overlay) {
                overlay.removeEventListener('click', handleAnnotationClick);
                overlay.remove();
            }
        }

        // å¤„ç†æ‰¹æ³¨ç‚¹å‡»äº‹ä»¶
        function handleAnnotationClick(event) {
            if (!isAnnotationMode) return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const iframe = document.getElementById('embeddedFrame');
            const iframeRect = iframe.getBoundingClientRect();
            
            // è€ƒè™‘iframeçš„ç¼©æ”¾æ¯”ä¾‹
            const scale = parseFloat(iframe.style.transform?.match(/scale\(([\d.]+)\)/)?.[1] || 1);
            
            // è®¡ç®—åœ¨iframeå†…çš„å®é™…ä½ç½®ï¼ˆè€ƒè™‘ç¼©æ”¾ï¼‰
            const x = (event.clientX - iframeRect.left) / scale;
            const y = (event.clientY - iframeRect.top) / scale;
            
            console.log('ç‚¹å‡»ä½ç½®:', { x, y, scale, clientX: event.clientX, clientY: event.clientY });
            
            // è·å–iframeæ–‡æ¡£ä¸­çš„å…ƒç´ 
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const targetElement = iframeDoc.elementFromPoint(x, y);
                
                console.log('åŸå§‹ç›®æ ‡å…ƒç´ :', targetElement);
                
                if (targetElement) {
                    // æ‰¾åˆ°æœ€åˆé€‚çš„çˆ¶å…ƒç´ 
                    const suitableElement = findSuitableElement(targetElement);
                    console.log('é€‰ä¸­çš„åˆé€‚å…ƒç´ :', suitableElement);
                    createAnnotationForElement(suitableElement, x, y, iframeDoc);
                }
            } catch (error) {
                console.log('æ— æ³•è®¿é—®iframeå†…å®¹ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶:', error);
                alert('æ— æ³•è®¿é—®iframeå†…å®¹ï¼Œè¯·ç¡®ä¿é¡µé¢å…è®¸è·¨åŸŸè®¿é—®');
            }
        }

        // æ‰¾åˆ°åˆé€‚çš„å…ƒç´ è¿›è¡Œæ‰¹æ³¨ï¼ˆä¼˜åŒ–ä¸ºé€‰æ‹©æ›´ç²¾ç¡®çš„å…ƒç´ ï¼‰
        function findSuitableElement(element) {
            let candidates = [];
            
            // ç­–ç•¥1: æ£€æŸ¥ç‚¹å‡»çš„å…ƒç´ æœ¬èº«åŠå…¶ç›´æ¥å­å…ƒç´ 
            const directCandidates = [element];
            
            // æ·»åŠ ç›´æ¥å­å…ƒç´ ï¼ˆå¦‚æœç‚¹å‡»çš„æ˜¯å®¹å™¨ï¼Œå¯èƒ½æƒ³é€‰æ‹©å…¶ä¸­çš„å…·ä½“å…ƒç´ ï¼‰
            if (element.children.length > 0 && element.children.length <= 5) {
                Array.from(element.children).forEach(child => {
                    directCandidates.push(child);
                });
            }
            
            // ç­–ç•¥2: å‘ä¸ŠæŸ¥æ‰¾çˆ¶å…ƒç´ ï¼ˆä½†é™åˆ¶æ·±åº¦ï¼Œé¿å…é€‰æ‹©è¿‡å¤§çš„å®¹å™¨ï¼‰
            let current = element;
            let maxDepth = 4; // å‡å°‘æŸ¥æ‰¾æ·±åº¦ï¼Œé¿å…é€‰æ‹©è¿‡å¤§å…ƒç´ 
            
            while (current && current !== document.body && maxDepth > 0) {
                directCandidates.push(current);
                current = current.parentElement;
                maxDepth--;
            }
            
            // ä¸ºæ‰€æœ‰å€™é€‰å…ƒç´ è¯„åˆ†
            directCandidates.forEach(candidate => {
                const score = calculateElementScore(candidate);
                if (score > 0) {
                    candidates.push({ 
                        element: candidate, 
                        score: score,
                        isOriginal: candidate === element,
                        isChild: element.contains(candidate) && candidate !== element,
                        isParent: candidate.contains(element) && candidate !== element
                    });
                }
            });
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœåŸå§‹ç‚¹å‡»å…ƒç´ å¾—åˆ†å¾ˆé«˜ï¼Œä¼˜å…ˆé€‰æ‹©å®ƒ
            const originalScore = candidates.find(c => c.isOriginal)?.score || 0;
            if (originalScore >= 15) {
                console.log('åŸå§‹å…ƒç´ å¾—åˆ†å¾ˆé«˜ï¼Œç›´æ¥é€‰æ‹©:', element);
                return element;
            }
            
            console.log('å€™é€‰å…ƒç´ :', candidates.map(c => ({
                tag: c.element.tagName,
                class: c.element.className,
                id: c.element.id,
                score: c.score,
                text: c.element.textContent?.trim().substring(0, 20),
                relation: c.isOriginal ? 'original' : c.isChild ? 'child' : c.isParent ? 'parent' : 'other'
            })));
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å€™é€‰å…ƒç´ ï¼Œè¿”å›åŸå§‹å…ƒç´ 
            if (candidates.length === 0) {
                return element;
            }
            
            // æŒ‰åˆ†æ•°æ’åº
            candidates.sort((a, b) => {
                // åœ¨åˆ†æ•°ç›¸è¿‘çš„æƒ…å†µä¸‹ï¼Œä¼˜å…ˆé€‰æ‹©å­å…ƒç´ æˆ–åŸå§‹å…ƒç´ 
                if (Math.abs(a.score - b.score) <= 3) {
                    if (a.isOriginal) return -1;
                    if (b.isOriginal) return 1;
                    if (a.isChild) return -1;
                    if (b.isChild) return 1;
                }
                return b.score - a.score;
            });
            
            const selected = candidates[0].element;
            console.log('é€‰ä¸­å…ƒç´ :', {
                tag: selected.tagName,
                class: selected.className,
                id: selected.id,
                score: candidates[0].score,
                text: selected.textContent?.trim().substring(0, 30)
            });
            
            return selected;
        }

        // è®¡ç®—å…ƒç´ çš„é‡è¦æ€§åˆ†æ•°ï¼ˆä¼˜åŒ–ä¸ºé€‰æ‹©æ›´ç²¾ç¡®çš„å°å…ƒç´ ï¼‰
        function calculateElementScore(element) {
            let score = 0;
            
            // é«˜ä¼˜å…ˆçº§ç²¾ç¡®å…ƒç´ ï¼ˆä¼˜å…ˆé€‰æ‹©å…·ä½“çš„å°ç»„ä»¶ï¼‰
            const highPriorityClasses = [
                'panel-title', 'panel-header', 'chart-title', 'widget-title',
                'button', 'btn', 'icon', 'label', 'badge', 'tag',
                'input', 'select', 'textarea', 'checkbox', 'radio',
                'link', 'nav-item', 'menu-item', 'dropdown-item',
                'card-title', 'card-header', 'stat-item', 'metric'
            ];
            
            // ä¸­ä¼˜å…ˆçº§å…·ä½“å…ƒç´ 
            const mediumPriorityClasses = [
                'chart', 'graph', 'table', 'list-item', 'item',
                'block', 'box', 'tile', 'thumbnail', 'avatar',
                'switch-btn', 'main-switch-btn', 'overlay-switch-btn'
            ];
            
            // ä½ä¼˜å…ˆçº§å¤§å®¹å™¨ï¼ˆå°½é‡é¿å…é€‰æ‹©ï¼‰
            const lowPriorityClasses = [
                'panel', 'container', 'wrapper', 'content', 'body',
                'main', 'section', 'row', 'col', 'grid', 'layout'
            ];
            
            // æ£€æŸ¥ç±»å
            if (element.className) {
                const classes = element.className.split(' ');
                for (const cls of classes) {
                    if (highPriorityClasses.some(priority => cls.includes(priority))) {
                        score += 15; // æé«˜å°å…ƒç´ ä¼˜å…ˆçº§
                    } else if (mediumPriorityClasses.some(priority => cls.includes(priority))) {
                        score += 8;
                    } else if (lowPriorityClasses.some(priority => cls.includes(priority))) {
                        score -= 3; // é™ä½å¤§å®¹å™¨ä¼˜å…ˆçº§
                    }
                }
            }
            
            // ID æƒé‡ï¼ˆä½†å¦‚æœæ˜¯å¤§å®¹å™¨IDåˆ™é™ä½æƒé‡ï¼‰
            if (element.id) {
                const largeContainerIds = ['main', 'content', 'container', 'wrapper', 'app'];
                if (largeContainerIds.some(id => element.id.includes(id))) {
                    score += 2; // å¤§å®¹å™¨IDæƒé‡è¾ƒä½
                } else {
                    score += 10; // å…·ä½“å…ƒç´ IDæƒé‡è¾ƒé«˜
                }
            }
            
            // data-* å±æ€§æƒé‡
            if (element.hasAttribute('data-function') || 
                element.hasAttribute('data-type') || 
                element.hasAttribute('data-widget') ||
                element.hasAttribute('data-chart') ||
                element.hasAttribute('onclick')) {
                score += 12;
            }
            
            // äº¤äº’å…ƒç´ æƒé‡ï¼ˆè¿™äº›é€šå¸¸æ˜¯ç”¨æˆ·çœŸæ­£æƒ³è¦æ‰¹æ³¨çš„å…ƒç´ ï¼‰
            const interactiveTags = ['BUTTON', 'INPUT', 'SELECT', 'TEXTAREA', 'A', 'LABEL'];
            if (interactiveTags.includes(element.tagName)) {
                score += 15;
            }
            
            // å†…å®¹å…ƒç´ æƒé‡
            const contentTags = ['H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'P', 'SPAN', 'STRONG', 'EM'];
            if (contentTags.includes(element.tagName)) {
                score += 10;
            }
            
            // å›¾åƒå’Œåª’ä½“å…ƒç´ 
            const mediaTags = ['IMG', 'SVG', 'CANVAS', 'VIDEO'];
            if (mediaTags.includes(element.tagName)) {
                score += 12;
            }
            
            // å°ºå¯¸æƒé‡ä¼˜åŒ–ï¼ˆåå‘é€‰æ‹©ä¸­ç­‰å¤§å°çš„å…ƒç´ ï¼‰
            const rect = element.getBoundingClientRect();
            if (rect.width < 10 || rect.height < 10) {
                score -= 10; // å¤ªå°çš„å…ƒç´ 
            } else if (rect.width < 30 || rect.height < 30) {
                score += 5; // å°å…ƒç´ ï¼ˆå›¾æ ‡ã€æŒ‰é’®ç­‰ï¼‰
            } else if (rect.width <= 200 && rect.height <= 100) {
                score += 10; // ä¸­ç­‰å¤§å°å…ƒç´ ï¼ˆæœ€ä½³é€‰æ‹©ï¼‰
            } else if (rect.width <= 400 && rect.height <= 200) {
                score += 5; // ç¨å¤§çš„å…ƒç´ 
            } else {
                score -= 5; // å¤§å‹å®¹å™¨å…ƒç´ 
            }
            
            // é¿å…é€‰æ‹©æ ¹å…ƒç´ å’Œå¤§å®¹å™¨
            const avoidTags = ['BODY', 'HTML', 'HEAD', 'MAIN', 'SECTION', 'ARTICLE'];
            if (avoidTags.includes(element.tagName)) {
                score -= 25;
            }
            
            // æ–‡æœ¬å†…å®¹æƒé‡ï¼ˆåå‘æœ‰é€‚é‡æ–‡æœ¬çš„å…ƒç´ ï¼‰
            const textContent = element.textContent?.trim();
            if (textContent) {
                if (textContent.length <= 3) {
                    score += 8; // çŸ­æ–‡æœ¬ï¼ˆå¦‚æŒ‰é’®ã€æ ‡ç­¾ï¼‰
                } else if (textContent.length <= 20) {
                    score += 12; // æ ‡é¢˜ã€çŸ­æè¿°
                } else if (textContent.length <= 50) {
                    score += 8; // ä¸­ç­‰æ–‡æœ¬
                } else {
                    score += 2; // é•¿æ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯å¤§å®¹å™¨ï¼‰
                }
            }
            
            // å­å…ƒç´ æ•°é‡æƒé‡ï¼ˆåå‘é€‰æ‹©å¶å­èŠ‚ç‚¹æˆ–ç®€å•å…ƒç´ ï¼‰
            const childCount = element.children.length;
            if (childCount === 0) {
                score += 8; // å¶å­èŠ‚ç‚¹ä¼˜å…ˆ
            } else if (childCount <= 3) {
                score += 5; // ç®€å•å…ƒç´ 
            } else if (childCount <= 10) {
                score += 2; // ä¸­ç­‰å¤æ‚å…ƒç´ 
            } else {
                score -= 5; // å¤æ‚å®¹å™¨
            }
            
            // ç‰¹æ®Šå±æ€§åŠ åˆ†
            if (element.hasAttribute('title') || element.hasAttribute('alt')) {
                score += 5;
            }
            
            // å¯è§æ€§æ£€æŸ¥
            const style = window.getComputedStyle(element);
            if (style.display === 'none' || style.visibility === 'hidden') {
                score -= 20;
            }
            
            console.log(`å…ƒç´  ${element.tagName}.${element.className} å¾—åˆ†:`, score, 
                       `å°ºå¯¸: ${rect.width}x${rect.height}`, 
                       `å­å…ƒç´ : ${childCount}`,
                       `æ–‡æœ¬é•¿åº¦: ${textContent?.length || 0}`);
            return score;
        }

        // ä¸ºå…ƒç´ åˆ›å»ºæ‰¹æ³¨ - ç²¾ç¡®ç‰ˆ
        function createAnnotationForElement(element, x, y, iframeDoc) {
            console.log('ğŸ¯ åˆ›å»ºå…ƒç´ æ‰¹æ³¨ - ç²¾ç¡®ç‰ˆ');
            const pageKey = getCurrentPageKey();
            
            // ç”Ÿæˆå¤šé‡å…ƒç´ æ ‡è¯†å’Œå®šä½ä¿¡æ¯
            const elementSignature = generateElementSignature(element, iframeDoc);
            const elementId = elementSignature.id;
            
            // è®°å½•å®Œæ•´çš„å…ƒç´ ä¿¡æ¯
            if (!pageElements[pageKey]) {
                pageElements[pageKey] = {};
            }
            
            pageElements[pageKey][elementId] = elementSignature;
            
            // é€‰ä¸­è¿™ä¸ªå…ƒç´ 
            selectedElementId = elementId;
            
            // ç«‹å³éªŒè¯å®šä½å‡†ç¡®æ€§
            const canRelocate = testElementRelocation(elementId, iframeDoc);
            console.log('ğŸ” å®šä½éªŒè¯ç»“æœ:', canRelocate);
            
            // é«˜äº®å…ƒç´ 
            highlightElement(elementId);
            
            // æ›´æ–°å…ƒç´ æ¸…å•
            updateElementList();
            
            // æ˜¾ç¤ºæ‰¹æ³¨åˆ›å»ºç•Œé¢
            updateAnnotationDisplay(elementId);
            
            console.log('âœ… å…ƒç´ æ‰¹æ³¨åˆ›å»ºå®Œæˆ:', {
                elementId,
                signature: elementSignature,
                canRelocate
            });
        }
        
        // ç”Ÿæˆå…ƒç´ ç­¾åï¼ˆåŒ…å«å¤šé‡å®šä½ä¿¡æ¯ï¼‰
        function generateElementSignature(element, iframeDoc) {
            console.log('ğŸ“ ç”Ÿæˆå…ƒç´ ç­¾å:', element);
            
            const rect = element.getBoundingClientRect();
            const computedStyle = window.getComputedStyle(element);
            
            // åŸºç¡€ä¿¡æ¯
            const basic = {
                tagName: element.tagName.toLowerCase(),
                id: element.id || null,
                className: element.className || null,
                textContent: element.textContent ? element.textContent.trim().substring(0, 50) : null
            };
            
            // ä¸ºCanvaså…ƒç´ ç”Ÿæˆæ™ºèƒ½åç§°
            if (element.tagName.toLowerCase() === 'canvas') {
                basic.smartName = generateCanvasDisplayName(element);
            }
            
            // å±‚çº§è·¯å¾„ä¿¡æ¯
            const hierarchy = generateElementPath(element);
            
            // å±æ€§ç‰¹å¾
            const attributes = {};
            if (element.attributes) {
                for (let attr of element.attributes) {
                    if (['id', 'class', 'data-', 'src', 'href', 'type', 'name', 'value'].some(prefix => 
                        attr.name === prefix || attr.name.startsWith(prefix))) {
                        attributes[attr.name] = attr.value;
                    }
                }
            }
            
            // ä½ç½®ä¿¡æ¯ï¼ˆå¤šé‡ï¼‰
            const positioning = {
                // ç»å¯¹åæ ‡
                absoluteRect: {
                    top: rect.top,
                    left: rect.left,
                    width: rect.width,
                    height: rect.height,
                    right: rect.right,
                    bottom: rect.bottom
                },
                // ç›¸å¯¹çˆ¶å…ƒç´ ä½ç½®
                relativePosition: getRelativePosition(element),
                // åœ¨åŒçº§å…ƒç´ ä¸­çš„ç´¢å¼•
                siblingIndex: getSiblingIndex(element),
                // åœ¨åŒç±»å‹å…ƒç´ ä¸­çš„ç´¢å¼•
                typeIndex: getTypeIndex(element)
            };
            
            // æ ·å¼ç‰¹å¾ï¼ˆç”¨äºè¯†åˆ«ï¼‰
            const styleFeatures = {
                display: computedStyle.display,
                position: computedStyle.position,
                backgroundColor: computedStyle.backgroundColor,
                color: computedStyle.color,
                fontSize: computedStyle.fontSize,
                zIndex: computedStyle.zIndex
            };
            
            // ç”Ÿæˆå¤šä¸ªé€‰æ‹©å™¨
            const selectors = {
                primary: generatePrimarySelector(element),
                xpath: generateXPath(element),
                cssPath: generateCSSPath(element),
                unique: generateUniqueSelector(element, iframeDoc),
                backup: generateBackupSelectors(element)
            };
            
            // å†…å®¹ç‰¹å¾
            const contentFeatures = {
                hasText: !!element.textContent?.trim(),
                hasChildren: element.children.length > 0,
                childCount: element.children.length,
                isLeaf: element.children.length === 0,
                innerHTML: element.innerHTML ? element.innerHTML.substring(0, 200) : null
            };
            
            // ç”Ÿæˆç¨³å®šID
            const stableId = generateStableElementId(basic, hierarchy, positioning);
            
            return {
                id: stableId,
                timestamp: Date.now(),
                basic,
                hierarchy,
                attributes,
                positioning,
                styleFeatures,
                contentFeatures,
                selectors,
                // ä¿å­˜åŸå§‹å…ƒç´ å¼•ç”¨ï¼ˆä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
                _element: element,
                // éªŒè¯å‡½æ•°
                validate: function(testElement) {
                    return validateElementMatch(this, testElement);
                }
            };
        }
        
        // ç”Ÿæˆå…ƒç´ å±‚çº§è·¯å¾„
        function generateElementPath(element) {
            const path = [];
            let current = element;
            let depth = 0;
            const maxDepth = 10;
            
            while (current && current !== document.body && depth < maxDepth) {
                const step = {
                    tagName: current.tagName.toLowerCase(),
                    id: current.id || null,
                    className: current.className || null,
                    index: Array.from(current.parentElement?.children || []).indexOf(current)
                };
                path.unshift(step);
                current = current.parentElement;
                depth++;
            }
            
            return {
                path,
                depth,
                fullPath: path.map(step => 
                    `${step.tagName}${step.id ? '#' + step.id : ''}${step.className ? '.' + step.className.split(' ')[0] : ''}[${step.index}]`
                ).join(' > ')
            };
        }
        
        // è·å–ç›¸å¯¹ä½ç½®
        function getRelativePosition(element) {
            const parent = element.parentElement;
            if (!parent) return null;
            
            const parentRect = parent.getBoundingClientRect();
            const elementRect = element.getBoundingClientRect();
            
            return {
                offsetTop: elementRect.top - parentRect.top,
                offsetLeft: elementRect.left - parentRect.left,
                offsetWidth: elementRect.width,
                offsetHeight: elementRect.height,
                parentTagName: parent.tagName.toLowerCase(),
                parentClassName: parent.className || null
            };
        }
        
        // è·å–åŒçº§ç´¢å¼•
        function getSiblingIndex(element) {
            const siblings = Array.from(element.parentElement?.children || []);
            return {
                total: siblings.length,
                index: siblings.indexOf(element),
                isFirst: siblings.indexOf(element) === 0,
                isLast: siblings.indexOf(element) === siblings.length - 1
            };
        }
        
        // è·å–åŒç±»å‹ç´¢å¼•
        function getTypeIndex(element) {
            const sameTypeElements = Array.from(
                element.parentElement?.querySelectorAll(element.tagName) || []
            );
            return {
                total: sameTypeElements.length,
                index: sameTypeElements.indexOf(element),
                isUnique: sameTypeElements.length === 1
            };
        }

        // ç”Ÿæˆä¸»è¦é€‰æ‹©å™¨
        function generatePrimarySelector(element) {
            if (element.id) {
                return `#${element.id}`;
            }
            
            let selector = element.tagName.toLowerCase();
            
            if (element.className) {
                const classes = element.className.split(' ').filter(cls => cls.trim());
                if (classes.length > 0) {
                    selector += '.' + classes.slice(0, 3).join('.');
                }
            }
            
            return selector;
        }
        
        // ç”ŸæˆXPath
        function generateXPath(element) {
            if (element.id) {
                return `//*[@id="${element.id}"]`;
            }
            
            const parts = [];
            let current = element;
            
            while (current && current.nodeType === Node.ELEMENT_NODE) {
                let part = current.tagName.toLowerCase();
                
                if (current.id) {
                    part += `[@id="${current.id}"]`;
                    parts.unshift('//' + part);
                    break;
                } else {
                    const siblings = Array.from(current.parentNode?.children || [])
                        .filter(sibling => sibling.tagName === current.tagName);
                    
                    if (siblings.length > 1) {
                        const index = siblings.indexOf(current) + 1;
                        part += `[${index}]`;
                    }
                    
                    parts.unshift(part);
                }
                
                current = current.parentNode;
                if (parts.length > 5) break; // é™åˆ¶æ·±åº¦
            }
            
            return '//' + parts.join('/');
        }
        
        // ç”ŸæˆCSSè·¯å¾„
        function generateCSSPath(element) {
            const parts = [];
            let current = element;
            
            while (current && current.nodeType === Node.ELEMENT_NODE && current !== document.body) {
                let selector = current.tagName.toLowerCase();
                
                if (current.id) {
                    selector += '#' + current.id;
                    parts.unshift(selector);
                    break;
                } else if (current.className) {
                    const classes = current.className.split(' ').filter(cls => cls.trim());
                    if (classes.length > 0) {
                        selector += '.' + classes[0];
                    }
                }
                
                // æ·»åŠ nth-childé€‰æ‹©å™¨ä»¥ç¡®ä¿å”¯ä¸€æ€§
                const siblings = Array.from(current.parentNode?.children || []);
                const index = siblings.indexOf(current) + 1;
                selector += `:nth-child(${index})`;
                
                parts.unshift(selector);
                current = current.parentNode;
                
                if (parts.length > 4) break; // é™åˆ¶æ·±åº¦
            }
            
            return parts.join(' > ');
        }
        
        // ç”Ÿæˆå”¯ä¸€é€‰æ‹©å™¨
        function generateUniqueSelector(element, doc) {
            // å°è¯•å¤šç§å”¯ä¸€æ ‡è¯†ç­–ç•¥
            const strategies = [];
            
            // ç­–ç•¥1: IDé€‰æ‹©å™¨
            if (element.id) {
                strategies.push(`#${element.id}`);
            }
            
            // ç­–ç•¥2: dataå±æ€§
            for (let attr of element.attributes || []) {
                if (attr.name.startsWith('data-') && attr.value) {
                    strategies.push(`[${attr.name}="${attr.value}"]`);
                }
            }
            
            // ç­–ç•¥3: å”¯ä¸€ç±»åç»„åˆ
            if (element.className) {
                const classes = element.className.split(' ').filter(cls => cls.trim());
                for (let i = 1; i <= Math.min(classes.length, 3); i++) {
                    const classSelector = '.' + classes.slice(0, i).join('.');
                    if (doc.querySelectorAll(classSelector).length === 1) {
                        strategies.push(classSelector);
                        break;
                    }
                }
            }
            
            // ç­–ç•¥4: æ–‡æœ¬å†…å®¹é€‰æ‹©å™¨
            const textContent = element.textContent?.trim();
            if (textContent && textContent.length < 30) {
                const escaped = textContent.replace(/"/g, '\\"');
                strategies.push(`${element.tagName.toLowerCase()}:contains("${escaped}")`);
            }
            
            // ç­–ç•¥5: å±æ€§ç»„åˆ
            const uniqueAttrs = ['name', 'type', 'href', 'src', 'value'];
            for (let attrName of uniqueAttrs) {
                const attrValue = element.getAttribute(attrName);
                if (attrValue) {
                    const attrSelector = `[${attrName}="${attrValue}"]`;
                    if (doc.querySelectorAll(attrSelector).length === 1) {
                        strategies.push(attrSelector);
                        break;
                    }
                }
            }
            
            return strategies;
        }
        
        // ç”Ÿæˆå¤‡ç”¨é€‰æ‹©å™¨
        function generateBackupSelectors(element) {
            const backups = [];
            
            // å¤‡ç”¨1: æ ‡ç­¾+ä½ç½®
            const siblings = Array.from(element.parentNode?.children || []);
            const index = siblings.indexOf(element);
            backups.push(`${element.tagName.toLowerCase()}:nth-child(${index + 1})`);
            
            // å¤‡ç”¨2: æ ‡ç­¾+ç±»å+ä½ç½®
            if (element.className) {
                const firstClass = element.className.split(' ')[0];
                backups.push(`${element.tagName.toLowerCase()}.${firstClass}:nth-child(${index + 1})`);
            }
            
            // å¤‡ç”¨3: ç›¸å¯¹çˆ¶å…ƒç´ çš„é€‰æ‹©å™¨
            const parent = element.parentElement;
            if (parent && parent.id) {
                backups.push(`#${parent.id} > ${element.tagName.toLowerCase()}:nth-child(${index + 1})`);
            }
            
            return backups;
        }
        
        // ========== Canvasæ™ºèƒ½è¯†åˆ«ç³»ç»Ÿ ==========
        
        // ç”ŸæˆCanvaså”¯ä¸€ç­¾å
        function generateCanvasSignature(canvasElement) {
            const signatures = [];
            
            // 1. åŸºç¡€ç‰©ç†ç‰¹å¾
            const width = canvasElement.width || canvasElement.offsetWidth || 0;
            const height = canvasElement.height || canvasElement.offsetHeight || 0;
            signatures.push(`size-${width}x${height}`);
            
            // 2. æ£€æµ‹EChartså®ä¾‹
            const echartsInfo = detectEChartsInstance(canvasElement);
            if (echartsInfo.isECharts) {
                signatures.push('echarts');
                
                // EChartså›¾è¡¨ç±»å‹
                if (echartsInfo.chartType) {
                    signatures.push(`type-${echartsInfo.chartType}`);
                }
                
                // EChartsæ ‡é¢˜ä½œä¸ºå”¯ä¸€æ ‡è¯†
                if (echartsInfo.title) {
                    const titleSlug = echartsInfo.title
                        .replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '')
                        .substring(0, 10);
                    signatures.push(`title-${titleSlug}`);
                }
                
                // EChartså®ä¾‹ID
                if (echartsInfo.instanceId) {
                    signatures.push(`inst-${echartsInfo.instanceId}`);
                }
            } else {
                // éEChartsçš„canvasç‰¹å¾
                signatures.push('native');
                
                // æ£€æµ‹canvasä¸Šä¸‹æ–‡ç±»å‹
                try {
                    if (canvasElement.getContext('2d')) {
                        signatures.push('2d');
                    } else if (canvasElement.getContext('webgl') || canvasElement.getContext('experimental-webgl')) {
                        signatures.push('webgl');
                    } else if (canvasElement.getContext('webgl2')) {
                        signatures.push('webgl2');
                    }
                } catch (e) {
                    signatures.push('protected');
                }
            }
            
            // 3. å®¹å™¨ä¸Šä¸‹æ–‡ç‰¹å¾
            const containerInfo = analyzeCanvasContainer(canvasElement);
            if (containerInfo.containerId) {
                signatures.push(`container-${containerInfo.containerId}`);
            }
            if (containerInfo.purpose) {
                const purposeSlug = containerInfo.purpose.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').substring(0, 8);
                signatures.push(`purpose-${purposeSlug}`);
            }
            
            // 4. ä½ç½®ç‰¹å¾ï¼ˆç”¨äºåŒºåˆ†ç›¸åŒç±»å‹çš„å¤šä¸ªcanvasï¼‰
            const positionInfo = getCanvasPositionContext(canvasElement);
            signatures.push(`pos-${positionInfo.gridPosition}`);
            if (positionInfo.isUnique) {
                signatures.push('unique');
            }
            
            // 5. æ•°æ®å±æ€§å’Œç±»åç‰¹å¾
            const dataFeatures = extractCanvasDataFeatures(canvasElement);
            signatures.push(...dataFeatures);
            
            return signatures.join('-');
        }
        
        // æ£€æµ‹EChartså®ä¾‹ï¼ˆå¢å¼ºç‰ˆï¼‰
        function detectEChartsInstance(canvasElement) {
            const result = {
                isECharts: false,
                chartType: null,
                title: null,
                instanceId: null,
                option: null,
                containerElement: null
            };
            
            try {
                // æ–¹æ³•1: æ£€æŸ¥ZRenderæ ‡è¯†
                if (canvasElement.getAttribute('data-zr-dom-id')) {
                    result.isECharts = true;
                    result.instanceId = canvasElement.getAttribute('data-zr-dom-id');
                }
                
                // æ–¹æ³•2: å‘ä¸ŠæŸ¥æ‰¾EChartså®¹å™¨
                let parent = canvasElement.parentElement;
                let echartsContainer = null;
                let level = 0;
                
                while (parent && level < 5) {
                    // æ£€æŸ¥EChartså®ä¾‹å±æ€§
                    if (parent._echarts_instance_ || 
                        parent.getAttribute('_echarts_instance_') ||
                        parent.classList.contains('echarts-instance')) {
                        echartsContainer = parent;
                        result.containerElement = parent;
                        result.isECharts = true;
                        break;
                    }
                    
                    // æ£€æŸ¥å®¹å™¨ç‰¹å¾
                    const containerId = parent.id || '';
                    const containerClass = parent.className || '';
                    
                    if (containerId.includes('chart') || containerId.includes('echarts') ||
                        containerClass.includes('chart') || containerClass.includes('echarts')) {
                        echartsContainer = parent;
                        result.containerElement = parent;
                        result.isECharts = true;
                        break;
                    }
                    
                    parent = parent.parentElement;
                    level++;
                }
                
                // æ–¹æ³•3: é€šè¿‡å…¨å±€echartså¯¹è±¡è·å–å®ä¾‹
                if (echartsContainer && window.echarts) {
                    try {
                        const instance = echarts.getInstanceByDom(echartsContainer);
                        if (instance) {
                            result.isECharts = true;
                            result.option = instance.getOption();
                            
                            // è§£æå›¾è¡¨ä¿¡æ¯
                            if (result.option) {
                                // è·å–æ ‡é¢˜
                                if (result.option.title) {
                                    const titleConfig = Array.isArray(result.option.title) ? 
                                        result.option.title[0] : result.option.title;
                                    if (titleConfig && titleConfig.text) {
                                        result.title = titleConfig.text;
                                    }
                                }
                                
                                // è·å–å›¾è¡¨ç±»å‹
                                if (result.option.series && result.option.series[0]) {
                                    result.chartType = result.option.series[0].type;
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('è·å–EChartså®ä¾‹å¤±è´¥:', error);
                    }
                }
                
                // æ–¹æ³•4: æ£€æŸ¥å®¹å™¨çš„æ•°æ®å±æ€§å’Œæ ‡é¢˜
                if (echartsContainer) {
                    // æ•°æ®å±æ€§ä¸­çš„æ ‡é¢˜
                    const dataTitle = echartsContainer.getAttribute('data-chart-title') ||
                                     echartsContainer.getAttribute('data-title') ||
                                     echartsContainer.getAttribute('title');
                    if (dataTitle && !result.title) {
                        result.title = dataTitle;
                    }
                    
                    // æ•°æ®å±æ€§ä¸­çš„å›¾è¡¨ç±»å‹
                    const dataType = echartsContainer.getAttribute('data-chart-type') ||
                                    echartsContainer.getAttribute('data-type');
                    if (dataType && !result.chartType) {
                        result.chartType = dataType;
                    }
                    
                    // æŸ¥æ‰¾ç›¸é‚»çš„æ ‡é¢˜å…ƒç´ 
                    if (!result.title) {
                        const titleElement = echartsContainer.querySelector('.chart-title, .title, h1, h2, h3, h4, h5, h6') ||
                                           echartsContainer.previousElementSibling?.querySelector('h1, h2, h3, h4, h5, h6') ||
                                           echartsContainer.nextElementSibling?.querySelector('h1, h2, h3, h4, h5, h6');
                        
                        if (titleElement && titleElement.textContent) {
                            result.title = titleElement.textContent.trim();
                        }
                    }
                }
                
            } catch (error) {
                console.warn('æ£€æµ‹EChartså®ä¾‹æ—¶å‡ºé”™:', error);
            }
            
            return result;
        }
        
        // åˆ†æCanvaså®¹å™¨ä¸Šä¸‹æ–‡
        function analyzeCanvasContainer(canvasElement) {
            const info = {
                containerId: null,
                purpose: null,
                level: 0
            };
            
            let parent = canvasElement.parentElement;
            let level = 0;
            
            while (parent && level < 5) {
                const id = parent.id || '';
                const className = parent.className || '';
                const tagName = parent.tagName.toLowerCase();
                
                // è®°å½•å®¹å™¨ID
                if (id && !info.containerId) {
                    info.containerId = id.replace(/[^\w\-]/g, '').substring(0, 15);
                }
                
                // æ£€æŸ¥è¯­ä¹‰åŒ–ç”¨é€”
                const purposes = [
                    'chart', 'graph', 'plot', 'diagram', 'visualization', 
                    'dashboard', 'monitor', 'analytics', 'report', 'overview',
                    'metric', 'kpi', 'stats', 'data'
                ];
                
                for (const purpose of purposes) {
                    if (id.includes(purpose) || className.includes(purpose)) {
                        info.purpose = purpose;
                        info.level = level;
                        break;
                    }
                }
                
                // ç‰¹æ®Šå®¹å™¨æ£€æµ‹
                if (className.includes('cesium') || id.includes('cesium')) {
                    info.purpose = 'cesium3d';
                    break;
                }
                
                if (className.includes('leaflet') || id.includes('leaflet')) {
                    info.purpose = 'leafletmap';
                    break;
                }
                
                if (info.purpose) break;
                
                parent = parent.parentElement;
                level++;
            }
            
            return info;
        }
        
        // è·å–Canvasä½ç½®ä¸Šä¸‹æ–‡
        function getCanvasPositionContext(canvasElement) {
            const rect = canvasElement.getBoundingClientRect();
            const allCanvases = document.querySelectorAll('canvas');
            const canvasIndex = Array.from(allCanvases).indexOf(canvasElement);
            
            // è®¡ç®—ç½‘æ ¼ä½ç½®
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let gridX = 'c'; // center
            if (centerX < viewportWidth * 0.33) gridX = 'l'; // left
            else if (centerX > viewportWidth * 0.67) gridX = 'r'; // right
            
            let gridY = 'm'; // middle  
            if (centerY < viewportHeight * 0.33) gridY = 't'; // top
            else if (centerY > viewportHeight * 0.67) gridY = 'b'; // bottom
            
            const gridPosition = gridX + gridY;
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç›¸åŒä½ç½®æœ‰å…¶ä»–canvas
            const samePositionCanvases = Array.from(allCanvases).filter(canvas => {
                if (canvas === canvasElement) return false;
                const otherRect = canvas.getBoundingClientRect();
                const otherCenterX = otherRect.left + otherRect.width / 2;
                const otherCenterY = otherRect.top + otherRect.height / 2;
                
                let otherGridX = 'c';
                if (otherCenterX < viewportWidth * 0.33) otherGridX = 'l';
                else if (otherCenterX > viewportWidth * 0.67) otherGridX = 'r';
                
                let otherGridY = 'm';
                if (otherCenterY < viewportHeight * 0.33) otherGridY = 't';
                else if (otherCenterY > viewportHeight * 0.67) otherGridY = 'b';
                
                return (otherGridX + otherGridY) === gridPosition;
            });
            
            return {
                gridPosition: samePositionCanvases.length > 0 ? 
                    `${gridPosition}${canvasIndex}` : gridPosition,
                isUnique: samePositionCanvases.length === 0,
                totalCanvases: allCanvases.length,
                index: canvasIndex
            };
        }
        
        // æå–Canvasæ•°æ®ç‰¹å¾
        function extractCanvasDataFeatures(canvasElement) {
            const features = [];
            
            // æ£€æŸ¥è‡ªèº«çš„æ•°æ®å±æ€§
            const dataset = canvasElement.dataset || {};
            for (const [key, value] of Object.entries(dataset)) {
                if (key.length <= 15 && value.length <= 15) {
                    const cleanKey = key.replace(/[^\w]/g, '').toLowerCase();
                    const cleanValue = String(value).replace(/[^\w\u4e00-\u9fa5]/g, '').substring(0, 8);
                    if (cleanKey && cleanValue) {
                        features.push(`data-${cleanKey}-${cleanValue}`);
                    }
                }
            }
            
            // æ£€æŸ¥ç±»åç‰¹å¾
            const className = canvasElement.className || '';
            if (className) {
                const classFeature = className
                    .split(' ')
                    .filter(cls => cls && cls.length > 2 && cls.length <= 15)
                    .map(cls => cls.replace(/[^\w\-]/g, ''))
                    .slice(0, 2)
                    .join('-');
                if (classFeature) {
                    features.push(`class-${classFeature}`);
                }
            }
            
            // æ£€æŸ¥IDç‰¹å¾
            const id = canvasElement.id || '';
            if (id && id.length <= 20) {
                const idFeature = id.replace(/[^\w\-]/g, '').substring(0, 10);
                features.push(`id-${idFeature}`);
            }
            
            return features.slice(0, 3); // æœ€å¤š3ä¸ªç‰¹å¾é¿å…ç­¾åè¿‡é•¿
        }
        
        // ç”ŸæˆCanvaså‹å¥½æ˜¾ç¤ºåç§°
        function generateCanvasDisplayName(canvasElement) {
            // é¦–å…ˆå°è¯•æ£€æµ‹ECharts
            const echartsInfo = detectEChartsInstance(canvasElement);
            if (echartsInfo.isECharts) {
                if (echartsInfo.title) {
                    return echartsInfo.title;
                }
                
                const chartTypeMap = {
                    'line': 'æŠ˜çº¿å›¾',
                    'bar': 'æŸ±çŠ¶å›¾',
                    'pie': 'é¥¼å›¾',
                    'scatter': 'æ•£ç‚¹å›¾',
                    'map': 'åœ°å›¾',
                    'radar': 'é›·è¾¾å›¾',
                    'gauge': 'ä»ªè¡¨ç›˜',
                    'funnel': 'æ¼æ–—å›¾',
                    'sankey': 'æ¡‘åŸºå›¾',
                    'heatmap': 'çƒ­åŠ›å›¾',
                    'tree': 'æ ‘å›¾',
                    'treemap': 'çŸ©å½¢æ ‘å›¾',
                    'sunburst': 'æ—­æ—¥å›¾',
                    'boxplot': 'ç®±çº¿å›¾',
                    'candlestick': 'Kçº¿å›¾',
                    'parallel': 'å¹³è¡Œåæ ‡å›¾',
                    'graph': 'å…³ç³»å›¾',
                    'liquidfill': 'æ°´çƒå›¾',
                    'wordcloud': 'è¯äº‘å›¾'
                };
                
                if (echartsInfo.chartType) {
                    const chartTypeName = chartTypeMap[echartsInfo.chartType] || `${echartsInfo.chartType}å›¾è¡¨`;
                    return `ECharts ${chartTypeName}`;
                }
                
                return 'EChartså›¾è¡¨';
            }
            
            // åˆ†æå®¹å™¨ä¸Šä¸‹æ–‡
            const containerInfo = analyzeCanvasContainer(canvasElement);
            if (containerInfo.purpose) {
                const purposeMap = {
                    'cesium3d': 'Cesium 3Dåœ°å›¾',
                    'leafletmap': 'Leafletåœ°å›¾',
                    'chart': 'å›¾è¡¨Canvas',
                    'graph': 'å›¾å½¢Canvas',
                    'plot': 'ç»˜å›¾Canvas',
                    'diagram': 'å›¾è§£Canvas',
                    'visualization': 'å¯è§†åŒ–Canvas',
                    'dashboard': 'ä»ªè¡¨æ¿Canvas',
                    'monitor': 'ç›‘æ§Canvas',
                    'analytics': 'åˆ†æCanvas',
                    'report': 'æŠ¥è¡¨Canvas',
                    'overview': 'æ¦‚è§ˆCanvas'
                };
                
                if (purposeMap[containerInfo.purpose]) {
                    return purposeMap[containerInfo.purpose];
                }
            }
            
            // æ£€æŸ¥canvasç‰¹å®šå±æ€§
            const dataTitle = canvasElement.getAttribute('data-title') ||
                             canvasElement.getAttribute('data-name') ||
                             canvasElement.getAttribute('title') ||
                             canvasElement.getAttribute('alt');
            if (dataTitle && dataTitle.trim()) {
                return dataTitle.trim();
            }
            
            // æ ¹æ®å°ºå¯¸å’Œä½ç½®ç”Ÿæˆæè¿°æ€§åç§°
            const width = canvasElement.width || canvasElement.offsetWidth || 0;
            const height = canvasElement.height || canvasElement.offsetHeight || 0;
            
            let sizeDesc = '';
            const area = width * height;
            if (area > 800000) {
                sizeDesc = 'å¤§å‹';
            } else if (area > 200000) {
                sizeDesc = 'ä¸­å‹';
            } else if (area > 50000) {
                sizeDesc = 'å°å‹';
            } else {
                sizeDesc = 'å¾®å‹';
            }
            
            // æ£€æŸ¥ä¸Šä¸‹æ–‡ç±»å‹
            let contextDesc = 'Canvas';
            try {
                if (canvasElement.getContext('2d')) {
                    contextDesc = '2D Canvas';
                } else if (canvasElement.getContext('webgl') || canvasElement.getContext('experimental-webgl')) {
                    contextDesc = 'WebGL Canvas';
                } else if (canvasElement.getContext('webgl2')) {
                    contextDesc = 'WebGL2 Canvas';
                }
            } catch (e) {
                contextDesc = 'å—ä¿æŠ¤ Canvas';
            }
            
            // ä½ç½®ä¿¡æ¯
            const allCanvases = document.querySelectorAll('canvas');
            if (allCanvases.length > 1) {
                const index = Array.from(allCanvases).indexOf(canvasElement) + 1;
                const rect = canvasElement.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let position = '';
                if (centerX < viewportWidth * 0.33) position += 'å·¦';
                else if (centerX > viewportWidth * 0.67) position += 'å³';
                else position += 'ä¸­';
                
                if (centerY < viewportHeight * 0.33) position += 'ä¸Š';
                else if (centerY > viewportHeight * 0.67) position += 'ä¸‹';
                else position += 'å¤®';
                
                return `${position}${sizeDesc}${contextDesc} #${index}`;
            }
            
            return `${sizeDesc}${contextDesc}`;
        }
        
        // è·å–å…ƒç´ çš„æ˜¾ç¤ºåç§°
        function getElementDisplayName(element) {
            if (!element) return 'æœªçŸ¥å…ƒç´ ';
            
            // å¦‚æœæœ‰æ™ºèƒ½åç§°ï¼Œä¼˜å…ˆä½¿ç”¨
            if (element.basic && element.basic.smartName) {
                return element.basic.smartName;
            }
            
            // å¦‚æœæ˜¯Canvaså…ƒç´ ï¼Œç”Ÿæˆæ™ºèƒ½åç§°
            if (element._element && element._element.tagName.toLowerCase() === 'canvas') {
                return generateCanvasDisplayName(element._element);
            }
            
            // ä½¿ç”¨åŸæœ‰çš„åç§°é€»è¾‘
            if (element.name) {
                return element.name;
            }
            
            // å›é€€åˆ°åŸºç¡€åç§°ç”Ÿæˆ
            if (element.basic) {
                const tagName = element.basic.tagName || 'unknown';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æœ¬å†…å®¹
                if (element.basic.textContent && element.basic.textContent.trim()) {
                    const text = element.basic.textContent.trim();
                    if (text.length <= 20) {
                        return `${tagName}: ${text}`;
                    } else {
                        return `${tagName}: ${text.substring(0, 15)}...`;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ID
                if (element.basic.id) {
                    return `${tagName}#${element.basic.id}`;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰class
                if (element.basic.className) {
                    const firstClass = element.basic.className.split(' ')[0];
                    return `${tagName}.${firstClass}`;
                }
                
                return tagName.toUpperCase();
            }
            
            return 'æœªçŸ¥å…ƒç´ ';
        }
        
        // ç”Ÿæˆç¨³å®šå…ƒç´ ID
        function generateStableElementId(basic, hierarchy, positioning) {
            // ä½¿ç”¨å¤šä¸ªç‰¹å¾ç”Ÿæˆç¨³å®šID
            const features = [
                basic.tagName,
                basic.id || 'noid',
                basic.className?.split(' ')[0] || 'noclass',
                hierarchy.depth,
                positioning.siblingIndex.index,
                positioning.typeIndex.index
            ];
            
            // æ·»åŠ å†…å®¹ç‰¹å¾
            if (basic.textContent && basic.textContent.length < 20) {
                features.push(basic.textContent.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, ''));
            }
            
            const idString = features.join('-');
            return `precise-${idString}`.replace(/[^a-zA-Z0-9\u4e00-\u9fa5-]/g, '-').replace(/-+/g, '-');
        }
        
        // éªŒè¯å…ƒç´ åŒ¹é…
        function validateElementMatch(signature, testElement) {
            if (!testElement) return { score: 0, reason: 'å…ƒç´ ä¸å­˜åœ¨' };
            
            let score = 0;
            const reasons = [];
            
            // åŸºç¡€ä¿¡æ¯åŒ¹é… (40åˆ†)
            if (signature.basic.tagName === testElement.tagName.toLowerCase()) {
                score += 15;
                reasons.push('æ ‡ç­¾åŒ¹é…');
            }
            
            if (signature.basic.id && signature.basic.id === testElement.id) {
                score += 25;
                reasons.push('IDå®Œå…¨åŒ¹é…');
            }
            
            if (signature.basic.className && testElement.className.includes(signature.basic.className.split(' ')[0])) {
                score += 10;
                reasons.push('ç±»ååŒ¹é…');
            }
            
            // ä½ç½®ä¿¡æ¯åŒ¹é… (30åˆ†)
            const siblings = Array.from(testElement.parentElement?.children || []);
            const currentIndex = siblings.indexOf(testElement);
            if (currentIndex === signature.positioning.siblingIndex.index) {
                score += 15;
                reasons.push('ä½ç½®ç´¢å¼•åŒ¹é…');
            }
            
            const rect = testElement.getBoundingClientRect();
            const sizeDiff = Math.abs(rect.width - signature.positioning.absoluteRect.width) + 
                           Math.abs(rect.height - signature.positioning.absoluteRect.height);
            if (sizeDiff < 20) {
                score += 15;
                reasons.push('å°ºå¯¸ç›¸ä¼¼');
            }
            
            // å†…å®¹åŒ¹é… (20åˆ†)
            if (signature.contentFeatures.hasText && testElement.textContent?.trim()) {
                const textSimilarity = calculateTextSimilarity(
                    signature.basic.textContent, 
                    testElement.textContent.trim().substring(0, 50)
                );
                score += Math.round(textSimilarity * 20);
                if (textSimilarity > 0.8) reasons.push('æ–‡æœ¬å†…å®¹åŒ¹é…');
            }
            
            // å±æ€§åŒ¹é… (10åˆ†)
            let attrMatches = 0;
            for (let [attrName, attrValue] of Object.entries(signature.attributes)) {
                if (testElement.getAttribute(attrName) === attrValue) {
                    attrMatches++;
                }
            }
            if (attrMatches > 0) {
                score += Math.min(attrMatches * 5, 10);
                reasons.push(`${attrMatches}ä¸ªå±æ€§åŒ¹é…`);
            }
            
            return {
                score,
                reasons,
                isMatch: score >= 70, // 70åˆ†ä»¥ä¸Šè®¤ä¸ºåŒ¹é…
                confidence: score / 100
            };
        }
        
        // è®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦
        function calculateTextSimilarity(text1, text2) {
            if (!text1 || !text2) return 0;
            
            text1 = text1.toLowerCase().trim();
            text2 = text2.toLowerCase().trim();
            
            if (text1 === text2) return 1;
            
            const longer = text1.length > text2.length ? text1 : text2;
            const shorter = text1.length > text2.length ? text2 : text1;
            
            if (longer.length === 0) return 1;
            
            const editDistance = calculateEditDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // è®¡ç®—ç¼–è¾‘è·ç¦»
        function calculateEditDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // æµ‹è¯•å…ƒç´ é‡å®šä½
        function testElementRelocation(elementId, iframeDoc) {
            const pageKey = getCurrentPageKey();
            const signature = pageElements[pageKey]?.[elementId];
            
            if (!signature) return false;
            
            try {
                const foundElement = relocateElementBySignature(signature, iframeDoc);
                return !!foundElement;
            } catch (error) {
                console.log('é‡å®šä½æµ‹è¯•å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ ¹æ®ç­¾åé‡å®šä½å…ƒç´ 
        function relocateElementBySignature(signature, iframeDoc) {
            console.log('ğŸ” æ ¹æ®ç­¾åé‡å®šä½å…ƒç´ :', signature.id);
            
            // ç­–ç•¥1: ä½¿ç”¨primaryé€‰æ‹©å™¨
            if (signature.selectors.primary) {
                try {
                    const element = iframeDoc.querySelector(signature.selectors.primary);
                    if (element) {
                        const validation = signature.validate(element);
                        console.log('Primaryé€‰æ‹©å™¨éªŒè¯:', validation);
                        if (validation.isMatch) {
                            return element;
                        }

                    }
                } catch (e) {
                    console.log('Primaryé€‰æ‹©å™¨å¤±è´¥:', e);
                }

            }
            
            // ç­–ç•¥2: ä½¿ç”¨uniqueé€‰æ‹©å™¨
            for (let uniqueSelector of signature.selectors.unique || []) {
                try {
                    const element = iframeDoc.querySelector(uniqueSelector);
                    if (element) {
                        const validation = signature.validate(element);
                        console.log('Uniqueé€‰æ‹©å™¨éªŒè¯:', validation);
                        if (validation.isMatch) {
                            return element;
                        }
                    }
                } catch (e) {
                    console.log('Uniqueé€‰æ‹©å™¨å¤±è´¥:', uniqueSelector, e);
                }
            }
            
            // ç­–ç•¥3: ä½¿ç”¨CSSè·¯å¾„
            if (signature.selectors.cssPath) {
                try {
                    const element = iframeDoc.querySelector(signature.selectors.cssPath);
                    if (element) {
                        const validation = signature.validate(element);
                        console.log('CSSè·¯å¾„éªŒè¯:', validation);
                        if (validation.isMatch) {
                            return element;
                        }
                    }
                } catch (e) {
                    console.log('CSSè·¯å¾„å¤±è´¥:', e);
                }
            }
            
            // ç­–ç•¥4: ä½¿ç”¨å±‚çº§è·¯å¾„é‡å»º
            const pathElement = findElementByPath(signature.hierarchy, iframeDoc);
            if (pathElement) {
                const validation = signature.validate(pathElement);
                console.log('è·¯å¾„é‡å»ºéªŒè¯:', validation);
                if (validation.isMatch) {
                    return pathElement;
                }
            }
            
            // ç­–ç•¥5: ç›¸ä¼¼åº¦åŒ¹é…
            const candidates = findSimilarElements(signature, iframeDoc);
            if (candidates.length > 0) {
                console.log('æ‰¾åˆ°ç›¸ä¼¼å…ƒç´ å€™é€‰:', candidates.length);
                return candidates[0].element;
            }
            
            console.log('âŒ æ‰€æœ‰é‡å®šä½ç­–ç•¥éƒ½å¤±è´¥äº†');
            return null;
        }
        
        // æ ¹æ®è·¯å¾„æŸ¥æ‰¾å…ƒç´ 
        function findElementByPath(hierarchy, iframeDoc) {
            try {
                let current = iframeDoc.body;
                
                for (let step of hierarchy.path) {
                    const children = Array.from(current.children);
                    const candidate = children[step.index];
                    
                    if (!candidate || candidate.tagName.toLowerCase() !== step.tagName) {
                        return null;
                    }
                    
                    current = candidate;
                }
                
                return current;
            } catch (error) {
                console.log('è·¯å¾„æŸ¥æ‰¾å¤±è´¥:', error);
                return null;
            }
        }
        
        // æŸ¥æ‰¾ç›¸ä¼¼å…ƒç´ 
        function findSimilarElements(signature, iframeDoc) {
            const candidates = [];
            const allElements = iframeDoc.querySelectorAll(signature.basic.tagName);
            
            for (let element of allElements) {
                const validation = signature.validate(element);
                if (validation.score > 50) { // 50åˆ†ä»¥ä¸Šçš„ç›¸ä¼¼å…ƒç´ 
                    candidates.push({
                        element,
                        score: validation.score,
                        reasons: validation.reasons
                    });
                }
            }
            
            // æŒ‰åˆ†æ•°æ’åº
            candidates.sort((a, b) => b.score - a.score);
            
            console.log('ç›¸ä¼¼å…ƒç´ :', candidates.map(c => ({
                score: c.score,
                reasons: c.reasons
            })));
            
            return candidates;
        }
        
        // ç”Ÿæˆç¨³å®šçš„å…ƒç´ ID - å¢å¼ºç‰ˆ
        function generateElementId(element) {
            // ç­–ç•¥1: ä½¿ç”¨åŸç”ŸID
            if (element.id) {
                return `id-${element.id}`;
            }
            
            // ç­–ç•¥2: ä½¿ç”¨dataå±æ€§
            if (element.dataset && element.dataset.function) {
                return `data-function-${element.dataset.function}`;
            }
            
            // ç­–ç•¥3: åŸºäºç¨³å®šç‰¹å¾ç”ŸæˆID
            const tagName = element.tagName.toLowerCase();
            const className = element.className ? element.className.split(' ')[0] : '';
            const parentClass = element.parentElement ? element.parentElement.className.split(' ')[0] : '';
            
            // ä½¿ç”¨ä½ç½®ç‰¹å¾
            const siblings = element.parentElement ? Array.from(element.parentElement.children) : [];
            const index = siblings.indexOf(element);
            const sameTagSiblings = siblings.filter(s => s.tagName === element.tagName);
            const tagIndex = sameTagSiblings.indexOf(element);
            
            // ç‰¹æ®Šå…ƒç´ å¤„ç†
            let specialFeature = '';
            
            // Canvaså…ƒç´ ç‰¹æ®Šå¤„ç†
            if (tagName === 'canvas') {
                specialFeature = generateCanvasSignature(element);
            }
            
            // SVGå…ƒç´ ç‰¹æ®Šå¤„ç†
            else if (tagName === 'svg') {
                const viewBox = element.getAttribute('viewBox');
                specialFeature = `svg-${viewBox || element.getAttribute('width') || 'auto'}`;
            }
            
            // å›¾ç‰‡å…ƒç´ ç‰¹æ®Šå¤„ç†
            else if (tagName === 'img') {
                const src = element.src ? element.src.split('/').pop().split('.')[0] : '';
                specialFeature = `img-${src || 'noname'}`;
            }
            
            // è¡¨å•å…ƒç´ ç‰¹æ®Šå¤„ç†
            else if (['input', 'select', 'textarea', 'button'].includes(tagName)) {
                const type = element.type || tagName;
                const name = element.name || '';
                specialFeature = `${type}-${name}`;
            }
            
            // æ–‡æœ¬å†…å®¹ï¼ˆå¯¹äºæœ‰å†…å®¹çš„å…ƒç´ ï¼‰
            else {
                const textContent = element.textContent ? element.textContent.trim().substring(0, 15) : '';
                if (textContent) {
                    specialFeature = textContent.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');
                }
            }
            
            // ç”Ÿæˆç¨³å®šçš„ID
            const features = [
                tagName,
                className || 'noclass',
                parentClass || 'noparent', 
                `idx${index}`,
                `tag${tagIndex}`,
                specialFeature || 'nofeature'
            ].filter(f => f && f !== '').join('-');
            
            const stableId = features.replace(/[^a-zA-Z0-9\u4e00-\u9fa5-]/g, '-').replace(/-+/g, '-');
            
            console.log('ç”Ÿæˆå…ƒç´ ID:', {
                element: element,
                tagName,
                className,
                index,
                tagIndex,
                specialFeature,
                finalId: `stable-${stableId}`
            });
            
            return `stable-${stableId}`;
        }

        // è·å–å…ƒç´ åç§°
        function getElementName(element) {
            // ä¼˜å…ˆçº§ï¼španel-title > æ–‡æœ¬å†…å®¹ > class > id > æ ‡ç­¾å
            const titleElement = element.querySelector('.panel-title, .title, h1, h2, h3, h4, h5, h6');
            if (titleElement && titleElement.textContent.trim()) {
                return titleElement.textContent.trim();
            }
            
            const textContent = element.textContent ? element.textContent.trim().substring(0, 30) : '';
            if (textContent && textContent.length > 3) {
                return textContent;
            }
            
            if (element.id) {
                return `#${element.id}`;
            }
            
            if (element.className) {
                return `.${element.className.split(' ')[0]}`;
            }
            
            return element.tagName.toLowerCase();
        }

        // è·å–å…ƒç´ æè¿°
        function getElementDescription(element) {
            const tagName = element.tagName.toLowerCase();
            const className = element.className ? ` (${element.className.split(' ').slice(0, 2).join(' ')})` : '';
            const id = element.id ? ` #${element.id}` : '';
            
            return `${tagName}å…ƒç´ ${id}${className}`;
        }

        // åŠ è½½æ‰¹æ³¨æ•°æ®ï¼ˆæ”¯æŒAPIå’Œæœ¬åœ°æ–‡ä»¶ï¼‰
        async function loadAnnotations() {
            const statusElement = document.getElementById('annotationStatus');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                if (statusElement) {
                    statusElement.textContent = 'æ­£åœ¨åŠ è½½...';
                    statusElement.style.color = '#2196F3';
                }
                
                // ä½¿ç”¨APIå®¢æˆ·ç«¯åŠ è½½æ•°æ®
                const annotations = await apiClient.loadAnnotations();
                
                if (annotations && Object.keys(annotations).length > 0) {
                    
                    // éªŒè¯å¹¶è¿ç§»æ‰¹æ³¨æ•°æ®æ ¼å¼
                    currentAnnotations = validateAndMigrateAnnotations(annotations);
                    
                    // ç»Ÿè®¡æ‰¹æ³¨æ•°é‡
                    let totalAnnotations = 0;
                    Object.values(currentAnnotations).forEach(pageAnnotations => {
                        totalAnnotations += Object.keys(pageAnnotations).length;
                    });
                    
                    console.log('=== æ‰¹æ³¨æ•°æ®åŠ è½½æˆåŠŸ ===');
                    console.log('é¡µé¢æ•°é‡:', Object.keys(currentAnnotations).length);
                    console.log('æ€»æ‰¹æ³¨æ•°é‡:', totalAnnotations);
                    console.log('è¯¦ç»†æ‰¹æ³¨æ•°æ®:', currentAnnotations);
                    console.log('å½“å‰é¡µé¢é”®:', getCurrentPageKey());
                    console.log('æ‰€æœ‰é¡µé¢é”®:', Object.keys(currentAnnotations));
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    if (statusElement) {
                        statusElement.textContent = `å·²åŠ è½½ (${totalAnnotations}æ¡æ‰¹æ³¨)`;
                        statusElement.style.color = '#4CAF50';
                    }
                } else {
                    console.log('æ‰¹æ³¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„æ‰¹æ³¨æ•°æ®');
                    currentAnnotations = {};
                    
                    if (statusElement) {
                        statusElement.textContent = 'æ–‡ä»¶ä¸å­˜åœ¨';
                        statusElement.style.color = '#ff9800';
                    }
                }
            } catch (error) {
                console.log('æ‰¹æ³¨æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œåˆ›å»ºæ–°çš„æ‰¹æ³¨æ•°æ®:', error);
                currentAnnotations = {};
                
                if (statusElement) {
                    statusElement.textContent = 'åŠ è½½å¤±è´¥';
                    statusElement.style.color = '#f44336';
                }
            }
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            updateLastUpdateTime();
        }
        
        // è°ƒè¯•æ‰¹æ³¨ç³»ç»Ÿ
        function debugAnnotationSystem() {
            const pageKey = getCurrentPageKey();
            const pageAnnotations = currentAnnotations[pageKey] || {};
            const elements = pageElements[pageKey] || {};
            
            console.log('=== æ‰¹æ³¨ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯ ===');
            console.log('å½“å‰é¡µé¢:', pages[currentPageIndex]);
            console.log('å½“å‰åŠŸèƒ½:', currentFunction);
            console.log('é¡µé¢é”®:', pageKey);
            console.log('é€‰ä¸­å…ƒç´ ID:', selectedElementId);
            console.log('æ‰¹æ³¨æ¨¡å¼:', isAnnotationMode);
            console.log('æ‰€æœ‰æ‰¹æ³¨æ•°æ®:', currentAnnotations);
            console.log('å½“å‰é¡µé¢æ‰¹æ³¨:', pageAnnotations);
            console.log('å½“å‰é¡µé¢å…ƒç´ :', elements);
            
            // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯åˆ°æ‰¹æ³¨é¢æ¿
            const annotationContent = document.getElementById('annotationContent');
            if (annotationContent) {
                annotationContent.innerHTML = `
                    <div class="annotation-item">
                        <div class="annotation-title">ğŸ› ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯</div>
                        <div style="font-size: 11px; margin-top: 8px; line-height: 1.4;">
                            <div><strong>å½“å‰é¡µé¢:</strong> ${pages[currentPageIndex]}</div>
                            <div><strong>å½“å‰åŠŸèƒ½:</strong> ${currentFunction}</div>
                            <div><strong>é¡µé¢é”®:</strong> ${pageKey}</div>
                            <div><strong>é€‰ä¸­å…ƒç´ :</strong> ${selectedElementId || 'æ— '}</div>
                            <div><strong>æ‰¹æ³¨æ¨¡å¼:</strong> ${isAnnotationMode ? 'å·²å¼€å¯' : 'å·²å…³é—­'}</div>
                            <hr style="margin: 8px 0; border-color: #404040;">
                            <div><strong>å½“å‰é¡µé¢æ‰¹æ³¨æ•°:</strong> ${Object.keys(pageAnnotations).length}</div>
                            <div><strong>å½“å‰é¡µé¢å…ƒç´ æ•°:</strong> ${Object.keys(elements).length}</div>
                            <div><strong>å…¨éƒ¨æ‰¹æ³¨æ•°:</strong> ${Object.values(currentAnnotations).reduce((total, page) => total + Object.keys(page).length, 0)}</div>
                            <hr style="margin: 8px 0; border-color: #404040;">
                            <div style="color: #00a8ff;"><strong>å½“å‰é¡µé¢æ‰¹æ³¨åˆ—è¡¨:</strong></div>
                            ${Object.entries(pageAnnotations).map(([id, annotation]) => `
                                <div style="margin: 2px 0; padding: 4px; background: #333; border-radius: 2px;">
                                    <div style="font-weight: bold;">ğŸ“ ${annotation.name}</div>
                                    <div style="font-size: 10px; color: #ccc;">ID: ${id}</div>
                                    <div style="font-size: 10px; color: #ccc;">å†…å®¹: ${annotation.content.substring(0, 30)}...</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 8px;">
                            <button onclick="console.clear(); console.log('æ§åˆ¶å°å·²æ¸…ç©º')" class="nav-button" style="margin: 2px; font-size: 10px;">æ¸…ç©ºæ§åˆ¶å°</button>
                            <button onclick="updateElementList()" class="nav-button" style="margin: 2px; font-size: 10px;">åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                    </div>
                `;
            }
            
            alert('è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ‰¹æ³¨é¢æ¿ï¼Œè¯·æŸ¥çœ‹ï¼');
        }
        
        // æµ‹è¯•é«˜äº®åŠŸèƒ½
        function testHighlight() {
            console.log('=== æµ‹è¯•é«˜äº®åŠŸèƒ½ ===');
            
            // åˆ›å»ºä¸€ä¸ªæµ‹è¯•é«˜äº®æ¡†
            clearHighlights();
            
            const iframe = document.getElementById('embeddedFrame');
            const iframeRect = iframe.getBoundingClientRect();
            
            // åœ¨iframeä¸­å¿ƒåˆ›å»ºæµ‹è¯•é«˜äº®
            const testHighlight = document.createElement('div');
            testHighlight.className = 'highlight-overlay';
            testHighlight.id = 'test-highlight';
            
            testHighlight.style.position = 'fixed';
            testHighlight.style.left = (iframeRect.left + 100) + 'px';
            testHighlight.style.top = (iframeRect.top + 100) + 'px';
            testHighlight.style.width = '200px';
            testHighlight.style.height = '100px';
            testHighlight.style.zIndex = '1000';
            testHighlight.style.border = '5px solid #ff0000';
            testHighlight.style.background = 'rgba(255, 0, 0, 0.5)';
            testHighlight.style.pointerEvents = 'none';
            
            document.body.appendChild(testHighlight);
            
            console.log('æµ‹è¯•é«˜äº®å·²åˆ›å»º:', testHighlight);
            console.log('iframeä½ç½®:', iframeRect);
            
            // å¦‚æœæœ‰æ‰¹æ³¨æ•°æ®ï¼Œå°è¯•é«˜äº®ç¬¬ä¸€ä¸ª
            const pageKey = getCurrentPageKey();
            const pageAnnotations = currentAnnotations[pageKey] || {};
            const annotationIds = Object.keys(pageAnnotations);
            
            if (annotationIds.length > 0) {
                const firstAnnotationId = annotationIds[0];
                console.log('å°è¯•é«˜äº®ç¬¬ä¸€ä¸ªæ‰¹æ³¨:', firstAnnotationId);
                
                setTimeout(() => {
                    highlightElement(firstAnnotationId);
                }, 2000);
            }
            
            // 5ç§’åç§»é™¤æµ‹è¯•é«˜äº®
            setTimeout(() => {
                if (testHighlight.parentNode) {
                    testHighlight.remove();
                }
            }, 5000);
            
            alert('æµ‹è¯•é«˜äº®å·²åˆ›å»ºï¼çº¢è‰²æ¡†åº”è¯¥å‡ºç°åœ¨iframeä¸Šæ–¹ã€‚å¦‚æœæœ‰æ‰¹æ³¨ï¼Œ2ç§’åä¼šå°è¯•é«˜äº®ç¬¬ä¸€ä¸ªæ‰¹æ³¨ã€‚');
        }
        
        // å¼ºåˆ¶åˆ·æ–°æ‰¹æ³¨æ•°æ®å’Œæ˜¾ç¤º
        async function forceRefreshAnnotations() {
            console.log('=== å¼ºåˆ¶åˆ·æ–°æ‰¹æ³¨ç³»ç»Ÿ ===');
            
            // æ¸…ç©ºå½“å‰æ•°æ®
            currentAnnotations = {};
            pageElements = {};
            selectedElementId = null;
            
            // é‡æ–°åŠ è½½æ‰¹æ³¨æ•°æ®
            await loadAnnotations();
            
            // å¼ºåˆ¶æ›´æ–°å…ƒç´ æ¸…å•
            updateElementList();
            
            // æ¸…ç©ºæ‰¹æ³¨é¢æ¿
            const annotationContent = document.getElementById('annotationContent');
            if (annotationContent) {
                annotationContent.innerHTML = `
                    <div class="annotation-item">
                        <div class="annotation-title">ğŸ”„ ç³»ç»Ÿå·²åˆ·æ–°</div>
                        <div style="margin-top: 8px; color: #4CAF50;">
                            æ‰¹æ³¨æ•°æ®å·²é‡æ–°åŠ è½½å®Œæˆï¼
                        </div>
                    </div>
                `;
            }
            
            console.log('å¼ºåˆ¶åˆ·æ–°å®Œæˆ');
            alert('æ‰¹æ³¨ç³»ç»Ÿå·²å¼ºåˆ¶åˆ·æ–°ï¼è¯·æŸ¥çœ‹é¡µé¢å…ƒç´ æ¸…å•ã€‚');
        }

        // éªŒè¯å’Œä¿®å¤æ‰¹æ³¨æ•°æ®
        async function validateAndFixAnnotations() {
            console.log('=== å¼€å§‹éªŒè¯å’Œä¿®å¤æ‰¹æ³¨æ•°æ® ===');
            
            const statusElement = document.getElementById('annotationStatus');
            if (statusElement) {
                statusElement.textContent = 'æ­£åœ¨ä¿®å¤...';
                statusElement.style.color = '#ff9800';
            }
            
            try {
                const iframe = document.getElementById('embeddedFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                let fixedCount = 0;
                let removedCount = 0;
                const newAnnotations = {};
                
                // éå†æ‰€æœ‰æ‰¹æ³¨
                for (const [pageKey, pageAnnotations] of Object.entries(currentAnnotations)) {
                    newAnnotations[pageKey] = {};
                    
                    for (const [elementId, annotation] of Object.entries(pageAnnotations)) {
                        console.log(`æ£€æŸ¥æ‰¹æ³¨: ${pageKey}/${elementId}`);
                        
                        // å°è¯•åœ¨å½“å‰é¡µé¢ä¸­æ‰¾åˆ°å¯¹åº”å…ƒç´ 
                        let targetElement = null;
                        
                        // å¤šç­–ç•¥æŸ¥æ‰¾å…ƒç´ 
                        targetElement = await findElementByMultipleStrategies(iframeDoc, elementId, annotation);
                        
                        if (targetElement) {
                            // å…ƒç´ æ‰¾åˆ°äº†ï¼Œç”Ÿæˆæ–°çš„ç¨³å®šID
                            const newElementId = generateElementId(targetElement);
                            const newSelector = generateElementSelector(targetElement);
                            
                            // æ›´æ–°æ‰¹æ³¨æ•°æ®
                            newAnnotations[pageKey][newElementId] = {
                                ...annotation,
                                elementId: newElementId,
                                selector: newSelector,
                                lastValidated: new Date().toLocaleString('zh-CN'),
                                originalElementId: elementId !== newElementId ? elementId : undefined
                            };
                            
                            if (elementId !== newElementId) {
                                console.log(`ä¿®å¤æ‰¹æ³¨: ${elementId} -> ${newElementId}`);
                                fixedCount++;
                            }
                        } else {
                            // å…ƒç´ æ‰¾ä¸åˆ°ï¼Œè¯¢é—®æ˜¯å¦åˆ é™¤
                            const shouldKeep = confirm(`æ‰¾ä¸åˆ°æ‰¹æ³¨å¯¹åº”çš„å…ƒç´ :\n\næ ‡é¢˜: ${annotation.name}\nå†…å®¹: ${annotation.content}\n\næ˜¯å¦ä¿ç•™æ­¤æ‰¹æ³¨ï¼Ÿ\n(ç‚¹å‡»"ç¡®å®š"ä¿ç•™ï¼Œ"å–æ¶ˆ"åˆ é™¤)`);
                            
                            if (shouldKeep) {
                                // ä¿ç•™ä½†æ ‡è®°ä¸ºæ— æ•ˆ
                                newAnnotations[pageKey][elementId] = {
                                    ...annotation,
                                    status: 'invalid',
                                    lastValidated: new Date().toLocaleString('zh-CN'),
                                    note: 'å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·æ‰‹åŠ¨ä¿®å¤'
                                };
                            } else {
                                console.log(`åˆ é™¤æ— æ•ˆæ‰¹æ³¨: ${elementId}`);
                                removedCount++;
                            }
                        }
                    }
                }
                
                // æ›´æ–°æ‰¹æ³¨æ•°æ®
                currentAnnotations = newAnnotations;
                
                // ä¿å­˜ä¿®å¤åçš„æ•°æ®
                await saveAnnotations();
                await loadAnnotations();
                updateElementList();
                
                // æ˜¾ç¤ºä¿®å¤ç»“æœ
                const annotationContent = document.getElementById('annotationContent');
                if (annotationContent) {
                    annotationContent.innerHTML = `
                        <div class="annotation-item">
                            <div class="annotation-title">ğŸ”§ æ‰¹æ³¨ä¿®å¤å®Œæˆ</div>
                            <div style="margin-top: 8px; line-height: 1.5;">
                                <div style="color: #4CAF50;">âœ… ä¿®å¤æ•°é‡: ${fixedCount}</div>
                                <div style="color: #f44336;">âŒ åˆ é™¤æ•°é‡: ${removedCount}</div>
                                <div style="color: #2196F3;">ğŸ“Š æ€»è®¡å¤„ç†: ${fixedCount + removedCount}</div>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #404040; font-size: 11px; color: #999;">
                                    ä¿®å¤åçš„æ‰¹æ³¨ä½¿ç”¨æ›´ç¨³å®šçš„å…ƒç´ æ ‡è¯†ï¼Œèƒ½å¤Ÿæ›´å‡†ç¡®åœ°å®šä½é¡µé¢å…ƒç´ ã€‚
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (statusElement) {
                    statusElement.textContent = `ä¿®å¤å®Œæˆ (ä¿®å¤${fixedCount}ä¸ª)`;
                    statusElement.style.color = '#4CAF50';
                }
                
                console.log('æ‰¹æ³¨ä¿®å¤å®Œæˆ:', { fixedCount, removedCount });
                alert(`æ‰¹æ³¨ä¿®å¤å®Œæˆï¼\nä¿®å¤: ${fixedCount} ä¸ª\nåˆ é™¤: ${removedCount} ä¸ª`);
                
            } catch (error) {
                console.error('æ‰¹æ³¨ä¿®å¤å¤±è´¥:', error);
                
                if (statusElement) {
                    statusElement.textContent = 'ä¿®å¤å¤±è´¥';
                    statusElement.style.color = '#f44336';
                }
                
                alert('æ‰¹æ³¨ä¿®å¤å¤±è´¥: ' + error.message);
            }
        }

        // å¤šç­–ç•¥æŸ¥æ‰¾å…ƒç´  - å¢å¼ºç‰ˆ
        async function findElementByMultipleStrategies(iframeDoc, elementId, annotation) {
            console.log('å¤šç­–ç•¥æŸ¥æ‰¾å…ƒç´ :', elementId, annotation.name);
            
            // ç­–ç•¥1: ç›´æ¥é€‰æ‹©å™¨æŸ¥æ‰¾
            if (annotation.selector) {
                try {
                    const element = iframeDoc.querySelector(annotation.selector);
                    if (element) {
                        console.log('ç­–ç•¥1æˆåŠŸ: é€‰æ‹©å™¨æŸ¥æ‰¾');
                        return element;
                    }
                } catch (e) {
                    console.log('é€‰æ‹©å™¨æ— æ•ˆ:', annotation.selector);
                }
            }
            
            // ç­–ç•¥2: IDæŸ¥æ‰¾
            if (elementId.startsWith('id-')) {
                const actualId = elementId.substring(3);
                const element = iframeDoc.getElementById(actualId);
                if (element) {
                    console.log('ç­–ç•¥2æˆåŠŸ: IDæŸ¥æ‰¾');
                    return element;
                }
            }
            
            // ç­–ç•¥3: ç‰¹æ®Šå…ƒç´ ç±»å‹æŸ¥æ‰¾
            if (elementId.includes('canvas') || annotation.name.toLowerCase().includes('canvas')) {
                console.log('ç­–ç•¥3: Canvaså…ƒç´ ä¸“é—¨æŸ¥æ‰¾');
                const canvasElements = iframeDoc.querySelectorAll('canvas');
                console.log('æ‰¾åˆ°canvaså…ƒç´ æ•°é‡:', canvasElements.length);
                
                for (const canvas of canvasElements) {
                    // æ£€æŸ¥å°ºå¯¸åŒ¹é…
                    const sizeMatch = elementId.includes(`${canvas.width}x${canvas.height}`);
                    // æ£€æŸ¥ä½ç½®åŒ¹é…
                    const rect = canvas.getBoundingClientRect();
                    console.log('Canvaså…ƒç´ ä¿¡æ¯:', {
                        width: canvas.width,
                        height: canvas.height,
                        rect: rect,
                        parent: canvas.parentElement?.className
                    });
                    
                    // å¦‚æœæ˜¯é¡µé¢ä¸­å”¯ä¸€çš„canvasæˆ–å°ºå¯¸åŒ¹é…ï¼Œä¼˜å…ˆé€‰æ‹©
                    if (canvasElements.length === 1 || sizeMatch) {
                        console.log('ç­–ç•¥3æˆåŠŸ: Canvaså…ƒç´ åŒ¹é…');
                        return canvas;
                    }
                }
                
                // å¦‚æœæœ‰å¤šä¸ªcanvasï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                if (canvasElements.length > 0) {
                    console.log('ç­–ç•¥3æˆåŠŸ: é€‰æ‹©ç¬¬ä¸€ä¸ªCanvas');
                    return canvasElements[0];
                }
            }
            
            // ç­–ç•¥4: ç¨³å®šIDç‰¹å¾è§£ææŸ¥æ‰¾
            if (elementId.startsWith('stable-')) {
                console.log('ç­–ç•¥4: ç¨³å®šIDç‰¹å¾è§£æ');
                const features = elementId.substring(7).split('-');
                const [tagName, className, parentClass, ...rest] = features;
                
                console.log('è§£æçš„ç‰¹å¾:', { tagName, className, parentClass, rest });
                
                let candidates = [];
                
                // æŒ‰æ ‡ç­¾æŸ¥æ‰¾
                if (tagName) {
                    candidates = Array.from(iframeDoc.getElementsByTagName(tagName));
                    console.log(`æŒ‰æ ‡ç­¾${tagName}æ‰¾åˆ°:`, candidates.length);
                }
                
                // æŒ‰ç±»åç­›é€‰
                if (className && className !== 'noclass' && candidates.length > 0) {
                    candidates = candidates.filter(el => el.className.includes(className));
                    console.log(`æŒ‰ç±»å${className}ç­›é€‰å:`, candidates.length);
                }
                
                // æŒ‰çˆ¶å…ƒç´ ç±»åç­›é€‰
                if (parentClass && parentClass !== 'noparent' && candidates.length > 0) {
                    candidates = candidates.filter(el => 
                        el.parentElement && el.parentElement.className.includes(parentClass)
                    );
                    console.log(`æŒ‰çˆ¶ç±»å${parentClass}ç­›é€‰å:`, candidates.length);
                }
                
                // æŒ‰ä½ç½®ç´¢å¼•ç­›é€‰
                const indexMatch = rest.find(f => f.startsWith('idx'));
                if (indexMatch && candidates.length > 1) {
                    const index = parseInt(indexMatch.substring(3));
                    if (!isNaN(index) && index < candidates.length) {
                        const parent = candidates[0].parentElement;
                        if (parent) {
                            const siblings = Array.from(parent.children);
                            if (siblings[index] && candidates.includes(siblings[index])) {
                                candidates = [siblings[index]];
                                console.log(`æŒ‰ç´¢å¼•${index}ç²¾ç¡®å®šä½`);
                            }
                        }
                    }
                }
                
                if (candidates.length > 0) {
                    console.log('ç­–ç•¥4æˆåŠŸ: ç¨³å®šç‰¹å¾åŒ¹é…');
                    return candidates[0];
                }
            }
            
            // ç­–ç•¥5: æ ¹æ®æ–‡æœ¬å†…å®¹æŸ¥æ‰¾
            if (annotation.name) {
                const cleanName = annotation.name.replace(/[ğŸ“ğŸŒ¾ğŸ¥¬âš ï¸ğŸ“ˆğŸ“ŠğŸŒ¤ï¸]/g, '').trim();
                if (cleanName && cleanName !== 'canvas') { // æ’é™¤çº¯canvasæœç´¢
                    const allElements = iframeDoc.querySelectorAll('*');
                    
                    for (const element of allElements) {
                        const text = element.textContent?.trim();
                        if (text && text.includes(cleanName) && element.children.length === 0) {
                            console.log('ç­–ç•¥5æˆåŠŸ: æ–‡æœ¬å†…å®¹æŸ¥æ‰¾');
                            return element;
                        }
                    }
                }
            }
            
            // ç­–ç•¥6: ç±»åéƒ¨åˆ†åŒ¹é…
            const classMatches = elementId.match(/([a-zA-Z-]+)/g);
            if (classMatches) {
                for (const className of classMatches) {
                    if (className.length > 4 && !['stable', 'canvas', 'noclass'].includes(className)) {
                        const elements = iframeDoc.getElementsByClassName(className);
                        if (elements.length > 0) {
                            console.log('ç­–ç•¥6æˆåŠŸ: ç±»ååŒ¹é…');
                            return elements[0];
                        }
                    }
                }
            }
            
            console.log('æ‰€æœ‰ç­–ç•¥éƒ½å¤±è´¥äº†');
            return null;
        }

        // å…¨é¢è¯Šæ–­ç³»ç»Ÿ
        async function comprehensiveDiagnosis() {
            console.log('ğŸ©º å¼€å§‹å…¨é¢è¯Šæ–­...');
            
            const annotationContent = document.getElementById('annotationContent');
            const iframe = document.getElementById('embeddedFrame');
            
            // è¯Šæ–­ç»“æœæ”¶é›†
            const diagnosis = {
                iframe: { accessible: false, crossOrigin: false, loaded: false },
                annotations: { total: 0, accessible: 0, broken: 0 },
                elements: { found: 0, missing: 0, virtual: 0 },
                recommendations: []
            };
            
            // 1. iframeè®¿é—®æ€§è¯Šæ–­
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc && iframeDoc.body) {
                    diagnosis.iframe.accessible = true;
                    diagnosis.iframe.loaded = true;
                    console.log('âœ… iframeå¯è®¿é—®');
                } else {
                    diagnosis.iframe.crossOrigin = true;
                    console.log('âŒ iframeè·¨åŸŸé™åˆ¶');
                }
            } catch (error) {
                diagnosis.iframe.crossOrigin = true;
                console.log('âŒ iframeè®¿é—®å¤±è´¥:', error.message);
            }
            
            // 2. æ‰¹æ³¨æ•°æ®è¯Šæ–­
            diagnosis.annotations.total = Object.values(currentAnnotations).reduce(
                (total, pageAnnotations) => total + Object.keys(pageAnnotations).length, 0
            );
            
            // 3. å…ƒç´ å®šä½è¯Šæ–­
            for (const [pageKey, pageAnnotations] of Object.entries(currentAnnotations)) {
                for (const [elementId, annotation] of Object.entries(pageAnnotations)) {
                    try {
                        const canHighlight = await testElementHighlight(elementId, false);
                        if (canHighlight) {
                            diagnosis.annotations.accessible++;
                        } else {
                            diagnosis.annotations.broken++;
                        }
                    } catch (error) {
                        diagnosis.annotations.broken++;
                    }
                }
            }
            
            // 4. è™šæ‹Ÿå…ƒç´ ç»Ÿè®¡
            const pageKey = getCurrentPageKey();
            const pageElements_current = pageElements[pageKey] || {};
            diagnosis.elements.found = Object.keys(pageElements_current).length;
            diagnosis.elements.virtual = Object.values(pageElements_current).filter(el => el.virtual).length;
            diagnosis.elements.missing = diagnosis.annotations.total - diagnosis.annotations.accessible;
            
            // 5. ç”Ÿæˆå»ºè®®
            if (diagnosis.iframe.crossOrigin) {
                diagnosis.recommendations.push('å»ºè®®ä½¿ç”¨åŒåŸŸiframeæˆ–å®ç°postMessageé€šä¿¡');
            }
            if (diagnosis.annotations.broken > 0) {
                diagnosis.recommendations.push(`å‘ç°${diagnosis.annotations.broken}ä¸ªæ— æ³•å®šä½çš„æ‰¹æ³¨ï¼Œå»ºè®®è¿è¡Œæ‰¹æ³¨ä¿®å¤`);
            }
            if (diagnosis.elements.virtual > 0) {
                diagnosis.recommendations.push('ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨è™šæ‹Ÿå…ƒç´ å®šä½ï¼Œå»ºè®®ä¼˜åŒ–å…ƒç´ æŠ“å–æœºåˆ¶');
            }
            if (diagnosis.annotations.accessible / diagnosis.annotations.total < 0.8) {
                diagnosis.recommendations.push('æ‰¹æ³¨å¯è®¿é—®ç‡è¾ƒä½ï¼Œå»ºè®®é‡æ–°æŠ“å–é¡µé¢å…ƒç´ ');
            }
            
            // 6. æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            annotationContent.innerHTML = `
                <div class="annotation-item">
                    <div class="annotation-title">ğŸ©º ç³»ç»Ÿè¯Šæ–­æŠ¥å‘Š</div>
                    <div style="margin-top: 12px; line-height: 1.6;">
                        <h4 style="color: #00a8ff; margin: 8px 0 4px 0;">ğŸ“± iframeçŠ¶æ€</h4>
                        <div style="font-size: 11px; margin-left: 12px;">
                            <div>â€¢ å¯è®¿é—®: ${diagnosis.iframe.accessible ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>
                            <div>â€¢ è·¨åŸŸé™åˆ¶: ${diagnosis.iframe.crossOrigin ? 'âš ï¸ æ˜¯' : 'âœ… å¦'}</div>
                            <div>â€¢ å·²åŠ è½½: ${diagnosis.iframe.loaded ? 'âœ… æ˜¯' : 'âŒ å¦'}</div>
                        </div>
                        
                        <h4 style="color: #00a8ff; margin: 8px 0 4px 0;">ğŸ“ æ‰¹æ³¨çŠ¶æ€</h4>
                        <div style="font-size: 11px; margin-left: 12px;">
                            <div>â€¢ æ€»æ•°: ${diagnosis.annotations.total}</div>
                            <div>â€¢ å¯å®šä½: <span style="color: #4CAF50">${diagnosis.annotations.accessible}</span></div>
                            <div>â€¢ å¤±æ•ˆ: <span style="color: #f44336">${diagnosis.annotations.broken}</span></div>
                            <div>â€¢ æˆåŠŸç‡: <span style="color: ${diagnosis.annotations.accessible / diagnosis.annotations.total > 0.8 ? '#4CAF50' : '#ff9800'}">${Math.round(diagnosis.annotations.accessible / diagnosis.annotations.total * 100)}%</span></div>
                        </div>
                        
                        <h4 style="color: #00a8ff; margin: 8px 0 4px 0;">ğŸ” å…ƒç´ çŠ¶æ€</h4>
                        <div style="font-size: 11px; margin-left: 12px;">
                            <div>â€¢ å·²è¯†åˆ«: ${diagnosis.elements.found}</div>
                            <div>â€¢ è™šæ‹Ÿå…ƒç´ : ${diagnosis.elements.virtual}</div>
                            <div>â€¢ ç¼ºå¤±: ${diagnosis.elements.missing}</div>
                        </div>
                        
                        ${diagnosis.recommendations.length > 0 ? `
                        <h4 style="color: #ff9800; margin: 8px 0 4px 0;">ğŸ’¡ ä¼˜åŒ–å»ºè®®</h4>
                        <div style="font-size: 11px; margin-left: 12px;">
                            ${diagnosis.recommendations.map(rec => `<div>â€¢ ${rec}</div>`).join('')}
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #404040;">
                            <button onclick="autoFixIssues()" class="nav-button" style="margin: 2px; font-size: 10px; background: #4CAF50;">è‡ªåŠ¨ä¿®å¤</button>
                            <button onclick="exportDiagnosisReport()" class="nav-button" style="margin: 2px; font-size: 10px; background: #2196F3;">å¯¼å‡ºæŠ¥å‘Š</button>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('ğŸ©º è¯Šæ–­å®Œæˆ:', diagnosis);
            return diagnosis;
        }
        
        // æµ‹è¯•å…ƒç´ é«˜äº®ï¼ˆä¸æ˜¾ç¤ºé«˜äº®æ¡†ï¼‰
        async function testElementHighlight(elementId, showHighlight = true) {
            try {
                const pageKey = getCurrentPageKey();
                const elementData = pageElements[pageKey]?.[elementId];
                const annotation = currentAnnotations[pageKey]?.[elementId];
                
                // è™šæ‹Ÿå…ƒç´ æ€»æ˜¯å¯ä»¥é«˜äº®
                if (elementData && elementData.virtual) {
                    if (showHighlight) highlightVirtualElement(elementData);
                    return true;
                }
                
                // åæ ‡å…ƒç´ å¯ä»¥é«˜äº®
                if (elementData && elementData.rect) {
                    if (showHighlight) highlightByCoordinates(elementData);
                    return true;
                }
                
                // æ‰¹æ³¨ä¿¡æ¯å¯ä»¥æ¨æ–­
                if (annotation) {
                    if (showHighlight) highlightByAnnotationInfo(annotation, elementId);
                    return true;
                }
                
                // DOMæŸ¥æ‰¾
                const iframe = document.getElementById('embeddedFrame');
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const element = await findElementByMultipleStrategies(iframeDoc, elementId, annotation);
                    if (element) {
                        if (showHighlight) {
                            // åˆ›å»ºä¸´æ—¶é«˜äº®
                            const rect = element.getBoundingClientRect();
                            const iframeRect = iframe.getBoundingClientRect();
                            const scale = parseFloat(iframe.style.transform?.match(/scale\(([\d.]+)\)/)?.[1] || 1);
                            const left = iframeRect.left + (rect.left * scale);
                            const top = iframeRect.top + (rect.top * scale);
                            const width = rect.width * scale;
                            const height = rect.height * scale;
                            createHighlightOverlay(left, top, width, height, 'DOMå®šä½æˆåŠŸ');
                        }
                        return true;
                    }
                } catch (error) {
                    console.log('DOMæŸ¥æ‰¾å¤±è´¥:', error);
                }
                
                return false;
            } catch (error) {
                console.log('æµ‹è¯•é«˜äº®å¤±è´¥:', error);
                return false;
            }
        }
        
        // æµ‹è¯•æ‰€æœ‰æ‰¹æ³¨
        async function testAllAnnotations() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æ‰€æœ‰æ‰¹æ³¨...');
            
            const results = {
                total: 0,
                success: 0,
                failed: [],
                tested: []
            };
            
            // éå†æ‰€æœ‰æ‰¹æ³¨
            for (const [pageKey, pageAnnotations] of Object.entries(currentAnnotations)) {
                for (const [elementId, annotation] of Object.entries(pageAnnotations)) {
                    results.total++;
                    
                    const success = await testElementHighlight(elementId, false);
                    if (success) {
                        results.success++;
                        results.tested.push({
                            id: elementId,
                            name: annotation.name,
                            status: 'âœ… æˆåŠŸ',
                            page: pageKey
                        });
                    } else {
                        results.failed.push({
                            id: elementId,
                            name: annotation.name,
                            status: 'âŒ å¤±è´¥',
                            page: pageKey
                        });
                    }
                    
                    // ç»™UIä¸€äº›æ—¶é—´æ›´æ–°
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            const annotationContent = document.getElementById('annotationContent');
            annotationContent.innerHTML = `
                <div class="annotation-item">
                    <div class="annotation-title">ğŸ§ª æ‰¹æ³¨æµ‹è¯•æŠ¥å‘Š</div>
                    <div style="margin-top: 12px; line-height: 1.5;">
                        <div style="font-size: 12px; margin-bottom: 8px;">
                            <span style="color: #4CAF50">æˆåŠŸ: ${results.success}</span> / 
                            <span style="color: #f44336">å¤±è´¥: ${results.failed.length}</span> / 
                            <span style="color: #2196F3">æ€»è®¡: ${results.total}</span>
                        </div>
                        
                        ${results.failed.length > 0 ? `
                        <h4 style="color: #f44336; margin: 8px 0 4px 0;">âŒ å¤±è´¥é¡¹ç›®</h4>
                        <div style="max-height: 150px; overflow-y: auto; font-size: 10px;">
                            ${results.failed.map(item => `
                                <div style="margin: 2px 0; padding: 4px; background: rgba(244, 67, 54, 0.1); border-radius: 2px;">
                                    <strong>${item.name}</strong><br>
                                    <span style="color: #999;">ID: ${item.id}</span><br>
                                    <span style="color: #999;">é¡µé¢: ${item.page}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #404040;">
                            <button onclick="highlightNextFailed()" class="nav-button" style="margin: 2px; font-size: 10px;">é€ä¸ªæµ‹è¯•å¤±è´¥é¡¹</button>
                            ${results.failed.length > 0 ? `
                            <button onclick="fixFailedAnnotations()" class="nav-button" style="margin: 2px; font-size: 10px; background: #ff5722;">ä¿®å¤å¤±è´¥é¡¹</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            console.log('ğŸ§ª æµ‹è¯•å®Œæˆ:', results);
            
            // å­˜å‚¨æµ‹è¯•ç»“æœä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨
            window.lastTestResults = results;
            
            alert(`æ‰¹æ³¨æµ‹è¯•å®Œæˆï¼\næˆåŠŸ: ${results.success}\nå¤±è´¥: ${results.failed.length}\næ€»è®¡: ${results.total}`);
        }

        // æµ‹è¯•æ–°çš„ç²¾ç¡®æŠ“å–ç³»ç»Ÿ
        async function testNewCaptureSystem() {
            console.log('ğŸ¯ æµ‹è¯•ç²¾ç¡®æŠ“å–ç³»ç»Ÿ...');
            
            const annotationContent = document.getElementById('annotationContent');
            
            annotationContent.innerHTML = `
                <div class="annotation-item">
                    <div class="annotation-title">ğŸ¯ ç²¾ç¡®æŠ“å–ç³»ç»Ÿæµ‹è¯•</div>
                    <div style="margin-top: 12px; line-height: 1.5;">
                        <div style="background: rgba(0, 168, 255, 0.1); padding: 10px; border-radius: 6px; margin-bottom: 12px;">
                            <h4 style="color: #00a8ff; margin: 0 0 8px 0;">æµ‹è¯•è¯´æ˜</h4>
                            <div style="font-size: 12px;">
                                1. å¼€å¯æ‰¹æ³¨æ¨¡å¼<br>
                                2. ç‚¹å‡»é¡µé¢ä¸­çš„ä»»æ„å…ƒç´ <br>
                                3. ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆç²¾ç¡®çš„å…ƒç´ ç­¾å<br>
                                4. ç«‹å³éªŒè¯å®šä½å‡†ç¡®æ€§<br>
                                5. æ˜¾ç¤ºè¯¦ç»†çš„æŠ“å–ä¿¡æ¯
                            </div>
                        </div>
                        
                        <div style="margin: 12px 0;">
                            <button onclick="toggleAnnotationMode()" class="nav-button" style="background: #4CAF50;">
                                ${isAnnotationMode ? 'âœ… æ‰¹æ³¨æ¨¡å¼å·²å¼€å¯' : 'ğŸ¯ å¼€å¯æ‰¹æ³¨æ¨¡å¼'}
                            </button>
                        </div>
                        
                        <div style="background: rgba(255, 193, 7, 0.1); padding: 10px; border-radius: 6px;">
                            <h4 style="color: #ffc107; margin: 0 0 8px 0;">æ–°ç³»ç»Ÿç‰¹æ€§</h4>
                            <div style="font-size: 11px;">
                                â€¢ ğŸ¯ å¤šé‡é€‰æ‹©å™¨ç”Ÿæˆ (Primary, XPath, CSS, Unique)<br>
                                â€¢ ğŸ“ ç²¾ç¡®ä½ç½®è®°å½• (ç»å¯¹+ç›¸å¯¹+ç´¢å¼•)<br>
                                â€¢ ğŸ§¬ å…ƒç´ ç‰¹å¾ç­¾å (å±æ€§+æ ·å¼+å†…å®¹)<br>
                                â€¢ ğŸ” 5ç§é‡å®šä½ç­–ç•¥<br>
                                â€¢ âœ… å®æ—¶éªŒè¯åŒ¹é…åº¦ (100åˆ†åˆ¶)<br>
                                â€¢ ğŸ”„ æ™ºèƒ½å®¹é”™å’Œé™çº§
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ˜¾ç¤ºå…ƒç´ ç­¾åè¯¦æƒ…
        function showElementSignatures() {
            console.log('ğŸ“‹ æ˜¾ç¤ºå…ƒç´ ç­¾å...');
            
            const pageKey = getCurrentPageKey();
            const pageElements_current = pageElements[pageKey] || {};
            const annotations = currentAnnotations[pageKey] || {};
            
            const annotationContent = document.getElementById('annotationContent');
            
            if (Object.keys(pageElements_current).length === 0) {
                annotationContent.innerHTML = `
                    <div class="annotation-item">
                        <div class="annotation-title">ğŸ“‹ å…ƒç´ ç­¾åæŸ¥çœ‹å™¨</div>
                        <div style="margin-top: 12px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                            <div>æš‚æ— å…ƒç´ ç­¾åæ•°æ®</div>
                            <div style="margin-top: 8px; font-size: 12px;">
                                è¯·å…ˆåˆ›å»ºæ‰¹æ³¨ä»¥ç”Ÿæˆå…ƒç´ ç­¾å
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const signatures = Object.entries(pageElements_current).map(([elementId, signature]) => {
                const annotation = annotations[elementId];
                const signatureData = signature.basic ? signature : null; // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ ¼å¼
                
                return {
                    elementId,
                    signature: signatureData,
                    annotation,
                    hasAnnotation: !!annotation,
                    isNewFormat: !!signatureData
                };
            });
            
            annotationContent.innerHTML = `
                <div class="annotation-item">
                    <div class="annotation-title">ğŸ“‹ å…ƒç´ ç­¾åè¯¦æƒ…</div>
                    <div style="margin-top: 12px; line-height: 1.4;">
                        <div style="margin-bottom: 12px; font-size: 12px;">
                            <span style="color: #4CAF50">æ–°æ ¼å¼: ${signatures.filter(s => s.isNewFormat).length}</span> / 
                            <span style="color: #ff9800">æ—§æ ¼å¼: ${signatures.filter(s => !s.isNewFormat).length}</span> / 
                            <span style="color: #2196F3">æ€»è®¡: ${signatures.length}</span>
                        </div>
                        
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${signatures.map(item => `
                                <div style="margin: 8px 0; padding: 8px; background: ${item.isNewFormat ? 'rgba(76, 175, 80, 0.1)' : 'rgba(255, 152, 0, 0.1)'}; border-radius: 4px; border-left: 3px solid ${item.isNewFormat ? '#4CAF50' : '#ff9800'};">
                                    <div style="font-weight: bold; margin-bottom: 4px;">
                                        ${item.hasAnnotation ? 'ğŸ“' : 'ğŸ”'} ${item.annotation?.name || item.elementId}
                                    </div>
                                    
                                    ${item.isNewFormat ? `
                                    <div style="font-size: 10px; color: #ccc;">
                                        <div><strong>æ ‡ç­¾:</strong> ${item.signature.basic.tagName}</div>
                                        <div><strong>ID:</strong> ${item.signature.basic.id || 'none'}</div>
                                        <div><strong>ç±»å:</strong> ${item.signature.basic.className || 'none'}</div>
                                        <div><strong>å±‚çº§æ·±åº¦:</strong> ${item.signature.hierarchy.depth}</div>
                                        <div><strong>é€‰æ‹©å™¨æ•°é‡:</strong> ${Object.keys(item.signature.selectors).length}</div>
                                        <div><strong>ä½ç½®ç´¢å¼•:</strong> ${item.signature.positioning.siblingIndex.index}/${item.signature.positioning.siblingIndex.total}</div>
                                        <div><strong>æ–‡æœ¬å†…å®¹:</strong> ${item.signature.basic.textContent ? '"' + item.signature.basic.textContent.substring(0, 20) + '..."' : 'none'}</div>
                                    </div>
                                    ` : `
                                    <div style="font-size: 10px; color: #ff9800;">
                                        æ—§æ ¼å¼æ•°æ® - å»ºè®®è¿è¡Œæ‰¹æ³¨ä¿®å¤å‡çº§
                                    </div>
                                    `}
                                    
                                    <div style="margin-top: 6px;">
                                        <button onclick="testSignatureRelocation('${item.elementId}')" class="nav-button" style="font-size: 9px; padding: 2px 6px;">æµ‹è¯•å®šä½</button>
                                        ${item.isNewFormat ? `
                                        <button onclick="showDetailedSignature('${item.elementId}')" class="nav-button" style="font-size: 9px; padding: 2px 6px; margin-left: 4px;">è¯¦ç»†ä¿¡æ¯</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #404040;">
                            <button onclick="upgradeAllSignatures()" class="nav-button" style="font-size: 10px; background: #ff9800;">å‡çº§æ—§æ ¼å¼ç­¾å</button>
                            <button onclick="exportSignatures()" class="nav-button" style="font-size: 10px; margin-left: 6px; background: #2196F3;">å¯¼å‡ºç­¾åæ•°æ®</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æµ‹è¯•ç­¾åé‡å®šä½
        async function testSignatureRelocation(elementId) {
            console.log('ğŸ” æµ‹è¯•ç­¾åé‡å®šä½:', elementId);
            
            try {
                const iframe = document.getElementById('embeddedFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                const pageKey = getCurrentPageKey();
                const signature = pageElements[pageKey]?.[elementId];
                
                if (!signature) {
                    alert('ç­¾åæ•°æ®ä¸å­˜åœ¨');
                    return;
                }
                
                if (!signature.basic) {
                    alert('è¿™æ˜¯æ—§æ ¼å¼ç­¾åï¼Œè¯·å…ˆå‡çº§');
                    return;
                }
                
                const startTime = performance.now();
                const foundElement = relocateElementBySignature(signature, iframeDoc);
                const endTime = performance.now();
                
                const duration = Math.round(endTime - startTime);
                
                if (foundElement) {
                    // é«˜äº®æ‰¾åˆ°çš„å…ƒç´ 
                    highlightElement(elementId);
                    
                    // éªŒè¯åŒ¹é…åº¦
                    const validation = signature.validate(foundElement);
                    
                    alert(`ğŸ¯ é‡å®šä½æˆåŠŸï¼\n\n` +
                          `è€—æ—¶: ${duration}ms\n` +
                          `åŒ¹é…åˆ†æ•°: ${validation.score}/100\n` +
                          `ç½®ä¿¡åº¦: ${Math.round(validation.confidence * 100)}%\n` +
                          `åŒ¹é…åŸå› : ${validation.reasons.join(', ')}`);
                } else {
                    alert(`âŒ é‡å®šä½å¤±è´¥\n\nè€—æ—¶: ${duration}ms\nè¯·æ£€æŸ¥å…ƒç´ æ˜¯å¦ä»ç„¶å­˜åœ¨äºé¡µé¢ä¸­`);
                }
                
            } catch (error) {
                console.error('æµ‹è¯•é‡å®šä½å¤±è´¥:', error);
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºè¯¦ç»†ç­¾åä¿¡æ¯
        function showDetailedSignature(elementId) {
            const pageKey = getCurrentPageKey();
            const signature = pageElements[pageKey]?.[elementId];
            
            if (!signature || !signature.basic) {
                alert('ç­¾åæ•°æ®ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯');
                return;
            }
            
            const details = {
                'åŸºç¡€ä¿¡æ¯': signature.basic,
                'å±‚çº§è·¯å¾„': signature.hierarchy,
                'å±æ€§ç‰¹å¾': signature.attributes,
                'ä½ç½®ä¿¡æ¯': signature.positioning,
                'æ ·å¼ç‰¹å¾': signature.styleFeatures,
                'å†…å®¹ç‰¹å¾': signature.contentFeatures,
                'é€‰æ‹©å™¨åˆ—è¡¨': signature.selectors
            };
            
            let output = `ğŸ“‹ å…ƒç´ ç­¾åè¯¦ç»†ä¿¡æ¯\n\nID: ${signature.id}\næ—¶é—´æˆ³: ${new Date(signature.timestamp).toLocaleString()}\n\n`;
            
            for (let [category, data] of Object.entries(details)) {
                output += `${category}:\n${JSON.stringify(data, null, 2)}\n\n`;
            }
            
            console.log('è¯¦ç»†ç­¾åä¿¡æ¯:', signature);
            
            // åˆ›å»ºä¸€ä¸ªå¯å¤åˆ¶çš„å¼¹çª—
            const textarea = document.createElement('textarea');
            textarea.value = output;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            alert('ğŸ“‹ è¯¦ç»†ç­¾åä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nä¹Ÿå¯ä»¥åœ¨æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ•°æ®ã€‚');
        }

        // ä¿å­˜æ‰¹æ³¨æ•°æ®
        async function saveAnnotations() {
            try {
                // ä½¿ç”¨APIå®¢æˆ·ç«¯ä¿å­˜æ•°æ®
                const success = await apiClient.saveAnnotations(currentAnnotations);
                
                if (success && CURRENT_ENV.enableRealTimeSync) {
                    console.log('âœ… æ‰¹æ³¨æ•°æ®å·²ä¿å­˜åˆ°æœåŠ¡å™¨');
                } else {
                    console.log('âœ… æ‰¹æ³¨æ•°æ®å·²å¯¼å‡ºåˆ°æœ¬åœ°');
                }
                
                return success;
            } catch (error) {
                console.error('ä¿å­˜æ‰¹æ³¨æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }

        // é€šè¿‡ä¸‹è½½æ–¹å¼ä¿å­˜æ‰¹æ³¨æ•°æ®
        function downloadAnnotations() {
            // éªŒè¯å’Œæ¸…ç†æ‰¹æ³¨æ•°æ®
            const cleanedAnnotations = cleanAnnotationsForSave(currentAnnotations);
            
            const dataStr = JSON.stringify(cleanedAnnotations, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            // ä½¿ç”¨æ—¶é—´æˆ³å‘½åæ–‡ä»¶
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            link.download = `annotations-${timestamp}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log('âœ… æ‰¹æ³¨æ•°æ®å·²å¯¼å‡º:', `annotations-${timestamp}.json`);
        }

        // éªŒè¯å¹¶è¿ç§»æ‰¹æ³¨æ•°æ®æ ¼å¼
        function validateAndMigrateAnnotations(annotations) {
            console.log('ğŸ”„ å¼€å§‹éªŒè¯å’Œè¿ç§»æ‰¹æ³¨æ•°æ®æ ¼å¼...');
            const migrated = {};
            
            Object.keys(annotations).forEach(pageKey => {
                migrated[pageKey] = {};
                
                Object.keys(annotations[pageKey]).forEach(elementId => {
                    const annotation = annotations[pageKey][elementId];
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ ¼å¼
                    const hasSmartSelector = annotation.targetInfo?.smartSelector;
                    const hasElementFingerprint = annotation.targetInfo?.elementFingerprint;
                    
                    if (hasSmartSelector && hasElementFingerprint) {
                        // å·²ç»æ˜¯æ–°æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                        console.log('âœ… æ–°æ ¼å¼æ‰¹æ³¨:', elementId);
                        migrated[pageKey][elementId] = annotation;
                    } else {
                        // æ—§æ ¼å¼ï¼Œéœ€è¦è¿ç§»
                        console.log('ğŸ”„ è¿ç§»æ—§æ ¼å¼æ‰¹æ³¨:', elementId);
                        migrated[pageKey][elementId] = migrateOldAnnotation(annotation, elementId);
                    }
                });
            });
            
            console.log('âœ… æ‰¹æ³¨æ•°æ®æ ¼å¼è¿ç§»å®Œæˆ');
            return migrated;
        }
        
        // è¿ç§»æ—§æ ¼å¼æ‰¹æ³¨åˆ°æ–°æ ¼å¼
        function migrateOldAnnotation(oldAnnotation, elementId) {
            console.log('ğŸ”„ è¿ç§»æ‰¹æ³¨:', elementId, oldAnnotation);
            
            // ä»æ—§çš„selectorç”Ÿæˆæ™ºèƒ½é€‰æ‹©å™¨
            const oldSelector = oldAnnotation.targetInfo?.selector || '';
            const smartSelector = oldSelector || 'div'; // å¦‚æœæ²¡æœ‰é€‰æ‹©å™¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
            
            // ä»æ—§æ•°æ®ç”Ÿæˆå…ƒç´ æŒ‡çº¹
            const elementFingerprint = {
                tagName: 'DIV', // é»˜è®¤å€¼ï¼Œå®é™…åº”è¯¥ä»é€‰æ‹©å™¨æ¨æ–­
                className: extractClassFromSelector(oldSelector),
                textContent: oldAnnotation.name || '', // ä½¿ç”¨æ‰¹æ³¨åç§°ä½œä¸ºæ–‡æœ¬å†…å®¹
                attributes: {},
                position: {
                    offsetLeft: oldAnnotation.targetInfo?.pageX || 0,
                    offsetTop: oldAnnotation.targetInfo?.pageY || 0,
                    offsetWidth: oldAnnotation.targetInfo?.width || 0,
                    offsetHeight: oldAnnotation.targetInfo?.height || 0
                },
                chartType: null
            };
            
            // ç”Ÿæˆå¤‡ç”¨é€‰æ‹©å™¨
            const fallbackSelector = extractClassFromSelector(oldSelector) || 'div';
            
            return {
                name: oldAnnotation.name || '',
                content: oldAnnotation.content || '',
                timestamp: oldAnnotation.timestamp || new Date().toLocaleString('zh-CN'),
                elementId: elementId,
                targetInfo: {
                    smartSelector: smartSelector,
                    elementFingerprint: elementFingerprint,
                    fallbackSelector: fallbackSelector,
                    textContent: oldAnnotation.name || '',
                    pageUrl: oldAnnotation.targetInfo?.pageUrl || '',
                    timestamp: oldAnnotation.targetInfo?.timestamp || new Date().toISOString()
                }
            };
        }
        
        // ä»é€‰æ‹©å™¨ä¸­æå–ç±»å
        function extractClassFromSelector(selector) {
            if (!selector) return '';
            
            // æå–æœ€åä¸€ä¸ªç±»å
            const classMatches = selector.match(/\.([a-zA-Z0-9_-]+)/g);
            if (classMatches && classMatches.length > 0) {
                return classMatches[classMatches.length - 1].substring(1); // å»æ‰ç‚¹å·
            }
            
            return '';
        }

        // æ¸…ç†æ‰¹æ³¨æ•°æ®ç”¨äºä¿å­˜
        function cleanAnnotationsForSave(annotations) {
            const cleaned = {};
            
            Object.keys(annotations).forEach(pageKey => {
                cleaned[pageKey] = {};
                
                Object.keys(annotations[pageKey]).forEach(elementId => {
                    const annotation = annotations[pageKey][elementId];
                    
                    // åˆ›å»ºæ¸…ç†åçš„æ‰¹æ³¨å¯¹è±¡
                    cleaned[pageKey][elementId] = {
                        name: annotation.name || '',
                        content: annotation.content || '',
                        timestamp: annotation.timestamp || new Date().toLocaleString('zh-CN'),
                        elementId: elementId,
                        targetInfo: {
                            smartSelector: annotation.targetInfo?.smartSelector || '',
                            elementFingerprint: {
                                tagName: annotation.targetInfo?.elementFingerprint?.tagName || '',
                                className: annotation.targetInfo?.elementFingerprint?.className || '',
                                textContent: annotation.targetInfo?.elementFingerprint?.textContent || '',
                                attributes: annotation.targetInfo?.elementFingerprint?.attributes || {},
                                position: annotation.targetInfo?.elementFingerprint?.position || {
                                    offsetLeft: 0,
                                    offsetTop: 0,
                                    offsetWidth: 0,
                                    offsetHeight: 0
                                },
                                chartType: annotation.targetInfo?.elementFingerprint?.chartType || null
                            },
                            fallbackSelector: annotation.targetInfo?.fallbackSelector || '',
                            textContent: annotation.targetInfo?.textContent || '',
                            pageUrl: annotation.targetInfo?.pageUrl || '',
                            timestamp: annotation.targetInfo?.timestamp || new Date().toISOString()
                        }
                    };
                });
            });
            
            return cleaned;
        }

        // è‡ªåŠ¨æ£€æµ‹å½“å‰æ¿€æ´»çš„åŠŸèƒ½é¡µé¢
        function detectCurrentFunction() {
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) {
                console.warn('æ— æ³•è®¿é—®iframeï¼Œä½¿ç”¨é»˜è®¤åŠŸèƒ½');
                return currentFunction;
            }
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) {
                console.warn('æ— æ³•è®¿é—®iframeæ–‡æ¡£ï¼Œä½¿ç”¨é»˜è®¤åŠŸèƒ½');
                return currentFunction;
            }
            
            try {
                // æŸ¥æ‰¾æ¿€æ´»çš„ä¸»åŠŸèƒ½æŒ‰é’®
                const activeMainBtn = iframeDoc.querySelector('.main-switch-btn.active');
                if (activeMainBtn) {
                    const detectedFunction = activeMainBtn.getAttribute('data-function');
                    if (detectedFunction && detectedFunction !== currentFunction) {
                        console.log(`ğŸ”„ æ£€æµ‹åˆ°é¡µé¢åŠŸèƒ½å˜åŒ–: ${currentFunction} â†’ ${detectedFunction}`);
                        currentFunction = detectedFunction;
                        
                        // æ›´æ–°é¡µé¢å…ƒç´ æ¸…å•å’Œç³»ç»ŸçŠ¶æ€
                        setTimeout(() => {
                            updateElementList();
                            updateSystemStatus();
                        }, 500);
                    }
                    return detectedFunction;
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¿€æ´»æŒ‰é’®ï¼Œå°è¯•ä»URLæˆ–é¡µé¢å†…å®¹æ¨æ–­
                const url = iframe.contentWindow.location.href;
                if (url.includes('growth-analysis')) {
                    return 'growth-analysis';
                } else if (url.includes('yield-estimation')) {
                    return 'yield-estimation';
                } else if (url.includes('weather-monitoring')) {
                    return 'weather-monitoring';
                } else if (url.includes('disaster-monitoring')) {
                    return 'disaster-monitoring';
                } else {
                    return 'crop-distribution'; // é»˜è®¤å€¼
                }
            } catch (error) {
                console.warn('æ£€æµ‹å½“å‰åŠŸèƒ½æ—¶å‡ºé”™:', error);
                return currentFunction;
            }
        }

        // è·å–å½“å‰é¡µé¢å’ŒåŠŸèƒ½çš„å”¯ä¸€æ ‡è¯†
        function getCurrentPageKey() {
            // å…ˆæ£€æµ‹å½“å‰å®é™…çš„åŠŸèƒ½çŠ¶æ€
            const detectedFunction = detectCurrentFunction();
            const currentPage = pages[currentPageIndex];
            return `${currentPage}-${detectedFunction}`;
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šåŠŸèƒ½é¡µé¢
        function switchToFunction(targetFunction) {
            console.log(`ğŸ”„ åˆ‡æ¢åˆ°åŠŸèƒ½é¡µé¢: ${targetFunction}`);
            
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) {
                console.error('æ— æ³•è®¿é—®iframe');
                return;
            }
            
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!iframeDoc) {
                    console.error('æ— æ³•è®¿é—®iframeæ–‡æ¡£');
                    return;
                }
                
                // æŸ¥æ‰¾ç›®æ ‡åŠŸèƒ½æŒ‰é’®
                const targetBtn = iframeDoc.querySelector(`[data-function="${targetFunction}"]`);
                if (targetBtn) {
                    // ç§»é™¤å½“å‰æ¿€æ´»çŠ¶æ€
                    const currentActiveBtn = iframeDoc.querySelector('.main-switch-btn.active');
                    if (currentActiveBtn) {
                        currentActiveBtn.classList.remove('active');
                    }
                    
                    // æ¿€æ´»ç›®æ ‡æŒ‰é’®
                    targetBtn.classList.add('active');
                    
                    // æ›´æ–°currentFunctionå˜é‡
                    currentFunction = targetFunction;
                    
                    // è§¦å‘ç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœæœ‰ç›¸å…³çš„JavaScripté€»è¾‘ï¼‰
                    targetBtn.click();
                    
                    // å»¶è¿Ÿæ›´æ–°å…ƒç´ æ¸…å•å’Œç³»ç»ŸçŠ¶æ€
                    setTimeout(() => {
                        updateElementList();
                        updateSystemStatus();
                        console.log(`âœ… å·²åˆ‡æ¢åˆ° ${targetFunction} é¡µé¢`);
                    }, 500);
                } else {
                    console.error(`æ‰¾ä¸åˆ°åŠŸèƒ½æŒ‰é’®: ${targetFunction}`);
                    alert(`æ— æ³•æ‰¾åˆ° "${targetFunction}" åŠŸèƒ½æŒ‰é’®`);
                }
            } catch (error) {
                console.error('åˆ‡æ¢åŠŸèƒ½é¡µé¢æ—¶å‡ºé”™:', error);
                alert('åˆ‡æ¢é¡µé¢å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨é¡µé¢çŠ¶æ€ç›‘å¬
        function startPageStateMonitoring() {
            console.log('ğŸ” å¯åŠ¨é¡µé¢çŠ¶æ€ç›‘å¬å™¨');
            
            // å®šæœŸæ£€æµ‹é¡µé¢çŠ¶æ€å˜åŒ–
            setInterval(() => {
                try {
                    const iframe = document.getElementById('embeddedFrame');
                    if (iframe && iframe.contentWindow && iframe.contentDocument) {
                        detectCurrentFunction();
                    }
                } catch (error) {
                    console.warn('é¡µé¢çŠ¶æ€æ£€æµ‹å¤±è´¥:', error);
                }
            }, 2000); // æ¯2ç§’æ£€æµ‹ä¸€æ¬¡
            
            // ç›‘å¬iframeçš„ç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœå¯èƒ½ï¼‰
            try {
                const iframe = document.getElementById('embeddedFrame');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.addEventListener('click', () => {
                        // å»¶è¿Ÿæ£€æµ‹ï¼Œç­‰å¾…ç‚¹å‡»äº‹ä»¶å®Œæˆ
                        setTimeout(() => {
                            detectCurrentFunction();
                        }, 300);
                    });
                }
            } catch (error) {
                console.warn('æ— æ³•ç›‘å¬iframeç‚¹å‡»äº‹ä»¶:', error);
            }
        }

        // æ›´æ–°æ‰¹æ³¨å¯¼èˆªçŠ¶æ€
        function updateAnnotationNavigation() {
            const detectedFunction = detectCurrentFunction();
            const currentPageKey = getCurrentPageKey();
            const currentPageAnnotations = currentAnnotations[currentPageKey] || {};
            
            // æ›´æ–°å½“å‰é¡µé¢æ‰¹æ³¨åˆ—è¡¨
            currentPageAnnotationList = Object.keys(currentPageAnnotations);
            
            const navigationDiv = document.getElementById('annotationNavigation');
            const prevBtn = document.getElementById('prevAnnotationBtn');
            const nextBtn = document.getElementById('nextAnnotationBtn');
            const counter = document.getElementById('annotationCounter');
            
            if (currentPageAnnotationList.length > 0) {
                // æœ‰æ‰¹æ³¨æ—¶æ˜¾ç¤ºå¯¼èˆª
                navigationDiv.style.display = 'block';
                
                // ç¡®ä¿å½“å‰ç´¢å¼•æœ‰æ•ˆ
                if (selectedElementId) {
                    const selectedIndex = currentPageAnnotationList.indexOf(selectedElementId);
                    if (selectedIndex !== -1) {
                        currentAnnotationIndex = selectedIndex;
                    }
                } else if (currentAnnotationIndex >= currentPageAnnotationList.length) {
                    currentAnnotationIndex = 0;
                }
                
                // æ›´æ–°è®¡æ•°å™¨
                counter.textContent = `${currentAnnotationIndex + 1}/${currentPageAnnotationList.length}`;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const hasMultiple = currentPageAnnotationList.length > 1;
                prevBtn.disabled = !hasMultiple || currentAnnotationIndex === 0;
                nextBtn.disabled = !hasMultiple || currentAnnotationIndex === currentPageAnnotationList.length - 1;
                
                // è®¾ç½®æŒ‰é’®æ ·å¼
                prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
                
            } else {
                // æ²¡æœ‰æ‰¹æ³¨æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€å¯¼èˆª
                navigationDiv.style.display = 'block';
                counter.textContent = '0/0';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                prevBtn.style.opacity = '0.3';
                nextBtn.style.opacity = '0.3';
                prevBtn.style.cursor = 'not-allowed';
                nextBtn.style.cursor = 'not-allowed';
            }
        }

        // å¯¼èˆªåˆ°ä¸Šä¸€ä¸ªæ‰¹æ³¨
        function navigateToPreviousAnnotation() {
            if (currentPageAnnotationList.length === 0) return;
            
            currentAnnotationIndex = Math.max(0, currentAnnotationIndex - 1);
            const targetElementId = currentPageAnnotationList[currentAnnotationIndex];
            
            console.log(`ğŸ”¼ å¯¼èˆªåˆ°ä¸Šä¸€ä¸ªæ‰¹æ³¨: ${targetElementId} (${currentAnnotationIndex + 1}/${currentPageAnnotationList.length})`);
            
            // é€‰ä¸­å¹¶é«˜äº®ç›®æ ‡æ‰¹æ³¨
            selectElementFromAnnotation(detectCurrentFunction(), targetElementId);
        }

        // å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªæ‰¹æ³¨
        function navigateToNextAnnotation() {
            if (currentPageAnnotationList.length === 0) return;
            
            currentAnnotationIndex = Math.min(currentPageAnnotationList.length - 1, currentAnnotationIndex + 1);
            const targetElementId = currentPageAnnotationList[currentAnnotationIndex];
            
            console.log(`ğŸ”½ å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªæ‰¹æ³¨: ${targetElementId} (${currentAnnotationIndex + 1}/${currentPageAnnotationList.length})`);
            
            // é€‰ä¸­å¹¶é«˜äº®ç›®æ ‡æ‰¹æ³¨
            selectElementFromAnnotation(detectCurrentFunction(), targetElementId);
        }

        // è®¾ç½®é”®ç›˜å¿«æ·é”®
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(event) {
                // åªåœ¨éè¾“å…¥å…ƒç´ æ—¶å“åº”å¿«æ·é”®
                if (event.target.tagName === 'INPUT' || 
                    event.target.tagName === 'TEXTAREA' || 
                    event.target.contentEditable === 'true') {
                    return;
                }
                
                // ä¸Šä¸€ä¸ªæ‰¹æ³¨: å·¦ç®­å¤´æˆ– J é”®
                if (event.key === 'ArrowLeft' || event.key === 'j' || event.key === 'J') {
                    event.preventDefault();
                    navigateToPreviousAnnotation();
                }
                
                // ä¸‹ä¸€ä¸ªæ‰¹æ³¨: å³ç®­å¤´æˆ– K é”®
                if (event.key === 'ArrowRight' || event.key === 'k' || event.key === 'K') {
                    event.preventDefault();
                    navigateToNextAnnotation();
                }
                
                console.log('é”®ç›˜å¿«æ·é”®:', event.key);
            });
            
            console.log('ğŸ¹ é”®ç›˜å¿«æ·é”®å·²è®¾ç½®: â† â†’ J K é”®å¯åˆ‡æ¢æ‰¹æ³¨');
        }

        // æŠ“å–é¡µé¢å…ƒç´ 
        function extractPageElements(iframeDoc) {
            const pageKey = getCurrentPageKey();
            pageElements[pageKey] = {};

            try {
                // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«panel-headerçš„å…ƒç´ 
                const panelHeaders = iframeDoc.querySelectorAll('.panel-header, [class*="panel-title"], [class*="title"]');
                
                panelHeaders.forEach((element, index) => {
                    const titleElement = element.querySelector('.panel-title') || element;
                    const title = titleElement.textContent.trim();
                    
                    if (title) {
                        const elementId = `element-${index}`;
                        const rect = element.getBoundingClientRect();
                        
                        pageElements[pageKey][elementId] = {
                            id: elementId,
                            name: title,
                            desc: `é¡µé¢å…ƒç´ : ${element.className}`,
                            element: element,
                            rect: {
                                top: rect.top,
                                left: rect.left,
                                width: rect.width,
                                height: rect.height
                            },
                            selector: generateElementSelector(element)
                        };
                    }
                });

                // æŸ¥æ‰¾å…¶ä»–é‡è¦å…ƒç´ 
                const otherElements = iframeDoc.querySelectorAll('.widget, .chart, .map, .button, [id], [class*="btn"]');
                otherElements.forEach((element, index) => {
                    const elementId = `other-${index}`;
                    if (!pageElements[pageKey][elementId]) {
                        const name = element.id || element.className.split(' ')[0] || element.tagName;
                        const rect = element.getBoundingClientRect();
                        
                        if (rect.width > 50 && rect.height > 20) { // è¿‡æ»¤å¤ªå°çš„å…ƒç´ 
                            pageElements[pageKey][elementId] = {
                                id: elementId,
                                name: name,
                                desc: `${element.tagName.toLowerCase()}å…ƒç´ `,
                                element: element,
                                rect: {
                                    top: rect.top,
                                    left: rect.left,
                                    width: rect.width,
                                    height: rect.height
                                },
                                selector: generateElementSelector(element)
                            };
                        }
                    }
                });

                updateElementList();
            } catch (error) {
                console.log('æŠ“å–é¡µé¢å…ƒç´ å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆç²¾ç¡®çš„å…ƒç´ é€‰æ‹©å™¨ - æ”¹è¿›ç‰ˆ
        function generateElementSelector(element) {
            // ç­–ç•¥1: ä¼˜å…ˆä½¿ç”¨IDé€‰æ‹©å™¨
            if (element.id) {
                return `#${element.id}`;
            }
            
            // ç­–ç•¥2: ä½¿ç”¨dataå±æ€§
            if (element.dataset && element.dataset.function) {
                return `[data-function="${element.dataset.function}"]`;
            }
            
            // ç­–ç•¥3: ç”Ÿæˆå¤åˆé€‰æ‹©å™¨è·¯å¾„
            const selectorParts = [];
            let currentElement = element;
            let depth = 0;
            const maxDepth = 4;
            
            while (currentElement && currentElement !== document.body && depth < maxDepth) {
                let selector = currentElement.nodeName.toLowerCase();
                
                // æ·»åŠ IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (currentElement.id) {
                    selector += `#${currentElement.id}`;
                    selectorParts.unshift(selector);
                    break; // IDæ˜¯å”¯ä¸€çš„ï¼Œå¯ä»¥åœæ­¢
                }
                
                // æ·»åŠ é‡è¦çš„ç±»å
                if (currentElement.className) {
                    const classes = currentElement.className.split(' ').filter(cls => 
                        cls && !cls.includes('active') && !cls.includes('hover')
                    );
                    if (classes.length > 0) {
                        selector += '.' + classes.slice(0, 2).join('.');
                    }
                }
                
                // æ·»åŠ nth-childä»¥æé«˜ç²¾ç¡®æ€§
                const siblings = currentElement.parentElement ? 
                    Array.from(currentElement.parentElement.children).filter(
                        sibling => sibling.tagName === currentElement.tagName
                    ) : [];
                    
                if (siblings.length > 1) {
                    const index = siblings.indexOf(currentElement) + 1;
                    selector += `:nth-child(${index})`;
                }
                
                selectorParts.unshift(selector);
                currentElement = currentElement.parentElement;
                depth++;
            }
            
            // ç­–ç•¥4: åŸºäºæ–‡æœ¬å†…å®¹çš„å¤‡ç”¨é€‰æ‹©å™¨
            const textContent = element.textContent ? element.textContent.trim() : '';
            if (textContent && textContent.length < 50) {
                selectorParts.push(`[textContent*="${textContent.substring(0, 20)}"]`);
            }
            
            const finalSelector = selectorParts.join(' > ');
            console.log('ç”Ÿæˆçš„é€‰æ‹©å™¨:', finalSelector);
            return finalSelector;
        }

        // æ›´æ–°é¡µé¢å…ƒç´ æ¸…å•
        function updateElementList() {
            const elementList = document.getElementById('elementList');
            const currentPage = pages[currentPageIndex];
            
            // æ”¶é›†æ‰€æœ‰ç›¸å…³åŠŸèƒ½çš„æ‰¹æ³¨
            const allRelatedAnnotations = {};
            const functionKeys = Object.keys(functionConfigs);
            
            functionKeys.forEach(funcKey => {
                const pageKey = `${currentPage}-${funcKey}`;
                const pageAnnotations = currentAnnotations[pageKey] || {};
                if (Object.keys(pageAnnotations).length > 0) {
                    allRelatedAnnotations[funcKey] = {
                        title: functionConfigs[funcKey].title,
                        annotations: pageAnnotations
                    };
                }
            });
            
            console.log('=== æ›´æ–°å…ƒç´ æ¸…å• ===');
            console.log('å½“å‰é¡µé¢:', currentPage);
            console.log('å½“å‰åŠŸèƒ½:', currentFunction);
            console.log('åŠŸèƒ½é”®åˆ—è¡¨:', functionKeys);
            console.log('æ‰€æœ‰æ‰¹æ³¨æ•°æ®:', currentAnnotations);
            console.log('ç›¸å…³åŠŸèƒ½æ‰¹æ³¨:', allRelatedAnnotations);
            console.log('æ‰¾åˆ°çš„æ‰¹æ³¨æ•°é‡:', Object.keys(allRelatedAnnotations).length);
            
            // ç”ŸæˆæŒ‰åŠŸèƒ½åˆ†ç»„çš„æ‰¹æ³¨æ˜¾ç¤º
            let htmlContent = '';
            
            // è·å–å½“å‰é¡µé¢çš„åŠŸèƒ½é”®
            const detectedFunction = detectCurrentFunction();
            const currentPageKey = getCurrentPageKey();
            const currentFunctionAnnotations = currentAnnotations[currentPageKey] || {};
            
            if (Object.keys(allRelatedAnnotations).length === 0) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å› ä¸ºå½“å‰åŠŸèƒ½é¡µé¢æ²¡æœ‰æ‰¹æ³¨æ•°æ®
                const functionTitle = functionConfigs[detectedFunction]?.title || detectedFunction;
                
                htmlContent = `
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                        <div style="margin-bottom: 8px;">å½“å‰é¡µé¢ï¼š${functionTitle}</div>
                        <div style="margin-bottom: 12px;">æš‚æ— æ‰¹æ³¨å†…å®¹</div>
                        <div style="font-size: 12px; color: #666; line-height: 1.4;">
                            ğŸ’¡ æç¤ºï¼š<br>
                            â€¢ ç›®å‰ä»…æœ‰ "ä½œç‰©åˆ†å¸ƒ" é¡µé¢çš„æ‰¹æ³¨æ•°æ®<br>
                            â€¢ å…¶ä»–é¡µé¢çš„æ‰¹æ³¨æ­£åœ¨å®Œå–„ä¸­<br>
                            â€¢ æ‚¨å¯ä»¥å¼€å¯æ‰¹æ³¨æ¨¡å¼ä¸ºå½“å‰é¡µé¢æ·»åŠ æ‰¹æ³¨
                        </div>
                        <div style="margin-top: 12px;">
                            <button onclick="switchToFunction('crop-distribution')" 
                                    style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                ğŸ“‹ æŸ¥çœ‹ä½œç‰©åˆ†å¸ƒæ‰¹æ³¨
                            </button>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px;">
                            å¼€å¯æ‰¹æ³¨æ¨¡å¼ï¼Œç‚¹å‡»é¡µé¢å…ƒç´ å³å¯æ·»åŠ æ‰¹æ³¨
                        </div>
                    </div>
                `;
            } else {
                // åªæ˜¾ç¤ºå½“å‰åŠŸèƒ½é¡µé¢çš„æ‰¹æ³¨
                const currentPageAnnotations = currentAnnotations[currentPageKey] || {};
                
                // ç›´æ¥æ˜¾ç¤ºå½“å‰é¡µé¢çš„æ‰¹æ³¨ï¼Œä¸è¦åŒ…è£…å®¹å™¨
                if (Object.keys(currentPageAnnotations).length > 0) {
                    Object.entries(currentPageAnnotations).forEach(([elementId, annotation]) => {
                        const isSelected = selectedElementId === elementId;
                        htmlContent += `
                            <div class="element-item ${isSelected ? 'active' : ''}" 
                                 onclick="selectElementFromAnnotation('${detectedFunction}', '${elementId}')" 
                                 data-element-id="${elementId}"
                                 style="margin: 4px 0; border: 1px solid #606060; border-radius: 4px; padding: 6px 8px; cursor: pointer; transition: all 0.2s;">
                                <div class="element-name" style="font-size: 11px; font-weight: bold; margin-bottom: 2px;">
                                    ğŸ“ ${annotation.name}
                                </div>
                                <div class="element-desc" style="font-size: 10px; color: #ccc; line-height: 1.3;">
                                    ${annotation.content ? annotation.content.substring(0, 80) + (annotation.content.length > 80 ? '...' : '') : 'æ— æè¿°'}
                                </div>
                                <div style="font-size: 9px; color: #999; margin-top: 4px;">
                                    ${annotation.timestamp}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // å½“å‰é¡µé¢æ²¡æœ‰æ‰¹æ³¨æ—¶çš„æç¤º
                    const functionTitle = functionConfigs[detectedFunction]?.title || detectedFunction;
                    htmlContent = `
                        <div style="text-align: center; color: #999; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                            <div style="margin-bottom: 8px;">å½“å‰é¡µé¢ï¼š${functionTitle}</div>
                            <div style="margin-bottom: 12px;">æš‚æ— æ‰¹æ³¨å†…å®¹</div>
                            <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                ğŸ’¡ æç¤ºï¼š<br>
                                â€¢ ç›®å‰ä»…æœ‰ "ä½œç‰©åˆ†å¸ƒ" é¡µé¢çš„æ‰¹æ³¨æ•°æ®<br>
                                â€¢ å…¶ä»–é¡µé¢çš„æ‰¹æ³¨æ­£åœ¨å®Œå–„ä¸­<br>
                                â€¢ æ‚¨å¯ä»¥å¼€å¯æ‰¹æ³¨æ¨¡å¼ä¸ºå½“å‰é¡µé¢æ·»åŠ æ‰¹æ³¨
                            </div>
                            <div style="margin-top: 12px;">
                                <button onclick="switchToFunction('crop-distribution')" 
                                        style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ğŸ“‹ æŸ¥çœ‹ä½œç‰©åˆ†å¸ƒæ‰¹æ³¨
                                </button>
                            </div>
                            <div style="margin-top: 8px; font-size: 12px;">
                                å¼€å¯æ‰¹æ³¨æ¨¡å¼ï¼Œç‚¹å‡»é¡µé¢å…ƒç´ å³å¯æ·»åŠ æ‰¹æ³¨
                            </div>
                        </div>
                    `;
                }
                
            }
            
            elementList.innerHTML = htmlContent;
            
            // æ›´æ–°æ‰¹æ³¨å¯¼èˆªçŠ¶æ€
            updateAnnotationNavigation();
        }
        
        // ä»æ‰¹æ³¨é€‰æ‹©å…ƒç´ ï¼ˆè·¨åŠŸèƒ½ï¼‰
        async function selectElementFromAnnotation(functionKey, elementId) {
            console.log('selectElementFromAnnotation è¢«è°ƒç”¨:', { functionKey, elementId, currentFunction });
            
            // å¦‚æœä¸æ˜¯å½“å‰åŠŸèƒ½ï¼Œåˆ‡æ¢åˆ°å¯¹åº”åŠŸèƒ½
            if (functionKey !== currentFunction) {
                console.log('åˆ‡æ¢åŠŸèƒ½ä»', currentFunction, 'åˆ°', functionKey);
                currentFunction = functionKey;
                await updatePageContentByFunction(functionKey);
                
                // ç­‰å¾…iframeåŠ è½½å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // é€‰æ‹©å…ƒç´ 
            selectedElementId = elementId;
            console.log('é€‰ä¸­å…ƒç´ ID:', selectedElementId);
            
            // æ£€æŸ¥æ‰¹æ³¨æ•°æ®æ˜¯å¦å­˜åœ¨
            const pageKey = getCurrentPageKey();
            const pageAnnotations = currentAnnotations[pageKey] || {};
            const annotation = pageAnnotations[elementId];
            
            console.log('é¡µé¢é”®:', pageKey);
            console.log('é¡µé¢æ‰¹æ³¨:', pageAnnotations);
            console.log('ç›®æ ‡æ‰¹æ³¨:', annotation);
            
            if (!annotation) {
                console.error('æ‰¾ä¸åˆ°æ‰¹æ³¨æ•°æ®:', elementId);
                alert('æ‰¹æ³¨æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°åŠ è½½æ‰¹æ³¨æ•°æ®');
                return;
            }
            
            // æ˜¾ç¤ºæ‰¹æ³¨å†…å®¹
            updateAnnotationDisplay(elementId);
            
            // æ£€æŸ¥å¹¶æ˜¾ç¤ºå¼¹çª—ï¼ˆå¦‚æœéœ€è¦ï¼‰
            await ensureModalVisibility(annotation);
            
            // ä½¿ç”¨å¢å¼ºçš„é«˜äº®ç³»ç»Ÿ
            const highlightSuccess = enhancedHighlightElement(annotation);
            if (!highlightSuccess) {
                console.warn('å¢å¼ºé«˜äº®å¤±è´¥ï¼Œå°è¯•ä¼ ç»Ÿé«˜äº®æ–¹æ³•');
                
                // å¤‡ç”¨ï¼šä¼ ç»Ÿé«˜äº®æ–¹æ³•
                try {
                    const iframe = document.getElementById('embeddedFrame');
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾å…ƒç´ 
                    let targetElement = null;
                
                // æ–¹å¼1: é€šè¿‡IDæŸ¥æ‰¾
                if (elementId.startsWith('id-')) {
                    const actualId = elementId.substring(3);
                    targetElement = iframeDoc.getElementById(actualId);
                }
                
                // æ–¹å¼2: é€šè¿‡ç±»åæŸ¥æ‰¾
                if (!targetElement && elementId.includes('-')) {
                    const parts = elementId.split('-');
                    if (parts.length >= 2) {
                        const className = parts[1];
                        const elements = iframeDoc.getElementsByClassName(className);
                        if (elements.length > 0) {
                            targetElement = elements[0];
                        }
                    }
                }
                
                // æ–¹å¼3: é€šè¿‡é€‰æ‹©å™¨æŸ¥æ‰¾ï¼ˆå¦‚æœæœ‰ä¿å­˜çš„å…ƒç´ ä¿¡æ¯ï¼‰
                const pageElements = window.pageElements || {};
                const elementData = pageElements[pageKey]?.[elementId];
                if (!targetElement && elementData && elementData.selector) {
                    targetElement = iframeDoc.querySelector(elementData.selector);
                }
                
                if (targetElement) {
                    console.log('æ‰¾åˆ°ç›®æ ‡å…ƒç´ ï¼Œå¼€å§‹é«˜äº®:', targetElement);
                    
                    // å¦‚æœå…ƒç´ æ•°æ®ä¸å­˜åœ¨ï¼Œä¸´æ—¶åˆ›å»ºä¸€ä¸ª
                    if (!window.pageElements) window.pageElements = {};
                    if (!window.pageElements[pageKey]) window.pageElements[pageKey] = {};
                    if (!window.pageElements[pageKey][elementId]) {
                        window.pageElements[pageKey][elementId] = {
                            id: elementId,
                            name: annotation.name,
                            element: targetElement,
                            rect: targetElement.getBoundingClientRect(),
                            selector: generateElementSelector(targetElement)
                        };
                    }
                    
                    // é«˜äº®å…ƒç´ 
                    const highlightSuccess = highlightElement(elementId);
                    
                    if (!highlightSuccess) {
                        console.warn('é«˜äº®å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶é«˜äº®');
                        // å»¶è¿Ÿé‡è¯•é«˜äº®
                        setTimeout(() => {
                            highlightElement(elementId);
                        }, 500);
                    }
                    
                    // æ»šåŠ¨åˆ°å…ƒç´ 
                    targetElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center', 
                        inline: 'center' 
                    });
                } else {
                    console.warn('åœ¨å½“å‰é¡µé¢æ‰¾ä¸åˆ°å¯¹åº”å…ƒç´ :', elementId);
                    // å³ä½¿æ‰¾ä¸åˆ°å…ƒç´ ï¼Œä¹Ÿå°è¯•å¼ºåˆ¶é«˜äº®
                    setTimeout(() => {
                        const success = highlightElement(elementId);
                        if (!success) {
                            console.error('æ‰€æœ‰é«˜äº®ç­–ç•¥éƒ½å¤±è´¥äº†');
                        }
                    }, 1000);
                }
                } catch (error) {
                    console.log('ä¼ ç»Ÿé«˜äº®å…ƒç´ å¤±è´¥:', error);
                    // é”™è¯¯æƒ…å†µä¸‹ä¹Ÿå°è¯•å¼ºåˆ¶é«˜äº®
                    setTimeout(() => {
                        highlightElement(elementId);
                    }, 1000);
                }
            }
            
            // æ›´æ–°å…ƒç´ æ¸…å•æ˜¾ç¤º
            updateElementList();
            
            console.log('æ‰¹æ³¨é€‰æ‹©å®Œæˆ');
        }

        // é€‰æ‹©é¡µé¢å…ƒç´ 
        function selectElement(elementId) {
            selectedElementId = elementId;
            
            // æ›´æ–°å½“å‰æ‰¹æ³¨åœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•
            if (currentPageAnnotationList.length > 0) {
                const index = currentPageAnnotationList.indexOf(elementId);
                if (index !== -1) {
                    currentAnnotationIndex = index;
                }
            }
            
            updateElementList();
            
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            clearHighlights();
            
            // é«˜äº®é€‰ä¸­çš„å…ƒç´ 
            highlightElement(elementId);
            
            // æ›´æ–°æ‰¹æ³¨å†…å®¹æ˜¾ç¤º
            updateAnnotationDisplay(elementId);
        }

        // é«˜äº®å…ƒç´ ï¼ˆå…¨æ–°çš„é²æ£’ç‰ˆæœ¬ï¼‰
        function highlightElement(elementId) {
            console.log('ğŸ¯ å¼€å§‹é«˜äº®å…ƒç´ :', elementId);
            clearHighlights();
            
            const pageKey = getCurrentPageKey();
            const elementData = pageElements[pageKey]?.[elementId];
            const annotation = currentAnnotations[pageKey]?.[elementId];
            
            console.log('ğŸ“Š é«˜äº®ä¸Šä¸‹æ–‡:', {
                pageKey,
                elementData,
                annotation,
                elementId
            });
            
            // ç­–ç•¥1: è™šæ‹Ÿå…ƒç´ é«˜äº®ï¼ˆå¦‚æœæ˜¯è™šæ‹Ÿå…ƒç´ ï¼‰
            if (elementData && elementData.virtual) {
                return highlightVirtualElement(elementData);
            }
            
            // ç­–ç•¥2: åæ ‡é«˜äº®ï¼ˆåŸºäºå·²ä¿å­˜çš„ä½ç½®ä¿¡æ¯ï¼‰
            if (elementData && elementData.rect) {
                return highlightByCoordinates(elementData);
            }
            
            // ç­–ç•¥3: æ‰¹æ³¨ä¿¡æ¯æ¨æ–­é«˜äº®
            if (annotation) {
                return highlightByAnnotationInfo(annotation, elementId);
            }
            
            // ç­–ç•¥4: æ™ºèƒ½DOMæŸ¥æ‰¾é«˜äº®
            return highlightByDOMSearch(elementId);
        }
        
        // è™šæ‹Ÿå…ƒç´ é«˜äº®
        function highlightVirtualElement(elementData) {
            console.log('ğŸ­ è™šæ‹Ÿå…ƒç´ é«˜äº®:', elementData.name);
            
            const iframe = document.getElementById('embeddedFrame');
            const iframeRect = iframe.getBoundingClientRect();
            const scale = parseFloat(iframe.style.transform?.match(/scale\(([\d.]+)\)/)?.[1] || 1);
            
            // ä½¿ç”¨é¢„å®šä¹‰çš„åæ ‡
            const rect = elementData.rect;
            const left = iframeRect.left + (rect.left * scale);
            const top = iframeRect.top + (rect.top * scale);
            const width = rect.width * scale;
            const height = rect.height * scale;
            
            createHighlightOverlay(left, top, width, height, 'è™šæ‹Ÿå…ƒç´ : ' + elementData.name);
            return true;
        }
        
        // åæ ‡é«˜äº®
        function highlightByCoordinates(elementData) {
            console.log('ğŸ“ åæ ‡é«˜äº®:', elementData.name);
            
            const iframe = document.getElementById('embeddedFrame');
            const iframeRect = iframe.getBoundingClientRect();
            const scale = parseFloat(iframe.style.transform?.match(/scale\(([\d.]+)\)/)?.[1] || 1);
            
            const rect = elementData.rect;
            const left = iframeRect.left + (rect.left * scale);
            const top = iframeRect.top + (rect.top * scale);
            const width = rect.width * scale;
            const height = rect.height * scale;
            
            createHighlightOverlay(left, top, width, height, 'åæ ‡å®šä½: ' + elementData.name);
            return true;
        }
        
        // åŸºäºæ‰¹æ³¨ä¿¡æ¯æ¨æ–­é«˜äº®
        function highlightByAnnotationInfo(annotation, elementId) {
            console.log('ğŸ”® æ¨æ–­é«˜äº®:', annotation.name);
            
            const iframe = document.getElementById('embeddedFrame');
            const iframeRect = iframe.getBoundingClientRect();
            const scale = parseFloat(iframe.style.transform?.match(/scale\(([\d.]+)\)/)?.[1] || 1);
            
            // æ ¹æ®æ‰¹æ³¨åç§°æ¨æ–­å¯èƒ½çš„ä½ç½®
            let estimatedRect = { left: 100, top: 100, width: 200, height: 100 };
            
            const name = annotation.name.toLowerCase();
            if (name.includes('åœ°å›¾') || name.includes('map')) {
                estimatedRect = { left: 400, top: 100, width: 600, height: 400 };
            } else if (name.includes('å›¾è¡¨') || name.includes('chart') || name.includes('canvas')) {
                estimatedRect = { left: 100, top: 300, width: 400, height: 300 };
            } else if (name.includes('é¢æ¿') || name.includes('panel')) {
                estimatedRect = { left: 1100, top: 100, width: 300, height: 200 };
            } else if (name.includes('æŒ‰é’®') || name.includes('button')) {
                estimatedRect = { left: 200, top: 50, width: 100, height: 40 };
            }
            
            const left = iframeRect.left + (estimatedRect.left * scale);
            const top = iframeRect.top + (estimatedRect.top * scale);
            const width = estimatedRect.width * scale;
            const height = estimatedRect.height * scale;
            
            createHighlightOverlay(left, top, width, height, 'æ™ºèƒ½æ¨æ–­: ' + annotation.name, 'warning');
            return true;
        }
        
        // DOMæŸ¥æ‰¾é«˜äº® - ç²¾ç¡®ç‰ˆ
        function highlightByDOMSearch(elementId) {
            console.log('ğŸ” DOMç²¾ç¡®æŸ¥æ‰¾é«˜äº®:', elementId);
            
            try {
                const iframe = document.getElementById('embeddedFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const iframeRect = iframe.getBoundingClientRect();
                const scale = parseFloat(iframe.style.transform?.match(/scale\(([\d.]+)\)/)?.[1] || 1);
                
                const pageKey = getCurrentPageKey();
                const signature = pageElements[pageKey]?.[elementId];
                
                if (!signature) {
                    console.log('âŒ æ²¡æœ‰æ‰¾åˆ°å…ƒç´ ç­¾å');
                    return false;
                }
                
                // ä½¿ç”¨æ–°çš„ç²¾ç¡®é‡å®šä½ç³»ç»Ÿ
                const targetElement = relocateElementBySignature(signature, iframeDoc);
                
                    if (targetElement) {
                    console.log('âœ… ç²¾ç¡®å®šä½æˆåŠŸ');
                    
                    // è·å–å…ƒç´ ä½ç½®ä¿¡æ¯
                    const rect = targetElement.getBoundingClientRect();
                    
                    // è®¡ç®—é«˜äº®ä½ç½®
                    const left = iframeRect.left + (rect.left * scale);
                    const top = iframeRect.top + (rect.top * scale);
                    const width = rect.width * scale;
                    const height = rect.height * scale;
                    
                    // æ›´æ–°å…ƒç´ ç­¾åä¸­çš„å…ƒç´ å¼•ç”¨
                    signature._element = targetElement;
                    
                    // åˆ›å»ºé«˜äº®
                    createHighlightOverlay(left, top, width, height, 'ç²¾ç¡®å®šä½: ' + (signature.basic.textContent || signature.basic.tagName), 'success');
                    
                    // æ»šåŠ¨åˆ°å…ƒç´ 
                    targetElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center', 
                        inline: 'center' 
                    });
                    
                    return true;
                } else {
                    console.log('âŒ ç²¾ç¡®å®šä½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç­¾åä¸­ä¿å­˜çš„ä½ç½®ä¿¡æ¯
                    if (signature.positioning && signature.positioning.absoluteRect) {
                        const rect = signature.positioning.absoluteRect;
                        const left = iframeRect.left + (rect.left * scale);
                        const top = iframeRect.top + (rect.top * scale);
                        const width = rect.width * scale;
                        const height = rect.height * scale;
                        
                        createHighlightOverlay(left, top, width, height, 'å†å²ä½ç½®: ' + (signature.basic.textContent || signature.basic.tagName), 'warning');
                        return true;
                    }
                }
                
                // ç­–ç•¥3: å¢å¼ºçš„IDå’Œç‰¹å¾åŒ¹é…
                if (!targetElement) {
                    console.log('ç­–ç•¥3: å¢å¼ºçš„IDå’Œç‰¹å¾åŒ¹é…');
                    
                    // 3.1: ç›´æ¥IDåŒ¹é…
                    if (elementId.startsWith('id-')) {
                        const actualId = elementId.substring(3);
                        targetElement = iframeDoc.getElementById(actualId);
                        console.log('IDåŒ¹é…:', actualId, targetElement ? 'æˆåŠŸ' : 'å¤±è´¥');
                    }
                    
                    // 3.2: data-functionå±æ€§åŒ¹é…
                    if (!targetElement && elementId.startsWith('data-function-')) {
                        const functionName = elementId.substring(14);
                        targetElement = iframeDoc.querySelector(`[data-function="${functionName}"]`);
                        console.log('data-functionåŒ¹é…:', functionName, targetElement ? 'æˆåŠŸ' : 'å¤±è´¥');
                    }
                    
                    // 3.3: ç¨³å®šIDç‰¹å¾åŒ¹é…
                    if (!targetElement && elementId.startsWith('stable-')) {
                        const features = elementId.substring(7).split('-');
                        const [tagName, className, parentClass] = features;
                        
                        // ç»„åˆæŸ¥è¯¢
                        let candidates = [];
                        if (tagName) {
                            candidates = Array.from(iframeDoc.getElementsByTagName(tagName));
                        }
                        
                        if (className && candidates.length > 0) {
                            candidates = candidates.filter(el => el.className.includes(className));
                        }
                        
                        if (parentClass && candidates.length > 0) {
                            candidates = candidates.filter(el => 
                                el.parentElement && el.parentElement.className.includes(parentClass)
                            );
                        }
                        
                        if (candidates.length > 0) {
                            targetElement = candidates[0];
                            console.log('ç¨³å®šç‰¹å¾åŒ¹é…æˆåŠŸ:', features);
                        }
                    }
                    
                    // 3.4: ç±»åæ¨¡ç³ŠåŒ¹é…
                    if (!targetElement) {
                        const classMatches = elementId.match(/([a-zA-Z-]+)/g);
                        if (classMatches) {
                            for (const className of classMatches) {
                                if (className.length > 3) { // å¿½ç•¥å¤ªçŸ­çš„åŒ¹é…
                                const elements = iframeDoc.getElementsByClassName(className);
                                if (elements.length > 0) {
                                    targetElement = elements[0];
                                    console.log('ç±»ååŒ¹é…æˆåŠŸ:', className);
                                    break;
                                    }
                                }
                            }
                        }
                    }
                }
                
                // ç­–ç•¥4: æ¨¡ç³Šæœç´¢ï¼ˆæ ¹æ®æ‰¹æ³¨åç§°ï¼‰
                if (!targetElement) {
                    console.log('ç­–ç•¥4: æ¨¡ç³Šæœç´¢');
                    const annotation = currentAnnotations[pageKey]?.[elementId];
                    if (annotation && annotation.name) {
                        // æŸ¥æ‰¾åŒ…å«ç›¸ä¼¼æ–‡æœ¬çš„å…ƒç´ 
                        const allElements = iframeDoc.querySelectorAll('*');
                        for (const el of allElements) {
                            const text = el.textContent?.trim();
                            if (text && text.includes(annotation.name.replace(/[ğŸ“ğŸŒ¾ğŸ¥¬âš ï¸ğŸ“ˆğŸ“ŠğŸŒ¤ï¸]/g, '').trim())) {
                                targetElement = el;
                                console.log('æ¨¡ç³Šæœç´¢æˆåŠŸ:', text);
                                break;
                            }
                        }
                    }
                }
                
                if (targetElement) {
                    console.log('æ‰¾åˆ°ç›®æ ‡å…ƒç´ :', targetElement);
                    
                    // è·å–å…ƒç´ çš„å®é™…ä½ç½®
                    const rect = targetElement.getBoundingClientRect();
                    console.log('å…ƒç´ ä½ç½®ä¿¡æ¯:', rect);
                    
                    // ç¡®ä¿å…ƒç´ åœ¨iframeçš„åæ ‡ç³»ä¸­
                    const iframeWindow = iframe.contentWindow;
                    const iframeScrollX = iframeWindow.pageXOffset || iframeDoc.documentElement.scrollLeft;
                    const iframeScrollY = iframeWindow.pageYOffset || iframeDoc.documentElement.scrollTop;
                    
                    console.log('iframeæ»šåŠ¨ä½ç½®:', { scrollX: iframeScrollX, scrollY: iframeScrollY });
                    
                    // è®¡ç®—é«˜äº®å±‚çš„ä½ç½®ï¼ˆè€ƒè™‘iframeçš„ä½ç½®ã€ç¼©æ”¾å’Œæ»šåŠ¨ï¼‰
                    const left = iframeRect.left + (rect.left * scale);
                    const top = iframeRect.top + (rect.top * scale);
                    const width = rect.width * scale;
                    const height = rect.height * scale;
                    
                    console.log('è®¡ç®—çš„é«˜äº®ä½ç½®:', { left, top, width, height });
                    
                    // åˆ›å»ºé«˜äº®è¦†ç›–å±‚
                    const highlight = document.createElement('div');
                    highlight.className = 'highlight-overlay';
                    highlight.id = 'current-highlight';
                    
                    // è®¾ç½®æ ·å¼
                    highlight.style.position = 'fixed';
                    highlight.style.left = left + 'px';
                    highlight.style.top = top + 'px';
                    highlight.style.width = width + 'px';
                    highlight.style.height = height + 'px';
                    highlight.style.zIndex = '1000';
                    highlight.style.pointerEvents = 'none';
                    
                    // æ·»åŠ æ˜æ˜¾çš„è§†è§‰æ•ˆæœç”¨äºè°ƒè¯•
                    highlight.style.border = '3px solid #ff0000';
                    highlight.style.background = 'rgba(255, 0, 0, 0.2)';
                    highlight.style.boxShadow = '0 0 20px rgba(255, 0, 0, 0.8)';
                    
                    document.body.appendChild(highlight);
                    
                    console.log('é«˜äº®å±‚å·²æ·»åŠ åˆ°DOM');
                    
                    // æ›´æ–°æˆ–åˆ›å»ºå…ƒç´ æ•°æ®
                    if (!window.pageElements) window.pageElements = {};
                    if (!window.pageElements[pageKey]) window.pageElements[pageKey] = {};
                    window.pageElements[pageKey][elementId] = {
                        id: elementId,
                        name: currentAnnotations[pageKey]?.[elementId]?.name || 'Unknown',
                        element: targetElement,
                        rect: rect,
                        selector: generateElementSelector(targetElement)
                    };
                    
                    // æ»šåŠ¨åˆ°å…ƒç´ 
                    targetElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center', 
                        inline: 'center' 
                    });
                    
                    // 3ç§’åæ¢å¤æ­£å¸¸æ ·å¼
                    setTimeout(() => {
                        if (highlight.parentNode) {
                            highlight.style.border = '3px solid #ffc107';
                            highlight.style.background = 'rgba(255, 193, 7, 0.3)';
                            highlight.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.5)';
                        }
                    }, 3000);
                    
                    console.log('é«˜äº®å®Œæˆ');
                    return true;
                    
                } else {
                    console.error('æ— æ³•æ‰¾åˆ°ç›®æ ‡å…ƒç´ ï¼Œæ‰€æœ‰ç­–ç•¥éƒ½å¤±è´¥äº†');
                    
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    const errorOverlay = document.createElement('div');
                    errorOverlay.style.position = 'fixed';
                    errorOverlay.style.top = '50%';
                    errorOverlay.style.left = '50%';
                    errorOverlay.style.transform = 'translate(-50%, -50%)';
                    errorOverlay.style.background = 'rgba(220, 53, 69, 0.9)';
                    errorOverlay.style.color = 'white';
                    errorOverlay.style.padding = '20px';
                    errorOverlay.style.borderRadius = '8px';
                    errorOverlay.style.zIndex = '2000';
                    errorOverlay.style.textAlign = 'center';
                    errorOverlay.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">âš ï¸</div>
                        <div>æ— æ³•æ‰¾åˆ°é¡µé¢å…ƒç´ </div>
                        <div style="margin-top: 8px; font-size: 12px;">å…ƒç´ ID: ${elementId}</div>
                        <div style="margin-top: 8px; font-size: 12px;">å¯èƒ½éœ€è¦é‡æ–°æŠ“å–é¡µé¢å…ƒç´ </div>
                    `;
                    
                    document.body.appendChild(errorOverlay);
                    setTimeout(() => {
                        if (errorOverlay.parentNode) {
                            errorOverlay.remove();
                        }
                    }, 3000);
                    
                    return false;
                }
                
            } catch (error) {
                console.error('é«˜äº®è¿‡ç¨‹å‘ç”Ÿé”™è¯¯:', error);
                alert('é«˜äº®å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // åˆ›å»ºé«˜äº®è¦†ç›–å±‚
        function createHighlightOverlay(left, top, width, height, label = '', type = 'success') {
            console.log('ğŸ¨ åˆ›å»ºé«˜äº®è¦†ç›–å±‚:', { left, top, width, height, label, type });
            
            // åˆ›å»ºé«˜äº®æ¡†
            const highlight = document.createElement('div');
            highlight.className = 'highlight-overlay';
            highlight.id = 'current-highlight';
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            let borderColor, backgroundColor, labelColor;
            switch (type) {
                case 'warning':
                    borderColor = '#ff9800';
                    backgroundColor = 'rgba(255, 152, 0, 0.2)';
                    labelColor = '#ff9800';
                    break;
                case 'error':
                    borderColor = '#f44336';
                    backgroundColor = 'rgba(244, 67, 54, 0.2)';
                    labelColor = '#f44336';
                    break;
                case 'info':
                    borderColor = '#2196F3';
                    backgroundColor = 'rgba(33, 150, 243, 0.2)';
                    labelColor = '#2196F3';
                    break;
                default: // success
                    borderColor = '#4CAF50';
                    backgroundColor = 'rgba(76, 175, 80, 0.2)';
                    labelColor = '#4CAF50';
            }
            
            // è®¾ç½®åŸºæœ¬æ ·å¼
            highlight.style.position = 'fixed';
            highlight.style.left = left + 'px';
            highlight.style.top = top + 'px';
            highlight.style.width = width + 'px';
            highlight.style.height = height + 'px';
            highlight.style.border = `3px solid ${borderColor}`;
            highlight.style.background = backgroundColor;
            highlight.style.zIndex = '1000';
            highlight.style.pointerEvents = 'none';
            highlight.style.borderRadius = '4px';
            highlight.style.boxShadow = `0 0 20px ${backgroundColor}`;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            highlight.style.animation = 'highlight-pulse 2s infinite';
            
            // æ·»åŠ æ ‡ç­¾
            if (label) {
                const labelElement = document.createElement('div');
                labelElement.style.position = 'absolute';
                labelElement.style.top = '-25px';
                labelElement.style.left = '0';
                labelElement.style.background = borderColor;
                labelElement.style.color = 'white';
                labelElement.style.padding = '4px 8px';
                labelElement.style.borderRadius = '4px';
                labelElement.style.fontSize = '12px';
                labelElement.style.fontWeight = 'bold';
                labelElement.style.whiteSpace = 'nowrap';
                labelElement.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
                labelElement.textContent = label;
                highlight.appendChild(labelElement);
            }
            
            document.body.appendChild(highlight);
            
            // 3ç§’åæ·¡åŒ–æ•ˆæœ
            setTimeout(() => {
                if (highlight.parentNode) {
                    highlight.style.opacity = '0.7';
                    highlight.style.animation = 'none';
                }
            }, 3000);
            
            return highlight;
        }

        // æ¸…é™¤é«˜äº®
        function clearHighlights() {
            const highlights = document.querySelectorAll('.highlight-overlay');
            highlights.forEach(highlight => {
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                highlight.style.transition = 'opacity 0.3s ease';
                highlight.style.opacity = '0';
                setTimeout(() => {
                    if (highlight.parentNode) {
                        highlight.remove();
                    }
                }, 300);
            });
        }

        // æ›´æ–°æ‰¹æ³¨æ˜¾ç¤º
        function updateAnnotationDisplay(elementId) {
            console.log('updateAnnotationDisplay è¢«è°ƒç”¨:', elementId);
            
            const pageKey = getCurrentPageKey();
            const pageAnnotations = currentAnnotations[pageKey] || {};
            const elementAnnotation = pageAnnotations[elementId];
            const element = pageElements[pageKey]?.[elementId];
            
            console.log('æ‰¹æ³¨æ˜¾ç¤ºå‚æ•°:', {
                pageKey,
                elementId,
                hasAnnotation: !!elementAnnotation,
                hasElement: !!element,
                annotation: elementAnnotation
            });
            
            const annotationContent = document.getElementById('annotationContent');
            
            if (!annotationContent) {
                console.error('æ‰¾ä¸åˆ°annotationContentå…ƒç´ ');
                return;
            }
            
            if (elementAnnotation) {
                // æ˜¾ç¤ºç°æœ‰æ‰¹æ³¨
                console.log('æ˜¾ç¤ºç°æœ‰æ‰¹æ³¨:', elementAnnotation);
                annotationContent.innerHTML = `
                    <div class="annotation-item">
                        <div class="annotation-title">ğŸ“ ${elementAnnotation.name}</div>
                        <div class="annotation-content" style="margin-top: 8px; padding: 8px; background: #333; border-radius: 4px; line-height: 1.4;">
                            ${convertMarkdownToHTML(elementAnnotation.content)}
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #404040;">
                            <small style="color: #999;">åˆ›å»ºæ—¶é—´: ${elementAnnotation.timestamp}</small>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #404040;">
                            <small style="color: #999;">é¡µé¢: ${pageKey}</small><br>
                            <small style="color: #999;">å…ƒç´ ID: ${elementId}</small>
                        </div>
                        ${isAnnotationMode ? `
                        <div style="margin-top: 8px;">
                            <button onclick="editAnnotation('${elementId}')" class="nav-button" style="margin: 2px;">ç¼–è¾‘</button>
                            <button onclick="deleteAnnotation('${elementId}')" class="nav-button" style="margin: 2px; background: #dc3545;">åˆ é™¤</button>
                        </div>
                        ` : `
                        <div style="margin-top: 8px;">
                            <button onclick="toggleAnnotationMode()" class="nav-button" style="margin: 2px; background: #667eea;">è¿›å…¥æ‰¹æ³¨æ¨¡å¼ç¼–è¾‘</button>
                        </div>
                        `}
                    </div>
                `;
                
                // æ·»åŠ æˆåŠŸæç¤º
                setTimeout(() => {
                    const title = annotationContent.querySelector('.annotation-title');
                    if (title) {
                        title.style.background = '#4CAF50';
                        title.style.color = 'white';
                        title.style.padding = '4px 8px';
                        title.style.borderRadius = '4px';
                        title.style.display = 'inline-block';
                        title.style.marginBottom = '8px';
                    }
                }, 100);
                
            } else if (isAnnotationMode && element) {
                // æ‰¹æ³¨æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ›å»ºè¡¨å•
                annotationContent.innerHTML = `
                    <div class="annotation-item">
                        <div class="annotation-title">ğŸ“ åˆ›å»ºæ–°æ‰¹æ³¨</div>
                        <div style="margin-top: 8px;">
                            <input type="text" id="annotationTitle" placeholder="æ‰¹æ³¨æ ‡é¢˜" value="${getElementDisplayName(element)}"
                                   style="width: 100%; padding: 6px; background: #404040; border: 1px solid #606060; 
                                          color: #fff; border-radius: 3px; margin-bottom: 8px;">
                            <textarea id="annotationContentInput" placeholder="æ‰¹æ³¨å†…å®¹" rows="4"
                                      style="width: 100%; padding: 6px; background: #404040; border: 1px solid #606060; 
                                             color: #fff; border-radius: 3px; resize: vertical; margin-bottom: 8px;"></textarea>
                            <button onclick="saveElementAnnotation('${elementId}')" class="nav-button">ä¿å­˜æ‰¹æ³¨</button>
                            <button onclick="cancelAnnotation()" class="nav-button" style="margin-left: 8px;">å–æ¶ˆ</button>
                        </div>
                    </div>
                `;
            } else {
                // æ™®é€šæ¨¡å¼ä¸‹æ˜¾ç¤ºæç¤º
                annotationContent.innerHTML = `
                    <div class="annotation-item">
                        <div class="annotation-title">ğŸ’¡ æç¤º</div>
                        <div class="annotation-content">
                            è¯¥å…ƒç´ æš‚æ— æ‰¹æ³¨ã€‚å¼€å¯æ‰¹æ³¨æ¨¡å¼å¯ä»¥æ·»åŠ æ‰¹æ³¨å†…å®¹ã€‚
                        </div>
                    </div>
                `;
            }
        }

        // éªŒè¯DOMå…ƒç´ æ˜¯å¦æœ‰æ•ˆ
        function isValidDOMElement(element) {
            return element && 
                   element.nodeType === Node.ELEMENT_NODE && 
                   element.tagName && 
                   typeof element.tagName === 'string';
        }

        // ç”Ÿæˆæ™ºèƒ½å…ƒç´ é€‰æ‹©å™¨
        function generateSmartSelector(element) {
            // éªŒè¯è¾“å…¥å…ƒç´ 
            if (!isValidDOMElement(element)) {
                console.error('âŒ generateSmartSelector: æ— æ•ˆçš„å…ƒç´ å‚æ•°', element);
                return null;
            }
            
            const path = [];
            let current = element;
            
            while (current && current !== document.body && current.tagName) {
                let selector = current.tagName.toLowerCase();
                
                // æ·»åŠ IDï¼ˆå¦‚æœæœ‰ä¸”å”¯ä¸€ï¼‰
                if (current.id) {
                    selector += '#' + current.id;
                    path.unshift(selector);
                    break; // IDæ˜¯å”¯ä¸€çš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
                }
                
                // æ·»åŠ ç±»å
                if (current.className && typeof current.className === 'string') {
                    const classes = current.className.trim().split(/\s+/);
                    if (classes.length > 0 && classes[0] !== '') {
                        selector += '.' + classes.join('.');
                    }
                }
                
                // å¦‚æœå…ƒç´ æœ‰ç‰¹æ®Šå±æ€§ï¼Œæ·»åŠ å±æ€§é€‰æ‹©å™¨
                if (current.hasAttribute('data-function')) {
                    selector += `[data-function="${current.getAttribute('data-function')}"]`;
                }
                if (current.hasAttribute('data-chart-type')) {
                    selector += `[data-chart-type="${current.getAttribute('data-chart-type')}"]`;
                }
                
                // å¦‚æœæœ‰æ–‡æœ¬å†…å®¹ï¼Œä½œä¸ºé¢å¤–çš„è¯†åˆ«ä¿¡æ¯
                const textContent = current.textContent?.trim();
                if (textContent && textContent.length < 50 && textContent.length > 0) {
                    // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                    const escapedText = textContent.replace(/['"\\]/g, '\\$&');
                    if (!textContent.includes('\n') && !textContent.includes('\t')) {
                        selector += `[data-text-content*="${escapedText.substring(0, 20)}"]`;
                    }
                }
                
                // è®¡ç®—åŒçº§å…ƒç´ ä¸­çš„ä½ç½®
                const siblings = Array.from(current.parentNode?.children || []);
                const sameTagSiblings = siblings.filter(sibling => 
                    sibling.tagName === current.tagName && 
                    sibling.className === current.className
                );
                
                if (sameTagSiblings.length > 1) {
                    const index = sameTagSiblings.indexOf(current);
                    selector += `:nth-of-type(${index + 1})`;
                }
                
                path.unshift(selector);
                current = current.parentNode;
            }
            
            return path.join(' > ');
        }

        // ç”Ÿæˆå…ƒç´ æŒ‡çº¹ï¼ˆç”¨äºå†…å®¹è¯†åˆ«ï¼‰
        function generateElementFingerprint(element) {
            // éªŒè¯è¾“å…¥å…ƒç´ 
            if (!isValidDOMElement(element)) {
                console.error('âŒ generateElementFingerprint: æ— æ•ˆçš„å…ƒç´ å‚æ•°', element);
                return null;
            }
            
            const fingerprint = {
                tagName: element.tagName,
                className: element.className,
                textContent: element.textContent?.trim().substring(0, 100) || '',
                attributes: {},
                position: {
                    offsetLeft: element.offsetLeft,
                    offsetTop: element.offsetTop,
                    offsetWidth: element.offsetWidth,
                    offsetHeight: element.offsetHeight
                }
            };
            
            // æ”¶é›†é‡è¦å±æ€§
            const importantAttrs = ['id', 'data-function', 'data-chart-type', 'data-panel', 'role', 'aria-label'];
            importantAttrs.forEach(attr => {
                if (element.hasAttribute(attr)) {
                    fingerprint.attributes[attr] = element.getAttribute(attr);
                }
            });
            
            // å¦‚æœæ˜¯å›¾è¡¨å®¹å™¨ï¼Œå°è¯•è·å–å›¾è¡¨ç±»å‹
            if (element.querySelector('canvas') || element.querySelector('.echarts-instance')) {
                fingerprint.chartType = 'echarts';
            }
            
            return fingerprint;
        }

        // æ”¹è¿›çš„å…ƒç´ åŒ¹é…å‡½æ•°
        function findElementByFingerprint(fingerprint, container = document) {
            const candidates = container.querySelectorAll(fingerprint.tagName);
            let bestMatch = null;
            let bestScore = 0;
            
            candidates.forEach(element => {
                let score = 0;
                
                // ç±»ååŒ¹é…
                if (element.className === fingerprint.className) score += 30;
                
                // æ–‡æœ¬å†…å®¹åŒ¹é…
                const elementText = element.textContent?.trim() || '';
                if (elementText === fingerprint.textContent) score += 50;
                else if (elementText.includes(fingerprint.textContent.substring(0, 20))) score += 25;
                
                // å±æ€§åŒ¹é…
                Object.entries(fingerprint.attributes).forEach(([attr, value]) => {
                    if (element.hasAttribute(attr) && element.getAttribute(attr) === value) {
                        score += 20;
                    }
                });
                
                // ä½ç½®åŒ¹é…ï¼ˆç›¸å¯¹ä½ç½®ï¼‰
                const posDiff = Math.abs(element.offsetLeft - fingerprint.position.offsetLeft) + 
                               Math.abs(element.offsetTop - fingerprint.position.offsetTop);
                if (posDiff < 50) score += 15;
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = element;
                }
            });
            
            return bestScore > 60 ? bestMatch : null; // è®¾ç½®æœ€ä½åŒ¹é…é˜ˆå€¼
        }

        // ä¿å­˜å…ƒç´ æ‰¹æ³¨
        async function saveElementAnnotation(elementId) {
            const titleInput = document.getElementById('annotationTitle');
            const contentInput = document.getElementById('annotationContentInput');
            
            if (!titleInput || !contentInput) {
                alert('æ— æ³•æ‰¾åˆ°æ‰¹æ³¨è¡¨å•å…ƒç´ ');
                return;
            }
            
            const title = titleInput.value;
            const content = contentInput.value;
            
            if (!title.trim() || !content.trim()) {
                alert('è¯·å¡«å†™æ‰¹æ³¨æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            // è·å–å½“å‰é€‰ä¸­çš„å…ƒç´ ä¿¡æ¯
            const pageKey = getCurrentPageKey();
            const elementData = pageElements[pageKey]?.[elementId];
            
            if (!elementData) {
                alert('æ— æ³•æ‰¾åˆ°å…ƒç´ æ•°æ®ï¼Œè¯·é‡æ–°é€‰æ‹©å…ƒç´ ');
                return;
            }
            
            // ä½¿ç”¨ç¤ºä¾‹æ•°æ®æ ¼å¼é‡æ–°å®šä½å…ƒç´ 
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) {
                alert('æ— æ³•è®¿é—®iframeå†…å®¹');
                return;
            }
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // ä½¿ç”¨å¤šç­–ç•¥æ™ºèƒ½å®šä½å…ƒç´ 
            let targetElement = null;
            let matchStrategy = '';
            
            console.log('ğŸ” å¼€å§‹é‡æ–°å®šä½å…ƒç´ :', elementId);
            console.log('ğŸ“‹ å…ƒç´ æ•°æ®:', elementData);
            
            // ç­–ç•¥1: ä½¿ç”¨åŸç”ŸID
            if (elementData.basic?.id && elementData.basic.id !== 'null') {
                targetElement = iframeDoc.getElementById(elementData.basic.id);
                if (targetElement) {
                    matchStrategy = 'IDåŒ¹é…';
                    console.log('âœ… é€šè¿‡IDæ‰¾åˆ°å…ƒç´ :', elementData.basic.id);
                }
            }
            
            // ç­–ç•¥2: ä½¿ç”¨å¤šç§é€‰æ‹©å™¨
            if (!targetElement && elementData.hierarchy?.selectors) {
                const selectors = elementData.hierarchy.selectors;
                
                // å°è¯•primaryé€‰æ‹©å™¨
                if (selectors.primary) {
                    try {
                        targetElement = iframeDoc.querySelector(selectors.primary);
                        if (targetElement) {
                            matchStrategy = 'Primaryé€‰æ‹©å™¨';
                            console.log('âœ… é€šè¿‡Primaryé€‰æ‹©å™¨æ‰¾åˆ°å…ƒç´ :', selectors.primary);
                        }
                    } catch (e) {
                        console.warn('Primaryé€‰æ‹©å™¨å¤±è´¥:', e);
                    }
                }
                
                // å°è¯•uniqueé€‰æ‹©å™¨
                if (!targetElement && selectors.unique) {
                    try {
                        targetElement = iframeDoc.querySelector(selectors.unique);
                        if (targetElement) {
                            matchStrategy = 'Uniqueé€‰æ‹©å™¨';
                            console.log('âœ… é€šè¿‡Uniqueé€‰æ‹©å™¨æ‰¾åˆ°å…ƒç´ :', selectors.unique);
                        }
                    } catch (e) {
                        console.warn('Uniqueé€‰æ‹©å™¨å¤±è´¥:', e);
                    }
                }
                
                // å°è¯•CSSè·¯å¾„
                if (!targetElement && selectors.cssPath) {
                    try {
                        targetElement = iframeDoc.querySelector(selectors.cssPath);
                        if (targetElement) {
                            matchStrategy = 'CSSè·¯å¾„';
                            console.log('âœ… é€šè¿‡CSSè·¯å¾„æ‰¾åˆ°å…ƒç´ :', selectors.cssPath);
                        }
                    } catch (e) {
                        console.warn('CSSè·¯å¾„æŸ¥æ‰¾å¤±è´¥:', e);
                    }
                }
            }
            
            // ç­–ç•¥3: ä½¿ç”¨æ ‡ç­¾å+ä½ç½®ç´¢å¼•ç²¾ç¡®åŒ¹é…
            if (!targetElement && elementData.basic?.tagName && elementData.positioning) {
                const candidates = iframeDoc.querySelectorAll(elementData.basic.tagName);
                const targetIndex = elementData.positioning.siblingIndex?.index;
                
                if (typeof targetIndex === 'number' && candidates[targetIndex]) {
                    // éªŒè¯è¿™ä¸ªå…ƒç´ æ˜¯å¦çœŸçš„åŒ¹é…
                    const candidate = candidates[targetIndex];
                    
                    // ç®€åŒ–ç‰ˆæœ¬çš„å…ƒç´ åŒ¹é…éªŒè¯
                    let matchScore = 0;
                    
                    // æ ‡ç­¾ååŒ¹é…
                    if (candidate.tagName.toLowerCase() === elementData.basic.tagName) {
                        matchScore += 30;
                    }
                    
                    // ç±»ååŒ¹é…
                    if (elementData.basic.className && candidate.className.includes(elementData.basic.className.split(' ')[0])) {
                        matchScore += 20;
                    }
                    
                    // æ–‡æœ¬å†…å®¹åŒ¹é…
                    if (elementData.basic.textContent && candidate.textContent?.includes(elementData.basic.textContent)) {
                        matchScore += 30;
                    }
                    
                    // ä½ç½®åŒ¹é…
                    const siblings = Array.from(candidate.parentElement?.children || []);
                    const currentIndex = siblings.indexOf(candidate);
                    if (currentIndex === targetIndex) {
                        matchScore += 20;
                    }
                    
                    if (matchScore > 50) { // è®¾ç½®åŒ¹é…é˜ˆå€¼
                        targetElement = candidate;
                        matchStrategy = `ä½ç½®ç´¢å¼•åŒ¹é…(${targetIndex}) - å¾—åˆ†:${matchScore}`;
                        console.log('âœ… é€šè¿‡ä½ç½®ç´¢å¼•æ‰¾åˆ°å…ƒç´ ï¼ŒåŒ¹é…å¾—åˆ†:', matchScore);
                    }
                }
            }
            
            // ç­–ç•¥4: Canvaså’Œç‰¹æ®Šå…ƒç´ çš„ä½ç½®åŒ¹é…
            if (!targetElement && elementData.basic?.tagName === 'canvas') {
                const canvasElements = iframeDoc.querySelectorAll('canvas');
                if (canvasElements.length > 0) {
                    // å¦‚æœåªæœ‰ä¸€ä¸ªcanvasï¼Œç›´æ¥ä½¿ç”¨
                    if (canvasElements.length === 1) {
                        targetElement = canvasElements[0];
                        matchStrategy = 'å”¯ä¸€Canvaså…ƒç´ ';
                        console.log('âœ… æ‰¾åˆ°å”¯ä¸€Canvaså…ƒç´ ');
                    } else {
                        // å¤šä¸ªcanvasæ—¶ï¼Œä½¿ç”¨ä½ç½®ä¿¡æ¯åŒ¹é…
                        const targetRect = elementData.positioning?.absoluteRect;
                        if (targetRect) {
                            let bestMatch = null;
                            let minDistance = Infinity;
                            
                            canvasElements.forEach(canvas => {
                                const rect = canvas.getBoundingClientRect();
                                const distance = Math.abs(rect.left - targetRect.left) + 
                                               Math.abs(rect.top - targetRect.top);
                                
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    bestMatch = canvas;
                                }
                            });
                            
                            if (bestMatch && minDistance < 100) { // ä½ç½®å·®å¼‚å°äº100px
                                targetElement = bestMatch;
                                matchStrategy = `Canvasä½ç½®åŒ¹é… - è·ç¦»:${minDistance}px`;
                                console.log('âœ… é€šè¿‡ä½ç½®åŒ¹é…æ‰¾åˆ°Canvaså…ƒç´ ');
                            }
                        }
                    }
                }
            }
            
            // ç­–ç•¥5: ç±»å+æ–‡æœ¬å†…å®¹åŒ¹é…ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
            if (!targetElement && elementData.basic?.className && elementData.basic?.textContent) {
                const className = elementData.basic.className.split(' ')[0];
                if (className && className !== 'null') {
                    const candidates = iframeDoc.querySelectorAll(`.${className}`);
                    if (candidates.length > 0) {
                        targetElement = Array.from(candidates).find(el => 
                            el.textContent?.trim().includes(elementData.basic.textContent)
                        );
                        if (targetElement) {
                            matchStrategy = 'ç±»å+æ–‡æœ¬å†…å®¹åŒ¹é…';
                            console.log('âœ… é€šè¿‡ç±»å+æ–‡æœ¬å†…å®¹æ‰¾åˆ°å…ƒç´ ');
                        }
                    }
                }
            }
            
            if (!targetElement) {
                // æä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                const debugInfo = {
                    elementId: elementId,
                    hasBasicId: !!elementData.basic?.id,
                    hasSelectors: !!elementData.hierarchy?.selectors,
                    tagName: elementData.basic?.tagName,
                    className: elementData.basic?.className,
                    hasPositioning: !!elementData.positioning,
                    availableStrategies: []
                };
                
                if (elementData.basic?.id && elementData.basic.id !== 'null') {
                    debugInfo.availableStrategies.push('IDæŸ¥æ‰¾');
                }
                if (elementData.hierarchy?.selectors) {
                    debugInfo.availableStrategies.push('é€‰æ‹©å™¨æŸ¥æ‰¾');
                }
                if (elementData.positioning) {
                    debugInfo.availableStrategies.push('ä½ç½®åŒ¹é…');
                }
                
                console.error('âŒ æ‰€æœ‰å®šä½ç­–ç•¥éƒ½å¤±è´¥äº†:', debugInfo);
                
                alert(`æ— æ³•é‡æ–°å®šä½å…ƒç´ : ${elementId}\n\nè°ƒè¯•ä¿¡æ¯:\n- å…ƒç´ ç±»å‹: ${elementData.basic?.tagName || 'æœªçŸ¥'}\n- æ˜¯å¦æœ‰ID: ${debugInfo.hasBasicId}\n- æ˜¯å¦æœ‰é€‰æ‹©å™¨: ${debugInfo.hasSelectors}\n- æ˜¯å¦æœ‰ä½ç½®ä¿¡æ¯: ${debugInfo.hasPositioning}\n\nè¯·å°è¯•ï¼š\n1. åˆ·æ–°é¡µé¢åé‡æ–°é€‰æ‹©å…ƒç´ \n2. ç¡®ä¿é¡µé¢å†…å®¹å·²å®Œå…¨åŠ è½½\n3. é€‰æ‹©å…·æœ‰æ˜ç¡®IDæˆ–ç±»åçš„å…ƒç´ `);
                return;
            }
            
            console.log(`ğŸ¯ æˆåŠŸé‡æ–°å®šä½å…ƒç´ ! ç­–ç•¥: ${matchStrategy}`);
            console.log('ç›®æ ‡å…ƒç´ :', targetElement);
            
            // æœ€ç»ˆéªŒè¯ç›®æ ‡å…ƒç´ çš„æœ‰æ•ˆæ€§
            if (!isValidDOMElement(targetElement)) {
                console.error('âŒ é‡æ–°å®šä½çš„å…ƒç´ æ— æ•ˆ', targetElement);
                alert('å®šä½åˆ°çš„å…ƒç´ æ— æ•ˆï¼Œæ— æ³•ä¿å­˜æ‰¹æ³¨ã€‚è¯·å°è¯•é€‰æ‹©å…¶ä»–å…ƒç´ ã€‚');
                return;
            }
            
            // ç”Ÿæˆæ™ºèƒ½é€‰æ‹©å™¨å’Œå…ƒç´ æŒ‡çº¹ï¼ˆå‚è€ƒç¤ºä¾‹æ•°æ®æ ¼å¼ï¼‰
            const smartSelector = generateSmartSelector(targetElement);
            if (!smartSelector) {
                console.error('âŒ æ— æ³•ç”Ÿæˆæ™ºèƒ½é€‰æ‹©å™¨ï¼Œè·³è¿‡ä¿å­˜');
                alert('å…ƒç´ é€‰æ‹©å™¨ç”Ÿæˆå¤±è´¥ï¼Œæ— æ³•ä¿å­˜æ‰¹æ³¨ã€‚è¯·å°è¯•é€‰æ‹©å…¶ä»–å…ƒç´ ã€‚');
                return;
            }
            const elementFingerprint = generateElementFingerprint(targetElement);
            if (!elementFingerprint) {
                console.error('âŒ æ— æ³•ç”Ÿæˆå…ƒç´ æŒ‡çº¹ï¼Œè·³è¿‡ä¿å­˜');
                alert('å…ƒç´ æŒ‡çº¹ç”Ÿæˆå¤±è´¥ï¼Œæ— æ³•ä¿å­˜æ‰¹æ³¨ã€‚è¯·å°è¯•é€‰æ‹©å…¶ä»–å…ƒç´ ã€‚');
                return;
            }
            
            // è·å–å…ƒç´ çš„åŸºæœ¬ä¿¡æ¯
            const elementText = targetElement.textContent?.trim() || title;
            const elementClass = targetElement.className || '';
            
            if (!currentAnnotations[pageKey]) {
                currentAnnotations[pageKey] = {};
            }
            
            // ä½¿ç”¨ç¤ºä¾‹æ•°æ®çš„æ ¼å¼ç»“æ„
            currentAnnotations[pageKey][elementId] = {
                name: title,
                content: content,
                timestamp: new Date().toLocaleString('zh-CN'),
                elementId: elementId,
                targetInfo: {
                    smartSelector: smartSelector,
                    elementFingerprint: {
                        tagName: targetElement.tagName.toUpperCase(),
                        className: elementClass,
                        textContent: elementText,
                        attributes: elementFingerprint.attributes || {},
                        position: elementFingerprint.position || {
                            offsetLeft: targetElement.offsetLeft || 0,
                            offsetTop: targetElement.offsetTop || 0,
                            offsetWidth: targetElement.offsetWidth || 0,
                            offsetHeight: targetElement.offsetHeight || 0
                        },
                        chartType: elementFingerprint.chartType || null
                    },
                    fallbackSelector: targetElement.tagName.toLowerCase() + 
                        (targetElement.className ? '.' + targetElement.className.split(' ').join('.') : ''),
                    textContent: elementText,
                    pageUrl: iframe.src,
                    timestamp: new Date().toISOString()
                }
            };
            
            console.log('ğŸ’¾ ä¿å­˜æ‰¹æ³¨æ•°æ®:', currentAnnotations[pageKey][elementId]);
            
            // ä¼˜å…ˆä½¿ç”¨å¢é‡æ›´æ–°ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
            if (CURRENT_ENV.enableRealTimeSync) {
                console.log('ğŸš€ ä½¿ç”¨å¢é‡æ›´æ–°æ¨¡å¼');
                
                // å¢é‡æ›´æ–°åˆ°æœåŠ¡å™¨
                const updateResult = await apiClient.updateAnnotation(
                    pageKey, 
                    elementId, 
                    currentAnnotations[pageKey][elementId], 
                    'update'
                );
                
                if (updateResult) {
                    console.log('âœ… å¢é‡æ›´æ–°æˆåŠŸ');
                    
                    // å¹¿æ’­åŒæ­¥äº‹ä»¶
                    await apiClient.syncAnnotation(currentAnnotations[pageKey][elementId], 'create');
                } else {
                    console.warn('âš ï¸ å¢é‡æ›´æ–°å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜');
                    await saveAnnotations();
                }
            } else {
                // çº¿ä¸Šæ¨¡å¼æˆ–æœ¬åœ°æ¨¡å¼ï¼šå…¨é‡ä¿å­˜
                await saveAnnotations();
            }
            updateElementList();
            updateAnnotationDisplay(elementId);
        }

        // ç¼–è¾‘æ‰¹æ³¨
        function editAnnotation(elementId) {
            // æƒé™æ£€æŸ¥
            if (!checkPermission('edit')) {
                showPermissionDenied('edit');
                return;
            }
            
            const pageKey = getCurrentPageKey();
            const annotation = currentAnnotations[pageKey][elementId];
            
            const annotationContent = document.getElementById('annotationContent');
            annotationContent.innerHTML = `
                <div class="annotation-item">
                    <div class="annotation-title">âœï¸ ç¼–è¾‘æ‰¹æ³¨</div>
                    <div style="margin-top: 8px;">
                        <input type="text" id="annotationTitle" value="${annotation.name}" placeholder="æ‰¹æ³¨æ ‡é¢˜" 
                               style="width: 100%; padding: 6px; background: #404040; border: 1px solid #606060; 
                                      color: #fff; border-radius: 3px; margin-bottom: 8px;">
                        <textarea id="annotationContentInput" placeholder="æ‰¹æ³¨å†…å®¹" rows="4"
                                  style="width: 100%; padding: 6px; background: #404040; border: 1px solid #606060; 
                                         color: #fff; border-radius: 3px; resize: vertical; margin-bottom: 8px;">${annotation.content}</textarea>
                        <button onclick="saveElementAnnotation('${elementId}')" class="nav-button">ä¿å­˜ä¿®æ”¹</button>
                        <button onclick="updateAnnotationDisplay('${elementId}')" class="nav-button" style="margin-left: 8px;">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
        }

        // åˆ é™¤æ‰¹æ³¨
        async function deleteAnnotation(elementId) {
            // æƒé™æ£€æŸ¥
            if (!checkPermission('edit')) {
                showPermissionDenied('edit');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ‰¹æ³¨å—ï¼Ÿ')) {
                const pageKey = getCurrentPageKey();
                const deletedAnnotation = currentAnnotations[pageKey][elementId];
                
                // ä»æœ¬åœ°æ•°æ®ä¸­åˆ é™¤
                delete currentAnnotations[pageKey][elementId];
                
                // ä¼˜å…ˆä½¿ç”¨å¢é‡åˆ é™¤ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
                if (CURRENT_ENV.enableRealTimeSync && deletedAnnotation) {
                    console.log('ğŸš€ ä½¿ç”¨å¢é‡åˆ é™¤æ¨¡å¼');
                    
                    // å¢é‡åˆ é™¤
                    const deleteResult = await apiClient.updateAnnotation(
                        pageKey, 
                        elementId, 
                        deletedAnnotation, 
                        'delete'
                    );
                    
                    if (deleteResult) {
                        console.log('âœ… å¢é‡åˆ é™¤æˆåŠŸ');
                        
                        // å¹¿æ’­åŒæ­¥äº‹ä»¶
                        await apiClient.syncAnnotation(deletedAnnotation, 'delete');
                    } else {
                        console.warn('âš ï¸ å¢é‡åˆ é™¤å¤±è´¥ï¼Œå›é€€åˆ°å…¨é‡ä¿å­˜');
                        await saveAnnotations();
                    }
                } else {
                    // çº¿ä¸Šæ¨¡å¼æˆ–æœ¬åœ°æ¨¡å¼ï¼šå…¨é‡ä¿å­˜
                    await saveAnnotations();
                }
                
                updateElementList();
                updateAnnotationDisplay(elementId);
            }
        }

        // å–æ¶ˆæ‰¹æ³¨
        function cancelAnnotation() {
            selectedElementId = null;
            updateElementList();
            clearHighlights();
            
            // æ¢å¤é»˜è®¤æ‰¹æ³¨æ˜¾ç¤º
            const currentPage = pages[currentPageIndex];
            const config = pageConfigs[currentPage];
            const annotationContent = document.getElementById('annotationContent');
            annotationContent.innerHTML = config.annotations.map(annotation => `
                <div class="annotation-item">
                    <div class="annotation-title">${annotation.title}</div>
                    <div class="annotation-content">${convertMarkdownToHTML(annotation.content)}</div>
                </div>
            `).join('');
        }

        // ç¡®ä¿å¼¹çª—å¯è§æ€§
        async function ensureModalVisibility(annotation) {
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) {
                console.warn('æ— æ³•è®¿é—®iframeå†…å®¹');
                return false;
            }
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) {
                console.warn('æ— æ³•è®¿é—®iframeæ–‡æ¡£');
                return false;
            }
            
            console.log('ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¼¹çª—:', annotation);
            
            // å…ˆå°è¯•æ‰¾åˆ°ç›®æ ‡å…ƒç´ 
            let targetElement = await findTargetElement(annotation, iframeDoc);
            
            if (!targetElement) {
                console.log('âŒ æ— æ³•æ‰¾åˆ°ç›®æ ‡å…ƒç´ ï¼Œå°è¯•æ˜¾ç¤ºç›¸å…³å¼¹çª—');
                await attemptToShowRelatedModals(annotation, iframeDoc);
                
                // é‡æ–°å°è¯•æŸ¥æ‰¾å…ƒç´ 
                await new Promise(resolve => setTimeout(resolve, 800));
                targetElement = await findTargetElement(annotation, iframeDoc);
            }
            
            if (targetElement) {
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨å¼¹çª—ä¸­ï¼Œå¦‚æœæ˜¯åˆ™ç¡®ä¿å¼¹çª—å¯è§
                const modalContainer = findParentModal(targetElement);
                if (modalContainer) {
                    console.log('ğŸ¯ æ‰¾åˆ°çˆ¶çº§å¼¹çª—å®¹å™¨:', modalContainer);
                    await showModal(modalContainer, iframeDoc);
                } else {
                    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å½“å‰å¯è§
                    const isVisible = isElementVisible(targetElement);
                    if (!isVisible) {
                        console.log('ğŸ” å…ƒç´ ä¸å¯è§ï¼Œå°è¯•æ˜¾ç¤ºç›¸å…³å¼¹çª—');
                        await attemptToShowRelatedModals(annotation, iframeDoc);
                    }
                }
            }
            
            return true;
        }
        
        // æŸ¥æ‰¾ç›®æ ‡å…ƒç´ 
        async function findTargetElement(annotation, iframeDoc) {
            let targetElement = null;
            
            // ç­–ç•¥1: ä½¿ç”¨æ™ºèƒ½é€‰æ‹©å™¨
            if (annotation.targetInfo?.smartSelector) {
                try {
                    targetElement = iframeDoc.querySelector(annotation.targetInfo.smartSelector);
                    if (targetElement) {
                        console.log('âœ… é€šè¿‡æ™ºèƒ½é€‰æ‹©å™¨æ‰¾åˆ°å…ƒç´ ');
                        return targetElement;
                    }
                } catch (e) {
                    console.warn('æ™ºèƒ½é€‰æ‹©å™¨æŸ¥æ‰¾å¤±è´¥:', e);
                }
            }
            
            // ç­–ç•¥2: ä½¿ç”¨å…ƒç´ æŒ‡çº¹åŒ¹é…
            if (!targetElement && annotation.targetInfo?.elementFingerprint) {
                targetElement = findElementByFingerprint(annotation.targetInfo.elementFingerprint, iframeDoc);
                if (targetElement) {
                    console.log('âœ… é€šè¿‡å…ƒç´ æŒ‡çº¹æ‰¾åˆ°å…ƒç´ ');
                    return targetElement;
                }
            }
            
            // ç­–ç•¥3: ä½¿ç”¨å¤‡ç”¨é€‰æ‹©å™¨
            if (!targetElement && annotation.targetInfo?.fallbackSelector) {
                try {
                    const candidates = iframeDoc.querySelectorAll(annotation.targetInfo.fallbackSelector);
                    if (candidates.length === 1) {
                        targetElement = candidates[0];
                    } else if (candidates.length > 1 && annotation.targetInfo.textContent) {
                        targetElement = Array.from(candidates).find(el => 
                            el.textContent?.trim().includes(annotation.targetInfo.textContent)
                        );
                    }
                    if (targetElement) {
                        console.log('âœ… é€šè¿‡å¤‡ç”¨é€‰æ‹©å™¨æ‰¾åˆ°å…ƒç´ ');
                        return targetElement;
                    }
                } catch (e) {
                    console.warn('å¤‡ç”¨é€‰æ‹©å™¨æŸ¥æ‰¾å¤±è´¥:', e);
                }
            }
            
            return null;
        }
        
        // æŸ¥æ‰¾çˆ¶çº§å¼¹çª—å®¹å™¨
        function findParentModal(element) {
            if (!element) return null;
            
            let current = element;
            let searchDepth = 0;
            const maxDepth = 15; // å¢åŠ æœç´¢æ·±åº¦
            
            // å¼¹çª—ç›¸å…³çš„ç±»åå’ŒIDå…³é”®è¯
            const modalKeywords = [
                'modal', 'dialog', 'popup', 'overlay', 'lightbox', 'popover',
                'tooltip', 'dropdown', 'menu', 'panel', 'drawer', 'sidebar',
                'detail', 'info', 'settings', 'config', 'form', 'edit',
                'plot-popup', 'crop-detail', 'device-info', 'weather-detail'
            ];
            
            while (current && current !== document.body && searchDepth < maxDepth) {
                const className = (current.className || '').toLowerCase();
                const id = (current.id || '').toLowerCase();
                const tagName = current.tagName.toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¼¹çª—å®¹å™¨
                const isModal = modalKeywords.some(keyword => 
                    className.includes(keyword) || id.includes(keyword)
                );
                
                // ç‰¹æ®Šæ£€æŸ¥ï¼šå¸¸è§çš„å¼¹çª—ç»“æ„
                const hasModalStructure = (
                    className.includes('show') ||
                    className.includes('active') ||
                    className.includes('visible') ||
                    current.hasAttribute('role') && current.getAttribute('role') === 'dialog' ||
                    current.style.position === 'absolute' ||
                    current.style.position === 'fixed'
                ) && (
                    current.style.zIndex > 1000 ||
                    className.includes('z-') ||
                    tagName === 'dialog'
                );
                
                if (isModal || hasModalStructure) {
                    console.log('ğŸ¯ æ‰¾åˆ°å¼¹çª—å®¹å™¨:', {
                        element: current.tagName,
                        className: current.className,
                        id: current.id,
                        depth: searchDepth,
                        reason: isModal ? 'å…³é”®è¯åŒ¹é…' : 'ç»“æ„åŒ¹é…'
                    });
                    return current;
                }
                
                current = current.parentElement;
                searchDepth++;
            }
            
            return null;
        }
        
        // æ˜¾ç¤ºå¼¹çª—
        async function showModal(modalElement, iframeDoc) {
            if (!modalElement) return false;
            
            console.log('ğŸ‘ï¸ æ˜¾ç¤ºå¼¹çª—:', {
                element: modalElement.tagName,
                className: modalElement.className,
                id: modalElement.id
            });
            
            const style = iframeDoc.defaultView.getComputedStyle(modalElement);
            
            // æ£€æŸ¥å½“å‰å¯è§æ€§
            const isCurrentlyVisible = (
                style.display !== 'none' &&
                style.visibility !== 'hidden' &&
                parseFloat(style.opacity) > 0.1
            );
            
            if (!isCurrentlyVisible) {
                console.log('ğŸ”§ å¼¹çª—å½“å‰ä¸å¯è§ï¼Œæ­£åœ¨æ˜¾ç¤º...');
                
                // è®¾ç½®åŸºæœ¬æ˜¾ç¤ºæ ·å¼
                modalElement.style.display = 'block';
                modalElement.style.visibility = 'visible';
                modalElement.style.opacity = '1';
                
                // ç¡®ä¿åˆé€‚çš„å®šä½å’Œå±‚çº§
                if (!modalElement.style.position || modalElement.style.position === 'static') {
                    modalElement.style.position = 'absolute';
                }
                
                if (!modalElement.style.zIndex || parseInt(modalElement.style.zIndex) < 1000) {
                    modalElement.style.zIndex = '10000';
                }
                
                // ç§»é™¤éšè—ç±»ï¼Œæ·»åŠ æ˜¾ç¤ºç±»
                const hiddenClasses = ['hidden', 'hide', 'd-none', 'opacity-0', 'invisible'];
                const showClasses = ['show', 'visible', 'active', 'opacity-100', 'block'];
                
                hiddenClasses.forEach(cls => modalElement.classList.remove(cls));
                showClasses.forEach(cls => modalElement.classList.add(cls));
                
                // è§¦å‘å¯èƒ½å­˜åœ¨çš„æ˜¾ç¤ºäº‹ä»¶
                try {
                    const showEvent = new iframeDoc.defaultView.CustomEvent('modal:show', {
                        bubbles: true,
                        detail: { element: modalElement }
                    });
                    modalElement.dispatchEvent(showEvent);
                } catch (e) {
                    console.warn('è§¦å‘æ˜¾ç¤ºäº‹ä»¶å¤±è´¥:', e);
                }
                
                console.log('âœ… å¼¹çª—å·²æ˜¾ç¤º');
                return true;
            } else {
                console.log('âœ… å¼¹çª—å·²ç»å¯è§');
                return true;
            }
        }
        
        // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§
        function isElementVisible(element) {
            if (!element) return false;
            
            try {
                const rect = element.getBoundingClientRect();
                const style = window.getComputedStyle(element);
                
                return (
                    rect.width > 0 && 
                    rect.height > 0 &&
                    style.display !== 'none' &&
                    style.visibility !== 'hidden' &&
                    parseFloat(style.opacity) > 0.1
                );
            } catch (e) {
                console.warn('æ£€æŸ¥å…ƒç´ å¯è§æ€§å¤±è´¥:', e);
                return false;
            }
        }
        
        // å°è¯•æ˜¾ç¤ºç›¸å…³å¼¹çª—
        async function attemptToShowRelatedModals(annotation, iframeDoc) {
            console.log('ğŸš€ å°è¯•æ˜¾ç¤ºç›¸å…³å¼¹çª—...');
            
            // ä¼˜å…ˆç­–ç•¥ï¼šç›´æ¥æ ¹æ®é€‰æ‹©å™¨æŸ¥æ‰¾å¼¹çª—å®¹å™¨
            const priorityResult = await showModalBySelector(annotation, iframeDoc);
            if (priorityResult) {
                console.log('âœ… ä¼˜å…ˆç­–ç•¥æˆåŠŸæ˜¾ç¤ºå¼¹çª—');
                return true;
            }
            
            const strategies = [
                () => findAndClickTriggerButtons(annotation, iframeDoc),
                () => showHiddenModals(iframeDoc),
                () => triggerModalEvents(annotation, iframeDoc),
                () => forceShowModalsByKeywords(annotation, iframeDoc)
            ];
            
            for (let i = 0; i < strategies.length; i++) {
                try {
                    console.log(`ğŸ”„ æ‰§è¡Œå¼¹çª—æ˜¾ç¤ºç­–ç•¥ ${i + 1}...`);
                    await strategies[i]();
                    await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
                    
                    // æ£€æŸ¥æ˜¯å¦æˆåŠŸæ˜¾ç¤ºäº†ç›®æ ‡å…ƒç´ 
                    const targetElement = await findTargetElement(annotation, iframeDoc);
                    if (targetElement && isElementVisible(targetElement)) {
                        console.log(`âœ… ç­–ç•¥ ${i + 1} æˆåŠŸæ˜¾ç¤ºå¼¹çª—`);
                        return true;
                    }
                } catch (error) {
                    console.warn(`ç­–ç•¥ ${i + 1} å¤±è´¥:`, error);
                }
            }
            
            return false;
        }
        
        // æ ¹æ®é€‰æ‹©å™¨ç›´æ¥æ˜¾ç¤ºå¼¹çª—
        async function showModalBySelector(annotation, iframeDoc) {
            const smartSelector = annotation.targetInfo?.smartSelector || '';
            
            if (!smartSelector) {
                console.log('âŒ æ²¡æœ‰æ™ºèƒ½é€‰æ‹©å™¨ä¿¡æ¯');
                return false;
            }
            
            console.log('ğŸ¯ æ ¹æ®æ™ºèƒ½é€‰æ‹©å™¨æŸ¥æ‰¾å¼¹çª—:', smartSelector);
            
            // ä»é€‰æ‹©å™¨ä¸­æå–å¼¹çª—å®¹å™¨IDæˆ–ç±»å
            // ä¾‹å¦‚: "div#plot-popup > div.popup-header" -> "plot-popup"
            const modalIdMatch = smartSelector.match(/#([a-zA-Z0-9_-]+)/);
            const modalClassMatch = smartSelector.match(/\.([a-zA-Z0-9_-]*(?:modal|popup|dialog|panel)[a-zA-Z0-9_-]*)/i);
            
            let modalContainer = null;
            
            // ç­–ç•¥1: é€šè¿‡IDç›´æ¥æŸ¥æ‰¾å¼¹çª—
            if (modalIdMatch) {
                const modalId = modalIdMatch[1];
                modalContainer = iframeDoc.getElementById(modalId);
                if (modalContainer) {
                    console.log('ğŸ¯ é€šè¿‡IDæ‰¾åˆ°å¼¹çª—å®¹å™¨:', modalId);
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°IDä¸º', modalId, 'çš„å…ƒç´ ');
                }
            }
            
            // ç­–ç•¥2: é€šè¿‡ç±»åæŸ¥æ‰¾å¼¹çª—
            if (!modalContainer && modalClassMatch) {
                const modalClass = modalClassMatch[1];
                const candidates = iframeDoc.querySelectorAll(`.${modalClass}`);
                if (candidates.length > 0) {
                    modalContainer = candidates[0];
                    console.log('ğŸ¯ é€šè¿‡ç±»åæ‰¾åˆ°å¼¹çª—å®¹å™¨:', modalClass);
                }
            }
            
            // ç­–ç•¥3: ä»é€‰æ‹©å™¨è·¯å¾„ä¸­æ¨æ–­å¼¹çª—å®¹å™¨
            if (!modalContainer) {
                const selectorParts = smartSelector.split(' > ');
                for (let i = 0; i < selectorParts.length - 1; i++) {
                    const part = selectorParts[i].trim();
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¼¹çª—å…³é”®è¯
                    const isModalPart = [
                        'popup', 'modal', 'dialog', 'panel', 'overlay'
                    ].some(keyword => part.toLowerCase().includes(keyword));
                    
                    if (isModalPart) {
                        try {
                            modalContainer = iframeDoc.querySelector(part);
                            if (modalContainer) {
                                console.log('ğŸ¯ é€šè¿‡é€‰æ‹©å™¨è·¯å¾„æ‰¾åˆ°å¼¹çª—å®¹å™¨:', part);
                                break;
                            }
                        } catch (e) {
                            console.warn('é€‰æ‹©å™¨æŸ¥æ‰¾å¤±è´¥:', part, e);
                        }
                    }
                }
            }
            
            if (modalContainer) {
                console.log('ğŸ“‹ å¼¹çª—å®¹å™¨ä¿¡æ¯:', {
                    tagName: modalContainer.tagName,
                    id: modalContainer.id,
                    className: modalContainer.className,
                    currentDisplay: modalContainer.style.display,
                    currentVisibility: modalContainer.style.visibility
                });
                
                // æ˜¾ç¤ºå¼¹çª—
                const showResult = await showModal(modalContainer, iframeDoc);
                
                if (showResult) {
                    // ç­‰å¾…å¼¹çª—æ˜¾ç¤ºå®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // éªŒè¯ç›®æ ‡å…ƒç´ æ˜¯å¦ç°åœ¨å¯è§
                    const targetElement = await findTargetElement(annotation, iframeDoc);
                    if (targetElement && isElementVisible(targetElement)) {
                        console.log('âœ… å¼¹çª—æ˜¾ç¤ºæˆåŠŸï¼Œç›®æ ‡å…ƒç´ ç°åœ¨å¯è§');
                        return true;
                    } else {
                        console.log('âš ï¸ å¼¹çª—å·²æ˜¾ç¤ºï¼Œä½†ç›®æ ‡å…ƒç´ ä»ä¸å¯è§');
                    }
                }
            } else {
                console.log('âŒ æ— æ³•ä»é€‰æ‹©å™¨ä¸­ç¡®å®šå¼¹çª—å®¹å™¨');
                
                // å¼ºåŒ–æŸ¥æ‰¾ç­–ç•¥ï¼šå°è¯•æ›´å¤šçš„æŸ¥æ‰¾æ–¹æ³•
                console.log('ğŸ” ä½¿ç”¨å¼ºåŒ–æŸ¥æ‰¾ç­–ç•¥...');
                const enhancedResult = await enhancedModalSearch(annotation, iframeDoc);
                if (enhancedResult) {
                    return true;
                }
            }
            
            return false;
        }
        
        // å¼ºåŒ–å¼¹çª—æŸ¥æ‰¾ç­–ç•¥
        async function enhancedModalSearch(annotation, iframeDoc) {
            console.log('ğŸ” å¼€å§‹å¼ºåŒ–å¼¹çª—æŸ¥æ‰¾...');
            
            const smartSelector = annotation.targetInfo?.smartSelector || '';
            const textContent = annotation.targetInfo?.textContent || '';
            
            // ç­–ç•¥1: æ·±åº¦DOMæŸ¥æ‰¾ - æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å¼¹çª—å®¹å™¨
            console.log('ğŸ“‹ ç­–ç•¥1: æ·±åº¦DOMæŸ¥æ‰¾æ‰€æœ‰å¼¹çª—å®¹å™¨...');
            const allPossibleModals = iframeDoc.querySelectorAll(`
                div[id*="popup"], div[id*="modal"], div[id*="dialog"],
                div[class*="popup"], div[class*="modal"], div[class*="dialog"],
                div[class*="overlay"], div[class*="panel"], 
                .plot-popup, .plot-info-popup, .info-popup,
                [role="dialog"], [aria-modal="true"]
            `);
            
            console.log(`ğŸ“Š æ‰¾åˆ° ${allPossibleModals.length} ä¸ªå¯èƒ½çš„å¼¹çª—å®¹å™¨`);
            
            for (let modal of allPossibleModals) {
                console.log('ğŸ” æ£€æŸ¥å¼¹çª—å®¹å™¨:', {
                    tagName: modal.tagName,
                    id: modal.id,
                    className: modal.className,
                    display: modal.style.display,
                    visibility: modal.style.visibility
                });
                
                // æ£€æŸ¥è¿™ä¸ªå®¹å™¨æ˜¯å¦åŒ…å«æˆ‘ä»¬è¦æ‰¾çš„å…ƒç´ 
                const headerInModal = modal.querySelector('.popup-header');
                if (headerInModal) {
                    console.log('ğŸ¯ åœ¨å¼¹çª—ä¸­æ‰¾åˆ°å¤´éƒ¨å…ƒç´ :', headerInModal);
                    
                    // æ˜¾ç¤ºè¿™ä¸ªå¼¹çª—
                    const showResult = await showModal(modal, iframeDoc);
                    if (showResult) {
                        // éªŒè¯ç›®æ ‡å…ƒç´ æ˜¯å¦ç°åœ¨å¯è§
                        const targetElement = await findTargetElement(annotation, iframeDoc);
                        if (targetElement && isElementVisible(targetElement)) {
                            console.log('âœ… å¼ºåŒ–æŸ¥æ‰¾æˆåŠŸï¼Œç›®æ ‡å…ƒç´ ç°åœ¨å¯è§');
                            return true;
                        }
                    }
                }
            }
            
            // ç­–ç•¥2: æ–‡æœ¬å†…å®¹åŒ¹é…æŸ¥æ‰¾
            console.log('ğŸ“‹ ç­–ç•¥2: åŸºäºæ–‡æœ¬å†…å®¹æŸ¥æ‰¾...');
            if (textContent && textContent.length > 5) {
                const textSearchKeywords = textContent.split(/\s+/).filter(word => word.length > 2);
                
                for (let keyword of textSearchKeywords) {
                    if (keyword.includes('è”¬èœ') || keyword.includes('åœ°å—') || keyword.includes('ä¿¡æ¯')) {
                        console.log('ğŸ” æœç´¢å…³é”®è¯:', keyword);
                        
                        // æŸ¥æ‰¾åŒ…å«è¿™äº›å…³é”®è¯çš„å…ƒç´ 
                        const allElements = iframeDoc.querySelectorAll('*');
                        for (let element of allElements) {
                            if (element.textContent && element.textContent.includes(keyword)) {
                                // å‘ä¸ŠæŸ¥æ‰¾å¯èƒ½çš„å¼¹çª—å®¹å™¨
                                const modalContainer = findParentModal(element);
                                if (modalContainer) {
                                    console.log('ğŸ¯ é€šè¿‡æ–‡æœ¬å†…å®¹æ‰¾åˆ°å¼¹çª—:', modalContainer);
                                    const showResult = await showModal(modalContainer, iframeDoc);
                                    if (showResult) {
                                        const targetElement = await findTargetElement(annotation, iframeDoc);
                                        if (targetElement && isElementVisible(targetElement)) {
                                            console.log('âœ… æ–‡æœ¬åŒ¹é…æŸ¥æ‰¾æˆåŠŸ');
                                            return true;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // ç­–ç•¥3: æ¨¡ç³Šé€‰æ‹©å™¨åŒ¹é…
            console.log('ğŸ“‹ ç­–ç•¥3: æ¨¡ç³Šé€‰æ‹©å™¨åŒ¹é…...');
            if (smartSelector) {
                // æå–é€‰æ‹©å™¨ä¸­çš„å…³é”®éƒ¨åˆ†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
                const selectorParts = smartSelector.split(/[>\s]+/).map(part => part.trim());
                
                for (let part of selectorParts) {
                    if (part.includes('popup') || part.includes('header') || part.includes('plot')) {
                        console.log('ğŸ” å°è¯•æ¨¡ç³Šé€‰æ‹©å™¨:', part);
                        
                        try {
                            // ç§»é™¤ç²¾ç¡®çš„ä¼ªç±»é€‰æ‹©å™¨ï¼Œè¿›è¡Œæ¨¡ç³ŠåŒ¹é…
                            const fuzzySelector = part.replace(/:\w+(-\w+)?\([^)]*\)/g, '');
                            const elements = iframeDoc.querySelectorAll(`[class*="${fuzzySelector.replace(/[.#]/g, '')}"], [id*="${fuzzySelector.replace(/[.#]/g, '')}"]`);
                            
                            for (let element of elements) {
                                const modalContainer = element.closest('[class*="popup"], [class*="modal"], [id*="popup"], [id*="modal"]') || findParentModal(element);
                                if (modalContainer) {
                                    console.log('ğŸ¯ é€šè¿‡æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°å¼¹çª—:', modalContainer);
                                    const showResult = await showModal(modalContainer, iframeDoc);
                                    if (showResult) {
                                        const targetElement = await findTargetElement(annotation, iframeDoc);
                                        if (targetElement && isElementVisible(targetElement)) {
                                            console.log('âœ… æ¨¡ç³ŠåŒ¹é…æŸ¥æ‰¾æˆåŠŸ');
                                            return true;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('æ¨¡ç³Šé€‰æ‹©å™¨åŒ¹é…å¤±è´¥:', part, e);
                        }
                    }
                }
            }
            
            // ç­–ç•¥4: å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰éšè—çš„å¯èƒ½å¼¹çª—
            console.log('ğŸ“‹ ç­–ç•¥4: å¼ºåˆ¶æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„éšè—å¼¹çª—...');
            const hiddenElements = iframeDoc.querySelectorAll(`
                div[style*="display: none"], div[style*="visibility: hidden"],
                .hidden, .hide, .d-none, [aria-hidden="true"]
            `);
            
            for (let element of hiddenElements) {
                // æ£€æŸ¥æ˜¯å¦çœ‹èµ·æ¥åƒå¼¹çª—
                const couldBeModal = (
                    element.id.toLowerCase().includes('popup') ||
                    element.id.toLowerCase().includes('modal') ||
                    element.className.toLowerCase().includes('popup') ||
                    element.className.toLowerCase().includes('modal') ||
                    element.querySelector('.popup-header, .modal-header, .dialog-header')
                );
                
                if (couldBeModal) {
                    console.log('ğŸ” å‘ç°éšè—çš„å¯èƒ½å¼¹çª—:', element);
                    const showResult = await showModal(element, iframeDoc);
                    if (showResult) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        const targetElement = await findTargetElement(annotation, iframeDoc);
                        if (targetElement && isElementVisible(targetElement)) {
                            console.log('âœ… éšè—å¼¹çª—æ˜¾ç¤ºæˆåŠŸ');
                            return true;
                        }
                    }
                }
            }
            
            console.log('âŒ æ‰€æœ‰å¼ºåŒ–æŸ¥æ‰¾ç­–ç•¥éƒ½å¤±è´¥äº†');
            return false;
        }
        
        // æŸ¥æ‰¾å¹¶ç‚¹å‡»è§¦å‘æŒ‰é’®
        function findAndClickTriggerButtons(annotation, iframeDoc) {
            const annotationText = annotation.name || annotation.targetInfo?.textContent || '';
            
            // æ ¹æ®æ‰¹æ³¨å†…å®¹æ™ºèƒ½æŸ¥æ‰¾å¯èƒ½çš„è§¦å‘æŒ‰é’®
            const possibleTriggers = [
                // é€šç”¨è§¦å‘å™¨é€‰æ‹©å™¨
                '[data-toggle="modal"]',
                '[data-target*="modal"]',
                '.modal-trigger',
                '.popup-trigger',
                '.detail-btn',
                '.info-btn',
                '.settings-btn',
                
                // å†œä¸šç³»ç»Ÿç‰¹å®š
                '.crop-detail-btn',
                '.device-info-btn',
                '.plot-info-btn'
            ];
            
            // åŸºäºæ–‡æœ¬å†…å®¹çš„æŒ‰é’®æŸ¥æ‰¾
            const textKeywords = [
                annotationText,
                'è¯¦æƒ…', 'ä¿¡æ¯', 'è®¾ç½®', 'æŸ¥çœ‹', 'æ˜¾ç¤º', 'æ‰“å¼€',
                'åœ°å—', 'ä½œç‰©', 'è®¾å¤‡', 'æ°”è±¡', 'åˆ†æ'
            ];
            
            possibleTriggers.forEach(selector => {
                try {
                    const buttons = iframeDoc.querySelectorAll(selector);
                    buttons.forEach(button => {
                        if (isElementVisible(button)) {
                            console.log('ğŸ–±ï¸ ç‚¹å‡»è§¦å‘æŒ‰é’®:', selector);
                            button.click();
                        }
                    });
                } catch (e) {
                    console.warn('ç‚¹å‡»è§¦å‘æŒ‰é’®å¤±è´¥:', selector, e);
                }
            });
            
            // æŸ¥æ‰¾åŒ…å«å…³é”®è¯çš„æŒ‰é’®
            findButtonsByText(iframeDoc, textKeywords);
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯åœ°å—å¼¹çª—ï¼Œå°è¯•ç‚¹å‡»åœ°å›¾åœ°å—
            if (annotationText.includes('åœ°å—') || annotation.targetInfo?.smartSelector?.includes('plot-popup')) {
                console.log('ğŸ—ºï¸ æ£€æµ‹åˆ°åœ°å—å¼¹çª—ï¼Œå°è¯•è§¦å‘åœ°å—ç‚¹å‡»...');
                triggerPlotClick(iframeDoc);
            }
        }
        
        // åŸºäºæ–‡æœ¬æŸ¥æ‰¾æŒ‰é’®
        function findButtonsByText(iframeDoc, keywords) {
            keywords.forEach(keyword => {
                if (!keyword || keyword.length < 2) return;
                
                try {
                    const allButtons = iframeDoc.querySelectorAll('button, input[type="button"], a[role="button"]');
                    
                    for (let button of allButtons) {
                        const text = button.textContent?.trim() || '';
                        const title = button.title || '';
                        const ariaLabel = button.getAttribute('aria-label') || '';
                        
                        if ((text.includes(keyword) || title.includes(keyword) || ariaLabel.includes(keyword)) 
                            && isElementVisible(button)) {
                            console.log('ğŸ–±ï¸ åŸºäºæ–‡æœ¬ç‚¹å‡»æŒ‰é’®:', keyword, text);
                            button.click();
                            return; // æ‰¾åˆ°å°±åœæ­¢
                        }
                    }
                } catch (e) {
                    console.warn('æ–‡æœ¬æŒ‰é’®æŸ¥æ‰¾å¤±è´¥:', keyword, e);
                }
            });
        }
        
        // æ˜¾ç¤ºéšè—çš„å¼¹çª—
        function showHiddenModals(iframeDoc) {
            const modalSelectors = [
                '.modal', '.dialog', '.popup', '.overlay', '.panel',
                '.detail-panel', '.info-panel', '.plot-popup',
                '[class*="modal"]', '[class*="popup"]', '[class*="dialog"]'
            ];
            
            modalSelectors.forEach(selector => {
                try {
                    const modals = iframeDoc.querySelectorAll(selector);
                    modals.forEach(modal => {
                        if (!isElementVisible(modal)) {
                            showModal(modal, iframeDoc);
                        }
                    });
                } catch (e) {
                    console.warn('æ˜¾ç¤ºéšè—å¼¹çª—å¤±è´¥:', selector, e);
                }
            });
        }
        
        // è§¦å‘å¼¹çª—ç›¸å…³äº‹ä»¶
        function triggerModalEvents(annotation, iframeDoc) {
            const events = [
                'showModal', 'openDialog', 'displayPopup', 'showPanel',
                'showDetail', 'openInfo', 'toggleModal'
            ];
            
            events.forEach(eventName => {
                try {
                    const event = new iframeDoc.defaultView.CustomEvent(eventName, {
                        bubbles: true,
                        detail: { annotation: annotation }
                    });
                    iframeDoc.dispatchEvent(event);
                } catch (e) {
                    console.warn('è§¦å‘äº‹ä»¶å¤±è´¥:', eventName, e);
                }
            });
        }
        
        // åŸºäºå…³é”®è¯å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
        function forceShowModalsByKeywords(annotation, iframeDoc) {
            const smartSelector = annotation.targetInfo?.smartSelector || '';
            const name = annotation.name || '';
            
            // ä»é€‰æ‹©å™¨å’Œåç§°ä¸­æå–å…³é”®è¯
            const keywords = [
                ...smartSelector.split(/[.#\s>]+/).filter(k => k.length > 2),
                ...name.split(/[\s\-_]+/).filter(k => k.length > 2)
            ];
            
            keywords.forEach(keyword => {
                try {
                    // æŸ¥æ‰¾åŒ…å«å…³é”®è¯çš„éšè—å…ƒç´ 
                    const elements = iframeDoc.querySelectorAll(`[class*="${keyword}"], [id*="${keyword}"]`);
                    elements.forEach(element => {
                        const className = element.className.toLowerCase();
                        const id = element.id.toLowerCase();
                        
                        // å¦‚æœçœ‹èµ·æ¥åƒå¼¹çª—å®¹å™¨
                        if (className.includes('modal') || className.includes('popup') || 
                            className.includes('dialog') || id.includes('modal') || 
                            id.includes('popup') || id.includes('dialog')) {
                            showModal(element, iframeDoc);
                        }
                    });
                } catch (e) {
                    console.warn('å…³é”®è¯å¼¹çª—æ˜¾ç¤ºå¤±è´¥:', keyword, e);
                }
            });
        }
        
        // è§¦å‘åœ°å—ç‚¹å‡»äº‹ä»¶
        function triggerPlotClick(iframeDoc) {
            console.log('ğŸ—ºï¸ å¼€å§‹å°è¯•è§¦å‘åœ°å—ç‚¹å‡»...');
            
            // ç­–ç•¥1: æŸ¥æ‰¾å¹¶ç‚¹å‡»åœ°å›¾ä¸Šçš„åœ°å—å…ƒç´ 
            const plotSelectors = [
                '.plot', '.crop-plot', '.field', '.land-plot', '.plot-layer',
                '[class*="plot"]', '[class*="field"]', '[class*="crop"]',
                'g[class*="plot"]', 'path[class*="plot"]', 'polygon[class*="plot"]',
                '.cesium-credit-logo', 'canvas'  // Cesiumåœ°å›¾å…ƒç´ 
            ];
            
            let clickSuccess = false;
            
            plotSelectors.forEach(selector => {
                if (clickSuccess) return;
                
                try {
                    const elements = iframeDoc.querySelectorAll(selector);
                    if (elements.length > 0) {
                        // ç‚¹å‡»ç¬¬ä¸€ä¸ªå¯è§çš„å…ƒç´ 
                        for (let element of elements) {
                            if (isElementVisible(element)) {
                                console.log('ğŸ¯ ç‚¹å‡»åœ°å—å…ƒç´ :', {
                                    selector: selector,
                                    tagName: element.tagName,
                                    className: element.className
                                });
                                
                                // æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
                                element.click();
                                clickSuccess = true;
                                break;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('åœ°å—å…ƒç´ ç‚¹å‡»å¤±è´¥:', selector, e);
                }
            });
            
            // ç­–ç•¥2: å¦‚æœæ²¡æœ‰æ‰¾åˆ°åœ°å—å…ƒç´ ï¼Œå°è¯•ç‚¹å‡»åœ°å›¾å®¹å™¨
            if (!clickSuccess) {
                console.log('ğŸ—ºï¸ æœªæ‰¾åˆ°åœ°å—å…ƒç´ ï¼Œå°è¯•ç‚¹å‡»åœ°å›¾å®¹å™¨...');
                
                const mapSelectors = [
                    '#cesiumContainer', '.cesium-viewer', '.map-container',
                    '#map', '.map', 'canvas', '.leaflet-container'
                ];
                
                mapSelectors.forEach(selector => {
                    if (clickSuccess) return;
                    
                    try {
                        const mapElement = iframeDoc.querySelector(selector);
                        if (mapElement && isElementVisible(mapElement)) {
                            console.log('ğŸ¯ ç‚¹å‡»åœ°å›¾å®¹å™¨:', selector);
                            
                            // åœ¨åœ°å›¾ä¸­å¿ƒä½ç½®æ¨¡æ‹Ÿç‚¹å‡»
                            const rect = mapElement.getBoundingClientRect();
                            const centerX = rect.left + rect.width / 2;
                            const centerY = rect.top + rect.height / 2;
                            
                            const clickEvent = new iframeDoc.defaultView.MouseEvent('click', {
                                bubbles: true,
                                cancelable: true,
                                view: iframeDoc.defaultView,
                                clientX: centerX,
                                clientY: centerY
                            });
                            mapElement.dispatchEvent(clickEvent);
                            clickSuccess = true;
                        }
                    } catch (e) {
                        console.warn('åœ°å›¾å®¹å™¨ç‚¹å‡»å¤±è´¥:', selector, e);
                    }
                });
            }
            
            // ä¸å†å¼ºåˆ¶åˆ›å»ºå¼¹çª—ï¼Œå¿…é¡»æ‰¾åˆ°ç°æœ‰å¼¹çª—
            if (!clickSuccess) {
                console.log('âš ï¸ æ‰€æœ‰åœ°å—ç‚¹å‡»ç­–ç•¥å¤±è´¥ï¼Œå¼¹çª—å¯èƒ½éœ€è¦å…¶ä»–æ–¹å¼è§¦å‘');
            }
            
            return clickSuccess;
        }
        


        // æ”¹è¿›çš„å…ƒç´ é€‰æ‹©å’Œé«˜äº®ç³»ç»Ÿ
        function enhancedHighlightElement(annotation) {
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) {
                console.warn('æ— æ³•è®¿é—®iframeå†…å®¹');
                return false;
            }
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) {
                console.warn('æ— æ³•è®¿é—®iframeæ–‡æ¡£');
                return false;
            }
            
            let targetElement = null;
            
            // ç­–ç•¥1: ä½¿ç”¨æ™ºèƒ½é€‰æ‹©å™¨
            if (annotation.targetInfo?.smartSelector) {
                try {
                    targetElement = iframeDoc.querySelector(annotation.targetInfo.smartSelector);
                    if (targetElement) {
                        console.log('âœ… æ™ºèƒ½é€‰æ‹©å™¨åŒ¹é…æˆåŠŸ');
                    }
                } catch (e) {
                    console.warn('âŒ æ™ºèƒ½é€‰æ‹©å™¨å¤±è´¥:', e);
                }
            }
            
            // ç­–ç•¥2: ä½¿ç”¨å…ƒç´ æŒ‡çº¹åŒ¹é…
            if (!targetElement && annotation.targetInfo?.elementFingerprint) {
                targetElement = findElementByFingerprint(annotation.targetInfo.elementFingerprint, iframeDoc);
                if (targetElement) {
                    console.log('âœ… å…ƒç´ æŒ‡çº¹åŒ¹é…æˆåŠŸ');
                }
            }
            
            // ç­–ç•¥3: æ–‡æœ¬å†…å®¹åŒ¹é…
            if (!targetElement && annotation.targetInfo?.textContent) {
                const textContent = annotation.targetInfo.textContent.trim();
                if (textContent) {
                    const allElements = iframeDoc.querySelectorAll('*');
                    for (let element of allElements) {
                        if (element.textContent?.trim() === textContent || 
                            element.textContent?.trim().includes(textContent.substring(0, 20))) {
                            targetElement = element;
                            console.log('âœ… æ–‡æœ¬å†…å®¹åŒ¹é…æˆåŠŸ');
                            break;
                        }
                    }
                }
            }
            
            // ç­–ç•¥4: å¤‡ç”¨é€‰æ‹©å™¨
            if (!targetElement && annotation.targetInfo?.fallbackSelector) {
                try {
                    const candidates = iframeDoc.querySelectorAll(annotation.targetInfo.fallbackSelector);
                    if (candidates.length === 1) {
                        targetElement = candidates[0];
                        console.log('âœ… å¤‡ç”¨é€‰æ‹©å™¨åŒ¹é…æˆåŠŸ');
                    } else if (candidates.length > 1 && annotation.targetInfo.textContent) {
                        // å¤šä¸ªå€™é€‰è€…æ—¶ï¼Œæ ¹æ®æ–‡æœ¬å†…å®¹è¿›ä¸€æ­¥ç­›é€‰
                        targetElement = Array.from(candidates).find(el => 
                            el.textContent?.trim().includes(annotation.targetInfo.textContent.substring(0, 20))
                        );
                        if (targetElement) {
                            console.log('âœ… å¤‡ç”¨é€‰æ‹©å™¨+æ–‡æœ¬ç­›é€‰åŒ¹é…æˆåŠŸ');
                        }
                    }
                } catch (e) {
                    console.warn('âŒ å¤‡ç”¨é€‰æ‹©å™¨å¤±è´¥:', e);
                }
            }
            
            if (targetElement) {
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                clearEnhancedHighlights();
                
                // æ·»åŠ å¢å¼ºçš„é«˜äº®æ•ˆæœ
                targetElement.style.outline = '3px solid #00a8ff';
                targetElement.style.outlineOffset = '2px';
                targetElement.style.backgroundColor = 'rgba(0, 168, 255, 0.1)';
                targetElement.style.boxShadow = '0 0 10px rgba(0, 168, 255, 0.5)';
                targetElement.setAttribute('data-enhanced-highlight', 'true');
                
                // æ·»åŠ è„‰æåŠ¨ç”»æ•ˆæœ
                targetElement.style.animation = 'pulse-highlight 2s ease-in-out 3';
                
                // æ»šåŠ¨åˆ°è§†å›¾
                targetElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'center' 
                });
                
                console.log('ğŸ¯ æˆåŠŸé«˜äº®å…ƒç´ :', {
                    tagName: targetElement.tagName,
                    className: targetElement.className,
                    textContent: targetElement.textContent?.substring(0, 50)
                });
                
                return true;
            } else {
                console.warn('âŒ æ‰€æœ‰åŒ¹é…ç­–ç•¥éƒ½å¤±è´¥äº†');
                return false;
            }
        }
        
        // æ¸…é™¤å¢å¼ºé«˜äº®æ•ˆæœ
        function clearEnhancedHighlights() {
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) return;
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) return;
            
            const highlightedElements = iframeDoc.querySelectorAll('[data-enhanced-highlight="true"]');
            highlightedElements.forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
                el.style.backgroundColor = '';
                el.style.boxShadow = '';
                el.style.animation = '';
                el.removeAttribute('data-enhanced-highlight');
            });
        }
        
        // æ·»åŠ CSSåŠ¨ç”»åˆ°iframe
        function addHighlightAnimationToIframe() {
            const iframe = document.getElementById('embeddedFrame');
            if (!iframe || !iframe.contentWindow) return;
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (!iframeDoc) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æ ·å¼
            if (iframeDoc.getElementById('highlight-animation-styles')) return;
            
            const style = iframeDoc.createElement('style');
            style.id = 'highlight-animation-styles';
            style.textContent = `
                @keyframes pulse-highlight {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.02); }
                    100% { transform: scale(1); }
                }
            `;
            iframeDoc.head.appendChild(style);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async function() {
            console.log('çª—å£åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢');
            await initializePage();
            
            // æ·»åŠ é«˜äº®åŠ¨ç”»æ ·å¼
            setTimeout(() => {
                addHighlightAnimationToIframe();
            }, 1000);
            
            // å¼ºåˆ¶åˆ·æ–°å…ƒç´ æ¸…å•
            setTimeout(() => {
                console.log('å¼ºåˆ¶åˆ·æ–°å…ƒç´ æ¸…å•');
                updateElementList();
            }, 3000);
        });
    </script>
</body>
</html>



