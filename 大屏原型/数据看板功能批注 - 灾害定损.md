# 数据看板功能批注 - 灾害定损 (disaster-monitoring.html)

## 📋 页面概览

**页面功能**: 灾害定损功能
**主要作用**: 农业灾害监测、损失评估、预警管理、应急响应
**技术栈**: Cesium.js 地图引擎 + ECharts 图表库 + 实时监测系统

## 🚨 核心功能模块

### 1. 灾害监测控制面板 (disaster-control-panel)

#### 功能说明
- **监测类型选择**: 3种主要灾害监测类型
  - 🌡️ 低温冻害监测 (temperature)
  - 🌵 干旱监测 (drought)  
  - 📊 综合灾害监测 (comprehensive)

- **作物类型筛选**: 5种主要作物类型
  - 🌾 小麦 (wheat)
  - 🌽 玉米 (corn)
  - 🥬 蔬菜 (vegetables)
  - 🥔 土豆 (potato)
  - 🌻 油菜 (rapeseed)

- **时间范围选择**: 5个时间维度
  - ⏰ 当前状态 (current)
  - 📅 近一周 (week)
  - 📆 近一月 (month)
  - 🌱 本季度 (season)
  - 📅 本年度 (year)

#### 实现原理
```javascript
// disaster-monitoring.js
let currentMonitoringConfig = {
    type: null,           // null (未选中), temperature, drought, comprehensive
    crop: 'wheat',        // wheat, corn, vegetables, potato, rapeseed
    time: 'current',      // current, week, month, season, year
    opacity: 85           // 图层透明度
};

// 控制面板交互逻辑
function updateMonitoringConfig(type, crop, time) {
    currentMonitoringConfig.type = type;
    currentMonitoringConfig.crop = crop;
    currentMonitoringConfig.time = time;
    
    // 更新地图图层
    updateDisasterLayers();
    
    // 更新数据面板
    updateDisasterDashboard();
}
```

#### 交互特性
- **可折叠面板**: 节省屏幕空间，专注地图显示
- **实时预览**: 选项变更即时反映在地图和数据面板
- **状态保持**: 用户选择的配置在会话期间保持

### 2. 左侧数据面板 - 损失预测分析

#### 2.1 损失预测统计图表
**功能**: ECharts柱状图显示不同作物的损失预测

**数据结构**:
```javascript
// 损失预测数据
const lossPredictionData = {
    wheat: {
        totalArea: 2847,        // 总种植面积 (亩)
        affectedArea: 568,      // 受灾面积 (亩)
        lossRate: 19.9,         // 损失率 (%)
        economicLoss: 45.6,     // 经济损失 (万元)
        severity: 'moderate'    // 灾害严重程度
    },
    corn: {
        totalArea: 2156,
        affectedArea: 432,
        lossRate: 20.0,
        economicLoss: 38.9,
        severity: 'moderate'
    }
    // ... 其他作物数据
};
```

**图表特性**:
- 双Y轴设计: 左轴显示面积，右轴显示损失率
- 颜色编码: 根据损失严重程度使用不同颜色
- 交互提示: 鼠标悬浮显示详细损失信息
- 动态更新: 根据选择的监测配置实时更新

#### 2.2 历史灾害对比分析
**功能**: 展示历史同期灾害发生情况对比

**对比维度**:
- 灾害发生频次对比
- 受灾面积变化趋势
- 经济损失金额对比
- 防灾减灾效果评估

**技术实现**:
```javascript
// 历史数据对比图表
function initHistoricalDisasterChart() {
    const option = {
        title: { text: '历史灾害对比分析' },
        xAxis: {
            data: ['2021年', '2022年', '2023年', '2024年', '2025年(预测)']
        },
        yAxis: [
            { type: 'value', name: '受灾面积(亩)' },
            { type: 'value', name: '经济损失(万元)' }
        ],
        series: [
            {
                name: '受灾面积',
                type: 'bar',
                data: [1250, 980, 1450, 1100, 890]
            },
            {
                name: '经济损失',
                type: 'line',
                yAxisIndex: 1,
                data: [95.6, 76.8, 118.9, 89.2, 72.3]
            }
        ]
    };
}
```

#### 2.3 损失分布饼图
**功能**: 显示不同类型灾害造成的损失比例分布

**损失类型分类**:
- 🌡️ 低温冻害: 35.2%
- 🌵 干旱灾害: 28.6%
- 🌧️ 洪涝灾害: 18.9%
- 🌪️ 风雹灾害: 12.1%
- 🐛 病虫害: 5.2%

### 3. 右侧数据面板 - 预警与应急

#### 3.1 灾害预警信息
**功能**: 实时显示各类农业灾害预警信息

**预警等级系统**:
```javascript
const alertLevels = {
    blue: { level: 1, name: '蓝色预警', color: '#3498db' },
    yellow: { level: 2, name: '黄色预警', color: '#f1c40f' },
    orange: { level: 3, name: '橙色预警', color: '#e67e22' },
    red: { level: 4, name: '红色预警', color: '#e74c3c' }
};
```

**预警信息结构**:
- 预警类型 (低温/干旱/洪涝等)
- 预警等级 (蓝/黄/橙/红)
- 发布时间
- 影响区域
- 预警措施建议

#### 3.2 应急响应方案
**功能**: 根据灾害类型自动推荐应急响应措施

**响应方案分类**:
1. **低温冻害应急方案**:
   - 🔥 熏烟防霜措施
   - 💧 灌水保温方法
   - 🛡️ 覆盖保护设施
   - 💊 化学防冻剂喷施

2. **干旱应急方案**:
   - 💧 应急灌溉调度
   - 🌧️ 人工增雨作业
   - 🌾 抗旱品种替换
   - 💧 节水技术推广

3. **综合应急方案**:
   - 📞 应急联系网络
   - 🚛 物资调配方案
   - 👥 人员疏散预案
   - 📋 损失评估流程

#### 3.3 实时监测数据
**功能**: 显示关键环境指标的实时监测数据

**监测指标**:
```javascript
const monitoringData = {
    temperature: {
        current: 3.2,           // 当前温度 (°C)
        dailyMin: -1.5,         // 日最低温 (°C)
        freezeRisk: 85,         // 冻害风险指数 (%)
        trend: 'decreasing'     // 变化趋势
    },
    soilMoisture: {
        current: 35.8,          // 土壤含水量 (%)
        optimal: 45,            // 最适含水量 (%)
        droughtRisk: 42,        // 干旱风险指数 (%)
        trend: 'stable'         // 变化趋势
    },
    precipitation: {
        daily: 0.0,             // 日降水量 (mm)
        monthly: 12.8,          // 月累计降水 (mm)
        seasonalDeficit: -25.6, // 季节性降水亏缺 (mm)
        trend: 'decreasing'     // 变化趋势
    }
};
```

### 4. 灾害图层可视化

#### 4.1 Cesium图层渲染
**功能**: 在地图上叠加显示不同类型的灾害监测图层

**图层类型**:
1. **温度监测图层**: 显示地表温度分布和冻害风险区域
2. **干旱监测图层**: 展示土壤湿度和干旱程度分布
3. **综合风险图层**: 多种灾害风险的综合评估结果

**技术实现**:
```javascript
// 图层加载逻辑
function loadDisasterImageryLayer(disasterType, cropType, timeRange) {
    const imageryProvider = new Cesium.UrlTemplateImageryProvider({
        url: `https://api.disaster.com/v1/layers/${disasterType}/${cropType}/${timeRange}/{z}/{x}/{y}.png`,
        maximumLevel: 12,
        credit: '农业灾害监测系统'
    });
    
    const imageryLayer = new Cesium.ImageryLayer(imageryProvider, {
        alpha: currentMonitoringConfig.opacity / 100
    });
    
    cesiumViewer.imageryLayers.add(imageryLayer);
    return imageryLayer;
}
```

#### 4.2 热力图显示
**功能**: 使用热力图方式显示灾害强度分布

**颜色映射方案**:
```javascript
const disasterColorScale = {
    temperature: {
        safe: '#00ff00',      // 安全: 绿色
        caution: '#ffff00',   // 注意: 黄色  
        warning: '#ff8800',   // 警告: 橙色
        danger: '#ff0000'     // 危险: 红色
    },
    drought: {
        normal: '#0066cc',    // 正常: 蓝色
        mild: '#00cc66',      // 轻度: 浅绿
        moderate: '#ffcc00',  // 中度: 黄色
        severe: '#ff6600'     // 重度: 橙红
    }
};
```

### 5. 灾害信息弹窗 (disaster-tooltip)

#### 功能说明
- **鼠标悬浮交互**: 鼠标移动到地图显示该位置灾害信息
- **多维度信息**: 温度、湿度、风险等级等多个维度
- **实时计算**: 根据鼠标位置实时计算风险指数

#### 实现原理
```javascript
// 灾害弹窗初始化
function initDisasterTooltip() {
    disasterTooltip = document.createElement('div');
    disasterTooltip.className = 'disaster-tooltip';
    disasterTooltip.innerHTML = `
        <div class="tooltip-header">灾害监测信息</div>
        <div class="tooltip-content">
            <div class="tooltip-item">
                <span class="label">坐标位置:</span>
                <span class="value" id="tooltip-coordinates">--</span>
            </div>
            <div class="tooltip-item">
                <span class="label">温度:</span>
                <span class="value" id="tooltip-temperature">--</span>
            </div>
            <div class="tooltip-item">
                <span class="label">风险等级:</span>
                <span class="value" id="tooltip-risk">--</span>
            </div>
        </div>
    `;
    document.body.appendChild(disasterTooltip);
}
```

## 🎨 UI设计特性

### 灾害预警配色
```css
:root {
    --disaster-safe: #00ff88;
    --disaster-caution: #ffcc00;
    --disaster-warning: #ff8800;
    --disaster-danger: #ff4757;
    --disaster-critical: #8b0000;
}
```

### 动态效果
- **预警闪烁动画**: 高级别预警信息的闪烁提醒
- **风险区域脉冲**: 高风险区域的脉冲效果
- **数据滚动更新**: 监测数据的数字滚动动画
- **图层切换过渡**: 平滑的图层透明度变化

### 交互反馈
- **悬浮高亮**: 鼠标悬浮时元素高亮显示
- **点击反馈**: 按钮点击时的视觉反馈效果
- **加载状态**: 数据加载时的loading动画
- **错误提示**: 数据加载失败时的友好提示

## 📊 数据处理架构

### 数据来源
1. **气象监测站**: 实时温度、湿度、降水数据
2. **卫星遥感**: 地表温度、植被指数、土壤湿度
3. **物联网传感器**: 田间环境监测设备
4. **历史数据库**: 历史灾害记录和统计数据

### 风险评估算法
```javascript
// 综合风险评估模型
function calculateDisasterRisk(temperature, soilMoisture, precipitation, cropType, growthStage) {
    let riskScore = 0;
    
    // 温度风险评估
    const tempRisk = assessTemperatureRisk(temperature, cropType, growthStage);
    
    // 水分风险评估
    const moistureRisk = assessMoistureRisk(soilMoisture, precipitation);
    
    // 综合风险计算
    riskScore = (tempRisk * 0.4) + (moistureRisk * 0.6);
    
    return {
        total: riskScore,
        level: getRiskLevel(riskScore),
        components: {
            temperature: tempRisk,
            moisture: moistureRisk
        }
    };
}
```

### 损失评估模型
```javascript
// 经济损失评估
function calculateEconomicLoss(affectedArea, cropType, disasterType, severity) {
    const cropPrices = {
        wheat: 2.8,    // 元/kg
        corn: 2.6,     // 元/kg
        vegetables: 4.2 // 元/kg
    };
    
    const averageYields = {
        wheat: 450,    // kg/亩
        corn: 520,     // kg/亩
        vegetables: 2800 // kg/亩
    };
    
    const lossRates = {
        mild: 0.1,     // 10%损失
        moderate: 0.3, // 30%损失  
        severe: 0.6    // 60%损失
    };
    
    const yieldLoss = affectedArea * averageYields[cropType] * lossRates[severity];
    const economicLoss = yieldLoss * cropPrices[cropType];
    
    return {
        yieldLoss: yieldLoss,      // kg
        economicLoss: economicLoss, // 元
        lossRate: lossRates[severity] * 100 // %
    };
}
```

## 🔧 技术实现细节

### 实时数据更新
```javascript
// 实时数据更新机制
function initRealTimeUpdates() {
    // WebSocket连接
    const websocket = new WebSocket('wss://api.disaster.com/realtime');
    
    websocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        // 更新监测数据
        updateMonitoringData(data.monitoring);
        
        // 更新预警信息
        updateAlertInfo(data.alerts);
        
        // 更新图表数据
        updateDisasterCharts(data.statistics);
    };
    
    // 定时数据同步
    setInterval(syncDisasterData, 5 * 60 * 1000); // 5分钟同步一次
}
```

### 图层管理
```javascript
// 图层状态管理
class DisasterLayerManager {
    constructor() {
        this.layers = new Map();
        this.activeLayer = null;
    }
    
    addLayer(type, layer) {
        this.layers.set(type, layer);
    }
    
    switchLayer(type) {
        // 隐藏当前图层
        if (this.activeLayer) {
            this.activeLayer.show = false;
        }
        
        // 显示新图层
        const newLayer = this.layers.get(type);
        if (newLayer) {
            newLayer.show = true;
            this.activeLayer = newLayer;
        }
    }
    
    removeLayer(type) {
        const layer = this.layers.get(type);
        if (layer) {
            cesiumViewer.imageryLayers.remove(layer);
            this.layers.delete(type);
        }
    }
}
```

## 🎯 应用场景

### 防灾减灾决策
- **提前预警**: 基于气象预报提前发布灾害预警
- **应急调度**: 快速调配防灾减灾资源
- **损失评估**: 灾后快速评估损失情况
- **保险理赔**: 为农业保险提供损失评估依据

### 农业生产指导
- **种植布局优化**: 根据灾害风险调整种植结构
- **田间管理**: 指导农户采取预防措施
- **品种选择**: 推荐抗灾性强的作物品种
- **技术推广**: 推广防灾减灾技术

### 政策制定支持
- **风险区划**: 为农业区划提供科学依据
- **补贴政策**: 制定差异化的农业补贴政策
- **基础设施**: 指导农业基础设施建设
- **保险产品**: 开发针对性的农业保险产品

## 📈 效果评估

### 监测精度
- **空间分辨率**: 100米×100米网格精度
- **时间分辨率**: 小时级数据更新
- **预警准确率**: ≥85%的预警准确率
- **损失评估误差**: ±10%的损失评估精度

### 响应效率
- **预警时效**: 灾害发生前12-24小时发布预警
- **应急响应**: 2小时内启动应急响应
- **损失评估**: 灾后24小时内完成初步评估
- **信息传播**: 5分钟内将预警信息推送到用户

## 🚀 扩展功能建议

### 功能增强
1. **AI预测模型**: 引入深度学习提升预测精度
2. **移动端APP**: 开发移动端灾害监测应用
3. **无人机巡检**: 集成无人机实地巡检数据
4. **区块链溯源**: 建立灾害数据可信溯源体系

### 技术升级
1. **边缘计算**: 部署边缘计算节点提升响应速度
2. **5G通信**: 利用5G网络实现超低延迟数据传输
3. **数字孪生**: 构建农田数字孪生模型
4. **知识图谱**: 建立农业灾害知识图谱

---

**文档版本**: v1.0
**创建时间**: 2025-01-17
**更新时间**: 2025-01-17
**维护人员**: 系统开发团队