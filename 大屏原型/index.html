<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†œæƒ…é¥æ„Ÿç³»ç»Ÿå¤§å± - ä½œç‰©åˆ†å¸ƒåŠŸèƒ½</title>
    
    <!-- å¼•å…¥Cesium CSS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    
    <!-- å¼•å…¥ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/cesium-map.css">
    <link rel="stylesheet" href="assets/css/township-blocks.css">
    <link rel="stylesheet" href="assets/css/timeline.css">
</head>
<body>
    <!-- é¢„è­¦æ¨ªå¹…æ»šåŠ¨åŒºåŸŸ -->
    <div class="alert-banner" id="alert-banner" style="display: none;">
        <div class="alert-banner-content" onclick="toggleAlertPanel()">
            <div class="alert-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-text-container">
                <div class="alert-text" id="alert-text">
                    <!-- æ»šåŠ¨çš„é¢„è­¦ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="alert-expand-icon" id="alert-expand-icon">
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="alert-close" onclick="closeAlertBanner(event)">
                <i class="fas fa-times"></i>
            </div>
        </div>
    </div>

    <!-- é¢„è­¦å±•å¼€é¢æ¿ -->
    <div class="alert-panel" id="alert-panel" style="display: none;">
        <div class="alert-panel-header">
            <div class="panel-title">
                <i class="fas fa-exclamation-triangle"></i>
                <span>é¢„è­¦ä¿¡æ¯è¯¦æƒ…</span>
            </div>
            <div class="panel-close" onclick="closeAlertPanel()">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="alert-panel-content" id="alert-panel-content">
            <!-- é¢„è­¦åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <!-- é¡¶éƒ¨ç³»ç»Ÿæ¨ªå¹… -->
    <div class="system-header">
        <!-- å·¦ä¾§ç³»ç»ŸçŠ¶æ€ -->
        <div class="header-left">
            <div class="system-status">
                <span class="status-dot"></span>
                <span class="status-text">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
            </div>
            <!-- å¯¼å‡ºæŠ¥è¡¨æŒ‰é’® -->
            <div class="export-report-btn" onclick="showReportPreview()" title="å¯¼å‡ºå†œæƒ…ç›‘æµ‹æŠ¥è¡¨">
                <span class="export-icon">ğŸ“Š</span>
                <span class="export-text">å¯¼å‡ºæŠ¥è¡¨</span>
            </div>
        </div>

        <!-- ä¸­å¿ƒæ ‡é¢˜ -->
        <div class="system-title">
            ä¸´å¤å¿å«æ˜Ÿé¥æ„Ÿå¹³å°
            <div class="system-subtitle">Linxia County Satellite Remote Sensing Platform</div>
        </div>

        <!-- å³ä¾§æ—¶é—´æ˜¾ç¤ºå’Œç”¨æˆ·ä¿¡æ¯ -->
        <div class="header-right">
            <div class="current-time">
                <div class="time-display" id="current-time">2024-01-15 14:30:25</div>
                <div class="date-display" id="current-date">æ˜ŸæœŸä¸€</div>
            </div>

            <!-- åŒºåŸŸé€‰æ‹© -->
            <div class="region-selector">
                <div class="region-display" onclick="toggleRegionDropdown()">
                    <span class="region-icon">ğŸ“</span>
                    <span class="region-name" id="selected-region">å…¨å¿</span>
                    <span class="dropdown-arrow">â–¼</span>
                </div>

                <!-- åŒºåŸŸä¸‹æ‹‰èœå• -->
                <div class="region-dropdown" id="region-dropdown">
                    <div class="dropdown-item active" data-region="all" onclick="selectRegion('all', 'å…¨å¿')">
                        <span>ğŸ›ï¸</span>
                        <span>å…¨å¿</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-region="chengguan" onclick="selectRegion('chengguan', 'åŸå…³é•‡')">
                        <span>ğŸ¢</span>
                        <span>åŸå…³é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="tuchang" onclick="selectRegion('tuchang', 'åœŸåœºé•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>åœŸåœºé•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="beita" onclick="selectRegion('beita', 'åŒ—å¡”é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>åŒ—å¡”é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="hongguang" onclick="selectRegion('hongguang', 'çº¢å…‰é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>çº¢å…‰é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="jishishan" onclick="selectRegion('jishishan', 'ç§¯çŸ³å±±é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>ç§¯çŸ³å±±é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="hanjiaji" onclick="selectRegion('hanjiaji', 'éŸ©å®¶é›†é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>éŸ©å®¶é›†é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="xinji" onclick="selectRegion('xinji', 'æ–°é›†é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>æ–°é›†é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="liujiaxia" onclick="selectRegion('liujiaxia', 'åˆ˜å®¶å³¡é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>åˆ˜å®¶å³¡é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="taiping" onclick="selectRegion('taiping', 'å¤ªå¹³é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>å¤ªå¹³é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="minfeng" onclick="selectRegion('minfeng', 'æ°‘ä¸°é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>æ°‘ä¸°é•‡</span>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
            <div class="user-info">
                <div class="user-avatar">
                    å¼ 
                    <div class="user-status"></div>
                </div>
                <div class="user-details">
                    <div class="user-name">å¼ ä¸‰</div>
                    <div class="user-role">ç³»ç»Ÿç®¡ç†å‘˜</div>
                </div>
                
                <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
                <div class="user-dropdown">
                    <div class="dropdown-item" onclick="showUserProfile()">
                        <span>ğŸ‘¤</span>
                        <span>ä¸ªäººä¿¡æ¯</span>
                    </div>
                    <div class="dropdown-item" onclick="showSystemSettings()">
                        <span>âš™ï¸</span>
                        <span>ç³»ç»Ÿè®¾ç½®</span>
                    </div>
                    <div class="dropdown-item" onclick="showOperationLog()">
                        <span>ğŸ“Š</span>
                        <span>æ“ä½œæ—¥å¿—</span>
                    </div>
                    <div class="dropdown-item" onclick="showHelp()">
                        <span>â“</span>
                        <span>å¸®åŠ©ä¸­å¿ƒ</span>
                    </div>
                    <div class="dropdown-item" onclick="logout()">
                        <span>ğŸšª</span>
                        <span>é€€å‡ºç™»å½•</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½åˆ‡æ¢æ¨¡å— -->
    <div class="function-switch-bar">
        <!-- ä¸»åŠŸèƒ½æŒ‰é’®ç»„ (5ä¸ª) -->
        <div class="main-switch-buttons">
            <div class="main-switch-btn active" data-function="crop-distribution">
                <span class="btn-icon">ğŸŒ¾</span>
                <span class="btn-text">ä½œç‰©åˆ†å¸ƒ</span>
            </div>
            <div class="main-switch-btn" data-function="growth-analysis" onclick="navigateToPage('growth-analysis-main.html')">
                <span class="btn-icon">ğŸ“Š</span>
                <span class="btn-text">é•¿åŠ¿åˆ†æ</span>
            </div>
            <div class="main-switch-btn" data-function="yield-estimation" onclick="navigateToPage('yield-estimation.html')">
                <span class="btn-icon">ğŸ“ˆ</span>
                <span class="btn-text">äº§é‡é¢„ä¼°</span>
            </div>
            <div class="main-switch-btn" data-function="weather-monitoring" onclick="navigateToPage('weather-monitoring.html')">
                <span class="btn-icon">ğŸŒ¤ï¸</span>
                <span class="btn-text">æ°”è±¡ç›‘æµ‹</span>
            </div>
            <div class="main-switch-btn" data-function="disaster-monitoring" onclick="navigateToPage('disaster-monitoring.html')">
                <span class="btn-icon">âš ï¸</span>
                <span class="btn-text">ç¾å®³å®šæŸ</span>
            </div>
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="switch-divider"></div>

        <!-- å åŠ åŠŸèƒ½æŒ‰é’® (2ä¸ª) -->
        <div class="overlay-switch-btn" data-function="device-monitoring">
            <span class="btn-icon">ğŸ“±</span>
            <span class="btn-text">è®¾å¤‡ç›‘æ§</span>
        </div>
        
        <div class="overlay-switch-btn" data-function="crop-selection">
            <span class="btn-icon">ğŸŒ¾</span>
            <span class="btn-text">ä½œç‰©é€‰æ‹©</span>
        </div>
        
        <!-- ç¬¬äºŒä¸ªåˆ†éš”çº¿ -->
        <div class="switch-divider"></div>
        
        <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
        <div class="map-reset-btn" title="é‡ç½®è§†å›¾" onclick="resetMapView()">
            <span class="btn-icon">ğŸ¯</span>
            <span class="btn-text">é‡ç½®è§†å›¾</span>
        </div>
    </div>


    <!-- ä¸»åœ°å›¾å®¹å™¨ -->
    <div id="map-container">
        <!-- ç§‘æŠ€æ„ŸèƒŒæ™¯å…ƒç´  -->
        <div class="tech-grid"></div>
        
        <!-- Cesiumåœ°å›¾å®¹å™¨ -->
        <div id="cesium-container"></div>
        
        <!-- åœ°å›¾è¦†ç›–å±‚ -->
        <div class="map-overlay"></div>





        <!-- å³ä¾§ä½œç‰©åˆ†å¸ƒæ•°æ®çœ‹æ¿ -->
        <div class="glass-panel right-panel">
            <div class="panel-header">
                <div class="panel-title">
                    ğŸŒ¾ ä½œç‰©åˆ†å¸ƒç›‘æµ‹çœ‹æ¿
                </div>
                <button class="collapse-btn">â–¶</button>
            </div>

            <!-- 1. åŒºåŸŸé¢ç§¯æ±‡æ€»çœ‹æ¿ -->
            <div class="stat-card" id="region-summary-card">
                <div class="stat-header">
                    ğŸ“‹ åŒºåŸŸé¢ç§¯æ±‡æ€»
                </div>
                <div class="area-summary">
                    <div class="summary-item large">
                        <div class="summary-value" id="total-area-value">5,272</div>
                        <div class="summary-label">æ€»ç›‘æµ‹é¢ç§¯ (äº©)</div>
                        <div class="summary-subtitle" id="coverage-info">è¦†ç›–8ä¸ªä¹¡é•‡</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-item">
                            <div class="summary-value" id="growth-index-value">0.8</div>
                            <div class="summary-label">å¹³å‡é•¿åŠ¿æŒ‡æ•°</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. å•ä½œç‰©æŒ‰ä¹¡é•‡é¢ç§¯åˆ†å¸ƒ -->
            <div class="stat-card chart-data-panel" style="height: 260px !important; min-height: 260px !important; max-height: 260px !important; display: flex !important; flex-direction: column !important; overflow: hidden !important;">
                <div class="stat-header" style="flex-shrink: 0 !important; flex-grow: 0 !important;">
                    <span id="current-crop-title">ğŸŒ¾ å°éº¦æŒ‰ä¹¡é•‡é¢ç§¯åˆ†å¸ƒ</span>
                </div>
                <div id="town-crop-chart" style="height: 220px; flex-shrink: 0 !important; flex-grow: 0 !important; margin: 0 !important;"></div>
            </div>

            <!-- 3. ç§æ¤é¢ç§¯å˜åŒ–è¶‹åŠ¿å›¾ -->
            <div class="stat-card">
                <div class="stat-header">
                    <span class="section-icon">ğŸ“ˆ</span>
                    ç§æ¤é¢ç§¯å˜åŒ–è¶‹åŠ¿å›¾
                </div>
                <div class="trend-comparison-container">
                    <div id="growth-trend-comparison" class="chart-container"></div>
                </div>
            </div>

            <div class="update-time">
                ğŸ”„ æ•°æ®æ›´æ–°: 2024-01-15 14:30 | é¥æ„Ÿæ•°æ®: 2024-01-12
            </div>
        </div>
    </div>

    <!-- æ—¶é—´è½´ç»„ä»¶ -->
    <div class="timeline-container" id="timeline-container">
        <!-- æ—¶é—´è½´æ ‡é¢˜æ  -->
        <div class="timeline-header">
            <div class="timeline-title">
                <span class="timeline-icon">ğŸ“…</span>
                <span class="timeline-text">æ•°æ®æ—¶é—´è½´</span>
            </div>
            <div class="timeline-controls">
                <span class="timeline-year">2025å¹´</span>
            </div>
        </div>
        
        <!-- æ—¶é—´è½´ä¸»ä½“ -->
        <div class="timeline-track">
            <!-- æ—¶é—´è½´èƒŒæ™¯çº¿ -->
            <div class="timeline-line"></div>
            
            <!-- è¿›åº¦æŒ‡ç¤ºæ¡ -->
            <div class="timeline-progress" id="timeline-progress" style="width: 66.67%;"></div>
            
            <!-- å½“å‰æ—¶é—´æŒ‡ç¤ºå™¨ -->
            <div class="current-time-indicator" id="current-time-indicator" style="left: 62.5%;">
                <div class="indicator-dot"></div>
                <div class="indicator-label">å½“å‰</div>
            </div>
            
            <!-- æœˆä»½èŠ‚ç‚¹å®¹å™¨ -->
            <div class="timeline-months" id="timeline-months">
                <!-- 1æœˆ -->
                <div class="month-node winter" data-month="1" data-season="winter" onclick="selectMonth(1)" title="1æœˆæ•°æ® - å†¬å­£ä½œç‰©ä¼‘çœ æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">1æœˆ</div>
                    <div class="season-indicator">å†¬</div>
                </div>
                
                <!-- 2æœˆ -->
                <div class="month-node winter" data-month="2" data-season="winter" onclick="selectMonth(2)" title="2æœˆæ•°æ® - æ˜¥è€•å‡†å¤‡æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">2æœˆ</div>
                    <div class="season-indicator">å†¬</div>
                </div>
                
                <!-- 3æœˆ -->
                <div class="month-node spring" data-month="3" data-season="spring" onclick="selectMonth(3)" title="3æœˆæ•°æ® - æ˜¥è€•æ’­ç§æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">3æœˆ</div>
                    <div class="season-indicator">æ˜¥</div>
                </div>
                
                <!-- 4æœˆ -->
                <div class="month-node spring" data-month="4" data-season="spring" onclick="selectMonth(4)" title="4æœˆæ•°æ® - ä½œç‰©ç”Ÿé•¿æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">4æœˆ</div>
                    <div class="season-indicator">æ˜¥</div>
                </div>
                
                <!-- 5æœˆ -->
                <div class="month-node spring" data-month="5" data-season="spring" onclick="selectMonth(5)" title="5æœˆæ•°æ® - ä½œç‰©å¿«é€Ÿç”Ÿé•¿æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">5æœˆ</div>
                    <div class="season-indicator">æ˜¥</div>
                </div>
                
                <!-- 6æœˆ -->
                <div class="month-node summer" data-month="6" data-season="summer" onclick="selectMonth(6)" title="6æœˆæ•°æ® - å¤å­£ç”Ÿé•¿æ—ºæœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">6æœˆ</div>
                    <div class="season-indicator">å¤</div>
                </div>
                
                <!-- 7æœˆ -->
                <div class="month-node summer" data-month="7" data-season="summer" onclick="selectMonth(7)" title="7æœˆæ•°æ® - ä½œç‰©å¼€èŠ±ç»“æœæœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">7æœˆ</div>
                    <div class="season-indicator">å¤</div>
                </div>
                
                <!-- 8æœˆ - å½“å‰æ¿€æ´»æœˆä»½ -->
                <div class="month-node summer active current" data-month="8" data-season="summer" onclick="selectMonth(8)" title="8æœˆæ•°æ® - ä½œç‰©æˆç†ŸæœŸï¼ˆå½“å‰æœˆä»½ï¼‰">
                    <div class="month-dot"></div>
                    <div class="month-label">8æœˆ</div>
                    <div class="season-indicator">å¤</div>
                    <div class="current-badge">å½“å‰</div>
                </div>
                
                <!-- 9æœˆ -->
                <div class="month-node autumn" data-month="9" data-season="autumn" onclick="selectMonth(9)" title="9æœˆæ•°æ® - ç§‹æ”¶å­£èŠ‚">
                    <div class="month-dot"></div>
                    <div class="month-label">9æœˆ</div>
                    <div class="season-indicator">ç§‹</div>
                </div>
                
                <!-- 10æœˆ -->
                <div class="month-node autumn" data-month="10" data-season="autumn" onclick="selectMonth(10)" title="10æœˆæ•°æ® - ä¸»è¦æ”¶è·æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">10æœˆ</div>
                    <div class="season-indicator">ç§‹</div>
                </div>
                
                <!-- 11æœˆ -->
                <div class="month-node autumn" data-month="11" data-season="autumn" onclick="selectMonth(11)" title="11æœˆæ•°æ® - æ”¶è·å®ŒæˆæœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">11æœˆ</div>
                    <div class="season-indicator">ç§‹</div>
                </div>
                
                <!-- 12æœˆ -->
                <div class="month-node winter" data-month="12" data-season="winter" onclick="selectMonth(12)" title="12æœˆæ•°æ® - å†¬å­£ä¼‘è€•æœŸ">
                    <div class="month-dot"></div>
                    <div class="month-label">12æœˆ</div>
                    <div class="season-indicator">å†¬</div>
                </div>
            </div>
            
            <!-- å­£èŠ‚åˆ†å‰²çº¿ -->
            <div class="season-dividers">
                <div class="season-divider spring-start" style="left: 16.67%;" title="æ˜¥å­£å¼€å§‹"></div>
                <div class="season-divider summer-start" style="left: 41.67%;" title="å¤å­£å¼€å§‹"></div>
                <div class="season-divider autumn-start" style="left: 66.67%;" title="ç§‹å­£å¼€å§‹"></div>
                <div class="season-divider winter-start" style="left: 91.67%;" title="å†¬å­£å¼€å§‹"></div>
            </div>
        </div>

    </div>

    <script>
        // ===== å…¨å±€å˜é‡ =====
        // æ³¨æ„ï¼šè¿™äº›å˜é‡å·²åœ¨main.jsä¸­å£°æ˜ï¼Œè¿™é‡Œä¸å†é‡å¤å£°æ˜
        // let currentSelectedRegion = 'all';  // å½“å‰é€‰ä¸­çš„åŒºåŸŸ
        // let currentChartType = 'bar';       // å½“å‰å›¾è¡¨ç±»å‹

        // ===== ä¹¡é•‡åœ°å—æ§åˆ¶å‡½æ•° =====

        /**
         * åˆ‡æ¢ä¹¡é•‡åœ°å—å¯è§æ€§
         */
        function toggleTownshipVisibility() {
            const switchElement = document.getElementById('township-visibility-switch');
            const isActive = switchElement.classList.contains('active');

            if (isActive) {
                switchElement.classList.remove('active');
                if (window.TownshipBlocks) {
                    window.TownshipBlocks.setVisibility(false);
                }
                console.log('ğŸ‘ï¸ éšè—ä¹¡é•‡åœ°å—');
            } else {
                switchElement.classList.add('active');
                if (window.TownshipBlocks) {
                    window.TownshipBlocks.setVisibility(true);
                }
                console.log('ğŸ‘ï¸ æ˜¾ç¤ºä¹¡é•‡åœ°å—');
            }
        }

        /**
         * é«˜äº®æŒ‡å®šä¹¡é•‡
         */
        function highlightTownship(townshipName) {
            if (window.TownshipBlocks) {
                window.TownshipBlocks.highlight(townshipName);
            }
        }

        /**
         * ç”Ÿæˆä¹¡é•‡ç»Ÿè®¡ä¿¡æ¯
         */
        function generateTownshipStats() {
            const statsContainer = document.getElementById('township-stats');
            if (!statsContainer || !window.TownshipBlocks) return;

            const stats = window.TownshipBlocks.getStatistics();
            statsContainer.innerHTML = `
                <div>æ€»ä¹¡é•‡æ•°: ${stats.totalTownships}ä¸ª</div>
                <div>æ€»äººå£: ${stats.totalPopulation.toLocaleString()}äºº</div>
                <div>æ€»é¢ç§¯: ${stats.totalArea}kmÂ²</div>
                <div>å¹³å‡äººå£: ${stats.averagePopulation.toLocaleString()}äºº</div>
            `;
        }

        /**
         * ç”Ÿæˆä¹¡é•‡åˆ—è¡¨
         */
        function generateTownshipList() {
            const listContainer = document.getElementById('township-list');
            if (!listContainer || !window.TownshipBlocks) return;

            const townships = window.TownshipBlocks.getByPopulationDensity();
            let listHtml = '';

            townships.forEach(township => {
                listHtml += `
                    <div class="township-item" onclick="selectTownshipFromList('${township.id}', '${township.name}')">
                        <div class="township-color" style="background-color: ${township.color}"></div>
                        <span class="township-name">${township.name}</span>
                        <span class="township-area">${township.area}kmÂ²</span>
                    </div>
                `;
            });

            listContainer.innerHTML = listHtml;
            console.log('ğŸ“‹ ä¹¡é•‡åˆ—è¡¨ç”Ÿæˆå®Œæˆ');
        }

        /**
         * ä»ä¹¡é•‡åˆ—è¡¨é€‰æ‹©ä¹¡é•‡ï¼ˆä¸åŒºåŸŸé€‰æ‹©å™¨è”åŠ¨ï¼‰
         */
        function selectTownshipFromList(townshipId, townshipName) {
            // è°ƒç”¨ä¸»ç³»ç»Ÿçš„åŒºåŸŸé€‰æ‹©å‡½æ•°ï¼Œå®ç°è”åŠ¨
            if (typeof selectRegion === 'function') {
                selectRegion(townshipId, townshipName);
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ“ä½œä¹¡é•‡åœ°å—
                if (window.TownshipBlocks) {
                    window.TownshipBlocks.filterByRegion(townshipId);
                    window.TownshipBlocks.highlight(townshipName);
                }
            }
        }

        // ===== ä¹¡é•‡é•¿åŠ¿å›¾è¡¨åŠŸèƒ½ =====
        // æ³¨æ„ï¼šå·²ç§»é™¤è¡¨æ ¼åˆ‡æ¢åŠŸèƒ½ï¼Œä½¿ç”¨ dashboard-charts.js ä¸­çš„å‡½æ•°

        /**
         * è·å–ä¹¡é•‡æ±‡æ€»å›¾è¡¨é…ç½®
         */
        function getTownshipSummaryChartOption(chartType) {
            const townships = ['çº¢å°é•‡', 'åœŸæ¡¥é•‡', 'æ¼«è·¯é•‡', 'åŒ—å¡¬é•‡', 'å…³æ»©é•‡', 'æ–°é›†é•‡', 'éº»å°¼å¯ºæ²Ÿé•‡', 'éŸ©é›†é•‡'];
            const data = [456, 398, 268, 134, 312, 289, 198, 167];

            return {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%', right: '4%', bottom: '3%', top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: townships,
                    axisLabel: { color: '#fff', fontSize: 10, rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff', fontSize: 10 }
                },
                series: [{
                    name: 'é¢ç§¯(äº©)',
                    type: 'bar',
                    data: data,
                    itemStyle: { color: '#00FFFF' }
                }]
            };
        }

        /**
         * è·å–å•ä¸ªä¹¡é•‡é•¿åŠ¿åˆ†ç±»å›¾è¡¨é…ç½®
         */
        function getSingleTownshipChartOption(regionId, chartType) {
            const growthData = getSingleTownshipGrowthData(regionId);
            const categories = ['ä¼˜', 'è‰¯', 'ä¸­', 'å·®'];
            const values = [growthData.excellent, growthData.good, growthData.medium, growthData.poor];
            const colors = ['#00FF88', '#00D4FF', '#FFD700', '#FF4500'];

            return {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        const data = params[0];
                        return `${data.name}<br/>é¢ç§¯: ${data.value} äº©<br/>å æ¯”: ${((data.value / values.reduce((a, b) => a + b, 0)) * 100).toFixed(1)}%`;
                    }
                },
                grid: {
                    left: '3%', right: '4%', bottom: '3%', top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: { 
                        color: '#fff', 
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    axisLine: {
                        lineStyle: { color: '#fff' }
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { 
                        color: '#fff', 
                        fontSize: 10 
                    },
                    axisLine: {
                        lineStyle: { color: '#fff' }
                    },
                    splitLine: {
                        lineStyle: { color: 'rgba(255, 255, 255, 0.2)' }
                    }
                },
                series: [{
                    name: 'é¢ç§¯(äº©)',
                    type: 'bar',
                    data: values.map((value, index) => ({
                        value: value,
                        itemStyle: { 
                            color: colors[index],
                            borderRadius: [4, 4, 0, 0]
                        }
                    })),
                    label: {
                        show: true,
                        position: 'top',
                        color: '#fff',
                        fontSize: 10,
                        formatter: '{c} äº©'
                    }
                }]
            };
        }



        /**
         * æ ¹æ®åŒºåŸŸIDè·å–ä¹¡é•‡åç§°
         */
        function getTownshipNameById(regionId) {
            const nameMap = {
                'chengguan': 'åŸå…³é•‡',
                'tuchang': 'åœŸåœºé•‡',
                'beita': 'åŒ—å¡”é•‡',
                'hongguang': 'çº¢å…‰é•‡',
                'jishishan': 'ç§¯çŸ³å±±é•‡',
                'hanjiaji': 'éŸ©å®¶é›†é•‡',
                'xinji': 'æ–°é›†é•‡',
                'liujiaxia': 'åˆ˜å®¶å³¡é•‡',
                'taiping': 'å¤ªå¹³é•‡',
                'minfeng': 'æ°‘ä¸°é•‡'
            };
            return nameMap[regionId] || 'æœªçŸ¥ä¹¡é•‡';
        }

        /**
         * æ›´æ–°å•ä¸ªä¹¡é•‡çš„é•¿åŠ¿åˆ†ç±»å›¾è¡¨
         */
        function updateSingleTownshipChart(regionId) {
            console.log(`ğŸ”„ updateSingleTownshipChart è¢«è°ƒç”¨ï¼ŒåŒºåŸŸID: ${regionId}`);
            
            // è·å–ä¹¡é•‡åç§°
            const townshipName = getTownshipNameById(regionId);
            if (!townshipName || townshipName === 'æœªçŸ¥ä¹¡é•‡') {
                console.warn(`âš ï¸ æœªæ‰¾åˆ°åŒºåŸŸåç§°: ${regionId}`);
                return;
            }
            
            // è·å–è¯¥ä¹¡é•‡çš„é•¿åŠ¿åˆ†ç±»æ•°æ®
            const growthData = getSingleTownshipGrowthData(regionId);
            console.log(`ğŸ“Š ${townshipName}é•¿åŠ¿æ•°æ®:`, growthData);

            // è·å–å›¾è¡¨å®¹å™¨
            const chartContainer = document.getElementById('town-crop-chart');
            if (!chartContainer) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°å›¾è¡¨å®¹å™¨');
                return;
            }

            // åˆå§‹åŒ–æˆ–è·å–EChartså®ä¾‹
            let chart = echarts.getInstanceByDom(chartContainer);
            if (!chart) {
                chart = echarts.init(chartContainer);
            }

            // é…ç½®å›¾è¡¨é€‰é¡¹
            const option = {
                title: {
                    text: `${townshipName}é•¿åŠ¿åˆ†ç±»åˆ†å¸ƒ`,
                    left: 'center',
                    textStyle: {
                        color: '#fff',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        const data = params[0];
                        const total = growthData.excellent + growthData.good + growthData.medium + growthData.poor;
                        const percentage = ((data.value / total) * 100).toFixed(1);
                        return `${data.name}<br/>é¢ç§¯: ${data.value}äº©<br/>å æ¯”: ${percentage}%`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['ä¼˜', 'è‰¯', 'ä¸­', 'å·®'],
                    axisLabel: {
                        color: '#fff',
                        fontSize: 12,
                        fontWeight: 'bold'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#fff'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'é¢ç§¯(äº©)',
                    nameTextStyle: {
                        color: '#fff'
                    },
                    axisLabel: {
                        color: '#fff'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#fff'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(255,255,255,0.1)'
                        }
                    }
                },
                series: [{
                    name: 'é•¿åŠ¿åˆ†å¸ƒ',
                    type: 'bar',
                    data: [growthData.excellent, growthData.good, growthData.medium, growthData.poor],
                    itemStyle: {
                        color: function(params) {
                            const colors = ['#4CAF50', '#FFC107', '#FF9800', '#F44336'];
                            return colors[params.dataIndex];
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    barWidth: '60%',
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(255,255,255,0.3)'
                        }
                    }
                }]
            };

            // è®¾ç½®å›¾è¡¨é…ç½®
            chart.setOption(option, true);
            console.log(`ğŸ“Š å·²æ›´æ–°${townshipName}çš„é•¿åŠ¿åˆ†ç±»å›¾è¡¨`);
        }

        /**
         * æœˆä»½æ•°æ®æ›´æ–°å‡½æ•°
         */
        function updateChartsForMonth(month) {
            console.log(`ğŸ“Š æ›´æ–°å›¾è¡¨æ•°æ®åˆ°${month}æœˆ`);

            // æ›´æ–°é•¿åŠ¿å›¾è¡¨
            if (typeof updateTownCropChart === 'function') {
                if (currentSelectedRegion === 'all') {
                    updateTownCropChart('wheat'); // å…¨å¿æ¨¡å¼æ˜¾ç¤ºå°éº¦æ•°æ®
                } else {
                    // å•ä¸ªä¹¡é•‡æ¨¡å¼ï¼Œéœ€è¦é‡æ–°è°ƒç”¨åŒºåŸŸé€‰æ‹©æ¥æ›´æ–°å›¾è¡¨
                    if (typeof updateSingleTownshipChart === 'function') {
                        updateSingleTownshipChart(currentSelectedRegion);
                    }
                }
            }

            // æ›´æ–°å…¶ä»–å›¾è¡¨
            updateDashboardChartsForMonth(month);
        }

        /**
         * æ›´æ–°ä»ªè¡¨æ¿å›¾è¡¨æ•°æ®
         */
        function updateDashboardChartsForMonth(month) {
            // æ¨¡æ‹Ÿä¸åŒæœˆä»½çš„æ•°æ®å˜åŒ–
            const monthlyData = getMonthlyData(month);

            // æ›´æ–°ä½œç‰©åˆ†å¸ƒæ•°æ®
            if (window.updateCropDistributionChart) {
                window.updateCropDistributionChart(monthlyData.cropDistribution);
            }

            // æ›´æ–°ç¯å¢ƒç›‘æµ‹æ•°æ®
            if (window.updateEnvironmentChart) {
                window.updateEnvironmentChart(monthlyData.environment);
            }

            console.log(`âœ… ä»ªè¡¨æ¿å›¾è¡¨å·²æ›´æ–°åˆ°${month}æœˆæ•°æ®`);
        }

        /**
         * è·å–æŒ‡å®šæœˆä»½çš„æ¨¡æ‹Ÿæ•°æ®
         */
        function getMonthlyData(month) {
            // æ¨¡æ‹Ÿä¸åŒæœˆä»½çš„æ•°æ®å˜åŒ–
            const baseData = {
                cropDistribution: {
                    wheat: 2200 + (month - 6) * 50,
                    corn: 1800 + (month - 6) * 30,
                    rice: 1500 + (month - 6) * 20,
                    soybean: 800 + (month - 6) * 15
                },
                environment: {
                    temperature: 15 + month * 2,
                    humidity: 60 + month * 3,
                    rainfall: Math.max(0, 50 + (month - 6) * 20),
                    sunshine: 8 + Math.sin(month * Math.PI / 6) * 3
                }
            };

            return baseData;
        }

        /**
         * æ›´æ–°å•ä¸ªä¹¡é•‡é•¿åŠ¿æ•°æ®ï¼ˆæ ¹æ®æœˆä»½å˜åŒ–ï¼‰
         */
        function getSingleTownshipGrowthData(regionId) {
            const currentMonth = window.Timeline ? window.Timeline.getCurrentMonth() : new Date().getMonth() + 1;

            // åŸºç¡€æ•°æ®
            const baseData = {
                'chengguan': { excellent: 180, good: 135, medium: 90, poor: 45 },
                'tuchang': { excellent: 160, good: 120, medium: 80, poor: 40 },
                'beita': { excellent: 110, good: 82, medium: 55, poor: 28 },
                'hongguang': { excellent: 140, good: 105, medium: 70, poor: 35 },
                'jishishan': { excellent: 200, good: 150, medium: 100, poor: 50 },
                'hanjiaji': { excellent: 130, good: 98, medium: 65, poor: 33 },
                'xinji': { excellent: 120, good: 90, medium: 60, poor: 30 },
                'liujiaxia': { excellent: 95, good: 71, medium: 47, poor: 24 },
                'taiping': { excellent: 115, good: 86, medium: 58, poor: 29 },
                'minfeng': { excellent: 105, good: 79, medium: 52, poor: 26 }
            };

            const base = baseData[regionId] || { excellent: 0, good: 0, medium: 0, poor: 0 };

            // æ ¹æ®æœˆä»½è°ƒæ•´æ•°æ®ï¼ˆæ¨¡æ‹Ÿå­£èŠ‚æ€§å˜åŒ–ï¼‰
            const seasonalFactor = getSeasonalFactor(currentMonth);

            return {
                excellent: Math.round(base.excellent * seasonalFactor.excellent),
                good: Math.round(base.good * seasonalFactor.good),
                medium: Math.round(base.medium * seasonalFactor.medium),
                poor: Math.round(base.poor * seasonalFactor.poor)
            };
        }

        /**
         * è·å–å­£èŠ‚æ€§è°ƒæ•´å› å­
         */
        function getSeasonalFactor(month) {
            // æ˜¥å­£(3-5æœˆ): é•¿åŠ¿é€æ¸å¥½è½¬
            // å¤å­£(6-8æœˆ): é•¿åŠ¿æœ€ä½³
            // ç§‹å­£(9-11æœˆ): é•¿åŠ¿ç¨³å®š
            // å†¬å­£(12-2æœˆ): é•¿åŠ¿è¾ƒå·®

            const factors = {
                1: { excellent: 0.6, good: 0.8, medium: 1.2, poor: 1.4 },  // å†¬å­£
                2: { excellent: 0.7, good: 0.9, medium: 1.1, poor: 1.3 },
                3: { excellent: 0.8, good: 1.0, medium: 1.0, poor: 1.2 },  // æ˜¥å­£å¼€å§‹
                4: { excellent: 0.9, good: 1.1, medium: 0.9, poor: 1.1 },
                5: { excellent: 1.0, good: 1.2, medium: 0.8, poor: 1.0 },
                6: { excellent: 1.2, good: 1.3, medium: 0.7, poor: 0.8 },  // å¤å­£æœ€ä½³
                7: { excellent: 1.3, good: 1.2, medium: 0.6, poor: 0.7 },
                8: { excellent: 1.2, good: 1.1, medium: 0.7, poor: 0.8 },
                9: { excellent: 1.1, good: 1.0, medium: 0.8, poor: 0.9 },  // ç§‹å­£
                10: { excellent: 1.0, good: 0.9, medium: 0.9, poor: 1.0 },
                11: { excellent: 0.9, good: 0.8, medium: 1.0, poor: 1.1 },
                12: { excellent: 0.7, good: 0.8, medium: 1.1, poor: 1.3 }   // å†¬å­£
            };

            return factors[month] || { excellent: 1, good: 1, medium: 1, poor: 1 };
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä¹¡é•‡æ§åˆ¶é¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–é¡µé¢...');
            
            // ç¡®ä¿å…¨å±€å˜é‡å·²åˆå§‹åŒ–
            if (typeof currentSelectedRegion === 'undefined') {
                window.currentSelectedRegion = 'all';
            }
            if (typeof currentChartType === 'undefined') {
                window.currentChartType = 'bar';
            }

            // æ·»åŠ è°ƒè¯•å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.debugRegionSelect = function() {
                console.log('ğŸ” è°ƒè¯•åŒºåŸŸé€‰æ‹©åŠŸèƒ½...');
                console.log('å½“å‰é€‰ä¸­åŒºåŸŸ:', window.currentSelectedRegion);
                console.log('å½“å‰å›¾è¡¨ç±»å‹:', window.currentChartType);
                console.log('selectRegionå‡½æ•°:', typeof selectRegion);
                console.log('updateTownCropChartå‡½æ•°:', typeof updateTownCropChart);
                console.log('updateSingleTownshipChartå‡½æ•°:', typeof updateSingleTownshipChart);
                
                // æµ‹è¯•åŒºåŸŸé€‰æ‹©
                if (typeof selectRegion === 'function') {
                    console.log('ğŸ§ª æµ‹è¯•é€‰æ‹©åŸå…³é•‡...');
                    selectRegion('chengguan', 'åŸå…³é•‡');
                }
            };



            // åˆå§‹åŒ–æ£€æŸ¥å‡½æ•°
            function initializeComponents() {
                console.log('ğŸ”§ æ£€æŸ¥ç»„ä»¶åˆå§‹åŒ–çŠ¶æ€...');
                
                // æ£€æŸ¥ä¹¡é•‡åœ°å—æ¨¡å—
                if (window.TownshipBlocks) {
                    console.log('âœ… ä¹¡é•‡åœ°å—æ¨¡å—å·²åŠ è½½');
                    generateTownshipStats();
                    generateTownshipList();
                } else {
                    console.log('âš ï¸ ä¹¡é•‡åœ°å—æ¨¡å—æœªåŠ è½½');
                }

                // æ£€æŸ¥å›¾è¡¨æ›´æ–°å‡½æ•°
                if (typeof updateTownCropChart === 'function') {
                    console.log('âœ… å›¾è¡¨æ›´æ–°å‡½æ•°å·²åŠ è½½');
                    updateTownCropChart('all', 'bar');
                } else {
                    console.log('âš ï¸ å›¾è¡¨æ›´æ–°å‡½æ•°æœªåŠ è½½');
                }

                // æ£€æŸ¥æ—¶é—´è½´æ¨¡å—
                if (window.Timeline) {
                    console.log('âœ… æ—¶é—´è½´æ¨¡å—å·²åŠ è½½');
                    window.Timeline.init();
                    console.log('â° æ—¶é—´è½´åˆå§‹åŒ–å®Œæˆ');
                } else {
                    console.log('âš ï¸ æ—¶é—´è½´æ¨¡å—æœªåŠ è½½');
                }

                console.log('ğŸ‰ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            }

            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
            setTimeout(initializeComponents, 2000);
        });
    </script>

    <!-- æŠ¥è¡¨é¢„è§ˆå¼¹çª— -->
    <div class="report-preview-modal" id="reportPreviewModal" style="display: none;">
        <div class="modal-backdrop" onclick="closeReportPreview()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>å†œæƒ…ç›‘æµ‹æŠ¥è¡¨é¢„è§ˆ</h3>
                <span class="close-btn" onclick="closeReportPreview()">âœ•</span>
            </div>
            <div class="modal-body">
                <div class="report-preview-content" id="reportPreviewContent">
                    <!-- æŠ¥è¡¨å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeReportPreview()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="exportReport()">ç¡®è®¤å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <script src="assets/js/cesium-config.js"></script>
    <script src="assets/js/cesium-map.js"></script>
    <script src="assets/js/crop-layers.js"></script>
    <script src="assets/js/township-blocks.js"></script>
    <script src="assets/js/timeline.js"></script>
    <script src="assets/js/device-monitoring.js"></script>
    <script src="assets/js/dashboard-charts.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/report-export.js"></script>
</body>
</html>