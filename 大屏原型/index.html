<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†œæƒ…é¥æ„Ÿç³»ç»Ÿå¤§å± - ä½œç‰©åˆ†å¸ƒåŠŸèƒ½</title>
    
    <!-- å¼•å…¥Cesium CSS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    
    <!-- å¼•å…¥ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/cesium-map.css">
    <link rel="stylesheet" href="assets/css/township-blocks.css">
    <link rel="stylesheet" href="assets/css/timeline.css">
</head>
<body>
    <!-- é¡¶éƒ¨ç³»ç»Ÿæ¨ªå¹… -->
    <div class="system-header">
        <!-- å·¦ä¾§ç³»ç»ŸçŠ¶æ€ -->
        <div class="header-left">
            <div class="system-status">
                <span class="status-dot"></span>
                <span class="status-text">ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
            </div>
        </div>

        <!-- ä¸­å¿ƒæ ‡é¢˜ -->
        <div class="system-title">
            ä¸´å¤å¿å«æ˜Ÿé¥æ„Ÿå¹³å°
            <div class="system-subtitle">Linxia County Satellite Remote Sensing Platform</div>
        </div>

        <!-- å³ä¾§æ—¶é—´æ˜¾ç¤ºå’Œç”¨æˆ·ä¿¡æ¯ -->
        <div class="header-right">
            <div class="current-time">
                <div class="time-display" id="current-time">2024-01-15 14:30:25</div>
                <div class="date-display" id="current-date">æ˜ŸæœŸä¸€</div>
            </div>

            <!-- åŒºåŸŸé€‰æ‹© -->
            <div class="region-selector">
                <div class="region-display" onclick="toggleRegionDropdown()">
                    <span class="region-icon">ğŸ“</span>
                    <span class="region-name" id="selected-region">å…¨å¿</span>
                    <span class="dropdown-arrow">â–¼</span>
                </div>

                <!-- åŒºåŸŸä¸‹æ‹‰èœå• -->
                <div class="region-dropdown" id="region-dropdown">
                    <div class="dropdown-item active" data-region="all" onclick="selectRegion('all', 'å…¨å¿')">
                        <span>ğŸ›ï¸</span>
                        <span>å…¨å¿</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-region="chengguan" onclick="selectRegion('chengguan', 'åŸå…³é•‡')">
                        <span>ğŸ¢</span>
                        <span>åŸå…³é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="tuchang" onclick="selectRegion('tuchang', 'åœŸåœºé•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>åœŸåœºé•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="beita" onclick="selectRegion('beita', 'åŒ—å¡”é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>åŒ—å¡”é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="hongguang" onclick="selectRegion('hongguang', 'çº¢å…‰é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>çº¢å…‰é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="jishishan" onclick="selectRegion('jishishan', 'ç§¯çŸ³å±±é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>ç§¯çŸ³å±±é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="hanjiaji" onclick="selectRegion('hanjiaji', 'éŸ©å®¶é›†é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>éŸ©å®¶é›†é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="xinji" onclick="selectRegion('xinji', 'æ–°é›†é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>æ–°é›†é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="liujiaxia" onclick="selectRegion('liujiaxia', 'åˆ˜å®¶å³¡é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>åˆ˜å®¶å³¡é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="taiping" onclick="selectRegion('taiping', 'å¤ªå¹³é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>å¤ªå¹³é•‡</span>
                    </div>
                    <div class="dropdown-item" data-region="minfeng" onclick="selectRegion('minfeng', 'æ°‘ä¸°é•‡')">
                        <span>ğŸ˜ï¸</span>
                        <span>æ°‘ä¸°é•‡</span>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
            <div class="user-info">
                <div class="user-avatar">
                    å¼ 
                    <div class="user-status"></div>
                </div>
                <div class="user-details">
                    <div class="user-name">å¼ ä¸‰</div>
                    <div class="user-role">ç³»ç»Ÿç®¡ç†å‘˜</div>
                </div>
                
                <!-- ç”¨æˆ·ä¸‹æ‹‰èœå• -->
                <div class="user-dropdown">
                    <div class="dropdown-item" onclick="showUserProfile()">
                        <span>ğŸ‘¤</span>
                        <span>ä¸ªäººä¿¡æ¯</span>
                    </div>
                    <div class="dropdown-item" onclick="showSystemSettings()">
                        <span>âš™ï¸</span>
                        <span>ç³»ç»Ÿè®¾ç½®</span>
                    </div>
                    <div class="dropdown-item" onclick="showOperationLog()">
                        <span>ğŸ“Š</span>
                        <span>æ“ä½œæ—¥å¿—</span>
                    </div>
                    <div class="dropdown-item" onclick="showHelp()">
                        <span>â“</span>
                        <span>å¸®åŠ©ä¸­å¿ƒ</span>
                    </div>
                    <div class="dropdown-item" onclick="logout()">
                        <span>ğŸšª</span>
                        <span>é€€å‡ºç™»å½•</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½åˆ‡æ¢æ¨¡å— -->
    <div class="function-switch-bar">
        <!-- ä¸»åŠŸèƒ½æŒ‰é’®ç»„ (5ä¸ª) -->
        <div class="main-switch-buttons">
            <div class="main-switch-btn active" data-function="crop-distribution">
                <span class="btn-icon">ğŸŒ¾</span>
                <span class="btn-text">ä½œç‰©åˆ†å¸ƒ</span>
            </div>
            <div class="main-switch-btn" data-function="growth-analysis">
                <span class="btn-icon">ğŸ“Š</span>
                <span class="btn-text">é•¿åŠ¿åˆ†æ</span>
            </div>
            <div class="main-switch-btn" data-function="yield-estimation">
                <span class="btn-icon">ğŸ“ˆ</span>
                <span class="btn-text">äº§é‡é¢„ä¼°</span>
            </div>
            <div class="main-switch-btn" data-function="weather-monitoring">
                <span class="btn-icon">ğŸŒ¤ï¸</span>
                <span class="btn-text">æ°”è±¡ç›‘æµ‹</span>
            </div>
            <div class="main-switch-btn" data-function="disaster-monitoring">
                <span class="btn-icon">âš ï¸</span>
                <span class="btn-text">ç¾å®³å®šæŸ</span>
            </div>
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="switch-divider"></div>

        <!-- å åŠ åŠŸèƒ½æŒ‰é’® (2ä¸ª) -->
        <div class="overlay-switch-btn" data-function="device-monitoring">
            <span class="btn-icon">ğŸ“±</span>
            <span class="btn-text">è®¾å¤‡ç›‘æ§</span>
        </div>
        
        <div class="overlay-switch-btn" data-function="crop-selection">
            <span class="btn-icon">ğŸŒ¾</span>
            <span class="btn-text">ä½œç‰©é€‰æ‹©</span>
        </div>
        
        <!-- ç¬¬äºŒä¸ªåˆ†éš”çº¿ -->
        <div class="switch-divider"></div>
        
        <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
        <div class="map-reset-btn" title="é‡ç½®è§†å›¾" onclick="resetMapView()">
            <span class="btn-icon">ğŸ¯</span>
            <span class="btn-text">é‡ç½®è§†å›¾</span>
        </div>
    </div>


    <!-- ä¸»åœ°å›¾å®¹å™¨ -->
    <div id="map-container">
        <!-- ç§‘æŠ€æ„ŸèƒŒæ™¯å…ƒç´  -->
        <div class="tech-grid"></div>
        
        <!-- Cesiumåœ°å›¾å®¹å™¨ -->
        <div id="cesium-container"></div>
        
        <!-- åœ°å›¾è¦†ç›–å±‚ -->
        <div class="map-overlay"></div>

        <!-- ä¹¡é•‡åœ°å—æ§åˆ¶é¢æ¿ -->
        <div class="township-control-panel" id="township-control-panel" style="top: 140px;">
            <div class="panel-title">ğŸ˜ï¸ ä¹¡é•‡åœ°å—</div>

            <div class="control-item">
                <div class="control-switch">
                    <div class="switch-input active" id="township-visibility-switch" onclick="toggleTownshipVisibility()"></div>
                    <span class="switch-label">æ˜¾ç¤ºä¹¡é•‡</span>
                </div>
            </div>

            <div class="control-item">
                <label class="control-label">ç»Ÿè®¡ä¿¡æ¯</label>
                <div id="township-stats" style="font-size: 11px; color: #B0BEC5; margin-top: 4px;">
                    <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="control-item">
                <label class="control-label">ä¹¡é•‡åˆ—è¡¨</label>
                <div class="township-list" id="township-list" style="max-height: 150px;">
                    <!-- ä¹¡é•‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>



        <!-- å³ä¾§ä½œç‰©åˆ†å¸ƒæ•°æ®çœ‹æ¿ -->
        <div class="glass-panel right-panel">
            <div class="panel-header">
                <div class="panel-title">
                    ğŸŒ¾ ä½œç‰©åˆ†å¸ƒç›‘æµ‹çœ‹æ¿
                </div>
                <button class="collapse-btn">â–¶</button>
            </div>

            <!-- 1. åŒºåŸŸé¢ç§¯æ±‡æ€»çœ‹æ¿ -->
            <div class="stat-card" id="region-summary-card">
                <div class="stat-header">
                    ğŸ“‹ åŒºåŸŸé¢ç§¯æ±‡æ€»
                </div>
                <div class="area-summary">
                    <div class="summary-item large">
                        <div class="summary-value" id="total-area-value">5,272</div>
                        <div class="summary-label">æ€»ç›‘æµ‹é¢ç§¯ (äº©)</div>
                        <div class="summary-subtitle" id="coverage-info">è¦†ç›–8ä¸ªä¹¡é•‡</div>
                    </div>
                    <div class="summary-row">
                        <div class="summary-item">
                            <div class="summary-value" id="growth-index-value">0.8</div>
                            <div class="summary-label">å¹³å‡é•¿åŠ¿æŒ‡æ•°</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. å•ä½œç‰©æŒ‰ä¹¡é•‡é¢ç§¯åˆ†å¸ƒ -->
            <div class="stat-card chart-data-panel" style="height: 260px !important; min-height: 260px !important; max-height: 260px !important; display: flex !important; flex-direction: column !important; overflow: hidden !important;">
                <div class="stat-header" style="flex-shrink: 0 !important; flex-grow: 0 !important;">
                    <span id="current-crop-title">ğŸŒ¾ å°éº¦æŒ‰ä¹¡é•‡é•¿åŠ¿åˆ†å¸ƒ</span>
                    <div class="chart-switch-buttons">
                        <button class="switch-btn active" data-type="bar" onclick="switchTownCropChart('bar')">æŸ±çŠ¶å›¾</button>
                        <button class="switch-btn" data-type="table" onclick="switchTownCropChart('table')">è¡¨æ ¼</button>
                    </div>
                </div>
                <div id="town-crop-chart" style="height: 220px; flex-shrink: 0 !important; flex-grow: 0 !important; margin: 0 !important;"></div>
                <div id="town-crop-table" class="town-crop-table" style="display: none; flex: 1 !important; margin-top: 0 !important; height: auto !important; overflow-y: auto !important;">
                    <table>
                        <thead>
                            <tr>
                                <th>ä¹¡é•‡</th>
                                <th>ä¼˜ (äº©)</th>
                                <th>è‰¯ (äº©)</th>
                                <th>ä¸­ (äº©)</th>
                                <th>å·® (äº©)</th>
                                <th>åˆè®¡ (äº©)</th>
                            </tr>
                            <tr class="total-row sticky-total">
                                <td><strong>åˆè®¡</strong></td>
                                <td><strong>889</strong></td>
                                <td><strong>667</strong></td>
                                <td><strong>444</strong></td>
                                <td><strong>222</strong></td>
                                <td><strong id="crop-total">2,222</strong></td>
                            </tr>
                        </thead>
                        <tbody id="town-crop-tbody">
                            <tr>
                                <td>çº¢å°é•‡</td>
                                <td>182</td>
                                <td>137</td>
                                <td>91</td>
                                <td>46</td>
                                <td>456</td>
                            </tr>
                            <tr>
                                <td>åœŸæ¡¥é•‡</td>
                                <td>159</td>
                                <td>119</td>
                                <td>80</td>
                                <td>40</td>
                                <td>398</td>
                            </tr>
                            <tr>
                                <td>æ¼«è·¯é•‡</td>
                                <td>107</td>
                                <td>80</td>
                                <td>54</td>
                                <td>27</td>
                                <td>268</td>
                            </tr>
                            <tr>
                                <td>åŒ—å¡¬é•‡</td>
                                <td>54</td>
                                <td>40</td>
                                <td>27</td>
                                <td>13</td>
                                <td>134</td>
                            </tr>
                            <tr>
                                <td>å…³æ»©é•‡</td>
                                <td>125</td>
                                <td>94</td>
                                <td>62</td>
                                <td>31</td>
                                <td>312</td>
                            </tr>
                            <tr>
                                <td>æ–°é›†é•‡</td>
                                <td>116</td>
                                <td>87</td>
                                <td>58</td>
                                <td>29</td>
                                <td>289</td>
                            </tr>
                            <tr>
                                <td>éº»å°¼å¯ºæ²Ÿé•‡</td>
                                <td>79</td>
                                <td>59</td>
                                <td>40</td>
                                <td>20</td>
                                <td>198</td>
                            </tr>
                            <tr>
                                <td>éŸ©é›†é•‡</td>
                                <td>67</td>
                                <td>50</td>
                                <td>33</td>
                                <td>17</td>
                                <td>167</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. é•¿åŠ¿æŒ‡æ•°å˜åŒ–è¶‹åŠ¿å›¾ -->
            <div class="stat-card">
                <div class="stat-header">
                    <span class="section-icon">ğŸ“ˆ</span>
                    é•¿åŠ¿æŒ‡æ•°å˜åŒ–è¶‹åŠ¿å›¾
                </div>
                <div class="trend-comparison-container">
                    <div id="growth-trend-comparison" class="chart-container"></div>
                </div>
            </div>

            <div class="update-time">
                ğŸ”„ æ•°æ®æ›´æ–°: 2024-01-15 14:30 | é¥æ„Ÿæ•°æ®: 2024-01-12
            </div>
        </div>
    </div>

    <script>
        // ===== ä¹¡é•‡åœ°å—æ§åˆ¶å‡½æ•° =====

        /**
         * åˆ‡æ¢ä¹¡é•‡åœ°å—å¯è§æ€§
         */
        function toggleTownshipVisibility() {
            const switchElement = document.getElementById('township-visibility-switch');
            const isActive = switchElement.classList.contains('active');

            if (isActive) {
                switchElement.classList.remove('active');
                if (window.TownshipBlocks) {
                    window.TownshipBlocks.setVisibility(false);
                }
                console.log('ğŸ‘ï¸ éšè—ä¹¡é•‡åœ°å—');
            } else {
                switchElement.classList.add('active');
                if (window.TownshipBlocks) {
                    window.TownshipBlocks.setVisibility(true);
                }
                console.log('ğŸ‘ï¸ æ˜¾ç¤ºä¹¡é•‡åœ°å—');
            }
        }

        /**
         * é«˜äº®æŒ‡å®šä¹¡é•‡
         */
        function highlightTownship(townshipName) {
            if (window.TownshipBlocks) {
                window.TownshipBlocks.highlight(townshipName);
            }
        }

        /**
         * ç”Ÿæˆä¹¡é•‡ç»Ÿè®¡ä¿¡æ¯
         */
        function generateTownshipStats() {
            const statsContainer = document.getElementById('township-stats');
            if (!statsContainer || !window.TownshipBlocks) return;

            const stats = window.TownshipBlocks.getStatistics();
            statsContainer.innerHTML = `
                <div>æ€»ä¹¡é•‡æ•°: ${stats.totalTownships}ä¸ª</div>
                <div>æ€»äººå£: ${stats.totalPopulation.toLocaleString()}äºº</div>
                <div>æ€»é¢ç§¯: ${stats.totalArea}kmÂ²</div>
                <div>å¹³å‡äººå£: ${stats.averagePopulation.toLocaleString()}äºº</div>
            `;
        }

        /**
         * ç”Ÿæˆä¹¡é•‡åˆ—è¡¨
         */
        function generateTownshipList() {
            const listContainer = document.getElementById('township-list');
            if (!listContainer || !window.TownshipBlocks) return;

            const townships = window.TownshipBlocks.getByPopulationDensity();
            let listHtml = '';

            townships.forEach(township => {
                listHtml += `
                    <div class="township-item" onclick="selectTownshipFromList('${township.id}', '${township.name}')">
                        <div class="township-color" style="background-color: ${township.color}"></div>
                        <span class="township-name">${township.name}</span>
                        <span class="township-area">${township.area}kmÂ²</span>
                    </div>
                `;
            });

            listContainer.innerHTML = listHtml;
            console.log('ğŸ“‹ ä¹¡é•‡åˆ—è¡¨ç”Ÿæˆå®Œæˆ');
        }

        /**
         * ä»ä¹¡é•‡åˆ—è¡¨é€‰æ‹©ä¹¡é•‡ï¼ˆä¸åŒºåŸŸé€‰æ‹©å™¨è”åŠ¨ï¼‰
         */
        function selectTownshipFromList(townshipId, townshipName) {
            // è°ƒç”¨ä¸»ç³»ç»Ÿçš„åŒºåŸŸé€‰æ‹©å‡½æ•°ï¼Œå®ç°è”åŠ¨
            if (typeof selectRegion === 'function') {
                selectRegion(townshipId, townshipName);
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ“ä½œä¹¡é•‡åœ°å—
                if (window.TownshipBlocks) {
                    window.TownshipBlocks.filterByRegion(townshipId);
                    window.TownshipBlocks.highlight(townshipName);
                }
            }
        }

        // ===== ä¹¡é•‡é•¿åŠ¿å›¾è¡¨åŠŸèƒ½ =====

        /**
         * åˆ‡æ¢ä¹¡é•‡ä½œç‰©å›¾è¡¨ç±»å‹
         */
        function switchTownCropChart(chartType) {
            console.log(`ğŸ“Š åˆ‡æ¢å›¾è¡¨ç±»å‹: ${chartType}`);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const buttons = document.querySelectorAll('.chart-switch-buttons .switch-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-type') === chartType) {
                    btn.classList.add('active');
                }
            });

            currentChartType = chartType;

            // æ ¹æ®å›¾è¡¨ç±»å‹æ˜¾ç¤ºå¯¹åº”å†…å®¹
            const chartDiv = document.getElementById('town-crop-chart');
            const tableDiv = document.getElementById('town-crop-table');

            if (chartType === 'table') {
                chartDiv.style.display = 'none';
                tableDiv.style.display = 'block';
                updateTownCropTable(currentSelectedRegion);
            } else {
                chartDiv.style.display = 'block';
                tableDiv.style.display = 'none';
                updateTownCropChart(currentSelectedRegion, chartType);
            }
        }

        /**
         * æ›´æ–°ä¹¡é•‡ä½œç‰©é•¿åŠ¿å›¾è¡¨
         */
        function updateTownCropChart(regionId, chartType = 'bar') {
            const chartContainer = document.getElementById('town-crop-chart');
            const titleElement = document.getElementById('current-crop-title');

            if (!chartContainer || !titleElement) return;

            // è·å–æˆ–åˆ›å»ºEChartså®ä¾‹
            let chart = echarts.getInstanceByDom(chartContainer);
            if (!chart) {
                chart = echarts.init(chartContainer);
            }

            let option;

            if (regionId === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰ä¹¡é•‡çš„æ±‡æ€»æ•°æ®
                titleElement.textContent = 'ğŸŒ¾ å°éº¦æŒ‰ä¹¡é•‡é•¿åŠ¿åˆ†å¸ƒ';
                option = getTownshipSummaryChartOption(chartType);
            } else {
                // æ˜¾ç¤ºå•ä¸ªä¹¡é•‡çš„é•¿åŠ¿åˆ†ç±»æ•°æ®
                const townshipName = getTownshipNameById(regionId);
                titleElement.textContent = `ğŸŒ¾ ${townshipName}é•¿åŠ¿åˆ†ç±»åˆ†å¸ƒ`;
                option = getSingleTownshipChartOption(regionId, chartType);
            }

            chart.setOption(option, true);
            console.log(`ğŸ“Š å›¾è¡¨å·²æ›´æ–°: ${regionId} - ${chartType}`);
        }

        /**
         * æ›´æ–°ä¹¡é•‡ä½œç‰©é•¿åŠ¿è¡¨æ ¼
         */
        function updateTownCropTable(regionId) {
            const titleElement = document.getElementById('current-crop-title');
            const tableBody = document.getElementById('town-crop-tbody');
            const totalElement = document.getElementById('crop-total');

            if (!titleElement || !tableBody) return;

            if (regionId === 'all') {
                // æ˜¾ç¤ºæ‰€æœ‰ä¹¡é•‡æ•°æ®
                titleElement.textContent = 'ğŸŒ¾ å°éº¦æŒ‰ä¹¡é•‡é•¿åŠ¿åˆ†å¸ƒ';
                // ä¿æŒåŸæœ‰çš„è¡¨æ ¼æ•°æ®
            } else {
                // æ˜¾ç¤ºå•ä¸ªä¹¡é•‡çš„é•¿åŠ¿åˆ†ç±»æ•°æ®
                const townshipName = getTownshipNameById(regionId);
                const growthData = getSingleTownshipGrowthData(regionId);

                titleElement.textContent = `ğŸŒ¾ ${townshipName}é•¿åŠ¿åˆ†ç±»åˆ†å¸ƒ`;

                // æ›´æ–°è¡¨æ ¼å†…å®¹ä¸ºé•¿åŠ¿åˆ†ç±»
                tableBody.innerHTML = `
                    <tr>
                        <td>${townshipName}</td>
                        <td>${growthData.excellent}</td>
                        <td>${growthData.good}</td>
                        <td>${growthData.medium}</td>
                        <td>${growthData.poor}</td>
                        <td>${growthData.excellent + growthData.good + growthData.medium + growthData.poor}</td>
                    </tr>
                `;

                // æ›´æ–°åˆè®¡
                if (totalElement) {
                    const total = growthData.excellent + growthData.good + growthData.medium + growthData.poor;
                    totalElement.textContent = total.toLocaleString();
                }
            }
        }

        /**
         * è·å–ä¹¡é•‡æ±‡æ€»å›¾è¡¨é…ç½®
         */
        function getTownshipSummaryChartOption(chartType) {
            const townships = ['çº¢å°é•‡', 'åœŸæ¡¥é•‡', 'æ¼«è·¯é•‡', 'åŒ—å¡¬é•‡', 'å…³æ»©é•‡', 'æ–°é›†é•‡', 'éº»å°¼å¯ºæ²Ÿé•‡', 'éŸ©é›†é•‡'];
            const data = [456, 398, 268, 134, 312, 289, 198, 167];

            return {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%', right: '4%', bottom: '3%', top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: townships,
                    axisLabel: { color: '#fff', fontSize: 10, rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff', fontSize: 10 }
                },
                series: [{
                    name: 'é¢ç§¯(äº©)',
                    type: 'bar',
                    data: data,
                    itemStyle: { color: '#00FFFF' }
                }]
            };
        }

        /**
         * è·å–å•ä¸ªä¹¡é•‡é•¿åŠ¿åˆ†ç±»å›¾è¡¨é…ç½®
         */
        function getSingleTownshipChartOption(regionId, chartType) {
            const growthData = getSingleTownshipGrowthData(regionId);
            const categories = ['ä¼˜', 'è‰¯', 'ä¸­', 'å·®'];
            const values = [growthData.excellent, growthData.good, growthData.medium, growthData.poor];
            const colors = ['#00FF88', '#00D4FF', '#FFD700', '#FF4500'];

            return {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '3%', right: '4%', bottom: '3%', top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: { color: '#fff', fontSize: 12 }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#fff', fontSize: 10 }
                },
                series: [{
                    name: 'é¢ç§¯(äº©)',
                    type: 'bar',
                    data: values.map((value, index) => ({
                        value: value,
                        itemStyle: { color: colors[index] }
                    }))
                }]
            };
        }

        /**
         * è·å–å•ä¸ªä¹¡é•‡çš„é•¿åŠ¿æ•°æ®
         */
        function getSingleTownshipGrowthData(regionId) {
            // æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»åç«¯è·å–
            const mockData = {
                'chengguan': { excellent: 180, good: 135, medium: 90, poor: 45 },
                'tuchang': { excellent: 160, good: 120, medium: 80, poor: 40 },
                'beita': { excellent: 110, good: 82, medium: 55, poor: 28 },
                'hongguang': { excellent: 140, good: 105, medium: 70, poor: 35 },
                'jishishan': { excellent: 200, good: 150, medium: 100, poor: 50 },
                'hanjiaji': { excellent: 130, good: 98, medium: 65, poor: 33 },
                'xinji': { excellent: 120, good: 90, medium: 60, poor: 30 },
                'liujiaxia': { excellent: 95, good: 71, medium: 47, poor: 24 },
                'taiping': { excellent: 115, good: 86, medium: 58, poor: 29 },
                'minfeng': { excellent: 105, good: 79, medium: 52, poor: 26 }
            };

            return mockData[regionId] || { excellent: 0, good: 0, medium: 0, poor: 0 };
        }

        /**
         * æ ¹æ®åŒºåŸŸIDè·å–ä¹¡é•‡åç§°
         */
        function getTownshipNameById(regionId) {
            const nameMap = {
                'chengguan': 'åŸå…³é•‡',
                'tuchang': 'åœŸåœºé•‡',
                'beita': 'åŒ—å¡”é•‡',
                'hongguang': 'çº¢å…‰é•‡',
                'jishishan': 'ç§¯çŸ³å±±é•‡',
                'hanjiaji': 'éŸ©å®¶é›†é•‡',
                'xinji': 'æ–°é›†é•‡',
                'liujiaxia': 'åˆ˜å®¶å³¡é•‡',
                'taiping': 'å¤ªå¹³é•‡',
                'minfeng': 'æ°‘ä¸°é•‡'
            };
            return nameMap[regionId] || 'æœªçŸ¥ä¹¡é•‡';
        }

        /**
         * æœˆä»½æ•°æ®æ›´æ–°å‡½æ•°
         */
        function updateChartsForMonth(month) {
            console.log(`ğŸ“Š æ›´æ–°å›¾è¡¨æ•°æ®åˆ°${month}æœˆ`);

            // æ›´æ–°é•¿åŠ¿å›¾è¡¨
            if (typeof updateTownCropChart === 'function') {
                updateTownCropChart(currentSelectedRegion, currentChartType || 'bar');
            }

            // æ›´æ–°å…¶ä»–å›¾è¡¨
            updateDashboardChartsForMonth(month);
        }

        /**
         * æ›´æ–°ä»ªè¡¨æ¿å›¾è¡¨æ•°æ®
         */
        function updateDashboardChartsForMonth(month) {
            // æ¨¡æ‹Ÿä¸åŒæœˆä»½çš„æ•°æ®å˜åŒ–
            const monthlyData = getMonthlyData(month);

            // æ›´æ–°ä½œç‰©åˆ†å¸ƒæ•°æ®
            if (window.updateCropDistributionChart) {
                window.updateCropDistributionChart(monthlyData.cropDistribution);
            }

            // æ›´æ–°ç¯å¢ƒç›‘æµ‹æ•°æ®
            if (window.updateEnvironmentChart) {
                window.updateEnvironmentChart(monthlyData.environment);
            }

            console.log(`âœ… ä»ªè¡¨æ¿å›¾è¡¨å·²æ›´æ–°åˆ°${month}æœˆæ•°æ®`);
        }

        /**
         * è·å–æŒ‡å®šæœˆä»½çš„æ¨¡æ‹Ÿæ•°æ®
         */
        function getMonthlyData(month) {
            // æ¨¡æ‹Ÿä¸åŒæœˆä»½çš„æ•°æ®å˜åŒ–
            const baseData = {
                cropDistribution: {
                    wheat: 2200 + (month - 6) * 50,
                    corn: 1800 + (month - 6) * 30,
                    rice: 1500 + (month - 6) * 20,
                    soybean: 800 + (month - 6) * 15
                },
                environment: {
                    temperature: 15 + month * 2,
                    humidity: 60 + month * 3,
                    rainfall: Math.max(0, 50 + (month - 6) * 20),
                    sunshine: 8 + Math.sin(month * Math.PI / 6) * 3
                }
            };

            return baseData;
        }

        /**
         * æ›´æ–°å•ä¸ªä¹¡é•‡é•¿åŠ¿æ•°æ®ï¼ˆæ ¹æ®æœˆä»½å˜åŒ–ï¼‰
         */
        function getSingleTownshipGrowthData(regionId) {
            const currentMonth = window.Timeline ? window.Timeline.getCurrentMonth() : new Date().getMonth() + 1;

            // åŸºç¡€æ•°æ®
            const baseData = {
                'chengguan': { excellent: 180, good: 135, medium: 90, poor: 45 },
                'tuchang': { excellent: 160, good: 120, medium: 80, poor: 40 },
                'beita': { excellent: 110, good: 82, medium: 55, poor: 28 },
                'hongguang': { excellent: 140, good: 105, medium: 70, poor: 35 },
                'jishishan': { excellent: 200, good: 150, medium: 100, poor: 50 },
                'hanjiaji': { excellent: 130, good: 98, medium: 65, poor: 33 },
                'xinji': { excellent: 120, good: 90, medium: 60, poor: 30 },
                'liujiaxia': { excellent: 95, good: 71, medium: 47, poor: 24 },
                'taiping': { excellent: 115, good: 86, medium: 58, poor: 29 },
                'minfeng': { excellent: 105, good: 79, medium: 52, poor: 26 }
            };

            const base = baseData[regionId] || { excellent: 0, good: 0, medium: 0, poor: 0 };

            // æ ¹æ®æœˆä»½è°ƒæ•´æ•°æ®ï¼ˆæ¨¡æ‹Ÿå­£èŠ‚æ€§å˜åŒ–ï¼‰
            const seasonalFactor = getSeasonalFactor(currentMonth);

            return {
                excellent: Math.round(base.excellent * seasonalFactor.excellent),
                good: Math.round(base.good * seasonalFactor.good),
                medium: Math.round(base.medium * seasonalFactor.medium),
                poor: Math.round(base.poor * seasonalFactor.poor)
            };
        }

        /**
         * è·å–å­£èŠ‚æ€§è°ƒæ•´å› å­
         */
        function getSeasonalFactor(month) {
            // æ˜¥å­£(3-5æœˆ): é•¿åŠ¿é€æ¸å¥½è½¬
            // å¤å­£(6-8æœˆ): é•¿åŠ¿æœ€ä½³
            // ç§‹å­£(9-11æœˆ): é•¿åŠ¿ç¨³å®š
            // å†¬å­£(12-2æœˆ): é•¿åŠ¿è¾ƒå·®

            const factors = {
                1: { excellent: 0.6, good: 0.8, medium: 1.2, poor: 1.4 },  // å†¬å­£
                2: { excellent: 0.7, good: 0.9, medium: 1.1, poor: 1.3 },
                3: { excellent: 0.8, good: 1.0, medium: 1.0, poor: 1.2 },  // æ˜¥å­£å¼€å§‹
                4: { excellent: 0.9, good: 1.1, medium: 0.9, poor: 1.1 },
                5: { excellent: 1.0, good: 1.2, medium: 0.8, poor: 1.0 },
                6: { excellent: 1.2, good: 1.3, medium: 0.7, poor: 0.8 },  // å¤å­£æœ€ä½³
                7: { excellent: 1.3, good: 1.2, medium: 0.6, poor: 0.7 },
                8: { excellent: 1.2, good: 1.1, medium: 0.7, poor: 0.8 },
                9: { excellent: 1.1, good: 1.0, medium: 0.8, poor: 0.9 },  // ç§‹å­£
                10: { excellent: 1.0, good: 0.9, medium: 0.9, poor: 1.0 },
                11: { excellent: 0.9, good: 0.8, medium: 1.0, poor: 1.1 },
                12: { excellent: 0.7, good: 0.8, medium: 1.1, poor: 1.3 }   // å†¬å­£
            };

            return factors[month] || { excellent: 1, good: 1, medium: 1, poor: 1 };
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä¹¡é•‡æ§åˆ¶é¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.TownshipBlocks) {
                    generateTownshipStats();
                    generateTownshipList();
                }

                // åˆå§‹åŒ–å›¾è¡¨
                updateTownCropChart('all', 'bar');

                // åˆå§‹åŒ–æ—¶é—´è½´
                if (window.Timeline) {
                    window.Timeline.init();
                    console.log('â° æ—¶é—´è½´åˆå§‹åŒ–å®Œæˆ');
                }
            }, 5000); // ç­‰å¾…ä¹¡é•‡åœ°å—åˆå§‹åŒ–å®Œæˆ
        });
    </script>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <script src="assets/js/cesium-config.js"></script>
    <script src="assets/js/cesium-map.js"></script>
    <script src="assets/js/crop-layers.js"></script>
    <script src="assets/js/township-blocks.js"></script>
    <script src="assets/js/timeline.js"></script>
    <script src="assets/js/device-monitoring.js"></script>
    <script src="assets/js/dashboard-charts.js"></script>
    <script src="assets/js/main.js"></script>
</body>
</html>