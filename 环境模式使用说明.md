# 智能化PRD系统 - 环境模式使用说明

## 📋 概述

智能化PRD系统现在支持两种运行模式：

- 🌐 **线上模式（Production）**: 只允许查看批注，不允许添加或编辑
- 🛠️ **开发模式（Development）**: 完整功能，支持批注编辑和实时同步

## 🎨 Canvas智能识别系统

### 核心特性
- **ECharts自动检测**: 识别图表类型、标题和配置信息
- **多Canvas精确区分**: 基于位置、尺寸、容器上下文生成唯一标识
- **智能友好命名**: 自动生成描述性名称，如"ECharts 销售趋势折线图"
- **上下文语义分析**: 检测Canvas容器的用途（图表、地图、3D等）

### 识别能力
| 类型 | 识别特征 | 命名示例 |
|------|----------|----------|
| ECharts图表 | 图表类型、标题、实例ID | "ECharts 折线图"、"销售趋势分析" |
| 原生Canvas | 上下文类型、尺寸、位置 | "左上中型2D Canvas #1" |
| 3D地图 | Cesium/Three.js检测 | "Cesium 3D地图" |
| WebGL场景 | WebGL上下文检测 | "中央大型WebGL Canvas" |

### 使用测试页面
系统已包含测试页面 `canvas-test-demo.html`，包含：
- 6种不同ECharts图表类型
- 4个原生Canvas（2D和WebGL）
- 5个不同位置的Canvas
- 各种尺寸和容器配置

## 🚀 快速开始

### 线上模式（默认）
直接打开 `prd-system.html` 文件即可，系统会自动检测为线上模式。

```bash
# 直接用浏览器打开
open prd-system.html
```

### 开发模式

#### 方式1: URL参数切换
在URL后添加 `?mode=dev` 参数：
```
prd-system.html?mode=dev
```

#### 方式2: 本地服务器（推荐）
```bash
# 1. 安装依赖
npm install

# 2. 启动API服务器
npm start

# 3. 打开浏览器访问
# http://localhost:3000/prd-system.html
```

## 🔧 环境配置

### 自动检测规则

系统会按以下优先级自动检测环境：

1. **URL参数**: `?mode=dev` 或 `?mode=prod`
2. **域名判断**: localhost、127.0.0.1、包含dev/test的域名 → 开发模式
3. **API配置**: 设置了 `window.PRD_API_BASE_URL` → 开发模式
4. **默认**: 线上模式

### 手动配置

在HTML中添加配置：
```html
<script>
    // 强制设置为开发模式
    window.PRD_API_BASE_URL = 'http://localhost:3000/api';
</script>
```

## 🌍 环境模式对比

| 功能 | 线上模式 | 开发模式 |
|------|----------|----------|
| 查看批注 | ✅ | ✅ |
| 添加批注 | ❌ | ✅ |
| 编辑批注 | ❌ | ✅ |
| 删除批注 | ❌ | ✅ |
| 调试工具 | ❌ | ✅ |
| 实时同步 | ❌ | ✅ |
| API连接 | ❌ | ✅ |

## 🔗 API接口说明

### 基础接口

- `GET /api/health` - 健康检查
- `GET /api/annotations` - 获取所有批注数据
- `POST /api/annotations` - 保存所有批注数据（全量）
- `POST /api/annotations/update` - 增量更新单个批注
- `POST /api/annotations/sync` - 实时同步单个批注（广播）
- `GET /api/sync-logs` - 获取同步日志
- `GET /api/operation-logs` - 获取操作日志
- `GET /api/annotations/stats` - 获取数据统计

### 数据格式

批注数据结构：
```json
{
  "页面键": {
    "元素ID": {
      "name": "批注标题",
      "content": "批注内容",
      "timestamp": "创建时间",
      "elementId": "元素标识",
      "targetInfo": {
        "smartSelector": "智能选择器",
        "elementFingerprint": "元素指纹",
        "fallbackSelector": "备用选择器",
        "textContent": "文本内容",
        "pageUrl": "页面地址",
        "timestamp": "ISO时间戳"
      }
    }
  }
}
```

## 🛠️ 开发模式功能

### 1. 实时批注同步
- 批注数据自动保存到服务器
- 支持多人协作编辑
- 操作日志记录

### 2. 调试工具
点击右上角的 🔧 按钮可访问：
- 系统诊断
- 批注测试
- 元素签名查看
- 数据修复工具
- API连接测试

### 3. 权限控制
- 自动隐藏不可用功能
- 友好的权限提示
- 模式状态显示

## 📁 文件结构

```
临夏农业/
├── prd-system.html           # 主要PRD系统文件
├── api-server-example.js     # 后端API服务器
├── package.json              # Node.js依赖配置
├── prd-docs/
│   ├── annotations.json      # 批注数据存储
│   └── *.md                  # 功能说明文档
└── 大屏原型/                  # 原型页面文件
    └── index.html
```

## 🚨 注意事项

### 线上部署
1. 确保服务器只提供线上模式访问
2. 批注数据文件设为只读
3. 移除或禁用API服务器

### 开发环境
1. 确保Node.js版本 >= 14.0.0
2. 检查端口3000是否被占用
3. 批注数据会自动备份

### 安全建议
1. 生产环境不要暴露API接口
2. 定期备份批注数据
3. 限制开发模式的访问权限

## 🔧 故障排除

### 常见问题

**Q: 无法进入开发模式？**
- 检查URL参数是否正确
- 确认API服务器是否启动
- 查看浏览器控制台错误信息

**Q: 批注数据丢失？**
- 检查 `prd-docs/annotations.json` 文件
- 查看备份文件（带时间戳）
- 使用调试工具导出数据

**Q: API连接失败？**
- 确认服务器状态：`npm start`
- 检查端口是否被占用
- 验证网络连接

### 日志查看
```bash
# 查看服务器日志
npm start

# 查看同步日志
curl http://localhost:3000/api/sync-logs

# 查看数据统计
curl http://localhost:3000/api/annotations/stats
```

## 📞 技术支持

如遇到问题，请提供以下信息：
1. 当前运行模式
2. 浏览器和版本
3. 错误信息截图
4. 控制台日志

通过调试工具的"导出调试信息"功能可以快速收集相关信息。